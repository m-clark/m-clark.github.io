<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"/>
  <meta name="generator" content="distill" />

  <style type="text/css">
  /* Hide doc at startup (prevent jankiness while JS renders/transforms) */
  body {
    visibility: hidden;
  }
  </style>

 <!--radix_placeholder_import_source-->
 <!--/radix_placeholder_import_source-->

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { color: #00769e; background-color: #f1f3f5; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span { color: #00769e; } /* Normal */
code span.al { color: #ad0000; } /* Alert */
code span.an { color: #5e5e5e; } /* Annotation */
code span.at { color: #657422; } /* Attribute */
code span.bn { color: #ad0000; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #00769e; } /* ControlFlow */
code span.ch { color: #20794d; } /* Char */
code span.cn { color: #8f5902; } /* Constant */
code span.co { color: #5e5e5e; } /* Comment */
code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
code span.dt { color: #ad0000; } /* DataType */
code span.dv { color: #ad0000; } /* DecVal */
code span.er { color: #ad0000; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #ad0000; } /* Float */
code span.fu { color: #4758ab; } /* Function */
code span.im { } /* Import */
code span.in { color: #5e5e5e; } /* Information */
code span.kw { color: #00769e; } /* Keyword */
code span.op { color: #5e5e5e; } /* Operator */
code span.ot { color: #00769e; } /* Other */
code span.pp { color: #ad0000; } /* Preprocessor */
code span.sc { color: #5e5e5e; } /* SpecialChar */
code span.ss { color: #20794d; } /* SpecialString */
code span.st { color: #20794d; } /* String */
code span.va { color: #111111; } /* Variable */
code span.vs { color: #20794d; } /* VerbatimString */
code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
</style>

<style>
  div.csl-bib-body { }
  div.csl-entry {
    clear: both;
    }
  .hanging div.csl-entry {
    margin-left:2em;
    text-indent:-2em;
  }
  div.csl-left-margin {
    min-width:2em;
    float:left;
  }
  div.csl-right-inline {
    margin-left:2em;
    padding-left:1em;
  }
  div.csl-indent {
    margin-left: 2em;
  }
</style>

  <!--radix_placeholder_meta_tags-->
  <title>Exploring Time</title>

  <meta property="description" itemprop="description" content="Multiple avenues to time-series analysis"/>


  <!--  https://schema.org/Article -->
  <meta property="article:published" itemprop="datePublished" content="2022-08-10"/>
  <meta property="article:created" itemprop="dateCreated" content="2022-08-10"/>
  <meta name="article:author" content="Michael Clark"/>

  <!--  https://developers.facebook.com/docs/sharing/webmasters#markup -->
  <meta property="og:title" content="Exploring Time"/>
  <meta property="og:type" content="article"/>
  <meta property="og:description" content="Multiple avenues to time-series analysis"/>
  <meta property="og:locale" content="en_US"/>

  <!--  https://dev.twitter.com/cards/types/summary -->
  <meta property="twitter:card" content="summary"/>
  <meta property="twitter:title" content="Exploring Time"/>
  <meta property="twitter:description" content="Multiple avenues to time-series analysis"/>

  <!--/radix_placeholder_meta_tags-->
  
  <meta name="citation_reference" content="citation_title=Forecasting: Principles and practice;citation_publication_date=2021;citation_author=R. J. Hyndman;citation_author=G. Athanasopoulos"/>
  <meta name="citation_reference" content="citation_title=Linear mixed models: A practical guide using statistical software;citation_publication_date=2022;citation_publisher=Crc Press;citation_author=Brady T West;citation_author=Kathleen B Welch;citation_author=Andrzej T Galecki"/>
  <!--radix_placeholder_rmarkdown_metadata-->

  <script type="text/json" id="radix-rmarkdown-metadata">
  {"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["title","description","author","date","preview","output","bibliography","draft","tags","categories"]}},"value":[{"type":"character","attributes":{},"value":["Exploring Time"]},{"type":"character","attributes":{},"value":["Multiple avenues to time-series analysis\n"]},{"type":"list","attributes":{},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["name","url"]}},"value":[{"type":"character","attributes":{},"value":["Michael Clark"]},{"type":"character","attributes":{},"value":["https://m-clark.github.io"]}]}]},{"type":"character","attributes":{},"value":["2022-08-10"]},{"type":"character","attributes":{},"value":["../../img/time-series/dalle_mini_time_series_seasonal_effect.png"]},{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["distill::distill_article"]}},"value":[{"type":"list","attributes":{"names":{"type":"character","attributes":{},"value":["self_contained","toc","css","df_print"]}},"value":[{"type":"logical","attributes":{},"value":[false]},{"type":"logical","attributes":{},"value":[true]},{"type":"character","attributes":{},"value":["../../styles.css"]},{"type":"character","attributes":{},"value":["kable_df"]}]}]},{"type":"character","attributes":{},"value":["../../bibs/ts.bib"]},{"type":"logical","attributes":{},"value":[false]},{"type":"character","attributes":{},"value":["time series","generalized additive models","mixed models","torch","deep learning","RNN","seq2seq","prophet","fable","lightgbm","gradient boosting","pytorch"]},{"type":"character","attributes":{},"value":["mixed models","GAM","boosting","time series","deep learning"]}]}
  </script>
  <!--/radix_placeholder_rmarkdown_metadata-->
  
  <script type="text/json" id="radix-resource-manifest">
  {"type":"character","attributes":{},"value":["time-series-r_files/anchor-4.2.2/anchor.min.js","time-series-r_files/bowser-1.9.3/bowser.min.js","time-series-r_files/distill-2.2.21/template.v2.js","time-series-r_files/figure-html5/arima-1.svg","time-series-r_files/figure-html5/arima-2.svg","time-series-r_files/figure-html5/arima-3.svg","time-series-r_files/figure-html5/arima-explore-1.svg","time-series-r_files/figure-html5/arima-model-xreg-1.svg","time-series-r_files/figure-html5/arima-model-xreg-explore-1.svg","time-series-r_files/figure-html5/armia-vis-1.svg","time-series-r_files/figure-html5/dupe-plot-1.svg","time-series-r_files/figure-html5/fable-model-explore-1.svg","time-series-r_files/figure-html5/gam-vis-1.svg","time-series-r_files/figure-html5/gbm-vis-1.svg","time-series-r_files/figure-html5/gbm-vis-show-1.svg","time-series-r_files/figure-html5/mixed-vis-1.svg","time-series-r_files/figure-html5/prophet-vis-1.svg","time-series-r_files/figure-html5/torch-plot-1.svg","time-series-r_files/figure-html5/torch-plot-window-1.svg","time-series-r_files/figure-html5/vis-all-lines-1.svg","time-series-r_files/figure-html5/vis-red-line-1.svg","time-series-r_files/header-attrs-2.13/header-attrs.js","time-series-r_files/jquery-3.6.0/jquery-3.6.0.js","time-series-r_files/jquery-3.6.0/jquery-3.6.0.min.js","time-series-r_files/jquery-3.6.0/jquery-3.6.0.min.map","time-series-r_files/kePrint-0.0.1/kePrint.js","time-series-r_files/lightable-0.0.1/lightable.css","time-series-r_files/popper-2.6.0/popper.min.js","time-series-r_files/tippy-6.2.7/tippy-bundle.umd.min.js","time-series-r_files/tippy-6.2.7/tippy-light-border.css","time-series-r_files/tippy-6.2.7/tippy.css","time-series-r_files/tippy-6.2.7/tippy.umd.min.js","time-series-r_files/webcomponents-2.0.0/webcomponents.js"]}
  </script>
  <!--radix_placeholder_navigation_in_header-->
  <!--/radix_placeholder_navigation_in_header-->
  <!--radix_placeholder_distill-->

  <style type="text/css">

  body {
    background-color: white;
  }

  .pandoc-table {
    width: 100%;
  }

  .pandoc-table>caption {
    margin-bottom: 10px;
  }

  .pandoc-table th:not([align]) {
    text-align: left;
  }

  .pagedtable-footer {
    font-size: 15px;
  }

  d-byline .byline {
    grid-template-columns: 2fr 2fr;
  }

  d-byline .byline h3 {
    margin-block-start: 1.5em;
  }

  d-byline .byline .authors-affiliations h3 {
    margin-block-start: 0.5em;
  }

  .authors-affiliations .orcid-id {
    width: 16px;
    height:16px;
    margin-left: 4px;
    margin-right: 4px;
    vertical-align: middle;
    padding-bottom: 2px;
  }

  d-title .dt-tags {
    margin-top: 1em;
    grid-column: text;
  }

  .dt-tags .dt-tag {
    text-decoration: none;
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0em 0.4em;
    margin-right: 0.5em;
    margin-bottom: 0.4em;
    font-size: 70%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  d-article table.gt_table td,
  d-article table.gt_table th {
    border-bottom: none;
  }

  .html-widget {
    margin-bottom: 2.0em;
  }

  .l-screen-inset {
    padding-right: 16px;
  }

  .l-screen .caption {
    margin-left: 10px;
  }

  .shaded {
    background: rgb(247, 247, 247);
    padding-top: 20px;
    padding-bottom: 20px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .html-widget {
    margin-bottom: 0;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .shaded .shaded-content {
    background: white;
  }

  .text-output {
    margin-top: 0;
    line-height: 1.5em;
  }

  .hidden {
    display: none !important;
  }

  d-article {
    padding-top: 2.5rem;
    padding-bottom: 30px;
  }

  d-appendix {
    padding-top: 30px;
  }

  d-article>p>img {
    width: 100%;
  }

  d-article h2 {
    margin: 1rem 0 1.5rem 0;
  }

  d-article h3 {
    margin-top: 1.5rem;
  }

  d-article iframe {
    border: 1px solid rgba(0, 0, 0, 0.1);
    margin-bottom: 2.0em;
    width: 100%;
  }

  /* Tweak code blocks */

  d-article div.sourceCode code,
  d-article pre code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: auto;
  }

  d-article div.sourceCode {
    background-color: white;
  }

  d-article div.sourceCode pre {
    padding-left: 10px;
    font-size: 12px;
    border-left: 2px solid rgba(0,0,0,0.1);
  }

  d-article pre {
    font-size: 12px;
    color: black;
    background: none;
    margin-top: 0;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  d-article pre a {
    border-bottom: none;
  }

  d-article pre a:hover {
    border-bottom: none;
    text-decoration: underline;
  }

  d-article details {
    grid-column: text;
    margin-bottom: 0.8em;
  }

  @media(min-width: 768px) {

  d-article pre,
  d-article div.sourceCode,
  d-article div.sourceCode pre {
    overflow: visible !important;
  }

  d-article div.sourceCode pre {
    padding-left: 18px;
    font-size: 14px;
  }

  d-article pre {
    font-size: 14px;
  }

  }

  figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  /* CSS for d-contents */

  .d-contents {
    grid-column: text;
    color: rgba(0,0,0,0.8);
    font-size: 0.9em;
    padding-bottom: 1em;
    margin-bottom: 1em;
    padding-bottom: 0.5em;
    margin-bottom: 1em;
    padding-left: 0.25em;
    justify-self: start;
  }

  @media(min-width: 1000px) {
    .d-contents.d-contents-float {
      height: 0;
      grid-column-start: 1;
      grid-column-end: 4;
      justify-self: center;
      padding-right: 3em;
      padding-left: 2em;
    }
  }

  .d-contents nav h3 {
    font-size: 18px;
    margin-top: 0;
    margin-bottom: 1em;
  }

  .d-contents li {
    list-style-type: none
  }

  .d-contents nav > ul {
    padding-left: 0;
  }

  .d-contents ul {
    padding-left: 1em
  }

  .d-contents nav ul li {
    margin-top: 0.6em;
    margin-bottom: 0.2em;
  }

  .d-contents nav a {
    font-size: 13px;
    border-bottom: none;
    text-decoration: none
    color: rgba(0, 0, 0, 0.8);
  }

  .d-contents nav a:hover {
    text-decoration: underline solid rgba(0, 0, 0, 0.6)
  }

  .d-contents nav > ul > li > a {
    font-weight: 600;
  }

  .d-contents nav > ul > li > ul {
    font-weight: inherit;
  }

  .d-contents nav > ul > li > ul > li {
    margin-top: 0.2em;
  }


  .d-contents nav ul {
    margin-top: 0;
    margin-bottom: 0.25em;
  }

  .d-article-with-toc h2:nth-child(2) {
    margin-top: 0;
  }


  /* Figure */

  .figure {
    position: relative;
    margin-bottom: 2.5em;
    margin-top: 1.5em;
  }

  .figure .caption {
    color: rgba(0, 0, 0, 0.6);
    font-size: 12px;
    line-height: 1.5em;
  }

  .figure img.external {
    background: white;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 1px 8px rgba(0, 0, 0, 0.1);
    padding: 18px;
    box-sizing: border-box;
  }

  .figure .caption a {
    color: rgba(0, 0, 0, 0.6);
  }

  .figure .caption b,
  .figure .caption strong, {
    font-weight: 600;
    color: rgba(0, 0, 0, 1.0);
  }

  /* Citations */

  d-article .citation {
    color: inherit;
    cursor: inherit;
  }

  div.hanging-indent{
    margin-left: 1em; text-indent: -1em;
  }

  /* Citation hover box */

  .tippy-box[data-theme~=light-border] {
    background-color: rgba(250, 250, 250, 0.95);
  }

  .tippy-content > p {
    margin-bottom: 0;
    padding: 2px;
  }


  /* Tweak 1000px media break to show more text */

  @media(min-width: 1000px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 80px [middle-start] 50px [text-start kicker-end] 65px 65px 65px 65px 65px 65px 65px 65px [text-end gutter-start] 65px [middle-end] 65px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 16px;
    }

    .grid {
      grid-column-gap: 16px;
    }

    d-article {
      font-size: 1.06rem;
      line-height: 1.7em;
    }
    figure .caption, .figure .caption, figure figcaption {
      font-size: 13px;
    }
  }

  @media(min-width: 1180px) {
    .base-grid,
    distill-header,
    d-title,
    d-abstract,
    d-article,
    d-appendix,
    distill-appendix,
    d-byline,
    d-footnote-list,
    d-citation-list,
    distill-footer {
      grid-template-columns: [screen-start] 1fr [page-start kicker-start] 60px [middle-start] 60px [text-start kicker-end] 60px 60px 60px 60px 60px 60px 60px 60px [text-end gutter-start] 60px [middle-end] 60px [page-end gutter-end] 1fr [screen-end];
      grid-column-gap: 32px;
    }

    .grid {
      grid-column-gap: 32px;
    }
  }


  /* Get the citation styles for the appendix (not auto-injected on render since
     we do our own rendering of the citation appendix) */

  d-appendix .citation-appendix,
  .d-appendix .citation-appendix {
    font-size: 11px;
    line-height: 15px;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    padding-left: 18px;
    border: 1px solid rgba(0,0,0,0.1);
    background: rgba(0, 0, 0, 0.02);
    padding: 10px 18px;
    border-radius: 3px;
    color: rgba(150, 150, 150, 1);
    overflow: hidden;
    margin-top: -12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* Include appendix styles here so they can be overridden */

  d-appendix {
    contain: layout style;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-top: 60px;
    margin-bottom: 0;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0,0,0,0.5);
    padding-top: 60px;
    padding-bottom: 48px;
  }

  d-appendix h3 {
    grid-column: page-start / text-start;
    font-size: 15px;
    font-weight: 500;
    margin-top: 1em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.65);
  }

  d-appendix h3 + * {
    margin-top: 1em;
  }

  d-appendix ol {
    padding: 0 0 0 15px;
  }

  @media (min-width: 768px) {
    d-appendix ol {
      padding: 0 0 0 30px;
      margin-left: -30px;
    }
  }

  d-appendix li {
    margin-bottom: 1em;
  }

  d-appendix a {
    color: rgba(0, 0, 0, 0.6);
  }

  d-appendix > * {
    grid-column: text;
  }

  d-appendix > d-footnote-list,
  d-appendix > d-citation-list,
  d-appendix > distill-appendix {
    grid-column: screen;
  }

  /* Include footnote styles here so they can be overridden */

  d-footnote-list {
    contain: layout style;
  }

  d-footnote-list > * {
    grid-column: text;
  }

  d-footnote-list a.footnote-backlink {
    color: rgba(0,0,0,0.3);
    padding-left: 0.5em;
  }



  /* Anchor.js */

  .anchorjs-link {
    /*transition: all .25s linear; */
    text-decoration: none;
    border-bottom: none;
  }
  *:hover > .anchorjs-link {
    margin-left: -1.125em !important;
    text-decoration: none;
    border-bottom: none;
  }

  /* Social footer */

  .social_footer {
    margin-top: 30px;
    margin-bottom: 0;
    color: rgba(0,0,0,0.67);
  }

  .disqus-comments {
    margin-right: 30px;
  }

  .disqus-comment-count {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
    cursor: pointer;
  }

  #disqus_thread {
    margin-top: 30px;
  }

  .article-sharing a {
    border-bottom: none;
    margin-right: 8px;
  }

  .article-sharing a:hover {
    border-bottom: none;
  }

  .sidebar-section.subscribe {
    font-size: 12px;
    line-height: 1.6em;
  }

  .subscribe p {
    margin-bottom: 0.5em;
  }


  .article-footer .subscribe {
    font-size: 15px;
    margin-top: 45px;
  }


  .sidebar-section.custom {
    font-size: 12px;
    line-height: 1.6em;
  }

  .custom p {
    margin-bottom: 0.5em;
  }

  /* Styles for listing layout (hide title) */
  .layout-listing d-title, .layout-listing .d-title {
    display: none;
  }

  /* Styles for posts lists (not auto-injected) */


  .posts-with-sidebar {
    padding-left: 45px;
    padding-right: 45px;
  }

  .posts-list .description h2,
  .posts-list .description p {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
  }

  .posts-list .description h2 {
    font-weight: 700;
    border-bottom: none;
    padding-bottom: 0;
  }

  .posts-list h2.post-tag {
    border-bottom: 1px solid rgba(0, 0, 0, 0.2);
    padding-bottom: 12px;
  }
  .posts-list {
    margin-top: 60px;
    margin-bottom: 24px;
  }

  .posts-list .post-preview {
    text-decoration: none;
    overflow: hidden;
    display: block;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    padding: 24px 0;
  }

  .post-preview-last {
    border-bottom: none !important;
  }

  .posts-list .posts-list-caption {
    grid-column: screen;
    font-weight: 400;
  }

  .posts-list .post-preview h2 {
    margin: 0 0 6px 0;
    line-height: 1.2em;
    font-style: normal;
    font-size: 24px;
  }

  .posts-list .post-preview p {
    margin: 0 0 12px 0;
    line-height: 1.4em;
    font-size: 16px;
  }

  .posts-list .post-preview .thumbnail {
    box-sizing: border-box;
    margin-bottom: 24px;
    position: relative;
    max-width: 500px;
  }
  .posts-list .post-preview img {
    width: 100%;
    display: block;
  }

  .posts-list .metadata {
    font-size: 12px;
    line-height: 1.4em;
    margin-bottom: 18px;
  }

  .posts-list .metadata > * {
    display: inline-block;
  }

  .posts-list .metadata .publishedDate {
    margin-right: 2em;
  }

  .posts-list .metadata .dt-authors {
    display: block;
    margin-top: 0.3em;
    margin-right: 2em;
  }

  .posts-list .dt-tags {
    display: block;
    line-height: 1em;
  }

  .posts-list .dt-tags .dt-tag {
    display: inline-block;
    color: rgba(0,0,0,0.6);
    padding: 0.3em 0.4em;
    margin-right: 0.2em;
    margin-bottom: 0.4em;
    font-size: 60%;
    border: 1px solid rgba(0,0,0,0.2);
    border-radius: 3px;
    text-transform: uppercase;
    font-weight: 500;
  }

  .posts-list img {
    opacity: 1;
  }

  .posts-list img[data-src] {
    opacity: 0;
  }

  .posts-more {
    clear: both;
  }


  .posts-sidebar {
    font-size: 16px;
  }

  .posts-sidebar h3 {
    font-size: 16px;
    margin-top: 0;
    margin-bottom: 0.5em;
    font-weight: 400;
    text-transform: uppercase;
  }

  .sidebar-section {
    margin-bottom: 30px;
  }

  .categories ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }

  .categories li {
    color: rgba(0, 0, 0, 0.8);
    margin-bottom: 0;
  }

  .categories li>a {
    border-bottom: none;
  }

  .categories li>a:hover {
    border-bottom: 1px solid rgba(0, 0, 0, 0.4);
  }

  .categories .active {
    font-weight: 600;
  }

  .categories .category-count {
    color: rgba(0, 0, 0, 0.4);
  }


  @media(min-width: 768px) {
    .posts-list .post-preview h2 {
      font-size: 26px;
    }
    .posts-list .post-preview .thumbnail {
      float: right;
      width: 30%;
      margin-bottom: 0;
    }
    .posts-list .post-preview .description {
      float: left;
      width: 45%;
    }
    .posts-list .post-preview .metadata {
      float: left;
      width: 20%;
      margin-top: 8px;
    }
    .posts-list .post-preview p {
      margin: 0 0 12px 0;
      line-height: 1.5em;
      font-size: 16px;
    }
    .posts-with-sidebar .posts-list {
      float: left;
      width: 75%;
    }
    .posts-with-sidebar .posts-sidebar {
      float: right;
      width: 20%;
      margin-top: 60px;
      padding-top: 24px;
      padding-bottom: 24px;
    }
  }


  /* Improve display for browsers without grid (IE/Edge <= 15) */

  .downlevel {
    line-height: 1.6em;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
    margin: 0;
  }

  .downlevel .d-title {
    padding-top: 6rem;
    padding-bottom: 1.5rem;
  }

  .downlevel .d-title h1 {
    font-size: 50px;
    font-weight: 700;
    line-height: 1.1em;
    margin: 0 0 0.5rem;
  }

  .downlevel .d-title p {
    font-weight: 300;
    font-size: 1.2rem;
    line-height: 1.55em;
    margin-top: 0;
  }

  .downlevel .d-byline {
    padding-top: 0.8em;
    padding-bottom: 0.8em;
    font-size: 0.8rem;
    line-height: 1.8em;
  }

  .downlevel .section-separator {
    border: none;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  .downlevel .d-article {
    font-size: 1.06rem;
    line-height: 1.7em;
    padding-top: 1rem;
    padding-bottom: 2rem;
  }


  .downlevel .d-appendix {
    padding-left: 0;
    padding-right: 0;
    max-width: none;
    font-size: 0.8em;
    line-height: 1.7em;
    margin-bottom: 0;
    color: rgba(0,0,0,0.5);
    padding-top: 40px;
    padding-bottom: 48px;
  }

  .downlevel .footnotes ol {
    padding-left: 13px;
  }

  .downlevel .base-grid,
  .downlevel .distill-header,
  .downlevel .d-title,
  .downlevel .d-abstract,
  .downlevel .d-article,
  .downlevel .d-appendix,
  .downlevel .distill-appendix,
  .downlevel .d-byline,
  .downlevel .d-footnote-list,
  .downlevel .d-citation-list,
  .downlevel .distill-footer,
  .downlevel .appendix-bottom,
  .downlevel .posts-container {
    padding-left: 40px;
    padding-right: 40px;
  }

  @media(min-width: 768px) {
    .downlevel .base-grid,
    .downlevel .distill-header,
    .downlevel .d-title,
    .downlevel .d-abstract,
    .downlevel .d-article,
    .downlevel .d-appendix,
    .downlevel .distill-appendix,
    .downlevel .d-byline,
    .downlevel .d-footnote-list,
    .downlevel .d-citation-list,
    .downlevel .distill-footer,
    .downlevel .appendix-bottom,
    .downlevel .posts-container {
    padding-left: 150px;
    padding-right: 150px;
    max-width: 900px;
  }
  }

  .downlevel pre code {
    display: block;
    border-left: 2px solid rgba(0, 0, 0, .1);
    padding: 0 0 0 20px;
    font-size: 14px;
  }

  .downlevel code, .downlevel pre {
    color: black;
    background: none;
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    word-wrap: normal;
    line-height: 1.5;

    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;

    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
  }

  .downlevel .posts-list .post-preview {
    color: inherit;
  }



  </style>

  <script type="application/javascript">

  function is_downlevel_browser() {
    if (bowser.isUnsupportedBrowser({ msie: "12", msedge: "16"},
                                   window.navigator.userAgent)) {
      return true;
    } else {
      return window.load_distill_framework === undefined;
    }
  }

  // show body when load is complete
  function on_load_complete() {

    // add anchors
    if (window.anchors) {
      window.anchors.options.placement = 'left';
      window.anchors.add('d-article > h2, d-article > h3, d-article > h4, d-article > h5');
    }


    // set body to visible
    document.body.style.visibility = 'visible';

    // force redraw for leaflet widgets
    if (window.HTMLWidgets) {
      var maps = window.HTMLWidgets.findAll(".leaflet");
      $.each(maps, function(i, el) {
        var map = this.getMap();
        map.invalidateSize();
        map.eachLayer(function(layer) {
          if (layer instanceof L.TileLayer)
            layer.redraw();
        });
      });
    }

    // trigger 'shown' so htmlwidgets resize
    $('d-article').trigger('shown');
  }

  function init_distill() {

    init_common();

    // create front matter
    var front_matter = $('<d-front-matter></d-front-matter>');
    $('#distill-front-matter').wrap(front_matter);

    // create d-title
    $('.d-title').changeElementType('d-title');

    // create d-byline
    var byline = $('<d-byline></d-byline>');
    $('.d-byline').replaceWith(byline);

    // create d-article
    var article = $('<d-article></d-article>');
    $('.d-article').wrap(article).children().unwrap();

    // move posts container into article
    $('.posts-container').appendTo($('d-article'));

    // create d-appendix
    $('.d-appendix').changeElementType('d-appendix');

    // flag indicating that we have appendix items
    var appendix = $('.appendix-bottom').children('h3').length > 0;

    // replace footnotes with <d-footnote>
    $('.footnote-ref').each(function(i, val) {
      appendix = true;
      var href = $(this).attr('href');
      var id = href.replace('#', '');
      var fn = $('#' + id);
      var fn_p = $('#' + id + '>p');
      fn_p.find('.footnote-back').remove();
      var text = fn_p.html();
      var dtfn = $('<d-footnote></d-footnote>');
      dtfn.html(text);
      $(this).replaceWith(dtfn);
    });
    // remove footnotes
    $('.footnotes').remove();

    // move refs into #references-listing
    $('#references-listing').replaceWith($('#refs'));

    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      var id = $(this).attr('id');
      $('.d-contents a[href="#' + id + '"]').parent().remove();
      appendix = true;
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('d-appendix'));
    });

    // show d-appendix if we have appendix content
    $("d-appendix").css('display', appendix ? 'grid' : 'none');

    // localize layout chunks to just output
    $('.layout-chunk').each(function(i, val) {

      // capture layout
      var layout = $(this).attr('data-layout');

      // apply layout to markdown level block elements
      var elements = $(this).children().not('details, div.sourceCode, pre, script');
      elements.each(function(i, el) {
        var layout_div = $('<div class="' + layout + '"></div>');
        if (layout_div.hasClass('shaded')) {
          var shaded_content = $('<div class="shaded-content"></div>');
          $(this).wrap(shaded_content);
          $(this).parent().wrap(layout_div);
        } else {
          $(this).wrap(layout_div);
        }
      });


      // unwrap the layout-chunk div
      $(this).children().unwrap();
    });

    // remove code block used to force  highlighting css
    $('.distill-force-highlighting-css').parent().remove();

    // remove empty line numbers inserted by pandoc when using a
    // custom syntax highlighting theme
    $('code.sourceCode a:empty').remove();

    // load distill framework
    load_distill_framework();

    // wait for window.distillRunlevel == 4 to do post processing
    function distill_post_process() {

      if (!window.distillRunlevel || window.distillRunlevel < 4)
        return;

      // hide author/affiliations entirely if we have no authors
      var front_matter = JSON.parse($("#distill-front-matter").html());
      var have_authors = front_matter.authors && front_matter.authors.length > 0;
      if (!have_authors)
        $('d-byline').addClass('hidden');

      // article with toc class
      $('.d-contents').parent().addClass('d-article-with-toc');

      // strip links that point to #
      $('.authors-affiliations').find('a[href="#"]').removeAttr('href');

      // add orcid ids
      $('.authors-affiliations').find('.author').each(function(i, el) {
        var orcid_id = front_matter.authors[i].orcidID;
        if (orcid_id) {
          var a = $('<a></a>');
          a.attr('href', 'https://orcid.org/' + orcid_id);
          var img = $('<img></img>');
          img.addClass('orcid-id');
          img.attr('alt', 'ORCID ID');
          img.attr('src','data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDo1N0NEMjA4MDI1MjA2ODExOTk0QzkzNTEzRjZEQTg1NyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozM0NDOEJGNEZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozM0NDOEJGM0ZGNTcxMUUxODdBOEVCODg2RjdCQ0QwOSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOkZDN0YxMTc0MDcyMDY4MTE5NUZFRDc5MUM2MUUwNEREIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjU3Q0QyMDgwMjUyMDY4MTE5OTRDOTM1MTNGNkRBODU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+84NovQAAAR1JREFUeNpiZEADy85ZJgCpeCB2QJM6AMQLo4yOL0AWZETSqACk1gOxAQN+cAGIA4EGPQBxmJA0nwdpjjQ8xqArmczw5tMHXAaALDgP1QMxAGqzAAPxQACqh4ER6uf5MBlkm0X4EGayMfMw/Pr7Bd2gRBZogMFBrv01hisv5jLsv9nLAPIOMnjy8RDDyYctyAbFM2EJbRQw+aAWw/LzVgx7b+cwCHKqMhjJFCBLOzAR6+lXX84xnHjYyqAo5IUizkRCwIENQQckGSDGY4TVgAPEaraQr2a4/24bSuoExcJCfAEJihXkWDj3ZAKy9EJGaEo8T0QSxkjSwORsCAuDQCD+QILmD1A9kECEZgxDaEZhICIzGcIyEyOl2RkgwAAhkmC+eAm0TAAAAABJRU5ErkJggg==');
          a.append(img);
          $(this).append(a);
        }
      });

      // hide elements of author/affiliations grid that have no value
      function hide_byline_column(caption) {
        $('d-byline').find('h3:contains("' + caption + '")').parent().css('visibility', 'hidden');
      }

      // affiliations
      var have_affiliations = false;
      for (var i = 0; i<front_matter.authors.length; ++i) {
        var author = front_matter.authors[i];
        if (author.affiliation !== "&nbsp;") {
          have_affiliations = true;
          break;
        }
      }
      if (!have_affiliations)
        $('d-byline').find('h3:contains("Affiliations")').css('visibility', 'hidden');

      // published date
      if (!front_matter.publishedDate)
        hide_byline_column("Published");

      // document object identifier
      var doi = $('d-byline').find('h3:contains("DOI")');
      var doi_p = doi.next().empty();
      if (!front_matter.doi) {
        // if we have a citation and valid citationText then link to that
        if ($('#citation').length > 0 && front_matter.citationText) {
          doi.html('Citation');
          $('<a href="#citation"></a>')
            .text(front_matter.citationText)
            .appendTo(doi_p);
        } else {
          hide_byline_column("DOI");
        }
      } else {
        $('<a></a>')
           .attr('href', "https://doi.org/" + front_matter.doi)
           .html(front_matter.doi)
           .appendTo(doi_p);
      }

       // change plural form of authors/affiliations
      if (front_matter.authors.length === 1) {
        var grid = $('.authors-affiliations');
        grid.children('h3:contains("Authors")').text('Author');
        grid.children('h3:contains("Affiliations")').text('Affiliation');
      }

      // remove d-appendix and d-footnote-list local styles
      $('d-appendix > style:first-child').remove();
      $('d-footnote-list > style:first-child').remove();

      // move appendix-bottom entries to the bottom
      $('.appendix-bottom').appendTo('d-appendix').children().unwrap();
      $('.appendix-bottom').remove();

      // hoverable references
      $('span.citation[data-cites]').each(function() {
        if ($(this).children()[0].nodeName == "D-FOOTNOTE") {
          var fn = $(this).children()[0]
          $(this).html(fn.shadowRoot.querySelector("sup"))
          $(this).id = fn.id
          fn.remove()
        }
        var refs = $(this).attr('data-cites').split(" ");
        var refHtml = refs.map(function(ref) {
          return "<p>" + $('#ref-' + ref).html() + "</p>";
        }).join("\n");
        window.tippy(this, {
          allowHTML: true,
          content: refHtml,
          maxWidth: 500,
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start'
        });
      });

      // fix footnotes in tables (#411)
      // replacing broken distill.pub feature
      $('table d-footnote').each(function() {
        // we replace internal showAtNode methode which is triggered when hovering a footnote
        this.hoverBox.showAtNode = function(node) {
          // ported from https://github.com/distillpub/template/pull/105/files
          calcOffset = function(elem) {
              let x = elem.offsetLeft;
              let y = elem.offsetTop;
              // Traverse upwards until an `absolute` element is found or `elem`
              // becomes null.
              while (elem = elem.offsetParent && elem.style.position != 'absolute') {
                  x += elem.offsetLeft;
                  y += elem.offsetTop;
              }

              return { left: x, top: y };
          }
          // https://developer.mozilla.org/en-US/docs/Web/API/HTMLElement/offsetTop
          const bbox = node.getBoundingClientRect();
          const offset = calcOffset(node);
          this.show([offset.left + bbox.width, offset.top + bbox.height]);
        }
      })

      // clear polling timer
      clearInterval(tid);

      // show body now that everything is ready
      on_load_complete();
    }

    var tid = setInterval(distill_post_process, 50);
    distill_post_process();

  }

  function init_downlevel() {

    init_common();

     // insert hr after d-title
    $('.d-title').after($('<hr class="section-separator"/>'));

    // check if we have authors
    var front_matter = JSON.parse($("#distill-front-matter").html());
    var have_authors = front_matter.authors && front_matter.authors.length > 0;

    // manage byline/border
    if (!have_authors)
      $('.d-byline').remove();
    $('.d-byline').after($('<hr class="section-separator"/>'));
    $('.d-byline a').remove();

    // remove toc
    $('.d-contents').remove();

    // move appendix elements
    $('h1.appendix, h2.appendix').each(function(i, val) {
      $(this).changeElementType('h3');
    });
    $('h3.appendix').each(function(i, val) {
      $(this).nextUntil($('h1, h2, h3')).addBack().appendTo($('.d-appendix'));
    });


    // inject headers into references and footnotes
    var refs_header = $('<h3></h3>');
    refs_header.text('References');
    $('#refs').prepend(refs_header);

    var footnotes_header = $('<h3></h3');
    footnotes_header.text('Footnotes');
    $('.footnotes').children('hr').first().replaceWith(footnotes_header);

    // move appendix-bottom entries to the bottom
    $('.appendix-bottom').appendTo('.d-appendix').children().unwrap();
    $('.appendix-bottom').remove();

    // remove appendix if it's empty
    if ($('.d-appendix').children().length === 0)
      $('.d-appendix').remove();

    // prepend separator above appendix
    $('.d-appendix').before($('<hr class="section-separator" style="clear: both"/>'));

    // trim code
    $('pre>code').each(function(i, val) {
      $(this).html($.trim($(this).html()));
    });

    // move posts-container right before article
    $('.posts-container').insertBefore($('.d-article'));

    $('body').addClass('downlevel');

    on_load_complete();
  }


  function init_common() {

    // jquery plugin to change element types
    (function($) {
      $.fn.changeElementType = function(newType) {
        var attrs = {};

        $.each(this[0].attributes, function(idx, attr) {
          attrs[attr.nodeName] = attr.nodeValue;
        });

        this.replaceWith(function() {
          return $("<" + newType + "/>", attrs).append($(this).contents());
        });
      };
    })(jQuery);

    // prevent underline for linked images
    $('a > img').parent().css({'border-bottom' : 'none'});

    // mark non-body figures created by knitr chunks as 100% width
    $('.layout-chunk').each(function(i, val) {
      var figures = $(this).find('img, .html-widget');
      // ignore leaflet img layers (#106)
      figures = figures.filter(':not(img[class*="leaflet"])')
      if ($(this).attr('data-layout') !== "l-body") {
        figures.css('width', '100%');
      } else {
        figures.css('max-width', '100%');
        figures.filter("[width]").each(function(i, val) {
          var fig = $(this);
          fig.css('width', fig.attr('width') + 'px');
        });

      }
    });

    // auto-append index.html to post-preview links in file: protocol
    // and in rstudio ide preview
    $('.post-preview').each(function(i, val) {
      if (window.location.protocol === "file:")
        $(this).attr('href', $(this).attr('href') + "index.html");
    });

    // get rid of index.html references in header
    if (window.location.protocol !== "file:") {
      $('.distill-site-header a[href]').each(function(i,val) {
        $(this).attr('href', $(this).attr('href').replace(/^index[.]html/, "./"));
      });
    }

    // add class to pandoc style tables
    $('tr.header').parent('thead').parent('table').addClass('pandoc-table');
    $('.kable-table').children('table').addClass('pandoc-table');

    // add figcaption style to table captions
    $('caption').parent('table').addClass("figcaption");

    // initialize posts list
    if (window.init_posts_list)
      window.init_posts_list();

    // implmement disqus comment link
    $('.disqus-comment-count').click(function() {
      window.headroom_prevent_pin = true;
      $('#disqus_thread').toggleClass('hidden');
      if (!$('#disqus_thread').hasClass('hidden')) {
        var offset = $(this).offset();
        $(window).resize();
        $('html, body').animate({
          scrollTop: offset.top - 35
        });
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    if (is_downlevel_browser())
      init_downlevel();
    else
      window.addEventListener('WebComponentsReady', init_distill);
  });

  </script>

  <!--/radix_placeholder_distill-->
  <script src="time-series-r_files/header-attrs-2.13/header-attrs.js"></script>
  <script src="time-series-r_files/kePrint-0.0.1/kePrint.js"></script>
  <link href="time-series-r_files/lightable-0.0.1/lightable.css" rel="stylesheet" />
  <script src="time-series-r_files/jquery-3.6.0/jquery-3.6.0.min.js"></script>
  <script src="time-series-r_files/popper-2.6.0/popper.min.js"></script>
  <link href="time-series-r_files/tippy-6.2.7/tippy.css" rel="stylesheet" />
  <link href="time-series-r_files/tippy-6.2.7/tippy-light-border.css" rel="stylesheet" />
  <script src="time-series-r_files/tippy-6.2.7/tippy.umd.min.js"></script>
  <script src="time-series-r_files/anchor-4.2.2/anchor.min.js"></script>
  <script src="time-series-r_files/bowser-1.9.3/bowser.min.js"></script>
  <script src="time-series-r_files/webcomponents-2.0.0/webcomponents.js"></script>
  <script src="time-series-r_files/distill-2.2.21/template.v2.js"></script>
  <!--radix_placeholder_site_in_header-->
  <!--/radix_placeholder_site_in_header-->

  <link rel="stylesheet" href="../../styles.css" type="text/css"/>

</head>

<body>

<!--radix_placeholder_front_matter-->

<script id="distill-front-matter" type="text/json">
{"title":"Exploring Time","description":"Multiple avenues to time-series analysis","authors":[{"author":"Michael Clark","authorURL":"https://m-clark.github.io","affiliation":"&nbsp;","affiliationURL":"#","orcidID":""}],"publishedDate":"2022-08-10T00:00:00.000-04:00","citationText":"Clark, 2022"}
</script>

<!--/radix_placeholder_front_matter-->
<!--radix_placeholder_navigation_before_body-->
<!--/radix_placeholder_navigation_before_body-->
<!--radix_placeholder_site_before_body-->
<!--/radix_placeholder_site_before_body-->

<div class="d-title">
<h1>Exploring Time</h1>
<!--radix_placeholder_categories-->
<div class="dt-tags">
<div class="dt-tag">mixed models</div>
<div class="dt-tag">GAM</div>
<div class="dt-tag">boosting</div>
<div class="dt-tag">time series</div>
<div class="dt-tag">deep learning</div>
</div>
<!--/radix_placeholder_categories-->
<p><p>Multiple avenues to time-series analysis</p></p>
</div>

<div class="d-byline">
  Michael Clark <a href="https://m-clark.github.io"
class="uri">https://m-clark.github.io</a> 
  
<br/>2022-08-10
</div>

<div class="d-article">
<div class="d-contents d-contents-float">
<nav class="l-text toc figcaption" id="TOC">
<h3>Contents</h3>
<ul>
<li><a href="#intro" id="toc-intro">Intro</a></li>
<li><a href="#outline" id="toc-outline">Outline</a></li>
<li><a href="#quick-summary" id="toc-quick-summary">Quick
Summary</a></li>
<li><a href="#data-description" id="toc-data-description">Data
Description</a>
<ul>
<li><a href="#import-setup" id="toc-import-setup">Import &amp;
Setup</a></li>
<li><a href="#training-and-validation"
id="toc-training-and-validation">Training and Validation</a></li>
<li><a href="#other" id="toc-other">Other</a></li>
</ul></li>
<li><a href="#classical-time-series"
id="toc-classical-time-series">Classical Time Series</a>
<ul>
<li><a href="#intro-1" id="toc-intro-1">Intro</a></li>
<li><a href="#model" id="toc-model">Model</a></li>
<li><a href="#explore" id="toc-explore">Explore</a></li>
</ul></li>
<li><a href="#mixed-model-with-ar-structure"
id="toc-mixed-model-with-ar-structure">Mixed model with AR Structure</a>
<ul>
<li><a href="#intro-2" id="toc-intro-2">Intro</a></li>
<li><a href="#data-prep" id="toc-data-prep">Data Prep</a></li>
<li><a href="#model-1" id="toc-model-1">Model</a></li>
<li><a href="#explore-1" id="toc-explore-1">Explore</a></li>
</ul></li>
<li><a href="#generalized-additive-models"
id="toc-generalized-additive-models">Generalized Additive Models</a>
<ul>
<li><a href="#intro-3" id="toc-intro-3">Intro</a></li>
<li><a href="#data-prep-1" id="toc-data-prep-1">Data Prep</a></li>
<li><a href="#model-2" id="toc-model-2">Model</a></li>
<li><a href="#explore-2" id="toc-explore-2">Explore</a></li>
</ul></li>
<li><a href="#prophet" id="toc-prophet">Prophet</a>
<ul>
<li><a href="#intro-4" id="toc-intro-4">Intro</a></li>
<li><a href="#data-prep-2" id="toc-data-prep-2">Data Prep</a></li>
<li><a href="#model-3" id="toc-model-3">Model</a></li>
<li><a href="#explore-3" id="toc-explore-3">Explore</a></li>
</ul></li>
<li><a href="#fable" id="toc-fable">Fable</a>
<ul>
<li><a href="#intro-5" id="toc-intro-5">Intro</a></li>
<li><a href="#data-prep-3" id="toc-data-prep-3">Data Prep</a></li>
<li><a href="#model-4" id="toc-model-4">Model</a></li>
<li><a href="#explore-4" id="toc-explore-4">Explore</a></li>
</ul></li>
<li><a href="#gbm" id="toc-gbm">GBM</a>
<ul>
<li><a href="#intro-6" id="toc-intro-6">Intro</a></li>
<li><a href="#data-prep-4" id="toc-data-prep-4">Data Prep</a></li>
<li><a href="#model-5" id="toc-model-5">Model</a></li>
<li><a href="#explore-5" id="toc-explore-5">Explore</a></li>
</ul></li>
<li><a href="#torch" id="toc-torch">Torch</a>
<ul>
<li><a href="#data" id="toc-data">Data</a></li>
<li><a href="#torch-data" id="toc-torch-data">Torch data</a></li>
<li><a href="#model-6" id="toc-model-6">Model</a></li>
<li><a href="#training" id="toc-training">Training</a></li>
<li><a href="#evaluations" id="toc-evaluations">Evaluations</a></li>
</ul></li>
<li><a href="#all" id="toc-all">All</a></li>
<li><a href="#summary" id="toc-summary">Summary</a></li>
</ul>
</nav>
</div>
<h2 id="intro">Intro</h2>
<blockquote>
<p>This post was mostly complete around May 2021, but for various
reasons not actually posted until August of 2022. I haven’t changed much
aside from adding a section on boosting, and have used the results I
conjured up previously (for the most part). However, many package
updates since then may mean that parts of the code may not work as well,
especially for the torch code. I would also recommend modeltime as
starting point for implementing a variety of model approaches for time
series data with R. It was still pretty new when this was first written,
but has many new features and capabilities, and could do some version of
the models shown here.</p>
</blockquote>
<p>It is extremely common to have data that exists over a period of
time. For example, we might have yearly sports statistics, daily
manufacturing records, server logs that might be occurring many times
per second, and similar. There are many approaches we could use to model
the data in these scenarios. When there are few time points and they are
clustered within other units, like repeated observations of exercise
data for many individuals, we often use tools like <a
href="https://m-clark.github.io/mixed-models-with-R/">mixed models</a>
for example, and even with many observations in a series, we can still
use tools like that. But sometimes there may be no natural clustering,
or we might want to use other approaches to handle additional
complexity.</p>
<p>This post is inspired by a co-worker’s efforts in using PyTorch to
analyze Chicago Transit data. <a
href="https://twitter.com/codydirks">Cody Dirks</a> was writing <a
href="https://www.strong.io/blog/forecasting-public-transport-utilization-in-chicago">a
post</a> where he used a <a
href="https://github.com/strongio/torchcast">Python module</a> developed
by our group at <a href="https://strong.io/">Strong Analytics</a> to
analyze the ridership across all the ‘<a
href="https://en.wikipedia.org/wiki/Chicago_%22L%22">L</a>’. This post
can be seen as a demonstration of some simpler models which might also
be viable for a given situation such as this, allowing for quick dives,
or even as ends in themselves.</p>
<h2 id="outline">Outline</h2>
<p>The models we’ll go through are the following:</p>
<ul>
<li>Error models and random effects</li>
<li>GAM</li>
<li>More elaborate time series with seasonal and other effects</li>
<li>Boosting and Deep learning</li>
</ul>
<p>In what follows I will show some more detailed code in the beginning,
but won’t show it later for conciseness, focusing mostly just on the
basic model code. You can always find the code for these posts on my <a
href="https:://github.com/m-clark/m-clark.github.io">GitHub</a>.</p>
<h2 id="quick-summary">Quick Summary</h2>
<ul>
<li><p>Classical econometrics approaches like ARIMA models may take
notable effort to match the flexibility of other approaches one might
take with time series. It’s also difficult to believe a specific lag/ma
number will hold up with any data change.</p></li>
<li><p>GAMs extend mixed models, and should probably be preferred if a
probabilistic approach is desired. Prophet-style approaches would likely
take notable effort and still likely lack performance, without adding
interpretability.</p></li>
<li><p>For black box methods, boosting can do very well without much
feature engineering, but possibly take a bit more for parameter tuning.
Deep learning methods may be your best bet given data size and other
data modeling needs.</p></li>
</ul>
<h2 id="data-description">Data Description</h2>
<p>As noted in <a
href="https://www.strong.io/blog/forecasting-public-transport-utilization-in-chicago">Cody’s
post</a>, over 750,000 people use the Chicago Transit Authority’s ‘L’
system to get around the city. There are 8 interconnected rail lines
named after colors- the Red, Blue, Green, Brown, Pink, Orange, Purple,
and Yellow, 145 entry/exit stations, and over 2,300 combined trips by
its railcars every day<a href="#fn1" class="footnote-ref" id="fnref1"
role="doc-noteref"><sup>1</sup></a>.</p>
<p>The city of Chicago provides ridership data that can be accessed
publicly.</p>
<ul>
<li><a
href="https://data.cityofchicago.org/Transportation/CTA-Ridership-L-Station-Entries-Daily-Totals/5neh-572f">ridership</a></li>
<li><a
href="https://data.cityofchicago.org/Transportation/CTA-System-Information-List-of-L-Stops/8pix-ypme">station
info</a></li>
</ul>
<p>In Cody’s exploration, he added pertinent information regarding
weather, sporting events, and more. You can access the <a
href="https://github.com/m-clark/m-clark.github.io/tree/master/data/time-series/processed_df.csv">processed
data</a>.</p>
<p>For our demonstrations we have daily ridership from 2012-2018, and we
will use a variety of methods to model this. We will use a normalized
ride count (mean of 0, standard deviation of 1) as our target
variable.</p>
<h3 id="import-setup">Import &amp; Setup</h3>
<p>To get things started we’ll use the tidyverse for some additional
data processing, and lubridate for any date processing, for example,
converting to weekdays.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># Data Processing</span>

<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://tidyverse.tidyverse.org'>tidyverse</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://lubridate.tidyverse.org'>lubridate</a></span><span class='op'>)</span>


<span class='co'># Misc</span>

<span class='va'>START_DT</span> <span class='op'>=</span> <span class='st'>'2008-06-01'</span>
<span class='va'>END_DT</span>   <span class='op'>=</span> <span class='st'>'2018-12-31'</span>
<span class='va'>SPLIT_DT</span> <span class='op'>=</span> <span class='st'>'2017-06-01'</span>
</code></pre>
</div>
</div>
<h5 id="main-data">Main data</h5>
<p>I start with data having already been processed, but as mentioned the
source is publicly available. I use <span class="pack"
style="">data.table</span> to read it in more quickly, but it’s default
date class can cause issues with other packages, so I deal with that. I
also extract the year, month, weekday, etc.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>df</span> <span class='op'>=</span> <span class='fu'>data.table</span><span class='fu'>::</span><span class='fu'><a href='https://Rdatatable.gitlab.io/data.table/reference/fread.html'>fread</a></span><span class='op'>(</span><span class='st'>'data/time-series/processed_df.csv'</span><span class='op'>)</span>

<span class='va'>df_start</span> <span class='op'>=</span> <span class='va'>df</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://tibble.tidyverse.org/reference/as_tibble.html'>as_tibble</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>contains</a></span><span class='op'>(</span><span class='st'>'_attributes'</span><span class='op'>)</span>, <span class='op'>-</span><span class='op'>(</span><span class='va'>tsun</span><span class='op'>:</span><span class='va'>wt22</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
    date      <span class='op'>=</span> <span class='fu'><a href='https://lubridate.tidyverse.org/reference/as_date.html'>as_date</a></span><span class='op'>(</span><span class='va'>date</span><span class='op'>)</span>, <span class='co'># remove IDATE class</span>
    rides_log <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/Log.html'>log</a></span><span class='op'>(</span><span class='va'>rides</span><span class='op'>)</span>,
    year      <span class='op'>=</span> <span class='fu'><a href='https://lubridate.tidyverse.org/reference/year.html'>year</a></span><span class='op'>(</span><span class='va'>date</span><span class='op'>)</span>,
    year_fac  <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>year</span><span class='op'>)</span>,
    month     <span class='op'>=</span> <span class='fu'><a href='https://lubridate.tidyverse.org/reference/month.html'>month</a></span><span class='op'>(</span><span class='va'>date</span>, label <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>,
    day       <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='fu'><a href='https://lubridate.tidyverse.org/reference/day.html'>wday</a></span><span class='op'>(</span><span class='va'>date</span>, label <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>, ordered <span class='op'>=</span> <span class='cn'>FALSE</span><span class='op'>)</span>,
    year_day  <span class='op'>=</span> <span class='fu'>lubridate</span><span class='fu'>::</span><span class='fu'><a href='https://lubridate.tidyverse.org/reference/day.html'>yday</a></span><span class='op'>(</span><span class='va'>date</span><span class='op'>)</span>,
    line      <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>line</span><span class='op'>)</span>,
    snow_scaled <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/scale.html'>scale</a></span><span class='op'>(</span><span class='va'>snow</span><span class='op'>)</span><span class='op'>[</span>, <span class='fl'>1</span><span class='op'>]</span>,
    colors <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/character.html'>as.character</a></span><span class='op'>(</span><span class='va'>line</span><span class='op'>)</span>,
    colors <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='va'>colors</span> <span class='op'>==</span> <span class='st'>'purple_express'</span>, <span class='st'>'purple4'</span>, <span class='va'>colors</span><span class='op'>)</span>,
    red_line_modernization <span class='op'>=</span> 
      <span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span>
        <span class='fu'><a href='https://dplyr.tidyverse.org/reference/between.html'>between</a></span><span class='op'>(</span><span class='va'>date</span>, <span class='fu'><a href='https://lubridate.tidyverse.org/reference/as_date.html'>as_date</a></span><span class='op'>(</span><span class='st'>'2013-05-19'</span><span class='op'>)</span>, <span class='fu'><a href='https://lubridate.tidyverse.org/reference/as_date.html'>as_date</a></span><span class='op'>(</span><span class='st'>'2013-10-20'</span><span class='op'>)</span><span class='op'>)</span>, 
        <span class='fl'>1</span>, 
        <span class='fl'>0</span>
      <span class='op'>)</span>
  <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>date</span>, <span class='va'>line</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<h3 id="training-and-validation">Training and Validation</h3>
<p>We split our data into training and validation sets, such that
everything before 2017-06-01 is used for training, while everything
after will be used for testing model performance<a href="#fn2"
class="footnote-ref" id="fnref2"
role="doc-noteref"><sup>2</sup></a>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>df_train</span> <span class='op'>=</span> <span class='va'>df_start</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>date</span> <span class='op'>&lt;</span> <span class='va'>SPLIT_DT</span>, <span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>rides</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>df_validate</span> <span class='op'>=</span> <span class='va'>df_start</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>date</span> <span class='op'>&gt;=</span> <span class='va'>SPLIT_DT</span>, <span class='op'>!</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>rides</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>red_line_train</span> <span class='op'>=</span> <span class='va'>df_train</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>line</span> <span class='op'>==</span> <span class='st'>'red'</span><span class='op'>)</span>

<span class='va'>red_line_validate</span> <span class='op'>=</span> <span class='va'>df_validate</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>line</span> <span class='op'>==</span> <span class='st'>'red'</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<h3 id="other">Other</h3>
<p>Holidays are available via the <span class="pack"
style="">prophet</span> package, which we’ll be demonstrating a model
with later. The data we’re using already has a ‘holiday vs. not’
variable for simplicity, though it comes from a different source. The
<span class="pack" style="">prophet</span> version has both the actual
date and the observed date counted as a holiday, and I prefer to use
both.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>holidays</span> <span class='op'>=</span> <span class='fu'>prophet</span><span class='fu'>::</span><span class='va'><a href='https://rdrr.io/pkg/prophet/man/generated_holidays.html'>generated_holidays</a></span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>country</span> <span class='op'>==</span> <span class='st'>'US'</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>ds <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='fu'><a href='https://lubridate.tidyverse.org/reference/as_date.html'>as_date</a></span><span class='op'>(</span><span class='va'>ds</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='fu'><a href='https://rdrr.io/r/base/droplevels.html'>droplevels</a></span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>We’ll take a quick look at the red line similar to Cody’s post, so we
can feel we have the data processed as we should.</p>
<div class="layout-chunk" data-layout="l-body">
<p><img src="time-series-r_files/figure-html5/dupe-plot-1.svg" width="624" style="display: block; margin: auto;" /></p>
</div>
<p>With the data ready to go, we are ready for modeling, so let’s get
started!</p>
<h2 id="classical-time-series">Classical Time Series</h2>
<h3 id="intro-1">Intro</h3>
<p>Classical times series from an econometrics perspective often
considers a error model that accounts for the correlation a current
observation has with past observations. A traditional example is the
so-called <em>autoregressive</em>, or <em>AR</em>, model, which lets a
current observation be predicted by past observations up to a certain
point. For example, would could start by just using the last observation
to predict the current one. Next we extend this to predict the current
based on the previous two observations, and so on. How many
<em>lags</em> we use is part of the model exploration.</p>
<p><span class="math display">\[y_t = \alpha_1y_{t-1} + \dots
+\alpha_{p}y_{t-p} + \varepsilon_t\]</span></p>
<p>We can extend this to include not just past observations but also
past residuals, called a <em>moving average</em>. So formally, our
<em>ARMA</em> (p, q) model now looks like this for an observation <span
class="math inline">\(y\)</span> at time <span
class="math inline">\(t\)</span>:</p>
<p><span class="math display">\[y_t = \alpha_1y_{t-1} + \dots
+\alpha_{p}y_{t-p} + (\varepsilon_t + \theta_1 \varepsilon_{t-1} +
\cdots +\theta_q \varepsilon_{t-q})\]</span></p>
<p>We can also use <a
href="https://otexts.com/fpp3/stationarity.html">differencing</a>, for
example subtracting the previous time value from the current observation
value for all values, to come to the final <a
href="https://en.wikipedia.org/wiki/Autoregressive_integrated_moving_average"><em>ARIMA</em>
(p, d, q) model</a>. See <span class="citation"
data-cites="Hyndman2021">Hyndman and Athanasopoulos (<a
href="#ref-Hyndman2021" role="doc-biblioref">2021</a>)</span> for more
details.</p>
<h3 id="model">Model</h3>
<p>Even base R comes with basic time series models such as this.
However, as mentioned, we typically don’t know what to set the values of
an ARIMA(p, d, q) to. A quick way to explore this is via the <span
class="pack" style="">forecast</span> package, which will search over
the various hyperparameters and select one based on AIC. Note that <span
class="pack" style="">fable</span>, a package we will be using later,
will also allow such an approach, and if you’d like to go ahead and
start using it I show some commented code below.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>model_arima</span> <span class='op'>=</span> <span class='fu'>forecast</span><span class='fu'>::</span><span class='fu'><a href='https://pkg.robjhyndman.com/forecast/reference/auto.arima.html'>auto.arima</a></span><span class='op'>(</span>
  <span class='va'>red_line_train</span><span class='op'>$</span><span class='va'>rides_scaled</span>
<span class='op'>)</span>

<span class='co'># model_arima = red_line_train %&gt;%</span>
<span class='co'>#   select(date, rides_scaled) %&gt;%</span>
<span class='co'>#   tsibble::as_tsibble() %&gt;%</span>
<span class='co'>#   fabletools::model(fable::ARIMA(</span>
<span class='co'>#     rides_scaled ~ 0 + PDQ(0,0,0),</span>
<span class='co'>#     stepwise = FALSE,</span>
<span class='co'>#     approximation = FALSE</span>
<span class='co'>#   ))</span>
<span class='co'># fabletools::report(model_arima)</span>
</code></pre>
</div>
</div>
<h3 id="explore">Explore</h3>
<p>In this case we have a selected AR of 3 and MA of 4 for the centered
value. But looking at the predictions, we can see this is an almost
useless result for any number of days out, and does little better than
guessing.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>broom</span><span class='fu'>::</span><span class='fu'><a href='https://generics.r-lib.org/reference/tidy.html'>tidy</a></span><span class='op'>(</span><span class='va'>model_arima</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
term
</th>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
std.error
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
ar1
</td>
<td style="text-align:right;">
0.238
</td>
<td style="text-align:right;">
0.048
</td>
</tr>
<tr>
<td style="text-align:left;">
ar2
</td>
<td style="text-align:right;">
-0.285
</td>
<td style="text-align:right;">
0.035
</td>
</tr>
<tr>
<td style="text-align:left;">
ar3
</td>
<td style="text-align:right;">
0.354
</td>
<td style="text-align:right;">
0.043
</td>
</tr>
<tr>
<td style="text-align:left;">
ma1
</td>
<td style="text-align:right;">
-0.725
</td>
<td style="text-align:right;">
0.046
</td>
</tr>
<tr>
<td style="text-align:left;">
ma2
</td>
<td style="text-align:right;">
-0.189
</td>
<td style="text-align:right;">
0.046
</td>
</tr>
<tr>
<td style="text-align:left;">
ma3
</td>
<td style="text-align:right;">
-0.575
</td>
<td style="text-align:right;">
0.029
</td>
</tr>
<tr>
<td style="text-align:left;">
ma4
</td>
<td style="text-align:right;">
0.552
</td>
<td style="text-align:right;">
0.025
</td>
</tr>
</tbody>
</table>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># plot(acf(residuals(model_arima))) # weekly autocorrelation still exists</span>

<span class='va'>red_line_validate</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/slice.html'>slice</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>30</span><span class='op'>)</span>  <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>pred <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>model_arima</span>, n.ahead <span class='op'>=</span> <span class='fl'>30</span><span class='op'>)</span><span class='op'>$</span><span class='va'>pred</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='co'># mutate(pred = forecast(model_arima, h = 30)$.mean) %&gt;%</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>date</span>, <span class='va'>rides_scaled</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_path.html'>geom_line</a></span><span class='op'>(</span>alpha <span class='op'>=</span> <span class='fl'>.25</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_path.html'>geom_line</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred</span><span class='op'>)</span>, alpha <span class='op'>=</span> <span class='fl'>.25</span>, color <span class='op'>=</span> <span class='st'>'darkred'</span><span class='op'>)</span>
</code></pre>
</div>
<p><img src="time-series-r_files/figure-html5/arima-explore-1.svg" width="624" style="display: block; margin: auto;" /></p>
</div>
<p>We’ll use <span class="pack" style="">yardstick</span> to help us
evaluate performance for this and subsequent models. In this case
however, the visualization told us enough- a basic ARIMA isn’t going cut
it.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/tidymodels/yardstick'>yardstick</a></span><span class='op'>)</span>

<span class='co'># this function will be used for all subsequent models!</span>
<span class='va'>metric_score</span> <span class='op'>=</span> <span class='fu'><a href='https://yardstick.tidymodels.org/reference/metric_set.html'>metric_set</a></span><span class='op'>(</span><span class='va'>rmse</span>, <span class='va'>mae</span>, <span class='va'>rsq</span><span class='op'>)</span> 

<span class='co'># validation</span>
<span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span>
  pred <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>model_arima</span>, newdata <span class='op'>=</span> <span class='va'>red_line_validate</span>, n.ahead <span class='op'>=</span> <span class='fl'>30</span><span class='op'>)</span><span class='op'>$</span><span class='va'>pred</span>,
  observed <span class='op'>=</span> <span class='va'>red_line_validate</span><span class='op'>$</span><span class='va'>rides_scaled</span><span class='op'>[</span><span class='fl'>1</span><span class='op'>:</span><span class='fl'>30</span><span class='op'>]</span>
<span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='fu'>metric_score</span><span class='op'>(</span>truth <span class='op'>=</span> <span class='va'>observed</span>, estimate <span class='op'>=</span> <span class='va'>pred</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
.metric
</th>
<th style="text-align:left;">
.estimator
</th>
<th style="text-align:right;">
.estimate
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
rmse
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
0.632
</td>
</tr>
<tr>
<td style="text-align:left;">
mae
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
0.572
</td>
</tr>
<tr>
<td style="text-align:left;">
rsq
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
0.132
</td>
</tr>
</tbody>
</table>
</div>
<p>One nice thing about the <span class="pack" style="">forecast</span>
package is that it can include additional features via the
<code>xreg</code> argument, which is exactly what we need- additional
information. Now our model looks something like this, where <span
class="math inline">\(X\)</span> is our model matrix of features and
<span class="math inline">\(\beta\)</span> their corresponding
regression weights.</p>
<p><span class="math display">\[y_t = X_t\beta + \alpha_1y_{t-1} + \dots
+\alpha_{p}y_{t-p} + (\varepsilon_t + \theta_1 \varepsilon_{t-1} +
\cdots +\theta_q \varepsilon_{t-q})\]</span></p>
<p>Adding these is not exactly straightforward, since it requires a
matrix rather than a data frame, but this is not too big a deal once you
are used to creating model matrices.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>mm</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/model.matrix.html'>model.matrix</a></span><span class='op'>(</span>
  <span class='op'>~</span> <span class='va'>.</span> <span class='op'>-</span> <span class='fl'>1</span>, 
  data <span class='op'>=</span> <span class='va'>red_line_train</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
    <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>is_weekend</span><span class='op'>:</span><span class='va'>is_sox_game</span>, <span class='va'>tmax_scaled</span>, <span class='va'>prcp_scaled</span>, <span class='va'>red_line_modernization</span><span class='op'>)</span>
<span class='op'>)</span>

<span class='va'>model_arima_xreg</span> <span class='op'>=</span> <span class='fu'>forecast</span><span class='fu'>::</span><span class='fu'><a href='https://pkg.robjhyndman.com/forecast/reference/auto.arima.html'>auto.arima</a></span><span class='op'>(</span>
  <span class='va'>red_line_train</span><span class='op'>$</span><span class='va'>rides_scaled</span>,
  max.p <span class='op'>=</span> <span class='fl'>10</span>,
  max.q <span class='op'>=</span> <span class='fl'>10</span>,
  xreg  <span class='op'>=</span> <span class='va'>mm</span>
<span class='op'>)</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
term
</th>
<th style="text-align:right;">
estimate
</th>
<th style="text-align:right;">
std.error
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
ar1
</td>
<td style="text-align:right;">
-0.444
</td>
<td style="text-align:right;">
0.018
</td>
</tr>
<tr>
<td style="text-align:left;">
ar2
</td>
<td style="text-align:right;">
-0.430
</td>
<td style="text-align:right;">
0.018
</td>
</tr>
<tr>
<td style="text-align:left;">
ar3
</td>
<td style="text-align:right;">
-0.370
</td>
<td style="text-align:right;">
0.019
</td>
</tr>
<tr>
<td style="text-align:left;">
ar4
</td>
<td style="text-align:right;">
-0.325
</td>
<td style="text-align:right;">
0.019
</td>
</tr>
<tr>
<td style="text-align:left;">
ar5
</td>
<td style="text-align:right;">
-0.312
</td>
<td style="text-align:right;">
0.019
</td>
</tr>
<tr>
<td style="text-align:left;">
ar6
</td>
<td style="text-align:right;">
-0.356
</td>
<td style="text-align:right;">
0.019
</td>
</tr>
<tr>
<td style="text-align:left;">
ar7
</td>
<td style="text-align:right;">
0.307
</td>
<td style="text-align:right;">
0.018
</td>
</tr>
<tr>
<td style="text-align:left;">
ar8
</td>
<td style="text-align:right;">
-0.051
</td>
<td style="text-align:right;">
0.017
</td>
</tr>
<tr>
<td style="text-align:left;">
is_weekend
</td>
<td style="text-align:right;">
-1.154
</td>
<td style="text-align:right;">
0.023
</td>
</tr>
<tr>
<td style="text-align:left;">
is_holiday
</td>
<td style="text-align:right;">
-1.045
</td>
<td style="text-align:right;">
0.021
</td>
</tr>
<tr>
<td style="text-align:left;">
is_cubs_game
</td>
<td style="text-align:right;">
0.208
</td>
<td style="text-align:right;">
0.015
</td>
</tr>
<tr>
<td style="text-align:left;">
is_sox_game
</td>
<td style="text-align:right;">
0.072
</td>
<td style="text-align:right;">
0.015
</td>
</tr>
<tr>
<td style="text-align:left;">
tmax_scaled
</td>
<td style="text-align:right;">
0.085
</td>
<td style="text-align:right;">
0.011
</td>
</tr>
<tr>
<td style="text-align:left;">
prcp_scaled
</td>
<td style="text-align:right;">
-0.031
</td>
<td style="text-align:right;">
0.004
</td>
</tr>
<tr>
<td style="text-align:left;">
red_line_modernization
</td>
<td style="text-align:right;">
-0.550
</td>
<td style="text-align:right;">
0.131
</td>
</tr>
</tbody>
</table>
</div>
<p>This is looking much better! We can also see how notably different
the ARMA structure is relative to the previous model. We also see that
adding weekend and holiday effects result in a huge drop in ridership as
expected, while baseball games and good weather will lead to an
increase.</p>
<p>In the following code, we create a model matrix similar to the
training data that we can feed into the <span class="func"
style="">predict</span> function. The forecast package also offers a
<span class="func" style="">glance</span> method if desired.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>nd</span> <span class='op'>=</span> <span class='va'>red_line_validate</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>is_weekend</span><span class='op'>:</span><span class='va'>is_sox_game</span>, <span class='va'>tmax_scaled</span>, <span class='va'>prcp_scaled</span>, <span class='va'>red_line_modernization</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://rdrr.io/r/stats/model.matrix.html'>model.matrix</a></span><span class='op'>(</span> <span class='op'>~</span> <span class='va'>.</span> <span class='op'>-</span> <span class='fl'>1</span>, data <span class='op'>=</span> <span class='va'>.</span><span class='op'>)</span>

<span class='va'>preds</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>model_arima_xreg</span>, newxreg <span class='op'>=</span> <span class='va'>nd</span>, n.ahead <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>red_line_validate</span><span class='op'>)</span><span class='op'>)</span><span class='op'>$</span><span class='va'>pred</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>p_arima_red</span> <span class='op'>=</span> <span class='va'>red_line_validate</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>pred <span class='op'>=</span> <span class='va'>preds</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>date</span>, <span class='va'>rides_scaled</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_path.html'>geom_line</a></span><span class='op'>(</span>alpha <span class='op'>=</span> <span class='fl'>.25</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_path.html'>geom_line</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred</span><span class='op'>)</span>, alpha <span class='op'>=</span> <span class='fl'>.25</span>, color <span class='op'>=</span> <span class='st'>'red'</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='st'>''</span>, y <span class='op'>=</span> <span class='st'>'Rides (scaled)'</span>, subtitle <span class='op'>=</span> <span class='st'>'ARIMA'</span><span class='op'>)</span>

<span class='va'>p_arima_red</span>
</code></pre>
</div>
<p><img src="time-series-r_files/figure-html5/armia-vis-1.svg" width="624" style="display: block; margin: auto;" /></p>
</div>
<p>And here we can see performance is notably improved (restrict to
first 30 obs for a direct comparison to the previous.</p>
<div class="layout-chunk" data-layout="l-body">
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
.metric
</th>
<th style="text-align:left;">
.estimator
</th>
<th style="text-align:right;">
.estimate
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
rmse
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
0.371
</td>
</tr>
<tr>
<td style="text-align:left;">
mae
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
0.282
</td>
</tr>
<tr>
<td style="text-align:left;">
rsq
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
0.747
</td>
</tr>
</tbody>
</table>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<h2 id="mixed-model-with-ar-structure">Mixed model with AR
Structure</h2>
<h3 id="intro-2">Intro</h3>
<p>More generally, we can think of that original AR error as a random
effect, such that after the linear predictor is constructed, we add a
random effect based on the correlation structure desired, in this case,
autoregressive. In the mixed model setting, it is actually quite common
to use an AR residual structure within a cluster or group, and here we
can do so as well, as the data is naturally grouped by line.</p>
<p>To make this a bit more clear, we can state the AR effect more
formally as follows for a single line at time <span
class="math inline">\(t\)</span>:</p>
<p><span class="math display">\[z_t  \sim N(0, \Sigma_{ar})\]</span>
<span class="math display">\[\Sigma_{ar} = cov(z(s), z(t)) =
\sigma^2\exp(-\theta|t-s|)\]</span></p>
<p>Where t,s are different time points, e.g. within a line.</p>
<p>If we were to simulate it for 4 time points, with autocovariance
value of .5, we could do so as follows<a href="#fn3"
class="footnote-ref" id="fnref3"
role="doc-noteref"><sup>3</sup></a>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>n_clusters</span>   <span class='op'>=</span> <span class='fl'>1</span>
<span class='va'>n_timepoints</span> <span class='op'>=</span> <span class='fl'>4</span>
<span class='va'>mu</span>  <span class='op'>=</span> <span class='fl'>0</span>
<span class='va'>var</span> <span class='op'>=</span> <span class='fl'>1</span>  <span class='co'># not actually used if the value is 1</span>
<span class='va'>S</span> <span class='op'>=</span> <span class='fl'>.5</span><span class='op'>^</span><span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>as.matrix</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/stats/dist.html'>dist</a></span><span class='op'>(</span><span class='fl'>1</span><span class='op'>:</span><span class='va'>n_timepoints</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>S</span>
</code></pre>
</div>
<pre><code>      1    2    3     4
1 1.000 0.50 0.25 0.125
2 0.500 1.00 0.50 0.250
3 0.250 0.50 1.00 0.500
4 0.125 0.25 0.50 1.000</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>z</span> <span class='op'>=</span> <span class='fu'>MASS</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/MASS/man/mvrnorm.html'>mvrnorm</a></span><span class='op'>(</span>mu <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='va'>mu</span>, <span class='va'>n_timepoints</span><span class='op'>)</span>, Sigma <span class='op'>=</span> <span class='va'>S</span><span class='op'>)</span>

<span class='va'>z</span>
</code></pre>
</div>
<pre><code>         1          2          3          4 
-1.0185671 -0.6169717 -0.7159917 -0.7421824 </code></pre>
</div>
<p>And here is our typical model with a single random effect, e.g. for
line:</p>
<p><span class="math display">\[ y_{tl} \sim X\beta + z^{line}_{l} +
e_{tl}\]</span> <span class="math display">\[\textrm{z}_{l} \sim N(0,
\sigma_l^2)\]</span> <span class="math display">\[\epsilon \sim N(0,
\sigma_e^2)\]</span></p>
<p>The X may be at either line or observation level, and potentially the
<span class="math inline">\(\beta\)</span> could vary by line.</p>
<p>Putting it all together, we’re just adding the AR random effect to
the standard mixed model for a single line.</p>
<p><span class="math display">\[ y_{tl} \sim X\beta + z^{ar}_t
+z^{line}_{l} + e_{tl}\]</span></p>
<h3 id="data-prep">Data Prep</h3>
<p>So let’s try this! First some minor data prep to add holidays.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>df_train_mixed</span> <span class='op'>=</span> <span class='va'>df_train</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>date <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='va'>date</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span><span class='va'>holidays</span>, by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'date'</span> <span class='op'>=</span> <span class='st'>'ds'</span>, <span class='st'>'year'</span> <span class='op'>=</span> <span class='st'>'year'</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>holiday <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>holiday</span><span class='op'>)</span>, <span class='st'>'0'</span>, <span class='fu'><a href='https://rdrr.io/r/base/character.html'>as.character</a></span><span class='op'>(</span><span class='va'>holiday</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>df_validate_mixed</span> <span class='op'>=</span> <span class='va'>df_validate</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>date <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='va'>date</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate-joins.html'>left_join</a></span><span class='op'>(</span><span class='va'>holidays</span>, by <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'date'</span> <span class='op'>=</span> <span class='st'>'ds'</span>, <span class='st'>'year'</span> <span class='op'>=</span> <span class='st'>'year'</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>holiday <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/ifelse.html'>ifelse</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/NA.html'>is.na</a></span><span class='op'>(</span><span class='va'>holiday</span><span class='op'>)</span>, <span class='st'>'0'</span>, <span class='fu'><a href='https://rdrr.io/r/base/character.html'>as.character</a></span><span class='op'>(</span><span class='va'>holiday</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<h3 id="model-1">Model</h3>
<p>For the model, we can now easily think of it as we do other standard
modeling scenarios. Along with standard features, we’ll add random
effects for line, day, day x line interaction, etc. Finally we also add
an AR random effect. For each line, we have an autoregressive structure
for days, such that days right next to each other are correlated, and
this correlation tapers off as days are further apart. This is not our
only option, but seems straightforward to me.</p>
<p>Depending on what you include in the model, you may have convergence
issues, so feel free to reduce the complexity if needed. For example,
most of the day effect is captured by weekend vs. not, and a by line
year trend wasn’t really necessary. In addition, the way the AR random
effect variance is estimated as noted above, this essentially captures
the line intercept variance.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>model_mixed</span> <span class='op'>=</span> 
  <span class='va'>rides_scaled</span> <span class='op'>~</span> 
  <span class='va'>is_weekend</span> <span class='op'>+</span>
  <span class='va'>is_cubs_game</span> <span class='op'>+</span>
  <span class='va'>is_sox_game</span> <span class='op'>+</span>
  <span class='va'>tmax_scaled</span> <span class='op'>+</span> 
  <span class='va'>prcp_scaled</span> <span class='op'>+</span> 
  <span class='va'>snow_scaled</span> <span class='op'>+</span>
  <span class='co'># year_day +</span>
  <span class='fu'>ar1</span><span class='op'>(</span><span class='fl'>0</span> <span class='op'>+</span> <span class='va'>day</span><span class='op'>|</span><span class='va'>line</span><span class='op'>)</span> <span class='op'>+</span>     <span class='co'># the 0 + is a nuance of tmb's approach</span>
  <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>holiday</span><span class='op'>)</span> <span class='op'>+</span>           <span class='co'># as RE with all holidays instead of just holiday vs. not</span>
  <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>year</span><span class='op'>)</span> <span class='op'>+</span>     
  <span class='op'>(</span><span class='fl'>1</span> <span class='op'>|</span> <span class='va'>red_line_modernization</span><span class='op'>:</span><span class='va'>line</span><span class='op'>)</span> <span class='op'>+</span>  <span class='co'># the project shifted ridership from red to other lines</span>
  <span class='co'># (1|day) #+ </span>
  <span class='co'># (1|line) +</span>
  <span class='op'>(</span><span class='fl'>1</span><span class='op'>|</span><span class='va'>day</span><span class='op'>:</span><span class='va'>line</span><span class='op'>)</span> <span class='co'>#+</span>
  <span class='co'># (1 + year_day|line)</span>

<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/glmmTMB/glmmTMB'>glmmTMB</a></span><span class='op'>)</span>

<span class='va'>fit_mixed</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/glmmTMB/man/glmmTMB.html'>glmmTMB</a></span><span class='op'>(</span><span class='va'>model_mixed</span>, data <span class='op'>=</span> <span class='va'>df_train_mixed</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<h3 id="explore-1">Explore</h3>
<p>The mixed model approach is nice because it is highly interpretable.
We get both standard regression coefficients, and variance components to
help us understand how the rest of the variance breaks down. For
example, I would interpret the following that that line and weekend are
the biggest contributors to the variability seen, and that we have high
autocorrelation, as expected.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://m-clark.github.io/mixedup'>mixedup</a></span><span class='op'>)</span>

<span class='fu'><a href='https://m-clark.github.io/mixedup/reference/summarize_model.html'>summarise_model</a></span><span class='op'>(</span><span class='va'>fit_mixed</span>, digits <span class='op'>=</span> <span class='fl'>4</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>
Variance Components:</code></pre>
<pre><code>                       Group Variance     SD SD_2.5 SD_97.5 Var_prop
                        line   0.4758 0.6898 0.4696  1.0132   0.1370
                     holiday   0.0734 0.2709 0.1868  0.3928   0.0211
                        year   0.0039 0.0624 0.0393  0.0991   0.0011
 red_line_modernization:line   0.0379 0.1947 0.1226  0.3091   0.0109
                    day:line   0.0000 0.0001 0.0000     Inf   0.0000
                    Residual   0.0278 0.1668     NA      NA   0.0080</code></pre>
<pre><code>
Fixed Effects:</code></pre>
<pre><code>         Term   Value     SE        Z P_value Lower_2.5 Upper_97.5
    Intercept -0.2710 0.2343  -1.1567  0.2474   -0.7301     0.1882
   is_weekend -0.5184 0.0581  -8.9218  0.0000   -0.6323    -0.4045
 is_cubs_game  0.0088 0.0029   3.0009  0.0027    0.0030     0.0145
  is_sox_game -0.0170 0.0029  -5.8336  0.0000   -0.0227    -0.0113
  tmax_scaled  0.0467 0.0014  34.3268  0.0000    0.0441     0.0494
  prcp_scaled -0.0115 0.0010 -11.3201  0.0000   -0.0135    -0.0095
  snow_scaled -0.0039 0.0010  -3.9389  0.0001   -0.0058    -0.0020</code></pre>
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://m-clark.github.io/mixedup/reference/extract_cor_structure.html'>extract_cor_structure</a></span><span class='op'>(</span><span class='va'>fit_mixed</span>, which_cor <span class='op'>=</span> <span class='st'>'ar1'</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code># A tibble: 1 × 2
  parameter  line
  &lt;chr&gt;     &lt;dbl&gt;
1 ar1       0.944</code></pre>
</div>
<p>We can visually inspect how well it matches the data. In the
following the colored lines are the predictions, while the observed is
gray. It looks like performance tapers for more recent time periods, and
holiday effects are not as prevalent for some lines (e.g. yellow). The
latter could be helped by adding a <code>holiday:line</code> random
effect.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>p_mixed</span> <span class='op'>=</span> <span class='va'>df_validate_mixed</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://rdrr.io/r/base/droplevels.html'>droplevels</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>pred <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>fit_mixed</span>, newdata <span class='op'>=</span> <span class='va'>.</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>date <span class='op'>=</span> <span class='fu'><a href='https://lubridate.tidyverse.org/reference/as_date.html'>as_date</a></span><span class='op'>(</span><span class='va'>date</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span><span class='va'>date</span>, <span class='va'>rides_scaled</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_path.html'>geom_line</a></span><span class='op'>(</span>alpha <span class='op'>=</span> <span class='fl'>.1</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_path.html'>geom_line</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>y <span class='op'>=</span> <span class='va'>pred</span>, color <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/AsIs.html'>I</a></span><span class='op'>(</span><span class='va'>colors</span><span class='op'>)</span><span class='op'>)</span>, alpha <span class='op'>=</span> <span class='fl'>.25</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/facet_grid.html'>facet_grid</a></span><span class='op'>(</span>rows <span class='op'>=</span> <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/vars.html'>vars</a></span><span class='op'>(</span><span class='va'>line</span><span class='op'>)</span>, scales <span class='op'>=</span> <span class='st'>'free_y'</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/labs.html'>labs</a></span><span class='op'>(</span>x <span class='op'>=</span> <span class='st'>''</span>, y <span class='op'>=</span> <span class='st'>'Rides (scaled)'</span>, subtitle <span class='op'>=</span> <span class='st'>'Mixed'</span><span class='op'>)</span>

<span class='va'>p_mixed</span>
</code></pre>
</div>
<p><img src="time-series-r_files/figure-html5/mixed-vis-1.svg" width="624" style="display: block; margin: auto;" /></p>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<p>As before we can measure performance via yardstick. This model does
appears to do very well.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># validation</span>
<span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span>
  pred <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>fit_mixed</span>, newdata <span class='op'>=</span> <span class='va'>df_validate_mixed</span>, allow.new.levels <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>,
  observed <span class='op'>=</span> <span class='va'>df_validate_mixed</span><span class='op'>$</span><span class='va'>rides_scaled</span>
<span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='fu'>metric_score</span><span class='op'>(</span>truth <span class='op'>=</span> <span class='va'>observed</span>, estimate <span class='op'>=</span> <span class='va'>pred</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
.metric
</th>
<th style="text-align:left;">
.estimator
</th>
<th style="text-align:right;">
.estimate
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
rmse
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
0.189
</td>
</tr>
<tr>
<td style="text-align:left;">
mae
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
0.110
</td>
</tr>
<tr>
<td style="text-align:left;">
rsq
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
0.965
</td>
</tr>
</tbody>
</table>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<p>For more on autocorrelation structure in the mixed model setting, <a
href="https://m-clark.github.io/mixed-models-with-R/extensions.html#autocorrelation">see
my mixed model document here</a><a href="#fn4" class="footnote-ref"
id="fnref4" role="doc-noteref"><sup>4</sup></a>.</p>
<h2 id="generalized-additive-models">Generalized Additive Models</h2>
<h3 id="intro-3">Intro</h3>
<p>We can generalize mixed models even further to incorporate nonlinear
components, which may include cyclic or other effects. Such models are
typically referred to as <a
href="https://m-clark.github.io/generalized-additive-models/">generalized
additive models</a> (GAMs). AR processes themselves can be seen as a
special case of <a href="http://www.gaussianprocess.org/">gaussian
processes</a>, which can potentially be approximated via GAMs. As GAMs
can accommodate spatial, temporal, nonlinear, and other effects, they
are sometimes more generally referred to as <em>structured additive
regression models</em>, or STARs.</p>
<h3 id="data-prep-1">Data Prep</h3>
<p>The data prep for the GAM is the same as with the mixed model, so
we’ll just use that data.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>df_train_gam</span> <span class='op'>=</span> <span class='va'>df_train_mixed</span>

<span class='va'>df_validate_gam</span> <span class='op'>=</span> <span class='va'>df_validate_mixed</span>
</code></pre>
</div>
</div>
<h3 id="model-2">Model</h3>
<p>With data in place we are ready to conduct the model. We have
numerous options for how we’d like to take this. However, as an example,
I tried various smooths, but didn’t really see much difference, which is
actually a good thing. For any further improvements we’d likely have to
tweak the core model itself. I also use <span class="func"
style="">bam</span> for a quicker result, but this isn’t really
necessary, as it didn’t even take a minute to run with standard gam. As
with the mixed model, we will use holiday as a random effect, but we add
the holiday by line interaction since we saw that need. In addition, our
year-day by line interaction should help some with the tailing off of
more recent predictions.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'>mgcv</span><span class='op'>)</span>

<span class='co'># for year, use year (numeric) or use year_fac, but for latter, it will not be</span>
<span class='co'># able to predict any year not in the training data unless you use</span>
<span class='co'># drop.unused.levels.</span>
<span class='va'>model_gam</span> <span class='op'>=</span> 
  <span class='va'>rides_scaled</span> <span class='op'>~</span> 
  <span class='va'>is_weekend</span> <span class='op'>+</span>
  <span class='va'>is_cubs_game</span> <span class='op'>+</span>
  <span class='va'>is_sox_game</span> <span class='op'>+</span>
  <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>tmax_scaled</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>prcp_scaled</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>snow_scaled</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>red_line_modernization</span>, <span class='va'>line</span>, bs <span class='op'>=</span> <span class='st'>'re'</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>holiday</span>,  bs <span class='op'>=</span> <span class='st'>'re'</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>holiday</span>, <span class='va'>line</span>,  bs <span class='op'>=</span> <span class='st'>'re'</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>year_fac</span>, bs <span class='op'>=</span> <span class='st'>'re'</span><span class='op'>)</span> <span class='op'>+</span>      
  <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>day</span>,  bs <span class='op'>=</span> <span class='st'>'re'</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>line</span>, bs <span class='op'>=</span> <span class='st'>'re'</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>line</span>, <span class='va'>day</span>, bs <span class='op'>=</span> <span class='st'>'re'</span><span class='op'>)</span> <span class='op'>+</span> 
  <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/s.html'>s</a></span><span class='op'>(</span><span class='va'>year_day</span>, by <span class='op'>=</span> <span class='va'>line</span>, bs <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='st'>'ds'</span>, <span class='st'>'fs'</span><span class='op'>)</span><span class='op'>)</span>


<span class='co'># will take a while!</span>
<span class='co'># fit_gam = gam(</span>
<span class='co'>#   model_gam, </span>
<span class='co'>#   data     = df_train_gam,</span>
<span class='co'>#   drop.unused.levels = FALSE, </span>
<span class='co'>#   method   = "REML"</span>
<span class='co'># )</span>

<span class='co'># fast even without parallel</span>
<span class='va'>fit_gam</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/mgcv/man/bam.html'>bam</a></span><span class='op'>(</span>
  <span class='va'>model_gam</span>, 
  data     <span class='op'>=</span> <span class='va'>df_train_gam</span>,
  drop.unused.levels <span class='op'>=</span> <span class='cn'>FALSE</span>, 
  method   <span class='op'>=</span> <span class='st'>"fREML"</span>,
  discrete <span class='op'>=</span> <span class='cn'>TRUE</span>     <span class='co'># will fit the model in a second rather than a couple seconds</span>
  <span class='co'># nthreads = 8,     # this option assumes a cluster is available. not necessary for this.</span>
<span class='op'>)</span>
</code></pre>
</div>
</div>
<h3 id="explore-2">Explore</h3>
<p>As with <span class="pack" style="">glmmTMB</span>, I use a custom
function to summarize the model, or extract different components from
it. From the initial glance we can see things that we expect (e.g. line
and weekend effects are large).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'>mixedup</span><span class='fu'>::</span><span class='fu'><a href='https://m-clark.github.io/mixedup/reference/summarize_model.html'>summarise_model</a></span><span class='op'>(</span><span class='va'>fit_gam</span><span class='op'>)</span>
</code></pre>
</div>
<pre><code>
Variance Components:</code></pre>
<pre><code>                       Group                 Effect Variance   SD SD_2.5      SD_97.5 Var_prop
                 tmax_scaled              Intercept     0.06 0.25   0.15 4.200000e-01     0.08
                 prcp_scaled              Intercept     0.00 0.01   0.00 2.000000e-02     0.00
                 snow_scaled              Intercept     0.01 0.07   0.04 1.300000e-01     0.01
                        line red_line_modernization     0.09 0.31   0.19 4.900000e-01     0.12
                     holiday              Intercept     0.05 0.22   0.14 3.300000e-01     0.06
                     holiday                   line     0.04 0.21   0.18 2.400000e-01     0.05
                    year_fac              Intercept     0.00 0.06   0.04 1.000000e-01     0.01
                         day              Intercept     0.00 0.00   0.00 1.325836e+58     0.00
                        line              Intercept     0.49 0.70   0.42 1.150000e+00     0.61
                        line                    day     0.05 0.22   0.18 2.700000e-01     0.06
           year_day:lineblue              Intercept     0.00 0.00   0.00 0.000000e+00     0.00
          year_day:linebrown              Intercept     0.00 0.00   0.00 0.000000e+00     0.00
          year_day:linegreen              Intercept     0.00 0.00   0.00 0.000000e+00     0.00
         year_day:lineorange              Intercept     0.00 0.00   0.00 0.000000e+00     0.00
           year_day:linepink              Intercept     0.00 0.00   0.00 0.000000e+00     0.00
         year_day:linepurple              Intercept     0.00 0.00   0.00 0.000000e+00     0.00
 year_day:linepurple_express              Intercept     0.00 0.00   0.00 0.000000e+00     0.00
            year_day:linered              Intercept     0.00 0.00   0.00 0.000000e+00     0.00
         year_day:lineyellow              Intercept     0.00 0.00   0.00 0.000000e+00     0.00
                    Residual                            0.02 0.13   0.13 1.300000e-01     0.02</code></pre>
<pre><code>
Fixed Effects:</code></pre>
<pre><code>         Term Value   SE     t P_value Lower_2.5 Upper_97.5
    Intercept -0.29 0.24 -1.18    0.24     -0.77       0.19
   is_weekend -0.54 0.06 -8.27    0.00     -0.66      -0.41
 is_cubs_game  0.04 0.00 13.83    0.00      0.03       0.04
  is_sox_game  0.01 0.00  4.06    0.00      0.01       0.02</code></pre>
</div>
<p>Now we can visualize test predictions broken about by line. The
greater flexibility of the GAM for fixed and other effects allows it to
follow the trends more easily than the standard linear mixed model
approach.</p>
<div class="layout-chunk" data-layout="l-body">
<p><img src="time-series-r_files/figure-html5/gam-vis-1.svg" width="624" style="display: block; margin: auto;" /></p>
</div>
<p>We can also see improvement over our standard mixed model approach,
and our best performance yet.</p>
<div class="layout-chunk" data-layout="l-body">
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
.metric
</th>
<th style="text-align:left;">
.estimator
</th>
<th style="text-align:right;">
.estimate
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
rmse
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
0.140
</td>
</tr>
<tr>
<td style="text-align:left;">
mae
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
0.087
</td>
</tr>
<tr>
<td style="text-align:left;">
rsq
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
0.981
</td>
</tr>
</tbody>
</table>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<h2 id="prophet">Prophet</h2>
<h3 id="intro-4">Intro</h3>
<p><em>Prophet</em> is an approach from Facebook that uses Stan to
estimate a time series model taking various trends, seasonality, and
other factors under consideration. By default, it only uses Stan for
optimization (e.g. via ‘BFGS’), but you can switch to fully Bayesian if
desired, and take advantage of all that the Bayesian approach has to
offer.</p>
<h3 id="data-prep-2">Data Prep</h3>
<p>The <span class="pack" style="">prophet</span> package in R takes
some getting used to. We have to have specific names for our variables,
and unfortunately have to do extra work to incorporate categorical
features. We can use <span class="pack" style="">recipes</span> (like
<span class="pack" style="">yardstick</span>, part of the <span
class="pack" style="">tidymodels</span> ’verse) to set up the data
(e.g. one-hot encoding).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/facebook/prophet'>prophet</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/tidymodels/recipes'>recipes</a></span><span class='op'>)</span>

<span class='va'>df_train_prophet</span> <span class='op'>=</span> <span class='va'>df_train</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>date</span>, <span class='va'>line</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename</a></span><span class='op'>(</span>y  <span class='op'>=</span> <span class='va'>rides_scaled</span>,
         ds <span class='op'>=</span> <span class='va'>date</span><span class='op'>)</span>

<span class='va'>rec</span> <span class='op'>=</span> <span class='fu'>recipes</span><span class='fu'>::</span><span class='fu'><a href='https://recipes.tidymodels.org/reference/recipe.html'>recipe</a></span><span class='op'>(</span><span class='op'>~</span><span class='va'>.</span>, <span class='va'>df_train_prophet</span><span class='op'>)</span>

<span class='va'>df_train_prophet</span> <span class='op'>=</span> <span class='va'>rec</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://recipes.tidymodels.org/reference/step_dummy.html'>step_dummy</a></span><span class='op'>(</span><span class='va'>line</span>, one_hot <span class='op'>=</span> <span class='cn'>TRUE</span>, keep_original_cols <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://recipes.tidymodels.org/reference/prep.html'>prep</a></span><span class='op'>(</span>training <span class='op'>=</span> <span class='va'>df_train_prophet</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://recipes.tidymodels.org/reference/bake.html'>bake</a></span><span class='op'>(</span>new_data <span class='op'>=</span> <span class='va'>df_train_prophet</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename_with</a></span><span class='op'>(</span>.cols <span class='op'>=</span> <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>'line_'</span><span class='op'>)</span>, <span class='va'>str_remove</span>, <span class='st'>'line_'</span><span class='op'>)</span>

<span class='va'>df_validate_prophet</span> <span class='op'>=</span> <span class='va'>df_validate</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/arrange.html'>arrange</a></span><span class='op'>(</span><span class='va'>date</span>, <span class='va'>line</span><span class='op'>)</span><span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename</a></span><span class='op'>(</span>ds <span class='op'>=</span> <span class='va'>date</span>, y <span class='op'>=</span> <span class='va'>rides_scaled</span><span class='op'>)</span>

<span class='va'>rec</span> <span class='op'>=</span> <span class='fu'><a href='https://recipes.tidymodels.org/reference/recipe.html'>recipe</a></span><span class='op'>(</span><span class='op'>~</span><span class='va'>.</span>, <span class='va'>df_validate_prophet</span><span class='op'>)</span>

<span class='va'>df_validate_prophet</span> <span class='op'>=</span> <span class='va'>rec</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://recipes.tidymodels.org/reference/step_dummy.html'>step_dummy</a></span><span class='op'>(</span><span class='va'>line</span>, one_hot <span class='op'>=</span> <span class='cn'>TRUE</span>, keep_original_cols <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://recipes.tidymodels.org/reference/prep.html'>prep</a></span><span class='op'>(</span>training <span class='op'>=</span> <span class='va'>df_train_prophet</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://recipes.tidymodels.org/reference/bake.html'>bake</a></span><span class='op'>(</span>new_data <span class='op'>=</span> <span class='va'>df_validate_prophet</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/rename.html'>rename_with</a></span><span class='op'>(</span>.cols <span class='op'>=</span> <span class='fu'><a href='https://tidyselect.r-lib.org/reference/starts_with.html'>starts_with</a></span><span class='op'>(</span><span class='st'>'line_'</span><span class='op'>)</span>, <span class='va'>str_remove</span>, <span class='st'>'line_'</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<h3 id="model-3">Model</h3>
<p>With data in place, we are ready to build the model. Note that later
we will compare results to <span class="pack"
style="">fable.prophet</span>, which will mask some of the functions
here, or vice versa depending on which you load first. I would suggest
only doing the prophet model, or only doing the fable model, rather than
trying to do both at the same time, to avoid any mix-up.</p>
<p>After setting up the model, you have to add additional features in
separate steps. Prophet has a nice way to incorporate holidays though.
When you run this model, you may have to wait for a minute or so.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># use prophet::prophet in case you have fable.prophet loaded also</span>
<span class='va'>model_prophet</span> <span class='op'>=</span> <span class='fu'>prophet</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/prophet/man/prophet.html'>prophet</a></span><span class='op'>(</span>
  holidays <span class='op'>=</span> <span class='va'>generated_holidays</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>country</span> <span class='op'>==</span> <span class='st'>'US'</span><span class='op'>)</span>,
  yearly.seasonality <span class='op'>=</span> <span class='cn'>FALSE</span>,
  seasonality.mode <span class='op'>=</span> <span class='st'>"multiplicative"</span>,
  changepoint.prior.scale <span class='op'>=</span> <span class='fl'>.5</span>
<span class='op'>)</span>

<span class='va'>line_names</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span>
  <span class='st'>'blue'</span>,
  <span class='st'>'brown'</span>,
  <span class='st'>'green'</span>,
  <span class='st'>'orange'</span>,
  <span class='st'>'pink'</span>,
  <span class='st'>'purple'</span>,
  <span class='st'>'purple_express'</span>,
  <span class='st'>'red'</span>,
  <span class='st'>'yellow'</span>
<span class='op'>)</span>

<span class='va'>predictors</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span>
  <span class='st'>'is_weekend'</span>,
  <span class='st'>'is_cubs_game'</span>,
  <span class='st'>'is_sox_game'</span>,
  <span class='co'># 'is_holiday',</span>
  <span class='st'>'tmax_scaled'</span>,
  <span class='st'>'prcp_scaled'</span>,
  <span class='st'>'snow_scaled'</span>,
  <span class='va'>line_names</span>
<span class='op'>)</span>

<span class='kw'>for</span> <span class='op'>(</span><span class='va'>i</span> <span class='kw'>in</span> <span class='va'>predictors</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>model_prophet</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/prophet/man/add_regressor.html'>add_regressor</a></span><span class='op'>(</span><span class='va'>model_prophet</span>, <span class='va'>i</span>, standardize <span class='op'>=</span> <span class='cn'>FALSE</span>, mode <span class='op'>=</span> <span class='st'>'additive'</span><span class='op'>)</span>
<span class='op'>}</span>

<span class='va'>model_prophet</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/prophet/man/add_country_holidays.html'>add_country_holidays</a></span><span class='op'>(</span><span class='va'>model_prophet</span>, country_name <span class='op'>=</span> <span class='st'>'US'</span><span class='op'>)</span>

<span class='va'>fit_prophet</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/prophet/man/fit.prophet.html'>fit.prophet</a></span><span class='op'>(</span><span class='va'>model_prophet</span>, df <span class='op'>=</span> <span class='va'>df_train_prophet</span><span class='op'>)</span>

<span class='va'>forecast</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>fit_prophet</span>, <span class='va'>df_validate_prophet</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<h3 id="explore-3">Explore</h3>
<p>We now visualize predictions as we did with the <a
href="#generalized-additive-models">GAM</a>. But one of the nice things
with <span class="pack" style="">prophet</span> is that you can plot the
various parts of the model results via the <span class="func"
style="">plot </span> method or <span class="func"
style="">prophet_plot_components</span> (not shown). Unfortunately, our
baseline effort seems to undersmooth our more popular lines (blue, red),
and overreacts to some of the others (purple, yellow). This is because
it’s not really changing the predictions according to line.</p>
<div class="layout-chunk" data-layout="l-body">
<p><img src="time-series-r_files/figure-html5/prophet-vis-1.svg" width="624" style="display: block; margin: auto;" /></p>
</div>
<p>We can also assess performance as before, but note that <span
class="pack" style="">prophet</span> has it’s own cross-validation
capabilities which would be better to utilize if this was your primary
tool. Between the previous visualization and these metrics, our first
stab doesn’t appear to do as well as the GAM, so you might like to go
back and tweak things.</p>
<div class="layout-chunk" data-layout="l-body">
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
.metric
</th>
<th style="text-align:left;">
.estimator
</th>
<th style="text-align:right;">
.estimate
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
rmse
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
0.280
</td>
</tr>
<tr>
<td style="text-align:left;">
mae
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
0.198
</td>
</tr>
<tr>
<td style="text-align:left;">
rsq
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
0.925
</td>
</tr>
</tbody>
</table>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<h2 id="fable">Fable</h2>
<h3 id="intro-5">Intro</h3>
<p>I came across <span class="pack" style="">fable.prophet</span> as a
possibly easier way to engage prophet. It is an extension of <span
class="pack" style="">fable</span> and related packages, which are very
useful for time series processing and analysis. Note that it is 0.1.0
version development, and hasn’t had much done with it in the past year,
so your mileage may vary with regard to utility by the time you read
this<a href="#fn5" class="footnote-ref" id="fnref5"
role="doc-noteref"><sup>5</sup></a>. But with it we can specify the
model in more of an R fashion, and we now don’t have as much data
pre-processing.</p>
<h3 id="data-prep-3">Data Prep</h3>
<p>One key difference using <span class="pack"
style="">fable.prophet</span> is that it works with <code>tsibble</code>
objects, and thus must have unique date observations. We can do this by
setting <code>line</code> as the key<a href="#fn6" class="footnote-ref"
id="fnref6" role="doc-noteref"><sup>6</sup></a>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://pkg.mitchelloharawild.com/fable.prophet/'>fable.prophet</a></span><span class='op'>)</span>

<span class='va'>df_train_fable</span> <span class='op'>=</span> <span class='va'>df_train_prophet</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://tsibble.tidyverts.org/reference/as-tsibble.html'>as_tsibble</a></span><span class='op'>(</span>index <span class='op'>=</span> <span class='va'>ds</span>, key <span class='op'>=</span> <span class='va'>line</span><span class='op'>)</span>

<span class='va'>df_validate_fable</span> <span class='op'>=</span> <span class='va'>df_validate_prophet</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://tsibble.tidyverts.org/reference/as-tsibble.html'>as_tsibble</a></span><span class='op'>(</span>index <span class='op'>=</span> <span class='va'>ds</span>, key <span class='op'>=</span> <span class='va'>line</span><span class='op'>)</span>

<span class='va'>holidays_fable</span> <span class='op'>=</span> <span class='va'>holidays</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>country</span> <span class='op'>==</span> <span class='st'>'US'</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>ds <span class='op'>=</span> <span class='fu'><a href='https://lubridate.tidyverse.org/reference/as_date.html'>as_date</a></span><span class='op'>(</span><span class='va'>ds</span><span class='op'>)</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://tsibble.tidyverts.org/reference/as-tsibble.html'>as_tsibble</a></span><span class='op'>(</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<h3 id="model-4">Model</h3>
<p>Beyond this we use functions within our formula to set the various
components. With line as the key, <span class="pack"
style="">fable</span> is actually running separate prophet models for
each line, and we can do so in parallel if desired.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>model_prophet</span> <span class='op'>=</span> <span class='fu'>fable.prophet</span><span class='fu'>::</span><span class='fu'><a href='https://pkg.mitchelloharawild.com/fable.prophet/reference/prophet.html'>prophet</a></span><span class='op'>(</span>
  <span class='va'>y</span> <span class='op'>~</span> 
    <span class='fu'>growth</span><span class='op'>(</span><span class='st'>'linear'</span>, changepoint_prior_scale <span class='op'>=</span> <span class='fl'>0.5</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>season</span><span class='op'>(</span><span class='st'>"week"</span>, type <span class='op'>=</span> <span class='st'>"multiplicative"</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>holiday</span><span class='op'>(</span><span class='va'>holidays_fable</span><span class='op'>)</span> <span class='op'>+</span>
    <span class='fu'>xreg</span><span class='op'>(</span>
      <span class='va'>is_weekend</span>,
      <span class='va'>is_cubs_game</span>,
      <span class='va'>is_sox_game</span>,
      <span class='co'># is_holiday,</span>
      <span class='va'>tmax_scaled</span>,
      <span class='va'>prcp_scaled</span>,
      <span class='va'>snow_scaled</span>
    <span class='op'>)</span> 
<span class='op'>)</span>

<span class='co'># library(future)</span>
<span class='co'># plan(multisession)</span>

<span class='co'># furrr is used under the hood, and though it wants a seed, it doesn't</span>
<span class='co'># automatically use one so will give warnings. I don't think it can be passed</span>
<span class='co'># via the model function, so expect to see ignorable warnings (suppressed here).</span>

<span class='va'>fit_fable</span> <span class='op'>=</span> <span class='fu'><a href='https://fabletools.tidyverts.org/reference/model.html'>model</a></span><span class='op'>(</span><span class='va'>df_train_fable</span>, mdl <span class='op'>=</span> <span class='va'>model_prophet</span><span class='op'>)</span>

<span class='va'>forecast_fable</span> <span class='op'>=</span> <span class='va'>fit_fable</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://fabletools.tidyverts.org/reference/forecast.html'>forecast</a></span><span class='op'>(</span><span class='va'>df_validate_fable</span><span class='op'>)</span> 

<span class='co'># plan(sequential)</span>
</code></pre>
</div>
</div>
<h3 id="explore-4">Explore</h3>
<p>With <span class="pack" style="">fable.prophet</span> visualization,
we have the more automatic plots, but again we’ll stick with the basic
validation plot we’ve been doing.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://generics.r-lib.org/reference/components.html'>components</a></span><span class='op'>(</span><span class='va'>fit_fable</span><span class='op'>)</span>
<span class='fu'><a href='https://generics.r-lib.org/reference/components.html'>components</a></span><span class='op'>(</span><span class='va'>fit_fable</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/autoplot.html'>autoplot</a></span><span class='op'>(</span><span class='op'>)</span>
<span class='va'>forecast_fable</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/autoplot.html'>autoplot</a></span><span class='op'>(</span>level <span class='op'>=</span> <span class='fl'>95</span>, color <span class='op'>=</span> <span class='st'>'#ff5500'</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>This model does well, and better than basic <span class="pack"
style="">prophet</span>, but we can see its limitations, for example,
with the yellow line, and more recent ridership in general.</p>
<div class="layout-chunk" data-layout="l-body">
<p><img src="time-series-r_files/figure-html5/fable-model-explore-1.svg" width="624" style="display: block; margin: auto;" /></p>
</div>
<p>And we check performance as before. The <span class="pack"
style="">fable</span> model is doing almost as well as our <a
href="#generalized-additive-models">GAM</a> approach did.</p>
<div class="layout-chunk" data-layout="l-body">
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
.metric
</th>
<th style="text-align:left;">
.estimator
</th>
<th style="text-align:right;">
.estimate
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
rmse
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
0.155
</td>
</tr>
<tr>
<td style="text-align:left;">
mae
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
0.093
</td>
</tr>
<tr>
<td style="text-align:left;">
rsq
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
0.979
</td>
</tr>
</tbody>
</table>
</div>
<p>One nice thing about the <span class="pack" style="">fable</span>
approach is its internal performance metrics, which are easily obtained.
It will give us results for each line<a href="#fn7" class="footnote-ref"
id="fnref7" role="doc-noteref"><sup>7</sup></a>, validation data results
shown. We see that we have more error for the popular lines as before,
but in terms of percentage error, the other lines are showing more
difficulty. You can find out more about the additional metrics available
<a href="https://otexts.com/fpp3/accuracy.html">here</a>.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='fu'><a href='https://fabletools.tidyverts.org/reference/accuracy.html'>accuracy</a></span><span class='op'>(</span><span class='va'>fit_fable</span><span class='op'>)</span>
<span class='fu'><a href='https://fabletools.tidyverts.org/reference/accuracy.html'>accuracy</a></span><span class='op'>(</span><span class='va'>forecast_fable</span>, <span class='va'>df_validate_fable</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
.model
</th>
<th style="text-align:left;">
line
</th>
<th style="text-align:left;">
.type
</th>
<th style="text-align:right;">
ME
</th>
<th style="text-align:right;">
RMSE
</th>
<th style="text-align:right;">
MAE
</th>
<th style="text-align:right;">
MPE
</th>
<th style="text-align:right;">
MAPE
</th>
<th style="text-align:right;">
ACF1
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
mdl
</td>
<td style="text-align:left;">
blue
</td>
<td style="text-align:left;">
Test
</td>
<td style="text-align:right;">
0.086
</td>
<td style="text-align:right;">
0.252
</td>
<td style="text-align:right;">
0.181
</td>
<td style="text-align:right;">
-26.534
</td>
<td style="text-align:right;">
61.789
</td>
<td style="text-align:right;">
0.642
</td>
</tr>
<tr>
<td style="text-align:left;">
mdl
</td>
<td style="text-align:left;">
brown
</td>
<td style="text-align:left;">
Test
</td>
<td style="text-align:right;">
0.002
</td>
<td style="text-align:right;">
0.126
</td>
<td style="text-align:right;">
0.084
</td>
<td style="text-align:right;">
-30.341
</td>
<td style="text-align:right;">
88.109
</td>
<td style="text-align:right;">
0.622
</td>
</tr>
<tr>
<td style="text-align:left;">
mdl
</td>
<td style="text-align:left;">
green
</td>
<td style="text-align:left;">
Test
</td>
<td style="text-align:right;">
0.093
</td>
<td style="text-align:right;">
0.123
</td>
<td style="text-align:right;">
0.104
</td>
<td style="text-align:right;">
-110.198
</td>
<td style="text-align:right;">
116.601
</td>
<td style="text-align:right;">
0.669
</td>
</tr>
<tr>
<td style="text-align:left;">
mdl
</td>
<td style="text-align:left;">
orange
</td>
<td style="text-align:left;">
Test
</td>
<td style="text-align:right;">
0.036
</td>
<td style="text-align:right;">
0.084
</td>
<td style="text-align:right;">
0.064
</td>
<td style="text-align:right;">
-43.625
</td>
<td style="text-align:right;">
60.708
</td>
<td style="text-align:right;">
0.638
</td>
</tr>
<tr>
<td style="text-align:left;">
mdl
</td>
<td style="text-align:left;">
pink
</td>
<td style="text-align:left;">
Test
</td>
<td style="text-align:right;">
0.060
</td>
<td style="text-align:right;">
0.090
</td>
<td style="text-align:right;">
0.073
</td>
<td style="text-align:right;">
-18.824
</td>
<td style="text-align:right;">
20.849
</td>
<td style="text-align:right;">
0.679
</td>
</tr>
<tr>
<td style="text-align:left;">
mdl
</td>
<td style="text-align:left;">
purple
</td>
<td style="text-align:left;">
Test
</td>
<td style="text-align:right;">
0.006
</td>
<td style="text-align:right;">
0.012
</td>
<td style="text-align:right;">
0.009
</td>
<td style="text-align:right;">
-0.726
</td>
<td style="text-align:right;">
1.050
</td>
<td style="text-align:right;">
0.512
</td>
</tr>
<tr>
<td style="text-align:left;">
mdl
</td>
<td style="text-align:left;">
purple_express
</td>
<td style="text-align:left;">
Test
</td>
<td style="text-align:right;">
0.046
</td>
<td style="text-align:right;">
0.106
</td>
<td style="text-align:right;">
0.081
</td>
<td style="text-align:right;">
-39.910
</td>
<td style="text-align:right;">
213.149
</td>
<td style="text-align:right;">
0.750
</td>
</tr>
<tr>
<td style="text-align:left;">
mdl
</td>
<td style="text-align:left;">
red
</td>
<td style="text-align:left;">
Test
</td>
<td style="text-align:right;">
0.055
</td>
<td style="text-align:right;">
0.300
</td>
<td style="text-align:right;">
0.214
</td>
<td style="text-align:right;">
-2.442
</td>
<td style="text-align:right;">
14.890
</td>
<td style="text-align:right;">
0.600
</td>
</tr>
<tr>
<td style="text-align:left;">
mdl
</td>
<td style="text-align:left;">
yellow
</td>
<td style="text-align:left;">
Test
</td>
<td style="text-align:right;">
-0.026
</td>
<td style="text-align:right;">
0.030
</td>
<td style="text-align:right;">
0.027
</td>
<td style="text-align:right;">
2.851
</td>
<td style="text-align:right;">
2.872
</td>
<td style="text-align:right;">
0.720
</td>
</tr>
</tbody>
</table>
</div>
<p>The <span class="pack" style="">fable</span> results suggests what we
already knew from our <a href="#generalized-additive-models">GAM</a> and
<a href="#mixed-model-with-ar-structure">mixed model</a> approach, that
interactions of the series with line are important. We weren’t easily
able to do this with the default <span class="pack"
style="">prophet</span> (it would likely require adding time x line
interaction regresssors), so it’s nice that we have the option here.</p>
<div class="layout-chunk" data-layout="l-body">

</div>
<h2 id="gbm">GBM</h2>
<h3 id="intro-6">Intro</h3>
<p>This part is actually new from when I first wrote up this post over a
year ago. I basically wanted to test if a boosting approach would work
decently out of the box without doing anything special regarding the
structure of the data. I don’t add it to the summary visualizations, but
provide the standard results here.</p>
<h3 id="data-prep-4">Data Prep</h3>
<p>I’ll use <span class="pack" style="">lightgbm</span> which I’ve been
increasingly using of late. It requires a matrix object for input, and
so some additional processing as well.</p>
<div class="layout-chunk" data-layout="l-body">

</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://github.com/Microsoft/LightGBM'>lightgbm</a></span><span class='op'>)</span>

<span class='co'># lightgbm only accepts a matrix input</span>
<span class='va'>df_train_lgb_init</span> <span class='op'>=</span> <span class='va'>df_train</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span>
    <span class='va'>rides_scaled</span>,
    <span class='va'>is_weekday</span>,
    <span class='va'>is_holiday</span>,
    <span class='va'>is_cubs_game</span>,
    <span class='va'>is_sox_game</span>,
    <span class='va'>tmax_scaled</span>,
    <span class='va'>prcp_scaled</span>,
    <span class='va'>line</span>, 
    <span class='va'>red_line_modernization</span>,
    <span class='va'>year</span>,
    <span class='va'>month</span>,
    <span class='va'>year_day</span>
  <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
    line <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='va'>line</span><span class='op'>)</span>,
    month <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='va'>month</span><span class='op'>)</span>
  <span class='op'>)</span>

<span class='va'>X_train</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>as.matrix</a></span><span class='op'>(</span><span class='va'>df_train_lgb_init</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='op'>-</span><span class='va'>rides_scaled</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>X_test</span>  <span class='op'>=</span> <span class='va'>df_validate</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span>
    <span class='va'>is_weekday</span>,
    <span class='va'>is_holiday</span>,
    <span class='va'>is_cubs_game</span>,
    <span class='va'>is_sox_game</span>,
    <span class='va'>tmax_scaled</span>,
    <span class='va'>prcp_scaled</span>,
    <span class='va'>line</span>, 
    <span class='va'>red_line_modernization</span>,
    <span class='va'>year</span>,
    <span class='va'>month</span>,
    <span class='va'>year_day</span>
  <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
    line <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='va'>line</span><span class='op'>)</span>,
    month <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/integer.html'>as.integer</a></span><span class='op'>(</span><span class='va'>month</span><span class='op'>)</span>
  <span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> 
  <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>as.matrix</a></span><span class='op'>(</span><span class='op'>)</span>


<span class='va'>df_train_lgb</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/lightgbm/man/lgb.Dataset.html'>lgb.Dataset</a></span><span class='op'>(</span>
  <span class='va'>X_train</span>,
  label <span class='op'>=</span> <span class='va'>df_train_lgb_init</span><span class='op'>$</span><span class='va'>rides_scaled</span>,
  categorical_feature <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span>
    <span class='st'>'is_weekday'</span>,
    <span class='st'>'is_holiday'</span>,
    <span class='st'>'is_cubs_game'</span>,
    <span class='st'>'is_sox_game'</span>,
    <span class='st'>'line'</span>,
    <span class='st'>'year'</span>,
    <span class='st'>'month'</span>
  <span class='op'>)</span>
<span class='op'>)</span>

<span class='va'>df_test_lgb</span>  <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/pkg/lightgbm/man/lgb.Dataset.create.valid.html'>lgb.Dataset.create.valid</a></span><span class='op'>(</span>
  <span class='va'>df_train_lgb</span>, 
  <span class='va'>X_test</span>,
  label <span class='op'>=</span> <span class='va'>df_validate</span><span class='op'>$</span><span class='va'>rides_scaled</span>
<span class='op'>)</span>
</code></pre>
</div>
</div>
<h3 id="model-5">Model</h3>
<p>Typically we would perform some sort of search over the (many)
parameters available to tweak with <span class="pack">lightgbm</span>,
like the number of trees, learning rate, regularizer parameters and
more. I ignore that, but I did fiddle with the learning rate and bumped
up the <code>nrounds</code> (trees), but that’s it. We internally
perform cross-validation as well (5-fold).</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>params</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>
  objective       <span class='op'>=</span> <span class='st'>"regression"</span>
  , metric        <span class='op'>=</span> <span class='st'>"l2"</span>
  , min_data      <span class='op'>=</span> <span class='fl'>10L</span>
  , learning_rate <span class='op'>=</span> <span class='fl'>.01</span>
<span class='op'>)</span>

<span class='va'>fit_gbm</span> <span class='op'>&lt;-</span> <span class='fu'>lgb.cv</span><span class='op'>(</span>
  params    <span class='op'>=</span> <span class='va'>params</span>
  , data    <span class='op'>=</span> <span class='va'>df_train_lgb</span>
  , nrounds <span class='op'>=</span> <span class='fl'>2000L</span>
  , nfold   <span class='op'>=</span> <span class='fl'>5L</span>
<span class='op'>)</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<h3 id="explore-5">Explore</h3>
<p>Some may be surprised at how well this does, but regular users of
boosting probably are not. We didn’t have to do much and it’s already
the best performing model.</p>
<div class="layout-chunk" data-layout="l-body">
<p><img src="time-series-r_files/figure-html5/gbm-vis-1.svg" width="624" style="display: block; margin: auto;" /></p>
</div>
<div class="layout-chunk" data-layout="l-body">
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
.metric
</th>
<th style="text-align:left;">
.estimator
</th>
<th style="text-align:right;">
.estimate
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
rmse
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
0.136
</td>
</tr>
<tr>
<td style="text-align:left;">
mae
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
0.078
</td>
</tr>
<tr>
<td style="text-align:left;">
rsq
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
0.982
</td>
</tr>
</tbody>
</table>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<h2 id="torch">Torch</h2>
<p>At this point we have a collection of models that are still
relatively interpretable, and mostly within our standard regression
model framework. It’s good to see them able to perform very well without
too much complexity. However, we still have other methods available that
would be more computationally demanding, are more opaque in operations,
but which would potentially provide the most accurate forecasts. For
this we turn to using PyTorch, which is now available via the <span
class="pack" style="">torch</span> package in R<a href="#fn8"
class="footnote-ref" id="fnref8"
role="doc-noteref"><sup>8</sup></a>.</p>
<p>In using <span class="pack" style="">torch</span>, we’re going to
follow the <a
href="https://blogs.rstudio.com/ai/posts/2021-03-19-forecasting-time-series-with-torch_4/">demo
series at the RStudio AI blog</a> <a href="#fn9" class="footnote-ref"
id="fnref9" role="doc-noteref"><sup>9</sup></a>. It shows in four parts
how to use a <em>recurrent neural network</em>. In their example, they
use a data set for a single series with (summarized) daily values,
similar to our daily counts here. We will use the final model
demonstrated in the series, a soi disant <em>seq2seq</em> model that
includes an <em>attention</em> mechanism. More detail can be found <a
href="https://www.deeplearningbook.org/contents/rnn.html">here</a>. The
conceptual gist of the model can be described as taking a set of time
points to predict another set of future time points, and doing so for
all points in the series.</p>
<p>To be clear, they only use a single series, no other information
(e.g. additional regressors). So we will do the same, coming full circle
to what we started out with, just looking at daily ridership- a single
time series for the red line.</p>
<h3 id="data">Data</h3>
<p>As usual we’ll need some data prep, both for initial training-test
split creation, but also specifically for usage with Torch.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://tsibble.tidyverts.org'>tsibble</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://lubridate.tidyverse.org'>lubridate</a></span><span class='op'>)</span>
<span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://torch.mlverse.org/docs'>torch</a></span><span class='op'>)</span>


<span class='va'>df_train_torch</span> <span class='op'>=</span> <span class='va'>df_train</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>line</span> <span class='op'>==</span> <span class='st'>'red'</span>, <span class='va'>year</span> <span class='op'>&lt;</span> <span class='fl'>2017</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/pull.html'>pull</a></span><span class='op'>(</span><span class='va'>rides_scaled</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>as.matrix</a></span><span class='op'>(</span><span class='op'>)</span>

<span class='va'>df_validate_torch</span> <span class='op'>=</span> <span class='va'>df_validate</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>line</span> <span class='op'>==</span> <span class='st'>'red'</span>, <span class='va'>year</span> <span class='op'>&gt;=</span> <span class='fl'>2017</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/pull.html'>pull</a></span><span class='op'>(</span><span class='va'>rides_scaled</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>as.matrix</a></span><span class='op'>(</span><span class='op'>)</span>

<span class='va'>df_test_torch</span> <span class='op'>=</span> <span class='va'>df_validate</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>line</span> <span class='op'>==</span> <span class='st'>'red'</span>, <span class='va'>date</span> <span class='op'>&gt;</span> <span class='st'>'2017-12-24'</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/pull.html'>pull</a></span><span class='op'>(</span><span class='va'>rides_scaled</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='fu'><a href='https://rdrr.io/r/base/matrix.html'>as.matrix</a></span><span class='op'>(</span><span class='op'>)</span>

<span class='va'>train_mean</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>df_train_torch</span><span class='op'>)</span>
<span class='va'>train_sd</span>   <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/stats/sd.html'>sd</a></span><span class='op'>(</span><span class='va'>df_train_torch</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<h3 id="torch-data">Torch data</h3>
<p>For our data, we will use a week behind lag to predict the following
week. This seems appropriate for this problem, but for any particular
time series problem we’d want to probably think hard about this and/or
test different settings.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>n_timesteps</span> <span class='op'>=</span> <span class='fl'>7</span>    <span class='co'># we use a week instead of 14 days in blog</span>
<span class='va'>n_forecast</span>  <span class='op'>=</span> <span class='fl'>7</span>    <span class='co'># look ahead one week</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>cta_dataset</span> <span class='op'>&lt;-</span> <span class='fu'>dataset</span><span class='op'>(</span>
  name <span class='op'>=</span> <span class='st'>"cta_dataset"</span>,

  initialize <span class='op'>=</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>x</span>, <span class='va'>n_timesteps</span>, <span class='va'>sample_frac</span> <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span> <span class='op'>{</span>

    <span class='va'>self</span><span class='op'>$</span><span class='va'>n_timesteps</span> <span class='op'>&lt;-</span> <span class='va'>n_timesteps</span>
    <span class='va'>self</span><span class='op'>$</span><span class='va'>x</span> <span class='op'>&lt;-</span> <span class='fu'>torch_tensor</span><span class='op'>(</span><span class='op'>(</span><span class='va'>x</span> <span class='op'>-</span> <span class='va'>train_mean</span><span class='op'>)</span> <span class='op'>/</span> <span class='va'>train_sd</span><span class='op'>)</span>

    <span class='va'>n</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>self</span><span class='op'>$</span><span class='va'>x</span><span class='op'>)</span> <span class='op'>-</span> <span class='va'>self</span><span class='op'>$</span><span class='va'>n_timesteps</span> <span class='op'>-</span> <span class='fl'>1</span>

    <span class='va'>self</span><span class='op'>$</span><span class='va'>starts</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/sort.html'>sort</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/sample.html'>sample.int</a></span><span class='op'>(</span>
      n <span class='op'>=</span> <span class='va'>n</span>,
      size <span class='op'>=</span> <span class='va'>n</span> <span class='op'>*</span> <span class='va'>sample_frac</span>
    <span class='op'>)</span><span class='op'>)</span>

  <span class='op'>}</span>,

  .getitem <span class='op'>=</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>i</span><span class='op'>)</span> <span class='op'>{</span>

    <span class='va'>start</span> <span class='op'>&lt;-</span> <span class='va'>self</span><span class='op'>$</span><span class='va'>starts</span><span class='op'>[</span><span class='va'>i</span><span class='op'>]</span>
    <span class='va'>end</span> <span class='op'>&lt;-</span> <span class='va'>start</span> <span class='op'>+</span> <span class='va'>self</span><span class='op'>$</span><span class='va'>n_timesteps</span> <span class='op'>-</span> <span class='fl'>1</span>
    <span class='va'>lag</span> <span class='op'>&lt;-</span> <span class='fl'>1</span>

    <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>
      x <span class='op'>=</span> <span class='va'>self</span><span class='op'>$</span><span class='va'>x</span><span class='op'>[</span><span class='va'>start</span><span class='op'>:</span><span class='va'>end</span><span class='op'>]</span>,
      y <span class='op'>=</span> <span class='va'>self</span><span class='op'>$</span><span class='va'>x</span><span class='op'>[</span><span class='op'>(</span><span class='va'>start</span><span class='op'>+</span><span class='va'>lag</span><span class='op'>)</span><span class='op'>:</span><span class='op'>(</span><span class='va'>end</span><span class='op'>+</span><span class='va'>lag</span><span class='op'>)</span><span class='op'>]</span><span class='op'>$</span><span class='fu'>squeeze</span><span class='op'>(</span><span class='fl'>2</span><span class='op'>)</span>
    <span class='op'>)</span>

  <span class='op'>}</span>,

  .length <span class='op'>=</span> <span class='kw'>function</span><span class='op'>(</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>self</span><span class='op'>$</span><span class='va'>starts</span><span class='op'>)</span>
  <span class='op'>}</span>
<span class='op'>)</span>

<span class='va'>batch_size</span> <span class='op'>=</span> <span class='fl'>32</span>

<span class='va'>train_ds</span> <span class='op'>=</span> <span class='fu'>cta_dataset</span><span class='op'>(</span><span class='va'>df_train_torch</span>, <span class='va'>n_timesteps</span><span class='op'>)</span>
<span class='va'>train_dl</span> <span class='op'>=</span> <span class='fu'>dataloader</span><span class='op'>(</span><span class='va'>train_ds</span>, batch_size <span class='op'>=</span> <span class='va'>batch_size</span>, shuffle <span class='op'>=</span> <span class='cn'>TRUE</span><span class='op'>)</span>

<span class='va'>valid_ds</span> <span class='op'>=</span> <span class='fu'>cta_dataset</span><span class='op'>(</span><span class='va'>df_validate_torch</span>, <span class='va'>n_timesteps</span><span class='op'>)</span>
<span class='va'>valid_dl</span> <span class='op'>=</span> <span class='fu'>dataloader</span><span class='op'>(</span><span class='va'>valid_ds</span>, batch_size <span class='op'>=</span> <span class='va'>batch_size</span><span class='op'>)</span>

<span class='va'>test_ds</span>  <span class='op'>=</span> <span class='fu'>cta_dataset</span><span class='op'>(</span><span class='va'>df_test_torch</span>, <span class='va'>n_timesteps</span><span class='op'>)</span>
<span class='va'>test_dl</span>  <span class='op'>=</span> <span class='fu'>dataloader</span><span class='op'>(</span><span class='va'>test_ds</span>, batch_size <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<h3 id="model-6">Model</h3>
<p>I leave it to the <a
href="https://blogs.rstudio.com/ai/posts/2021-03-19-forecasting-time-series-with-torch_4/#attention-module">blog</a>
for details, but briefly, there are four components to the model:</p>
<ul>
<li><strong>Encoder</strong>: takes input, and produces outputs and
states via RNN</li>
<li><strong>Decoder</strong>: takes the last predicted value as input
and current context to make a new prediction</li>
<li><strong>Seq2Seq</strong>: essentially encodes once, and calls the
decoder in a loop</li>
<li><strong>Attention</strong>: allows output from the encoder at a
specific time point to provide ‘context’ for the decoder</li>
</ul>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>net</span> <span class='op'>=</span>
  <span class='fu'>seq2seq_module</span><span class='op'>(</span>
    <span class='st'>"gru"</span>,
    input_size     <span class='op'>=</span> <span class='fl'>1</span>,
    hidden_size    <span class='op'>=</span> <span class='fl'>32</span>,
    attention_type <span class='op'>=</span> <span class='st'>"multiplicative"</span>,
    attention_size <span class='op'>=</span> <span class='fl'>8</span>,
    n_forecast     <span class='op'>=</span> <span class='va'>n_forecast</span>
  <span class='op'>)</span>

<span class='va'>b</span> <span class='op'>=</span> <span class='fu'>dataloader_make_iter</span><span class='op'>(</span><span class='va'>train_dl</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span> <span class='fu'>dataloader_next</span><span class='op'>(</span><span class='op'>)</span>

<span class='fu'>net</span><span class='op'>(</span><span class='va'>b</span><span class='op'>$</span><span class='va'>x</span>, <span class='va'>b</span><span class='op'>$</span><span class='va'>y</span>, teacher_forcing_ratio <span class='op'>=</span> <span class='fl'>1</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<h3 id="training">Training</h3>
<p>With data in place, we’re ready to train the model. For the most
part, not much is going on here that would be different from other deep
learning situations, e.g. choosing an optimizer, number of epochs, etc.
We’ll use mean squared error as our loss, and I create an object to
store the validation loss over the epochs of training. I played around
with it a bit, and you’re probably not going to see much improvement
after letting it go for 100 epochs.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>optimizer</span> <span class='op'>=</span> <span class='fu'>optim_adam</span><span class='op'>(</span><span class='va'>net</span><span class='op'>$</span><span class='va'>parameters</span>, lr <span class='op'>=</span> <span class='fl'>0.001</span><span class='op'>)</span>

<span class='va'>num_epochs</span> <span class='op'>=</span> <span class='fl'>100</span>

<span class='va'>train_batch</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>b</span>, <span class='va'>teacher_forcing_ratio</span><span class='op'>)</span> <span class='op'>{</span>

  <span class='va'>optimizer</span><span class='op'>$</span><span class='fu'>zero_grad</span><span class='op'>(</span><span class='op'>)</span>
  <span class='va'>output</span> <span class='op'>&lt;-</span> <span class='fu'>net</span><span class='op'>(</span><span class='va'>b</span><span class='op'>$</span><span class='va'>x</span>, <span class='va'>b</span><span class='op'>$</span><span class='va'>y</span>, <span class='va'>teacher_forcing_ratio</span><span class='op'>)</span>
  <span class='va'>target</span> <span class='op'>&lt;-</span> <span class='va'>b</span><span class='op'>$</span><span class='va'>y</span>

  <span class='va'>loss</span> <span class='op'>&lt;-</span> <span class='fu'>nnf_mse_loss</span><span class='op'>(</span><span class='va'>output</span>, <span class='va'>target</span><span class='op'>[</span> , <span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/dim.html'>dim</a></span><span class='op'>(</span><span class='va'>output</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span><span class='op'>]</span><span class='op'>)</span>
  <span class='va'>loss</span><span class='op'>$</span><span class='fu'>backward</span><span class='op'>(</span><span class='op'>)</span>
  <span class='va'>optimizer</span><span class='op'>$</span><span class='fu'>step</span><span class='op'>(</span><span class='op'>)</span>

  <span class='va'>loss</span><span class='op'>$</span><span class='fu'>item</span><span class='op'>(</span><span class='op'>)</span>

<span class='op'>}</span>

<span class='va'>valid_batch</span> <span class='op'>&lt;-</span> <span class='kw'>function</span><span class='op'>(</span><span class='va'>b</span>, <span class='va'>teacher_forcing_ratio</span> <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span> <span class='op'>{</span>

  <span class='va'>output</span> <span class='op'>&lt;-</span> <span class='fu'>net</span><span class='op'>(</span><span class='va'>b</span><span class='op'>$</span><span class='va'>x</span>, <span class='va'>b</span><span class='op'>$</span><span class='va'>y</span>, <span class='va'>teacher_forcing_ratio</span><span class='op'>)</span>
  <span class='va'>target</span> <span class='op'>&lt;-</span> <span class='va'>b</span><span class='op'>$</span><span class='va'>y</span>

  <span class='va'>loss</span> <span class='op'>&lt;-</span> <span class='fu'>nnf_mse_loss</span><span class='op'>(</span><span class='va'>output</span>, <span class='va'>target</span><span class='op'>[</span> , <span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/dim.html'>dim</a></span><span class='op'>(</span><span class='va'>output</span><span class='op'>)</span><span class='op'>[</span><span class='fl'>2</span><span class='op'>]</span><span class='op'>)</span><span class='op'>]</span><span class='op'>)</span>

  <span class='va'>loss</span><span class='op'>$</span><span class='fu'>item</span><span class='op'>(</span><span class='op'>)</span>

<span class='op'>}</span>


<span class='va'>all_valid_loss</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>)</span>

<span class='kw'>for</span> <span class='op'>(</span><span class='va'>epoch</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='va'>num_epochs</span><span class='op'>)</span> <span class='op'>{</span>

  <span class='va'>net</span><span class='op'>$</span><span class='fu'>train</span><span class='op'>(</span><span class='op'>)</span>
  <span class='va'>train_loss</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>)</span>

  <span class='fu'>coro</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/coro/man/collect.html'>loop</a></span><span class='op'>(</span><span class='kw'>for</span> <span class='op'>(</span><span class='va'>b</span> <span class='kw'>in</span> <span class='va'>train_dl</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='va'>loss</span> <span class='op'>&lt;-</span> <span class='fu'>train_batch</span><span class='op'>(</span><span class='va'>b</span>, teacher_forcing_ratio <span class='op'>=</span> <span class='fl'>0.0</span><span class='op'>)</span>
    <span class='va'>train_loss</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>train_loss</span>, <span class='va'>loss</span><span class='op'>)</span>
  <span class='op'>}</span><span class='op'>)</span>

  <span class='fu'><a href='https://rdrr.io/r/base/cat.html'>cat</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/sprintf.html'>sprintf</a></span><span class='op'>(</span><span class='st'>"\nEpoch %d, training: loss: %3.5f \n"</span>, <span class='va'>epoch</span>, <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>train_loss</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>

  <span class='va'>net</span><span class='op'>$</span><span class='fu'>eval</span><span class='op'>(</span><span class='op'>)</span>
  <span class='va'>valid_loss</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='op'>)</span>

  <span class='fu'>coro</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/coro/man/collect.html'>loop</a></span><span class='op'>(</span><span class='kw'>for</span> <span class='op'>(</span><span class='va'>b</span> <span class='kw'>in</span> <span class='va'>valid_dl</span><span class='op'>)</span> <span class='op'>{</span>
    <span class='va'>loss</span> <span class='op'>&lt;-</span> <span class='fu'>valid_batch</span><span class='op'>(</span><span class='va'>b</span><span class='op'>)</span>
    <span class='va'>valid_loss</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>valid_loss</span>, <span class='va'>loss</span><span class='op'>)</span>
  <span class='op'>}</span><span class='op'>)</span>
  
  <span class='va'>all_valid_loss</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='va'>all_valid_loss</span>, <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>valid_loss</span><span class='op'>)</span><span class='op'>)</span>

  <span class='fu'><a href='https://rdrr.io/r/base/cat.html'>cat</a></span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/sprintf.html'>sprintf</a></span><span class='op'>(</span><span class='st'>"\nEpoch %d, validation: loss: %3.5f \n"</span>, <span class='va'>epoch</span>, <span class='fu'><a href='https://rdrr.io/r/base/mean.html'>mean</a></span><span class='op'>(</span><span class='va'>valid_loss</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>
<span class='op'>}</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<h3 id="evaluations">Evaluations</h3>
<div class="layout-chunk" data-layout="l-body">

</div>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='va'>net</span><span class='op'>$</span><span class='fu'>eval</span><span class='op'>(</span><span class='op'>)</span>

<span class='va'>test_preds</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/vector.html'>vector</a></span><span class='op'>(</span>mode <span class='op'>=</span> <span class='st'>"list"</span>, length <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>test_dl</span><span class='op'>)</span><span class='op'>)</span>

<span class='va'>i</span> <span class='op'>=</span> <span class='fl'>1</span>

<span class='fu'>coro</span><span class='fu'>::</span><span class='fu'><a href='https://rdrr.io/pkg/coro/man/collect.html'>loop</a></span><span class='op'>(</span><span class='kw'>for</span> <span class='op'>(</span><span class='va'>b</span> <span class='kw'>in</span> <span class='va'>test_dl</span><span class='op'>)</span> <span class='op'>{</span>

  <span class='kw'>if</span> <span class='op'>(</span><span class='va'>i</span> <span class='op'><a href='https://rdrr.io/r/base/Arithmetic.html'>%%</a></span> <span class='fl'>100</span> <span class='op'>==</span> <span class='fl'>0</span><span class='op'>)</span>
    <span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='va'>i</span><span class='op'>)</span>

  <span class='va'>output</span> <span class='op'>&lt;-</span> <span class='fu'>net</span><span class='op'>(</span><span class='va'>b</span><span class='op'>$</span><span class='va'>x</span>, <span class='va'>b</span><span class='op'>$</span><span class='va'>y</span>, teacher_forcing_ratio <span class='op'>=</span> <span class='fl'>0</span><span class='op'>)</span>
  <span class='va'>preds</span> <span class='op'>&lt;-</span> <span class='fu'><a href='https://rdrr.io/r/base/numeric.html'>as.numeric</a></span><span class='op'>(</span><span class='va'>output</span><span class='op'>)</span>

  <span class='va'>test_preds</span><span class='op'>[[</span><span class='va'>i</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>&lt;-</span> <span class='va'>preds</span>
  <span class='va'>i</span> <span class='op'>&lt;&lt;-</span> <span class='va'>i</span> <span class='op'>+</span> <span class='fl'>1</span>
<span class='op'>}</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<div class="layout-chunk" data-layout="l-body">

</div>
<p>For this visualization, we do things a little different. In our
current setup, we have 7 timesteps predicting 7 day windows. We started
our test set at the beginning of December so that the first prediction
is January first, and then proceeds accordingly.</p>
<div class="layout-chunk" data-layout="l-body">
<div class="sourceCode">
<pre class="sourceCode r"><code class="sourceCode r"><span class='co'># same as test</span>
<span class='va'>df_eval_torch</span> <span class='op'>=</span> <span class='va'>df_validate</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/filter.html'>filter</a></span><span class='op'>(</span><span class='va'>line</span> <span class='op'>==</span> <span class='st'>'red'</span>, <span class='va'>date</span> <span class='op'>&gt;</span> <span class='st'>'2017-12-01'</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/select.html'>select</a></span><span class='op'>(</span><span class='va'>rides_scaled</span>, <span class='va'>date</span><span class='op'>)</span> <span class='op'><a href='https://magrittr.tidyverse.org/reference/pipe.html'>%&gt;%</a></span>
  <span class='fu'>as_tsibble</span><span class='op'>(</span><span class='op'>)</span>

<span class='va'>test_preds_plot</span> <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/vector.html'>vector</a></span><span class='op'>(</span>mode <span class='op'>=</span> <span class='st'>"list"</span>, length <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>test_preds</span><span class='op'>)</span><span class='op'>)</span>

<span class='kw'>for</span> <span class='op'>(</span><span class='va'>i</span> <span class='kw'>in</span> <span class='fl'>1</span><span class='op'>:</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/length.html'>length</a></span><span class='op'>(</span><span class='va'>test_preds_plot</span><span class='op'>)</span><span class='op'>-</span>  <span class='va'>n_forecast</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>{</span>
  <span class='va'>test_preds_plot</span><span class='op'>[[</span><span class='va'>i</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>=</span>
    <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span>
      pred <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span>
        <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='cn'>NA</span>, <span class='va'>n_timesteps</span> <span class='op'>+</span> <span class='op'>(</span><span class='va'>i</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span><span class='op'>)</span>,
        <span class='va'>test_preds</span><span class='op'>[[</span><span class='va'>i</span><span class='op'>]</span><span class='op'>]</span> <span class='op'>*</span> <span class='va'>train_sd</span> <span class='op'>+</span> <span class='va'>train_mean</span>,
        <span class='fu'><a href='https://rdrr.io/r/base/rep.html'>rep</a></span><span class='op'>(</span><span class='cn'>NA</span>, <span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>df_eval_torch</span><span class='op'>)</span> <span class='op'>-</span> <span class='op'>(</span><span class='va'>i</span> <span class='op'>-</span> <span class='fl'>1</span><span class='op'>)</span> <span class='op'>-</span> <span class='va'>n_timesteps</span> <span class='op'>-</span> <span class='va'>n_forecast</span><span class='op'>)</span>
      <span class='op'>)</span>
    <span class='op'>)</span>
<span class='op'>}</span>

<span class='va'>df_eval_torch_plot0</span> <span class='op'>=</span>
  <span class='fu'><a href='https://dplyr.tidyverse.org/reference/bind.html'>bind_cols</a></span><span class='op'>(</span><span class='va'>df_eval_torch</span>, <span class='fu'><a href='https://dplyr.tidyverse.org/reference/bind.html'>bind_cols</a></span><span class='op'>(</span><span class='va'>test_preds_plot</span><span class='op'>)</span><span class='op'>)</span>
</code></pre>
</div>
</div>
<p>A visualization of the predictions makes this more clear. Each 30 day
segment is making predictions for the next 14 days.</p>
<div class="layout-chunk" data-layout="l-body">
<p><img src="time-series-r_files/figure-html5/torch-plot-window-1.svg" width="624" style="display: block; margin: auto;" /></p>
</div>
<p>So for our red line plot, we’ll just use the average prediction at
each date to make it comparable to the other plots. In general it looks
to be doing okay, even armed with no contextual information. Certainly
better than the base ARIMA plot.</p>
<div class="layout-chunk" data-layout="l-body">
<p><img src="time-series-r_files/figure-html5/torch-plot-1.svg" width="624" style="display: block; margin: auto;" /></p>
</div>
<p>However, we can see that there is much information lost just adhering
to the series alone.</p>
<div class="layout-chunk" data-layout="l-body">
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
.metric
</th>
<th style="text-align:left;">
.estimator
</th>
<th style="text-align:right;">
.estimate
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
rmse
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
0.804
</td>
</tr>
<tr>
<td style="text-align:left;">
mae
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
0.584
</td>
</tr>
<tr>
<td style="text-align:left;">
rsq
</td>
<td style="text-align:left;">
standard
</td>
<td style="text-align:right;">
0.120
</td>
</tr>
</tbody>
</table>
</div>
<h2 id="all">All</h2>
<div class="layout-chunk" data-layout="l-body">

</div>
<div class="layout-chunk" data-layout="l-page">
<p><img src="time-series-r_files/figure-html5/vis-all-lines-1.svg" width="624" height="125%" style="display: block; margin: auto;" /></p>
</div>
<div class="layout-chunk" data-layout="l-page">
<p><img src="time-series-r_files/figure-html5/vis-red-line-1.svg" width="624" style="display: block; margin: auto;" /></p>
</div>
<h2 id="summary">Summary</h2>
<ul>
<li>ARIMA: no real reason to still be doing such a simplified model</li>
<li>Mixed Model: may be just what you need, but may lack in other
settings</li>
<li>GAM: great, more viable than some might suspect, easy
implementation</li>
<li>Prophet/Fable: Prophet needs notable work out of the box, though
Fable saves you some of that work, and did great in this situation via
by-group models</li>
<li>GBM: can it really be this easy?</li>
<li>Torch: pretty good even with minimal information</li>
</ul>
<p>To get some information on what Torch would do at the next level,
i.e. adding additional features and other considerations, see <a
href="https://www.strong.io/blog/forecasting-public-transport-utilization-in-chicago">Cody’s
post</a>.</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode r distill-force-highlighting-css"><code class="sourceCode r"></code></pre></div>
<div id="refs" class="references csl-bib-body hanging-indent"
role="doc-bibliography">
<div id="ref-Hyndman2021" class="csl-entry" role="doc-biblioentry">
Hyndman, R. J., and G. Athanasopoulos. 2021. <em>Forecasting: Principles
and Practice</em>. 3rd ed. <a
href="https://OTexts.com/fpp3">https://OTexts.com/fpp3</a>.
</div>
<div id="ref-west2022" class="csl-entry" role="doc-biblioentry">
West, Brady T, Kathleen B Welch, and Andrzej T Galecki. 2022. <em>Linear
Mixed Models: A Practical Guide Using Statistical Software</em>. Crc
Press.
</div>
</div>
<section class="footnotes footnotes-end-of-document"
role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>There is also the Purple express
line, which is very irregular compared to the others.<a href="#fnref1"
class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>Technically we should scale the test
set using the mean/sd of the training set, and though with very large
data this should not matter, for time series it’s a particular concern
as data can ‘shift’ over time.<a href="#fnref2" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p>This follows <a
href="https://cran.r-project.org/web/packages/glmmTMB/vignettes/covstruct.html">Bolker’s
demo</a>.<a href="#fnref3" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
<li id="fn4" role="doc-endnote"><p>I always appreciated the depiction of
this topic in <span class="citation" data-cites="west2022">West, Welch,
and Galecki (<a href="#ref-west2022"
role="doc-biblioref">2022</a>)</span> quite a bit.<a href="#fnref4"
class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5" role="doc-endnote"><p>A year plus later after that
statement, it still hasn’t gone beyond 0.1.0, so I don’t think this will
continue to be useful for very long. Unfortunate, but honestly, it’s not
clear <span class="pack" style = "">prophet&lt;/span itself can do much
better than many other tools.<a href="#fnref5" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
<li id="fn6" role="doc-endnote"><p><span class="pack"
style="">fable.prophet</span> may have a bug enabling the holidays
functionality with parallel, so you can just use the original holiday
column if you do so (single core doesn’t take too long).<a
href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7" role="doc-endnote"><p>We can also do this with our previous
method with a split-by-apply approach. You would obtain the same
results, so this serves as a nice supplement to our ‘overall’ metrics.<a
href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8" role="doc-endnote"><p>For the basics of using PyTorch via
R, including installation, see <a
href="https://blogs.rstudio.com/ai/posts/2020-09-29-introducing-torch-for-r/">the
RStudio</a> post.<a href="#fnref8" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
<li id="fn9" role="doc-endnote"><p>The blog code actually has several
issues, but the <a
href="https://github.com/mlverse/torchbook_materials/blob/master/scripts/rnn_attention.R">github
repo</a> should work fine and is what is followed for this demo.<a
href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
<!--radix_placeholder_article_footer-->
<!--/radix_placeholder_article_footer-->
</div>

<div class="d-appendix">
</div>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

<!--radix_placeholder_site_after_body-->
<!--/radix_placeholder_site_after_body-->
<!--radix_placeholder_appendices-->
<div class="appendix-bottom">
<h3 id="references">References</h3>
<div id="references-listing"></div>
</div>
<!--/radix_placeholder_appendices-->
<!--radix_placeholder_navigation_after_body-->
<!--/radix_placeholder_navigation_after_body-->

</body>

</html>
