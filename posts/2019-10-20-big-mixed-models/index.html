<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.30">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Michael Clark">
<meta name="dcterms.date" content="2019-10-20">
<meta name="keywords" content="mixed models, big data, generalized linear mixed models, additive models, random effects, lme4, glmmTMB, mgcv, lmer, glmer">
<meta name="description" content="Explorations of a fast penalized regression approach with mgcv">

<title>Mixed Models for Big Data – Michael Clark</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-3a01e2046221230fdceeea94b1ec5d67.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-b98f056cf3508670ef95a599f1e4d22b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/quarto-contrib/social-share-1.0.0/social-share.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/social-share-1.0.0/all.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-1.2.0/all.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-1.2.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../../site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="../../site_libs/lightable-0.0.1/lightable.css" rel="stylesheet">


</head>

<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../img/mc_logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Michael Clark</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/michael-clark-b475b5170/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/m-clark"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/m-clark.bsky.social"> 
<span class="menu-text"><i class="fa-brands fa-bluesky" aria-label="bluesky"></i></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://x.com/statsdatasci"> <i class="bi bi-twitter-x" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../documents.html"> 
<span class="menu-text">Content</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../code.html"> 
<span class="menu-text">Code</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Mixed Models for Big Data</h1>
                  <div>
        <div class="description">
          <p>Explorations of a fast penalized regression approach with mgcv</p>
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">GAM</div>
                <div class="quarto-category">mixed models</div>
                <div class="quarto-category">big data</div>
                <div class="quarto-category">bayesian</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p><a href="https://m-clark.github.io">Michael Clark</a> </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">October 20, 2019</p>
      </div>
    </div>
    
      
    </div>
    

  <div>
    <div class="keywords">
      <div class="block-title">Keywords</div>
      <p>mixed models, big data, generalized linear mixed models, additive models, random effects, lme4, glmmTMB, mgcv, lmer, glmer</p>
    </div>
  </div>
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#r-packages-for-mixed-models-with-large-data" id="toc-r-packages-for-mixed-models-with-large-data" class="nav-link" data-scroll-target="#r-packages-for-mixed-models-with-large-data">R Packages for Mixed Models with Large Data</a></li>
  <li><a href="#additive-models-as-mixed-models" id="toc-additive-models-as-mixed-models" class="nav-link" data-scroll-target="#additive-models-as-mixed-models">Additive Models as Mixed Models</a>
  <ul class="collapse">
  <li><a href="#comparison-of-gam-to-the-mixed-model" id="toc-comparison-of-gam-to-the-mixed-model" class="nav-link" data-scroll-target="#comparison-of-gam-to-the-mixed-model">Comparison of GAM to the Mixed Model</a></li>
  <li><a href="#the-bam-approach" id="toc-the-bam-approach" class="nav-link" data-scroll-target="#the-bam-approach">The bam approach</a></li>
  <li><a href="#fixed-effects-comparison" id="toc-fixed-effects-comparison" class="nav-link" data-scroll-target="#fixed-effects-comparison">Fixed effects comparison</a></li>
  <li><a href="#variance-components-comparison" id="toc-variance-components-comparison" class="nav-link" data-scroll-target="#variance-components-comparison">Variance components comparison</a></li>
  <li><a href="#estimated-random-effects" id="toc-estimated-random-effects" class="nav-link" data-scroll-target="#estimated-random-effects">Estimated random effects</a></li>
  <li><a href="#comparisons-to-bayesian-estimates" id="toc-comparisons-to-bayesian-estimates" class="nav-link" data-scroll-target="#comparisons-to-bayesian-estimates">Comparisons to Bayesian Estimates</a></li>
  </ul></li>
  <li><a href="#back-to-the-initial-problem" id="toc-back-to-the-initial-problem" class="nav-link" data-scroll-target="#back-to-the-initial-problem">Back to the initial problem</a></li>
  <li><a href="#when-to-use-bam" id="toc-when-to-use-bam" class="nav-link" data-scroll-target="#when-to-use-bam">When to use bam</a>
  <ul class="collapse">
  <li><a href="#linear-mixed-models" id="toc-linear-mixed-models" class="nav-link" data-scroll-target="#linear-mixed-models">Linear Mixed Models</a></li>
  <li><a href="#generalized-linear-mixed-models" id="toc-generalized-linear-mixed-models" class="nav-link" data-scroll-target="#generalized-linear-mixed-models">Generalized Linear Mixed Models</a></li>
  <li><a href="#other-options" id="toc-other-options" class="nav-link" data-scroll-target="#other-options">Other options</a></li>
  </ul></li>
  <li><a href="#limitations" id="toc-limitations" class="nav-link" data-scroll-target="#limitations">Limitations</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  <li><a href="#supplemental" id="toc-supplemental" class="nav-link" data-scroll-target="#supplemental">Supplemental</a>
  <ul class="collapse">
  <li><a href="#simulation-settings" id="toc-simulation-settings" class="nav-link" data-scroll-target="#simulation-settings">Simulation Settings</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<div class="page-columns page-full"><p></p><div class="no-row-height column-margin column-container"><span class="margin-aside">Last updated January 02, 2025. Timings based on original date of posting.</span></div></div>
<p>NOTE: When redoing my website, some of the results were not saved as needed, so it may be possible to see a mismatch with printed results vs.&nbsp;text description. It was also easier to run bam in parallel, but nowadays this requires openmp which likely won’t be recognized even if you have it installed. As of 2023, I have some packages work with it (data.table), and others not (mgcv).</p>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>With mixed models, it is easy to run into data that is larger in size than some more typical data scenarios. Consider a cross-sectional data set with 200 individuals. This is fairly small data. Now, if we observe them each five times, as in a longitudinal setting, we suddenly have 1000 observations. There may be less than 200 countries in the world, but if we survey 100s or 1000s of people in many of them, we suddenly have a notable data set size, and still would potentially like to model a country-level random effect. What are our options when dealing with possibly gigabytes of data?</p>
<p>This post will demonstrate an approach that can be used with potentially millions of data points, multiple random effects, and possibly other complexities. First we’ll demonstrate how to get typical mixed model results using the approach used for generalized additive models. We’ll compare the output of the GAM, lme4, and even fully Bayesian mixed models. Then we’ll show some timings to compare the speed of the different approaches of common tools, and summarize some findings from other places.</p>
<p>[Background required:</p>
<p>For the following you should have familiarity with <a href="https://m-clark.github.io/mixed-models-with-R/">mixed models</a>. Knowledge of the <span class="pack" style="">lme4</span> package would be useful but isn’t required. Likewise, knowledge of <a href="https://m-clark.github.io/generalized-additive-models/">generalized additive models</a> and <span class="pack" style="">mgcv</span> would be helpful, but I don’t think it’s required to follow the demonstration.]{.aside}</p>
</section>
<section id="r-packages-for-mixed-models-with-large-data" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="r-packages-for-mixed-models-with-large-data">R Packages for Mixed Models with Large Data</h2>
<p>While many tools abound to conduct mixed models for larger data sizes, their limitations can be found pretty quickly. R’s <span class="pack" style="">lme4</span> is a standard, but powerful mixed model tool. More to the point, it is computationally efficient, such that it can handle very large sample sizes for simpler mixed models. For linear mixed models this can include hundreds of thousands of observations with possibly multiple random effects, still running on a basic laptop. For such models, it’s still largely the tool of choice, and its approach has even been copied/ported into other statistical packages.</p>
<p>We’ll first create some data to model. This is just a simple random intercepts setting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12358</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>N <span class="ot">=</span> <span class="fl">1e6</span>                                  <span class="co"># total sample size</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>n_groups <span class="ot">=</span> <span class="dv">1000</span>                          <span class="co"># number of groups</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>g <span class="ot">=</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n_groups, <span class="at">e =</span> N<span class="sc">/</span>n_groups)      <span class="co"># the group identifier</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">rnorm</span>(N)                             <span class="co"># an observation level continuous variable</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>b <span class="ot">=</span> <span class="fu">rbinom</span>(n_groups, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob=</span>.<span class="dv">5</span>)  <span class="co"># a cluster level categorical variable</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>b <span class="ot">=</span> b[g]</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>sd_g <span class="ot">=</span> .<span class="dv">5</span>     <span class="co"># standard deviation for the random effect</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>sigma <span class="ot">=</span> <span class="dv">1</span>     <span class="co"># standard deviation for the observation</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>re0 <span class="ot">=</span> <span class="fu">rnorm</span>(n_groups, <span class="at">sd =</span> sd_g)  <span class="co"># random effects</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>re  <span class="ot">=</span> re0[g]</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>lp <span class="ot">=</span> <span class="dv">0</span> <span class="sc">+</span> .<span class="dv">5</span><span class="sc">*</span>x <span class="sc">+</span> .<span class="dv">25</span><span class="sc">*</span>b <span class="sc">+</span> re        <span class="co"># linear predictor </span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>y <span class="ot">=</span> <span class="fu">rnorm</span>(N, <span class="at">mean =</span> lp, <span class="at">sd =</span> sigma)               <span class="co"># create a continuous target variable</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>y_bin <span class="ot">=</span> <span class="fu">rbinom</span>(N, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> <span class="fu">plogis</span>(lp))    <span class="co"># create a binary target variable</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>d <span class="ot">=</span> <span class="fu">tibble</span>(x, b, y, y_bin, <span class="at">g =</span> <span class="fu">factor</span>(g))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><br></p>
<p>Let’s take a look at the data first.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">index</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">x</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">b</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">y</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">y_bin</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">g</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.378</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">-0.278</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">-0.812</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">-0.343</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">0.218</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">-0.810</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: right;">1.529</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.465</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: right;">-1.877</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">-1.570</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: right;">6</td>
<td style="text-align: right;">-0.427</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.047</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">999995</td>
<td style="text-align: right;">-1.181</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1.111</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">1000</td>
</tr>
<tr class="even">
<td style="text-align: right;">999996</td>
<td style="text-align: right;">-1.487</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.563</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">1000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">999997</td>
<td style="text-align: right;">-1.236</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-0.603</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">1000</td>
</tr>
<tr class="even">
<td style="text-align: right;">999998</td>
<td style="text-align: right;">0.412</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.736</td>
<td style="text-align: right;">0</td>
<td style="text-align: left;">1000</td>
</tr>
<tr class="odd">
<td style="text-align: right;">999999</td>
<td style="text-align: right;">-0.644</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">-1.257</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">1000</td>
</tr>
<tr class="even">
<td style="text-align: right;">1000000</td>
<td style="text-align: right;">0.409</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.520</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">1000</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Now with the data in place, let’s try <span class="pack" style="">lme4</span> to model the continuous outcome.</p>
<div class="page-columns page-full"><p></p><div class="no-row-height column-margin column-container"><span class="margin-aside">The time to focus on is <code>elapsed</code>, which is the number of seconds the function took to run.</span></div></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  mixed_big <span class="ot">=</span> <span class="fu">lmer</span>(y <span class="sc">~</span> x <span class="sc">+</span> b <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>g))</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
  3.573   0.250   3.902 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mixed_big, <span class="at">cor =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: y ~ x + b + (1 | g)

REML criterion at convergence: 2841256

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-4.6066 -0.6743 -0.0004  0.6744  5.0367 

Random effects:
 Groups   Name        Variance Std.Dev.
 g        (Intercept) 0.2509   0.5009  
 Residual             0.9978   0.9989  
Number of obs: 1000000, groups:  g, 1000

Fixed effects:
             Estimate Std. Error t value
(Intercept) 0.0364754  0.0223332   1.633
x           0.5017616  0.0009987 502.409
b           0.1904534  0.0317430   6.000</code></pre>
</div>
</div>
<p>This is great! We just ran a mixed model for 1,000,000 observations and 1,000 groups for our random effect in just a few seconds.</p>
<p>But one problem comes as soon as you move to the generalized mixed model, e.g.&nbsp;having a binary outcome, or include additional complexity while still dealing with large data. The following is essentially the same model, but for a binary outcome.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  mixed_big_glmm <span class="ot">=</span> <span class="fu">glmer</span>(y_bin <span class="sc">~</span> x <span class="sc">+</span> b <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>g), <span class="at">family =</span> binomial)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   user  system elapsed 
 58.090   6.462  65.693 </code></pre>
</div>
</div>
<p>To begin with, you shouldn’t be worried about models taking a few minutes to run, or even a couple hours. Once you have your model(s) squared away, the testing of which can be done on a smaller sample of the data set, there is no need to repeatedly run it. But in this case we had a greater than 15 fold increase in time for a very simple data scenario. So it’s good to have options when you need them. Let’s turn to those.</p>
</section>
<section id="additive-models-as-mixed-models" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="additive-models-as-mixed-models">Additive Models as Mixed Models</h2>
<p>Simon Wood’s wonderful work on generalized additive models (GAM) and the <span class="pack" style="">mgcv</span> package make it one of the better modeling tools in the R kingdom. As his text<span class="citation" data-cites="wood_generalized_2017">(<a href="#ref-wood_generalized_2017" role="doc-biblioref">S. N. Wood 2017</a>)</span> and other work shows, additive models constructed be posited in a similar way as mixed models, and he exploits this by providing numerous ways to include and explore random effects in the GAM approach. One key difference between the GAM and a standard linear mixed model approach is the way parameters are estimated. For the GAM, the random effects are estimated as are other fixed effect coefficients. Those random effects are penalized, in a similar way as L2/ridge regression. The ‘fixed effects’ are not penalized, and so that part is basically just a generalized linear model. As we will see though, the results will be nearly the same between <span class="pack" style="">mgcv</span> and <span class="pack" style="">lme4</span>.</p>
<p>The following demonstrates the link between the approaches by showing a model that includes a random intercept and slope. We will use the standard <span class="pack" style="">mgcv</span> approach for specifying a smooth term, but alternatives are shown for those familiar with the package.</p>
<div class="page-columns page-full"><p></p><div class="no-row-height column-margin column-container"><span class="margin-aside">If you just use <span class="func" style="">coef</span> on the following gam objects, you will see that the random effects are lumped in with the other estimated coefficients.</span></div></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>mixed_model <span class="ot">=</span> <span class="fu">lmer</span>(</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  Reaction <span class="sc">~</span> Days <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> Subject) <span class="sc">+</span> (<span class="dv">0</span> <span class="sc">+</span> Days <span class="sc">|</span> Subject),</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> sleepstudy</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>ga_model <span class="ot">=</span> <span class="fu">gam</span>(</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  Reaction <span class="sc">~</span>  Days <span class="sc">+</span> <span class="fu">s</span>(Subject, <span class="at">bs =</span> <span class="st">'re'</span>) <span class="sc">+</span> <span class="fu">s</span>(Days, Subject, <span class="at">bs =</span> <span class="st">'re'</span>),</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> sleepstudy,</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">'REML'</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Using gamm and gamm4 for the same model</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co"># ga_model = gamm(</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co">#   Reaction ~  Days ,</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co">#   random = list(Subject = ~ 0 + Days),</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="co">#   data = sleepstudy,</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="co">#   method = 'REML'</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="co"># ga_model = gamm4::gamm4(</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a><span class="co">#   Reaction ~  Days,</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="co">#   random =  ~ (Days||Subject),</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="co">#   data = sleepstudy,</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="co">#   REML = TRUE</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that we use <span class="func" style="">s</span> to denote a <span class="emph" style="">smooth term</span> in the parlance of additive models, and the <code>bs = 're'</code> specifies that we want it as a random effect (as opposed to a spline or other basis function). The second smooth term <code>s(Days, Subject, bs = 're')</code> denotes random coefficients for the <code>Days</code> covariate.</p>
<div class="page-columns page-full"><p></p><div class="no-row-height column-margin column-container"><span class="margin-aside">As shown, one could use the <span class="func" style="">gamm</span> function for the <span class="pack" style="">nlme</span> style, or Wood’s <span class="pack" style="">gamm4</span> package to use the <span class="pack" style="">lme4</span> syntax. These alternate approaches allow for more flexibility in some ways, but will not be useful to us for big data.</span></div></div>
<section id="comparison-of-gam-to-the-mixed-model" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="comparison-of-gam-to-the-mixed-model">Comparison of GAM to the Mixed Model</h3>
<p>Aside from the syntax, the underlying model between the two is the same, and the following shows that we obtain the same results for both <span class="pack" style="">lme4</span> and <span class="pack" style="">mgcv</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mixed_model, <span class="at">cor =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: Reaction ~ Days + (1 | Subject) + (0 + Days | Subject)
   Data: sleepstudy

REML criterion at convergence: 1743.7

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-3.9626 -0.4625  0.0204  0.4653  5.1860 

Random effects:
 Groups    Name        Variance Std.Dev.
 Subject   (Intercept) 627.57   25.051  
 Subject.1 Days         35.86    5.988  
 Residual              653.58   25.565  
Number of obs: 180, groups:  Subject, 18

Fixed effects:
            Estimate Std. Error t value
(Intercept)  251.405      6.885  36.513
Days          10.467      1.560   6.712</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ga_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: gaussian 
Link function: identity 

Formula:
Reaction ~ Days + s(Subject, bs = "re") + s(Days, Subject, bs = "re")

Parametric coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  251.405      6.885  36.513  &lt; 2e-16 ***
Days          10.467      1.560   6.712 3.67e-10 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
                  edf Ref.df      F  p-value    
s(Subject)      12.94     17  89.29 1.09e-06 ***
s(Days,Subject) 14.41     17 104.56  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

R-sq.(adj) =  0.794   Deviance explained = 82.7%
-REML = 871.83  Scale est. = 653.58    n = 180</code></pre>
</div>
</div>
<p>I don’t want to go into the details of the printout for <span class="pack" style="">mgcv</span>, but it is worth noting that the parametric part is equivalent to the fixed effects portion of the <span class="pack" style="">lme4</span> output. Likewise the smooth terms output is related to the random effects, but we’ll extract them in a manner more suited to typical mixed model output instead. So let’s compare the variance components, and get them ready for later comparison to <span class="func" style="">bam</span> results. Note, I’ve use several packages for mixed models, so I created a package called <span class="pack" style="">mixedup</span> to provide tidier and consistent output, and which is more similar to <span class="pack" style="">lme4</span>. I note the corresponding <span class="pack" style="">mgcv</span> function where appropriate.</p>
<div class="page-columns page-full"><p></p><div class="no-row-height column-margin column-container"><span class="margin-aside">The <span class="pack" style="">mixedup</span> package is available on <a href="https://m-clark/github.com/mixedup">GitHub</a>.</span></div></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mixedup)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co"># extract just the fixed effects for later.</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>mixed_fe <span class="ot">=</span> <span class="fu">extract_fixed_effects</span>(mixed_model, <span class="at">digits =</span> <span class="dv">5</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>gam_fe   <span class="ot">=</span> <span class="fu">extract_fixed_effects</span>(ga_model, <span class="at">digits =</span> <span class="dv">5</span>)  <span class="co"># coefs with se and confidence interval</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># variance components</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>lmer_vcov <span class="ot">=</span> <span class="fu">extract_vc</span>(mixed_model, <span class="at">digits =</span> <span class="dv">5</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>gam_vcov  <span class="ot">=</span> <span class="fu">extract_vc</span>(ga_model, <span class="at">digits =</span> <span class="dv">5</span>)    <span class="co"># cleaner gam.vcomp</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>LME Result</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">group</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">effect</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">variance</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd_2.5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd_97.5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">var_prop</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Subject</td>
<td style="text-align: left;">Intercept</td>
<td style="text-align: right;">627.569</td>
<td style="text-align: right;">25.051</td>
<td style="text-align: right;">15.259</td>
<td style="text-align: right;">37.786</td>
<td style="text-align: right;">0.477</td>
</tr>
<tr class="even">
<td style="text-align: left;">Subject.1</td>
<td style="text-align: left;">Days</td>
<td style="text-align: right;">35.858</td>
<td style="text-align: right;">5.988</td>
<td style="text-align: right;">3.964</td>
<td style="text-align: right;">8.769</td>
<td style="text-align: right;">0.027</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Residual</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">653.584</td>
<td style="text-align: right;">25.565</td>
<td style="text-align: right;">22.881</td>
<td style="text-align: right;">28.788</td>
<td style="text-align: right;">0.496</td>
</tr>
</tbody>
</table>


</div>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>GAM Result</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">group</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">effect</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">variance</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd_2.5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd_97.5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">var_prop</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Subject</td>
<td style="text-align: left;">Intercept</td>
<td style="text-align: right;">627.571</td>
<td style="text-align: right;">25.051</td>
<td style="text-align: right;">16.085</td>
<td style="text-align: right;">39.015</td>
<td style="text-align: right;">0.477</td>
</tr>
<tr class="even">
<td style="text-align: left;">Subject</td>
<td style="text-align: left;">Days</td>
<td style="text-align: right;">35.858</td>
<td style="text-align: right;">5.988</td>
<td style="text-align: right;">4.025</td>
<td style="text-align: right;">8.908</td>
<td style="text-align: right;">0.027</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Residual</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">653.582</td>
<td style="text-align: right;">25.565</td>
<td style="text-align: right;">22.792</td>
<td style="text-align: right;">28.676</td>
<td style="text-align: right;">0.496</td>
</tr>
</tbody>
</table>


</div>
</div>
<div class="page-columns page-full"><p></p><div class="no-row-height column-margin column-container"><span class="margin-aside">The penalty parameter in the GAM model is inversely related to the variance estimate of the random effects. See <a href="https://m-clark.github.io/generalized-additive-models/appendix.html#a-comparison-to-mixed-models">this demo</a>.</span></div></div>
</section>
<section id="the-bam-approach" class="level3">
<h3 class="anchored" data-anchor-id="the-bam-approach">The bam approach</h3>
<p>For large data, <span class="pack" style="">mgcv</span> provides the <span class="func" style="">bam</span> function. For this small data setting we don’t really need it, but we can establish that we would get similar results using it without having to wait. We will see the benefits when we apply <span class="func" style="">bam</span> to large data later. None of our syntax changes, just the function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>ba_model <span class="ot">=</span> <span class="fu">bam</span>(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  Reaction <span class="sc">~</span>  Days <span class="sc">+</span> <span class="fu">s</span>(Subject, <span class="at">bs=</span><span class="st">'re'</span>) <span class="sc">+</span> <span class="fu">s</span>(Days, Subject, <span class="at">bs=</span><span class="st">'re'</span>), </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> sleepstudy</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>bam_fe   <span class="ot">=</span> <span class="fu">extract_fixed_effects</span>(ba_model, <span class="at">digits =</span> <span class="dv">5</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>bam_vcov <span class="ot">=</span> <span class="fu">extract_vc</span>(ba_model, <span class="at">digits =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>How does it work? The function uses a parallelized approach where possible, essentially working on subsets of the model matrices simultaneously. Details can be found in the references[<span class="citation" data-cites="li_faster_2019">Li and Wood (<a href="#ref-li_faster_2019" role="doc-biblioref">2019</a>)</span>]<span class="citation" data-cites="wood_generalized_2015">(<a href="#ref-wood_generalized_2015" role="doc-biblioref">S. N. Wood, Goude, and Shaw 2015a</a>)</span><span class="citation" data-cites="wood_generalized_2017-1">(<a href="#ref-wood_generalized_2017-1" role="doc-biblioref">S. N. Wood et al. 2017</a>)</span>, but basically <span class="pack" style="">mgcv</span> parallelizes the parts that can be, and additionally provides an option to discretize the data to work with the minimal information necessary to produce viable estimates. The following uses the discrete option. As there isn’t really anything to discretize with so little data, this is just to demonstrate the syntax.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>ba_d_model <span class="ot">=</span> <span class="fu">bam</span>(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  Reaction <span class="sc">~</span>  Days <span class="sc">+</span> <span class="fu">s</span>(Subject, <span class="at">bs=</span><span class="st">'re'</span>) <span class="sc">+</span> <span class="fu">s</span>(Days, Subject, <span class="at">bs=</span><span class="st">'re'</span>), </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> sleepstudy,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">discrete =</span> <span class="cn">TRUE</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>bam_d_fe   <span class="ot">=</span> <span class="fu">extract_fixed_effects</span>(ba_d_model, <span class="at">digits =</span> <span class="dv">5</span>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>bam_d_vcov <span class="ot">=</span> <span class="fu">extract_vc</span>(ba_d_model, <span class="at">digits =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fixed-effects-comparison" class="level3">
<h3 class="anchored" data-anchor-id="fixed-effects-comparison">Fixed effects comparison</h3>
<p>We start by comparing the fixed effects of all models run thus far. No surprises here, the results are the same.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Fixed Effects Estimates</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">term</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mixed</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">gam</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">bam</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">bam_d</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: right;">251.405</td>
<td style="text-align: right;">251.405</td>
<td style="text-align: right;">251.405</td>
<td style="text-align: right;">251.405</td>
</tr>
<tr class="even">
<td style="text-align: left;">Days</td>
<td style="text-align: right;">10.467</td>
<td style="text-align: right;">10.467</td>
<td style="text-align: right;">10.467</td>
<td style="text-align: right;">10.467</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Let’s examine the standard errors. Note that there are options for the GAM models for standard error estimation, including a Bayesian one. For more details, see <code>?gamObject</code>, but I will offer the summary:</p>
<section id="ve" class="level5">
<h5 class="anchored" data-anchor-id="ve">Ve</h5>
<p>frequentist estimated covariance matrix for the parameter estimators. Particularly useful for testing whether terms are zero. Not so useful for CI’s as smooths are usually biased.</p>
</section>
<section id="vp" class="level5">
<h5 class="anchored" data-anchor-id="vp">Vp</h5>
<p>estimated covariance matrix for the parameters. This is a Bayesian posterior covariance matrix that results from adopting a particular Bayesian model of the smoothing process. Particularly useful for creating credible/confidence intervals.</p>
</section>
<section id="vc" class="level5">
<h5 class="anchored" data-anchor-id="vc">Vc</h5>
<p>Under ML or REML smoothing parameter estimation it is possible to correct the covariance matrix Vp for smoothing parameter uncertainty. This is the corrected version.</p>
<p>We will use the Bayesian estimates (<code>Vp</code>), but for this setting there are no appreciable differences. I expand the digits to show they are in fact different to some decimal place.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Fixed Effects Standard Errors</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">term</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mixed</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">gam</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">bam</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">bam_d</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: right;">6.88538</td>
<td style="text-align: right;">6.88540</td>
<td style="text-align: right;">6.88538</td>
<td style="text-align: right;">6.88538</td>
</tr>
<tr class="even">
<td style="text-align: left;">Days</td>
<td style="text-align: right;">1.55957</td>
<td style="text-align: right;">1.55956</td>
<td style="text-align: right;">1.55957</td>
<td style="text-align: right;">1.55957</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
</section>
<section id="variance-components-comparison" class="level3">
<h3 class="anchored" data-anchor-id="variance-components-comparison">Variance components comparison</h3>
<p>Now we move to the variance component estimates. Reported are the standard deviations for subject level random effects for intercept, <code>Days</code> coefficient, and residual.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Variance Components Estimates</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th"></th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Intercept</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Days</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Residual</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">mixed</td>
<td style="text-align: right;">25.051</td>
<td style="text-align: right;">5.988</td>
<td style="text-align: right;">25.565</td>
</tr>
<tr class="even">
<td style="text-align: left;">gam</td>
<td style="text-align: right;">25.051</td>
<td style="text-align: right;">5.988</td>
<td style="text-align: right;">25.565</td>
</tr>
<tr class="odd">
<td style="text-align: left;">bam</td>
<td style="text-align: right;">25.051</td>
<td style="text-align: right;">5.988</td>
<td style="text-align: right;">25.565</td>
</tr>
<tr class="even">
<td style="text-align: left;">bam_d</td>
<td style="text-align: right;">25.051</td>
<td style="text-align: right;">5.988</td>
<td style="text-align: right;">25.565</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>We can also look at their interval estimates. We use the profile likelihood for the <span class="pack" style="">lme4</span> mixed model. In this case we can see slightly wider and somewhat different boundary estimates for the variance components, but not too dissimilar.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Interval Estimates for Variance Components</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Model</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">group</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">effect</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">variance</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd_2.5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd_97.5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">width</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td rowspan="3" style="text-align: left; vertical-align: top !important;">mixed</td>
<td rowspan="2" style="text-align: left; vertical-align: top !important;">Subject</td>
<td style="text-align: left;">Intercept</td>
<td style="text-align: right;">627.5690</td>
<td style="text-align: right;">25.0513</td>
<td style="text-align: right;">15.2586</td>
<td style="text-align: right;">37.7865</td>
<td style="text-align: right;">22.5278</td>
</tr>
<tr class="even">
<td style="text-align: left;">Days</td>
<td style="text-align: right;">35.8584</td>
<td style="text-align: right;">5.9882</td>
<td style="text-align: right;">3.9641</td>
<td style="text-align: right;">8.7692</td>
<td style="text-align: right;">4.8051</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Residual</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">653.5835</td>
<td style="text-align: right;">25.5653</td>
<td style="text-align: right;">22.8805</td>
<td style="text-align: right;">28.7876</td>
<td style="text-align: right;">5.9071</td>
</tr>
<tr class="even">
<td rowspan="3" style="text-align: left; vertical-align: top !important;">gam</td>
<td rowspan="2" style="text-align: left; vertical-align: top !important;">Subject</td>
<td style="text-align: left;">Intercept</td>
<td style="text-align: right;">627.5712</td>
<td style="text-align: right;">25.0514</td>
<td style="text-align: right;">16.0854</td>
<td style="text-align: right;">39.0150</td>
<td style="text-align: right;">22.9297</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Days</td>
<td style="text-align: right;">35.8580</td>
<td style="text-align: right;">5.9882</td>
<td style="text-align: right;">4.0252</td>
<td style="text-align: right;">8.9083</td>
<td style="text-align: right;">4.8830</td>
</tr>
<tr class="even">
<td style="text-align: left;">Residual</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">653.5822</td>
<td style="text-align: right;">25.5652</td>
<td style="text-align: right;">22.7918</td>
<td style="text-align: right;">28.6763</td>
<td style="text-align: right;">5.8845</td>
</tr>
<tr class="odd">
<td rowspan="3" style="text-align: left; vertical-align: top !important;">bam</td>
<td rowspan="2" style="text-align: left; vertical-align: top !important;">Subject</td>
<td style="text-align: left;">Intercept</td>
<td style="text-align: right;">627.5691</td>
<td style="text-align: right;">25.0513</td>
<td style="text-align: right;">16.0853</td>
<td style="text-align: right;">39.0150</td>
<td style="text-align: right;">22.9297</td>
</tr>
<tr class="even">
<td style="text-align: left;">Days</td>
<td style="text-align: right;">35.8582</td>
<td style="text-align: right;">5.9882</td>
<td style="text-align: right;">4.0253</td>
<td style="text-align: right;">8.9083</td>
<td style="text-align: right;">4.8830</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Residual</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">653.5838</td>
<td style="text-align: right;">25.5653</td>
<td style="text-align: right;">22.7918</td>
<td style="text-align: right;">28.6763</td>
<td style="text-align: right;">5.8845</td>
</tr>
<tr class="even">
<td rowspan="3" style="text-align: left; vertical-align: top !important;">bam_d</td>
<td rowspan="2" style="text-align: left; vertical-align: top !important;">Subject</td>
<td style="text-align: left;">Intercept</td>
<td style="text-align: right;">627.5691</td>
<td style="text-align: right;">25.0513</td>
<td style="text-align: right;">16.0853</td>
<td style="text-align: right;">39.0150</td>
<td style="text-align: right;">22.9297</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Days</td>
<td style="text-align: right;">35.8582</td>
<td style="text-align: right;">5.9882</td>
<td style="text-align: right;">4.0253</td>
<td style="text-align: right;">8.9083</td>
<td style="text-align: right;">4.8830</td>
</tr>
<tr class="even">
<td style="text-align: left;">Residual</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">653.5838</td>
<td style="text-align: right;">25.5653</td>
<td style="text-align: right;">22.7918</td>
<td style="text-align: right;">28.6763</td>
<td style="text-align: right;">5.8845</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="estimated-random-effects" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="estimated-random-effects">Estimated random effects</h3>
<p>Now let’s look at the random effect estimates.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>mixed_re_init <span class="ot">=</span> <span class="fu">extract_ranef</span>(mixed_model, <span class="at">digits =</span> <span class="dv">5</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>gam_re_init   <span class="ot">=</span> <span class="fu">extract_ranef</span>(ga_model, <span class="at">digits =</span> <span class="dv">5</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>bam_re_init   <span class="ot">=</span> <span class="fu">extract_ranef</span>(ba_model, <span class="at">digits =</span> <span class="dv">5</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>bam_d_re_init <span class="ot">=</span> <span class="fu">extract_ranef</span>(ba_d_model, <span class="at">digits =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll start with the random effects for the intercept. To several decimal places, we start to see differences, so again we know they aren’t doing exactly the same thing, but they are coming to the same conclusion.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Estimated Random Intercepts</caption>
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">bam_d_re_init</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">bam_re_init</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">gam_re_init</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mixed_re_init</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1.51270</td>
<td style="text-align: right;">1.51270</td>
<td style="text-align: right;">1.51272</td>
<td style="text-align: right;">1.51266</td>
</tr>
<tr class="even">
<td style="text-align: right;">-40.37390</td>
<td style="text-align: right;">-40.37390</td>
<td style="text-align: right;">-40.37397</td>
<td style="text-align: right;">-40.37387</td>
</tr>
<tr class="odd">
<td style="text-align: right;">-39.18104</td>
<td style="text-align: right;">-39.18104</td>
<td style="text-align: right;">-39.18111</td>
<td style="text-align: right;">-39.18103</td>
</tr>
<tr class="even">
<td style="text-align: right;">24.51890</td>
<td style="text-align: right;">24.51890</td>
<td style="text-align: right;">24.51893</td>
<td style="text-align: right;">24.51892</td>
</tr>
<tr class="odd">
<td style="text-align: right;">22.91443</td>
<td style="text-align: right;">22.91443</td>
<td style="text-align: right;">22.91446</td>
<td style="text-align: right;">22.91445</td>
</tr>
<tr class="even">
<td style="text-align: right;">9.22197</td>
<td style="text-align: right;">9.22197</td>
<td style="text-align: right;">9.22199</td>
<td style="text-align: right;">9.22198</td>
</tr>
<tr class="odd">
<td style="text-align: right;">17.15612</td>
<td style="text-align: right;">17.15612</td>
<td style="text-align: right;">17.15614</td>
<td style="text-align: right;">17.15612</td>
</tr>
<tr class="even">
<td style="text-align: right;">-7.45173</td>
<td style="text-align: right;">-7.45173</td>
<td style="text-align: right;">-7.45174</td>
<td style="text-align: right;">-7.45174</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.57872</td>
<td style="text-align: right;">0.57872</td>
<td style="text-align: right;">0.57870</td>
<td style="text-align: right;">0.57876</td>
</tr>
<tr class="even">
<td style="text-align: right;">34.76793</td>
<td style="text-align: right;">34.76793</td>
<td style="text-align: right;">34.76800</td>
<td style="text-align: right;">34.76790</td>
</tr>
<tr class="odd">
<td style="text-align: right;">-25.75432</td>
<td style="text-align: right;">-25.75432</td>
<td style="text-align: right;">-25.75436</td>
<td style="text-align: right;">-25.75433</td>
</tr>
<tr class="even">
<td style="text-align: right;">-13.86504</td>
<td style="text-align: right;">-13.86504</td>
<td style="text-align: right;">-13.86504</td>
<td style="text-align: right;">-13.86506</td>
</tr>
<tr class="odd">
<td style="text-align: right;">4.91598</td>
<td style="text-align: right;">4.91598</td>
<td style="text-align: right;">4.91598</td>
<td style="text-align: right;">4.91599</td>
</tr>
<tr class="even">
<td style="text-align: right;">20.92904</td>
<td style="text-align: right;">20.92904</td>
<td style="text-align: right;">20.92908</td>
<td style="text-align: right;">20.92903</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3.25865</td>
<td style="text-align: right;">3.25865</td>
<td style="text-align: right;">3.25865</td>
<td style="text-align: right;">3.25864</td>
</tr>
<tr class="even">
<td style="text-align: right;">-26.47583</td>
<td style="text-align: right;">-26.47583</td>
<td style="text-align: right;">-26.47585</td>
<td style="text-align: right;">-26.47585</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.90565</td>
<td style="text-align: right;">0.90565</td>
<td style="text-align: right;">0.90565</td>
<td style="text-align: right;">0.90565</td>
</tr>
<tr class="even">
<td style="text-align: right;">12.42176</td>
<td style="text-align: right;">12.42176</td>
<td style="text-align: right;">12.42178</td>
<td style="text-align: right;">12.42175</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Random effects for the Days coefficient.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Estimated Random Intercepts</caption>
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">bam_d_re_init</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">bam_re_init</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">gam_re_init</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">mixed_re_init</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">9.32349</td>
<td style="text-align: right;">9.32349</td>
<td style="text-align: right;">9.32348</td>
<td style="text-align: right;">9.32350</td>
</tr>
<tr class="even">
<td style="text-align: right;">-8.59917</td>
<td style="text-align: right;">-8.59917</td>
<td style="text-align: right;">-8.59916</td>
<td style="text-align: right;">-8.59918</td>
</tr>
<tr class="odd">
<td style="text-align: right;">-5.38779</td>
<td style="text-align: right;">-5.38779</td>
<td style="text-align: right;">-5.38778</td>
<td style="text-align: right;">-5.38779</td>
</tr>
<tr class="even">
<td style="text-align: right;">-4.96865</td>
<td style="text-align: right;">-4.96865</td>
<td style="text-align: right;">-4.96865</td>
<td style="text-align: right;">-4.96865</td>
</tr>
<tr class="odd">
<td style="text-align: right;">-3.19393</td>
<td style="text-align: right;">-3.19393</td>
<td style="text-align: right;">-3.19394</td>
<td style="text-align: right;">-3.19394</td>
</tr>
<tr class="even">
<td style="text-align: right;">-0.30849</td>
<td style="text-align: right;">-0.30849</td>
<td style="text-align: right;">-0.30850</td>
<td style="text-align: right;">-0.30849</td>
</tr>
<tr class="odd">
<td style="text-align: right;">-0.28721</td>
<td style="text-align: right;">-0.28721</td>
<td style="text-align: right;">-0.28721</td>
<td style="text-align: right;">-0.28721</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.11599</td>
<td style="text-align: right;">1.11599</td>
<td style="text-align: right;">1.11599</td>
<td style="text-align: right;">1.11599</td>
</tr>
<tr class="odd">
<td style="text-align: right;">-10.90597</td>
<td style="text-align: right;">-10.90597</td>
<td style="text-align: right;">-10.90596</td>
<td style="text-align: right;">-10.90598</td>
</tr>
<tr class="even">
<td style="text-align: right;">8.62762</td>
<td style="text-align: right;">8.62762</td>
<td style="text-align: right;">8.62760</td>
<td style="text-align: right;">8.62762</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1.28069</td>
<td style="text-align: right;">1.28069</td>
<td style="text-align: right;">1.28069</td>
<td style="text-align: right;">1.28069</td>
</tr>
<tr class="even">
<td style="text-align: right;">6.75640</td>
<td style="text-align: right;">6.75640</td>
<td style="text-align: right;">6.75640</td>
<td style="text-align: right;">6.75641</td>
</tr>
<tr class="odd">
<td style="text-align: right;">-3.07513</td>
<td style="text-align: right;">-3.07513</td>
<td style="text-align: right;">-3.07513</td>
<td style="text-align: right;">-3.07514</td>
</tr>
<tr class="even">
<td style="text-align: right;">3.51221</td>
<td style="text-align: right;">3.51221</td>
<td style="text-align: right;">3.51220</td>
<td style="text-align: right;">3.51221</td>
</tr>
<tr class="odd">
<td style="text-align: right;">0.87305</td>
<td style="text-align: right;">0.87305</td>
<td style="text-align: right;">0.87305</td>
<td style="text-align: right;">0.87305</td>
</tr>
<tr class="even">
<td style="text-align: right;">4.98379</td>
<td style="text-align: right;">4.98379</td>
<td style="text-align: right;">4.98379</td>
<td style="text-align: right;">4.98379</td>
</tr>
<tr class="odd">
<td style="text-align: right;">-1.00529</td>
<td style="text-align: right;">-1.00529</td>
<td style="text-align: right;">-1.00529</td>
<td style="text-align: right;">-1.00529</td>
</tr>
<tr class="even">
<td style="text-align: right;">1.25840</td>
<td style="text-align: right;">1.25840</td>
<td style="text-align: right;">1.25840</td>
<td style="text-align: right;">1.25840</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Standard errors for the random effects. In the balanced design these are essentially constant across clusters. We can see that the Bayesian estimates from <span class="pack" style="">mgcv</span> reflect greater uncertainty.</p>
<div class="page-columns page-full"><p></p><div class="no-row-height column-margin column-container"><span class="margin-aside">The <span class="func" style="">bam</span> results may actually be slightly different for some clusters.</span></div></div>
<p><br></p>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Standard Errors of the Random Coefficients</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Model</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Intercepts</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">Days</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">mixed</td>
<td style="text-align: right;">12.239</td>
<td style="text-align: right;">2.335</td>
</tr>
<tr class="even">
<td style="text-align: left;">gam</td>
<td style="text-align: right;">13.279</td>
<td style="text-align: right;">2.673</td>
</tr>
<tr class="odd">
<td style="text-align: left;">bam</td>
<td style="text-align: right;">13.279</td>
<td style="text-align: right;">2.673</td>
</tr>
<tr class="even">
<td style="text-align: left;">bam_discrete</td>
<td style="text-align: right;">13.279</td>
<td style="text-align: right;">2.673</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="comparisons-to-bayesian-estimates" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="comparisons-to-bayesian-estimates">Comparisons to Bayesian Estimates</h3>
<p>As we have noted, one of the differences between <span class="pack" style="">lme4</span> and <span class="pack" style="">mgcv</span> output is that the default uncertainty estimates for the GAM are Bayesian. As such, it might be interesting to compare these to a fully Bayes approach. We’ll use <span class="pack" style="">rstanarm</span>, which uses the <span class="pack" style="">lme4</span> style syntax.</p>
<div class="page-columns page-full"><p></p><div class="no-row-height column-margin column-container"><span class="margin-aside">For those familiar with Bayesian models, the Stan group provides a vignette with information about the <a href="http://mc-stan.org/rstanarm/articles/glmer.html">priors in this model and comparisons to lme4 and gamm4</a>.</span></div></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rstanarm)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>bayes <span class="ot">=</span> <span class="fu">stan_lmer</span>(Reaction <span class="sc">~</span> Days <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>Subject) <span class="sc">+</span> (<span class="dv">0</span> <span class="sc">+</span> Days<span class="sc">|</span>Subject), </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> sleepstudy,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">cores =</span> <span class="dv">4</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>bayes_fe <span class="ot">=</span> <span class="fu">extract_fixed_effects</span>(bayes)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>bayes_vc <span class="ot">=</span> <span class="fu">extract_vc</span>(bayes)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>bayes_re <span class="ot">=</span> <span class="fu">extract_random_effects</span>(bayes)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Bayesian fixed effects</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">term</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">value</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">se</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">lower_2.5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">upper_97.5</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: right;">251.276</td>
<td style="text-align: right;">7.054</td>
<td style="text-align: right;">237.681</td>
<td style="text-align: right;">265.017</td>
</tr>
<tr class="even">
<td style="text-align: left;">Days</td>
<td style="text-align: right;">10.415</td>
<td style="text-align: right;">1.695</td>
<td style="text-align: right;">7.156</td>
<td style="text-align: right;">13.757</td>
</tr>
</tbody>
</table>


</div>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Bayesian variance components</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">group</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">effect</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">variance</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd_2.5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd_97.5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">var_prop</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Subject</td>
<td style="text-align: left;">Intercept</td>
<td style="text-align: right;">697.634</td>
<td style="text-align: right;">26.413</td>
<td style="text-align: right;">15.909</td>
<td style="text-align: right;">39.397</td>
<td style="text-align: right;">0.497</td>
</tr>
<tr class="even">
<td style="text-align: left;">Subject</td>
<td style="text-align: left;">Days</td>
<td style="text-align: right;">43.464</td>
<td style="text-align: right;">6.593</td>
<td style="text-align: right;">4.253</td>
<td style="text-align: right;">9.501</td>
<td style="text-align: right;">0.031</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Residual</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">662.481</td>
<td style="text-align: right;">25.739</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0.472</td>
</tr>
</tbody>
</table>


</div>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Bayesian random effects</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">effect</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">group</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">value</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">se</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">lower_2.5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">upper_97.5</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">308</td>
<td style="text-align: right;">1.421</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-22.778</td>
<td style="text-align: right;">25.621</td>
</tr>
<tr class="even">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">309</td>
<td style="text-align: right;">-39.502</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-63.701</td>
<td style="text-align: right;">-15.302</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">310</td>
<td style="text-align: right;">-38.157</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-62.356</td>
<td style="text-align: right;">-13.957</td>
</tr>
<tr class="even">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">330</td>
<td style="text-align: right;">23.994</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-0.205</td>
<td style="text-align: right;">48.194</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">331</td>
<td style="text-align: right;">22.666</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-1.533</td>
<td style="text-align: right;">46.866</td>
</tr>
<tr class="even">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">332</td>
<td style="text-align: right;">9.140</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-15.060</td>
<td style="text-align: right;">33.339</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">333</td>
<td style="text-align: right;">16.476</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-7.724</td>
<td style="text-align: right;">40.676</td>
</tr>
<tr class="even">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">334</td>
<td style="text-align: right;">-7.232</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-31.432</td>
<td style="text-align: right;">16.968</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">335</td>
<td style="text-align: right;">0.946</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-23.254</td>
<td style="text-align: right;">25.145</td>
</tr>
<tr class="even">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">337</td>
<td style="text-align: right;">33.940</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">9.741</td>
<td style="text-align: right;">58.140</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">349</td>
<td style="text-align: right;">-25.148</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-49.347</td>
<td style="text-align: right;">-0.948</td>
</tr>
<tr class="even">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">350</td>
<td style="text-align: right;">-13.861</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-38.061</td>
<td style="text-align: right;">10.338</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">351</td>
<td style="text-align: right;">5.064</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-19.136</td>
<td style="text-align: right;">29.263</td>
</tr>
<tr class="even">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">352</td>
<td style="text-align: right;">20.650</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-3.550</td>
<td style="text-align: right;">44.849</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">369</td>
<td style="text-align: right;">3.039</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-21.161</td>
<td style="text-align: right;">27.238</td>
</tr>
<tr class="even">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">370</td>
<td style="text-align: right;">-25.923</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-50.123</td>
<td style="text-align: right;">-1.724</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">371</td>
<td style="text-align: right;">1.149</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-23.051</td>
<td style="text-align: right;">25.348</td>
</tr>
<tr class="even">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">372</td>
<td style="text-align: right;">12.153</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-12.047</td>
<td style="text-align: right;">36.353</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">308</td>
<td style="text-align: right;">9.406</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">4.668</td>
<td style="text-align: right;">14.143</td>
</tr>
<tr class="even">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">309</td>
<td style="text-align: right;">-8.680</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-13.417</td>
<td style="text-align: right;">-3.942</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">310</td>
<td style="text-align: right;">-5.383</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-10.120</td>
<td style="text-align: right;">-0.645</td>
</tr>
<tr class="even">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">330</td>
<td style="text-align: right;">-4.862</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-9.599</td>
<td style="text-align: right;">-0.124</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">331</td>
<td style="text-align: right;">-3.052</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-7.790</td>
<td style="text-align: right;">1.685</td>
</tr>
<tr class="even">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">332</td>
<td style="text-align: right;">-0.274</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-5.011</td>
<td style="text-align: right;">4.464</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">333</td>
<td style="text-align: right;">-0.119</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-4.857</td>
<td style="text-align: right;">4.618</td>
</tr>
<tr class="even">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">334</td>
<td style="text-align: right;">1.189</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-3.549</td>
<td style="text-align: right;">5.927</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">335</td>
<td style="text-align: right;">-10.870</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-15.607</td>
<td style="text-align: right;">-6.132</td>
</tr>
<tr class="even">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">337</td>
<td style="text-align: right;">8.819</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">4.081</td>
<td style="text-align: right;">13.557</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">349</td>
<td style="text-align: right;">1.280</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-3.457</td>
<td style="text-align: right;">6.018</td>
</tr>
<tr class="even">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">350</td>
<td style="text-align: right;">6.778</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">2.040</td>
<td style="text-align: right;">11.515</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">351</td>
<td style="text-align: right;">-3.036</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-7.773</td>
<td style="text-align: right;">1.702</td>
</tr>
<tr class="even">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">352</td>
<td style="text-align: right;">3.589</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-1.149</td>
<td style="text-align: right;">8.326</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">369</td>
<td style="text-align: right;">0.940</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-3.797</td>
<td style="text-align: right;">5.678</td>
</tr>
<tr class="even">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">370</td>
<td style="text-align: right;">4.968</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">0.231</td>
<td style="text-align: right;">9.706</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">371</td>
<td style="text-align: right;">-0.979</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-5.717</td>
<td style="text-align: right;">3.758</td>
</tr>
<tr class="even">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">372</td>
<td style="text-align: right;">1.359</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-3.378</td>
<td style="text-align: right;">6.097</td>
</tr>
</tbody>
</table>


</div>
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Random effect standard errors</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">effect</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">group</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">value</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">se</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">lower_2.5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">upper_97.5</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">308</td>
<td style="text-align: right;">1.421</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-22.778</td>
<td style="text-align: right;">25.621</td>
</tr>
<tr class="even">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">309</td>
<td style="text-align: right;">-39.502</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-63.701</td>
<td style="text-align: right;">-15.302</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">310</td>
<td style="text-align: right;">-38.157</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-62.356</td>
<td style="text-align: right;">-13.957</td>
</tr>
<tr class="even">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">330</td>
<td style="text-align: right;">23.994</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-0.205</td>
<td style="text-align: right;">48.194</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">331</td>
<td style="text-align: right;">22.666</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-1.533</td>
<td style="text-align: right;">46.866</td>
</tr>
<tr class="even">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">332</td>
<td style="text-align: right;">9.140</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-15.060</td>
<td style="text-align: right;">33.339</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">333</td>
<td style="text-align: right;">16.476</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-7.724</td>
<td style="text-align: right;">40.676</td>
</tr>
<tr class="even">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">334</td>
<td style="text-align: right;">-7.232</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-31.432</td>
<td style="text-align: right;">16.968</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">335</td>
<td style="text-align: right;">0.946</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-23.254</td>
<td style="text-align: right;">25.145</td>
</tr>
<tr class="even">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">337</td>
<td style="text-align: right;">33.940</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">9.741</td>
<td style="text-align: right;">58.140</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">349</td>
<td style="text-align: right;">-25.148</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-49.347</td>
<td style="text-align: right;">-0.948</td>
</tr>
<tr class="even">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">350</td>
<td style="text-align: right;">-13.861</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-38.061</td>
<td style="text-align: right;">10.338</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">351</td>
<td style="text-align: right;">5.064</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-19.136</td>
<td style="text-align: right;">29.263</td>
</tr>
<tr class="even">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">352</td>
<td style="text-align: right;">20.650</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-3.550</td>
<td style="text-align: right;">44.849</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">369</td>
<td style="text-align: right;">3.039</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-21.161</td>
<td style="text-align: right;">27.238</td>
</tr>
<tr class="even">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">370</td>
<td style="text-align: right;">-25.923</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-50.123</td>
<td style="text-align: right;">-1.724</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">371</td>
<td style="text-align: right;">1.149</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-23.051</td>
<td style="text-align: right;">25.348</td>
</tr>
<tr class="even">
<td style="text-align: left;">Intercept</td>
<td style="text-align: left;">372</td>
<td style="text-align: right;">12.153</td>
<td style="text-align: right;">12.347</td>
<td style="text-align: right;">-12.047</td>
<td style="text-align: right;">36.353</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">308</td>
<td style="text-align: right;">9.406</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">4.668</td>
<td style="text-align: right;">14.143</td>
</tr>
<tr class="even">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">309</td>
<td style="text-align: right;">-8.680</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-13.417</td>
<td style="text-align: right;">-3.942</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">310</td>
<td style="text-align: right;">-5.383</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-10.120</td>
<td style="text-align: right;">-0.645</td>
</tr>
<tr class="even">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">330</td>
<td style="text-align: right;">-4.862</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-9.599</td>
<td style="text-align: right;">-0.124</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">331</td>
<td style="text-align: right;">-3.052</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-7.790</td>
<td style="text-align: right;">1.685</td>
</tr>
<tr class="even">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">332</td>
<td style="text-align: right;">-0.274</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-5.011</td>
<td style="text-align: right;">4.464</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">333</td>
<td style="text-align: right;">-0.119</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-4.857</td>
<td style="text-align: right;">4.618</td>
</tr>
<tr class="even">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">334</td>
<td style="text-align: right;">1.189</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-3.549</td>
<td style="text-align: right;">5.927</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">335</td>
<td style="text-align: right;">-10.870</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-15.607</td>
<td style="text-align: right;">-6.132</td>
</tr>
<tr class="even">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">337</td>
<td style="text-align: right;">8.819</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">4.081</td>
<td style="text-align: right;">13.557</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">349</td>
<td style="text-align: right;">1.280</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-3.457</td>
<td style="text-align: right;">6.018</td>
</tr>
<tr class="even">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">350</td>
<td style="text-align: right;">6.778</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">2.040</td>
<td style="text-align: right;">11.515</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">351</td>
<td style="text-align: right;">-3.036</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-7.773</td>
<td style="text-align: right;">1.702</td>
</tr>
<tr class="even">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">352</td>
<td style="text-align: right;">3.589</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-1.149</td>
<td style="text-align: right;">8.326</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">369</td>
<td style="text-align: right;">0.940</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-3.797</td>
<td style="text-align: right;">5.678</td>
</tr>
<tr class="even">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">370</td>
<td style="text-align: right;">4.968</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">0.231</td>
<td style="text-align: right;">9.706</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">371</td>
<td style="text-align: right;">-0.979</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-5.717</td>
<td style="text-align: right;">3.758</td>
</tr>
<tr class="even">
<td style="text-align: left;">Days</td>
<td style="text-align: left;">372</td>
<td style="text-align: right;">1.359</td>
<td style="text-align: right;">2.417</td>
<td style="text-align: right;">-3.378</td>
<td style="text-align: right;">6.097</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>We can see that the <span class="pack" style="">mgcv</span> estimates for standard errors of the random effects are close to the average standard errors from the fully Bayesian approach. For the Bayesian result we have 12.347 and 2.417 for Intercept and Days coefficient respectively, while for <span class="pack" style="">mgcv</span> this is 13.27913 and 2.67273.</p>
</section>
</section>
<section id="back-to-the-initial-problem" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="back-to-the-initial-problem">Back to the initial problem</h2>
<p>So we’ve established that both default <span class="func" style="">gam</span> and <span class="func" style="">bam</span> functions are providing what we want. However, the reason we’re here is to use demonstrate the speed gain we’ll get with big data using <span class="pack" style="">mgcv</span> for mixed models. So let’s return to the binary outcome example that took over a minute for <span class="pack" style="">lme4</span> to run.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  bam_big <span class="ot">&lt;-</span> <span class="fu">bam</span>(</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    y_bin <span class="sc">~</span> x <span class="sc">+</span> b <span class="sc">+</span> <span class="fu">s</span>(g, <span class="at">bs=</span><span class="st">'re'</span>), </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> d,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">nthreads =</span> <span class="dv">8</span>,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> binomial</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
    user   system  elapsed 
8164.817  120.570 1298.584 </code></pre>
</div>
</div>
<p>That didn’t actually improve our situation, and was much worse in time- more than 20 minutes! Remember though, that the <span class="pack" style="">mgcv</span> approach has to estimate all those random effect coefficients, while <span class="pack" style="">lme4</span> is able to take advantage of design for mixed models among other things.</p>
<p>However, even here we haven’t used all our secret weapons. Another option with <span class="func" style="">bam</span> works on a modified data set using binned/rounded values for continuous covariates, and working with only the minimum data necessary to estimate the coefficients<span class="citation" data-cites="wood_generalized_2015">(<a href="#ref-wood_generalized_2015" role="doc-biblioref">S. N. Wood, Goude, and Shaw 2015a</a>)</span>. With large enough data, as is the case here, the estimated parameters might not be different at all, while the efficiency gains could be tremendous. Let’s add <code>discrete = TRUE</code> and see what happens.</p>
<div class="page-columns page-full"><p></p><div class="no-row-height column-margin column-container"><span class="margin-aside">We just need the distinct set of values after rounding.</span></div></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>({</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  bam_big_d <span class="ot">&lt;-</span> <span class="fu">bam</span>(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    y_bin <span class="sc">~</span> x <span class="sc">+</span> b <span class="sc">+</span> <span class="fu">s</span>(g, <span class="at">bs=</span><span class="st">'re'</span>), </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> d,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">nthreads =</span> <span class="dv">8</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> binomial, </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">discrete =</span> <span class="cn">TRUE</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
   user  system elapsed 
 43.542   2.649  12.387 
    </code></pre>
</div>
</div>
<p><strong>Wow!</strong> That was almost as fast as <span class="pack" style="">lme4</span> with the linear mixed model! Let’s check the results. We’ll start with the fixed effects. I add some digits to the result so we can see the very slight differences.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Fixed Effects</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Model</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">term</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">value</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">se</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">lower_2.5</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">upper_97.5</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">True</td>
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">0.00000000</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">True</td>
<td style="text-align: left;">x</td>
<td style="text-align: right;">0.50000000</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="odd">
<td style="text-align: left;">True</td>
<td style="text-align: left;">b</td>
<td style="text-align: right;">0.25000000</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">NA</td>
</tr>
<tr class="even">
<td style="text-align: left;">bam_big</td>
<td style="text-align: left;">Intercept</td>
<td style="text-align: right;">0.03730496</td>
<td style="text-align: right;">0.02257804</td>
<td style="text-align: right;">-0.00694725</td>
<td style="text-align: right;">0.08155716</td>
</tr>
<tr class="odd">
<td style="text-align: left;">bam_big</td>
<td style="text-align: left;">x</td>
<td style="text-align: right;">0.50087021</td>
<td style="text-align: right;">0.00223195</td>
<td style="text-align: right;">0.49649565</td>
<td style="text-align: right;">0.50524476</td>
</tr>
<tr class="even">
<td style="text-align: left;">bam_big</td>
<td style="text-align: left;">b</td>
<td style="text-align: right;">0.19083417</td>
<td style="text-align: right;">0.03209232</td>
<td style="text-align: right;">0.12793430</td>
<td style="text-align: right;">0.25373405</td>
</tr>
<tr class="odd">
<td style="text-align: left;">bam_big_d</td>
<td style="text-align: left;">Intercept</td>
<td style="text-align: right;">0.03730460</td>
<td style="text-align: right;">0.02257842</td>
<td style="text-align: right;">-0.00694835</td>
<td style="text-align: right;">0.08155755</td>
</tr>
<tr class="even">
<td style="text-align: left;">bam_big_d</td>
<td style="text-align: left;">x</td>
<td style="text-align: right;">0.50087441</td>
<td style="text-align: right;">0.00223195</td>
<td style="text-align: right;">0.49649987</td>
<td style="text-align: right;">0.50524895</td>
</tr>
<tr class="odd">
<td style="text-align: left;">bam_big_d</td>
<td style="text-align: left;">b</td>
<td style="text-align: right;">0.19083450</td>
<td style="text-align: right;">0.03209286</td>
<td style="text-align: right;">0.12793357</td>
<td style="text-align: right;">0.25373543</td>
</tr>
<tr class="even">
<td style="text-align: left;">mixed_big_glmm</td>
<td style="text-align: left;">Intercept</td>
<td style="text-align: right;">0.03734700</td>
<td style="text-align: right;">0.02254374</td>
<td style="text-align: right;">-0.00683792</td>
<td style="text-align: right;">0.08153193</td>
</tr>
<tr class="odd">
<td style="text-align: left;">mixed_big_glmm</td>
<td style="text-align: left;">x</td>
<td style="text-align: right;">0.50136881</td>
<td style="text-align: right;">0.00223342</td>
<td style="text-align: right;">0.49699138</td>
<td style="text-align: right;">0.50574624</td>
</tr>
<tr class="even">
<td style="text-align: left;">mixed_big_glmm</td>
<td style="text-align: left;">b</td>
<td style="text-align: right;">0.19104484</td>
<td style="text-align: right;">0.03205912</td>
<td style="text-align: right;">0.12821011</td>
<td style="text-align: right;">0.25387957</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Now for the variance components.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Variance Components</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">Model</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">sd</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">variance</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">true</td>
<td style="text-align: right;">0.500</td>
<td style="text-align: right;">0.250</td>
</tr>
<tr class="even">
<td style="text-align: left;">bam_big</td>
<td style="text-align: right;">0.503</td>
<td style="text-align: right;">0.253</td>
</tr>
<tr class="odd">
<td style="text-align: left;">bam_big_d</td>
<td style="text-align: right;">0.503</td>
<td style="text-align: right;">0.253</td>
</tr>
<tr class="even">
<td style="text-align: left;">lme4</td>
<td style="text-align: right;">0.503</td>
<td style="text-align: right;">0.253</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>And finally, let’s look at the estimated random effects for the first 5 clusters.</p>
<div class="page-columns page-full"><p></p><div class="no-row-height column-margin column-container"><span class="margin-aside">Just a note, unless you have very many observations per cluster, you should not expect to get very close to the true values of the random effects except on average, which should serve as a caution for any 2-step approach one might undertake using the estimates. The rank correlations of the estimates vs.&nbsp;the true values in this example are 1.0.</span></div></div>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<caption>Estimated Random Effects</caption>
<thead>
<tr class="header">
<th style="text-align: left;" data-quarto-table-cell-role="th">cluster</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">true</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">bam_big</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">bam_big_d</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">lme4</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">1</td>
<td style="text-align: right;">0.0912404</td>
<td style="text-align: right;">-0.036</td>
<td style="text-align: right;">-0.036</td>
<td style="text-align: right;">-0.036</td>
</tr>
<tr class="even">
<td style="text-align: left;">2</td>
<td style="text-align: right;">0.1310768</td>
<td style="text-align: right;">0.148</td>
<td style="text-align: right;">0.148</td>
<td style="text-align: right;">0.148</td>
</tr>
<tr class="odd">
<td style="text-align: left;">3</td>
<td style="text-align: right;">-0.0562572</td>
<td style="text-align: right;">-0.142</td>
<td style="text-align: right;">-0.143</td>
<td style="text-align: right;">-0.143</td>
</tr>
<tr class="even">
<td style="text-align: left;">4</td>
<td style="text-align: right;">0.6194238</td>
<td style="text-align: right;">0.556</td>
<td style="text-align: right;">0.556</td>
<td style="text-align: right;">0.556</td>
</tr>
<tr class="odd">
<td style="text-align: left;">5</td>
<td style="text-align: right;">-0.5022289</td>
<td style="text-align: right;">-0.415</td>
<td style="text-align: right;">-0.415</td>
<td style="text-align: right;">-0.415</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>So we’re getting what we should in general.</p>
</section>
<section id="when-to-use-bam" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="when-to-use-bam">When to use bam</h2>
<p>The following are some guidelines for when <span class="func" style="">bam</span> might be preferable compared to other mixed modeling tools. To help with this, I’ve conducted my own examinations on very large data sets of up to <a href="#simulation-settings">one million observations</a>, and included timing results from other relevant studies, which will be presented here.</p>
<section id="linear-mixed-models" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="linear-mixed-models">Linear Mixed Models</h3>
<p>As we’ll see, in general you’ll probably need very large data for <span class="func" style="">bam</span> to be preferred to <span class="pack" style="">lme4</span> for linear mixed models unless:</p>
<ul>
<li>You have complicated structure that begins to bog down lme4</li>
<li>You want to add smooth terms<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></li>
<li>You have memory issues</li>
<li>You have a computing setup that can take advantage of <span class="func" style="">bam</span></li>
</ul>
<p>The following shows some timings for <span class="pack" style="">lme4</span>, <span class="pack" style="">glmmTMB</span>, and <span class="pack" style="">mgcv</span> for the linear mixed model case under a variety of settings with large data. In some sense, this is not exactly a fair comparison as <span class="pack" style="">mgcv</span> parallelizes computations while <span class="pack" style="">lme4</span> and <span class="pack" style="">glmmTMB</span> do not. However, this is also exactly the point of the demonstration - those who can, do. In general though, the <span class="pack" style="">lme4</span> advantage holds until around 500k observations. We can see that the main issue for <span class="func" style="">bam</span> is not so much the sample size, but the number of parameters to estimate.</p>
<div class="page-columns page-full"><p></p><div class="no-row-height column-margin column-container"><span class="margin-aside">For <span class="pack" style="">lme4</span>, I set at least one argument to possibly improve speed/performance for both lme and glmm models, though this only shaved a few seconds for the largest sample size settings for the linear mixed model. For <span class="pack" style="">mgcv</span> I only used 12 cores for parallelization so as to be similar to what is common on modern machines (8-12), but anyone with access to a better machine or cluster computing environment would see even more speed gain by utilizing additional cores, so I also looked at 16 cores. For <span class="pack" style="">glmmTMB</span>, settings were left at defaults, as I’ve not come across any specific speed recommendations. See Brooks et al.<span class="citation" data-cites="brooks_glmmtmb_2017">(<a href="#ref-brooks_glmmtmb_2017" role="doc-biblioref">Brooks et al. 2017</a>)</span> (<span class="citation" data-cites="brooks_glmmtmb_2017">Brooks et al. (<a href="#ref-brooks_glmmtmb_2017" role="doc-biblioref">2017</a>)</span>) for more speed comparisons of <span class="pack" style="">glmmTMB</span>, <span class="pack" style="">mgcv</span>, <span class="pack" style="">lme4</span>, and others, as well as the <a href="https://cran.r-project.org/web/packages/glmmTMB/vignettes/glmmTMB.pdf">glmmTMB vignette</a>.</span></div></div>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/lme-timings-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="generalized-linear-mixed-models" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="generalized-linear-mixed-models">Generalized Linear Mixed Models</h3>
<p>For the generalized setting with binary, count, and other outcomes:</p>
<ul>
<li><span class="pack" style="">lme4</span>, at least at the time of this writing, will almost certainly start giving convergence warnings even in well-behaved data settings, and as such, will require tweaking to mitigate.</li>
<li><span class="pack" style="">glmmTMB</span> is probably viable up to 100k and one or two random effects, but may generally be a slower option.</li>
<li>Use <span class="pack" style="">mgcv</span> for same reasons as with linear mixed models, but here it potentially becomes an advantage with as few as 100k.</li>
</ul>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/gmm-timings-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="page-columns page-full"><p></p><div class="no-row-height column-margin column-container"><span class="margin-aside">I have also done some timings on a local machine with as many as 10000 levels for one of the random effects, 1000 for the other, and 5 million observations. Depending on the computational setup, this could take 30 minutes for a linear mixed model and 24 cores, to 2-3 hours for a logistic mixed model using 12 cores.</span></div></div>
</section>
<section id="other-options" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="other-options">Other options</h3>
<p>When looking into mixed models for big data, you typically won’t find much in the way of options. I’ve seen some packages or offerings for some machine learning approaches like random forests<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>, but this doesn’t address the issue of large data. A Spark module provided by LinkedIn is available, <a href="https://github.com/linkedin/photon-ml">photonML</a>, but it’s not clear how easy it is to implement. Julia has recently made multithreading a viable option for any function. This is notable since Doug Bates, one of the <span class="pack" style="">lme4</span> authors, develops the <a href="https://github.com/dmbates/MixedModels.jl">MixedModels</a> module for Julia. Should multithreading functionality be added, it could be a very powerful tool<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>.</p>
<p>Among proprietary options, SAS and Stata are the more commonly used tools. SAS PROC HPMIXED essentially uses the <span class="pack" style="">lme4</span> approach, but can be faster for well-behaved data. Stata, while commonly used for mixed models, is generally slower than the <span class="pack" style="">lme4</span> even for standard settings, and is likely prohibitively slow for settings above<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>.</p>
<div class="page-columns page-full"><p></p><div class="no-row-height column-margin column-container"><span class="margin-aside">SAS uses disk rather than RAM for processing, so may be preferred for low RAM devices.</span></div></div>
<p>Here is a summary of other timings of various tools for mixed models.</p>
<section id="mccoach-et-al.-2018" class="level5">
<h5 class="anchored" data-anchor-id="mccoach-et-al.-2018">McCoach et al.&nbsp;2018</h5>
<p>These are the results from McCoach et al.<span class="citation" data-cites="mccoach2018">(<a href="#ref-mccoach2018" role="doc-biblioref">McCoach et al. 2018</a>)</span> with a standard linear mixed model. Sample size fixed at 10000, with a single grouping factor with only 50 levels. Models included five covariates each with a random slope. In the first five cases, a true variance parameter was set to zero, a situation <span class="pack" style="">lme4</span> handles well<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>. SAS is very speedy for such settings if data is well-behaved.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="../../img/bam/mccoach.png" class="img-fluid figure-img" width="618"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="brooks-et-al.-2018-timing-as-a-function-of-sample-size" class="level5">
<h5 class="anchored" data-anchor-id="brooks-et-al.-2018-timing-as-a-function-of-sample-size">Brooks et al.&nbsp;2018 timing as a function of sample size</h5>
<p>Brooks et al.&nbsp;uses the Salamander data from the <span class="pack" style="">glmmTMB</span> package. It has a single grouping factor for the random effect with 23 levels. Starting sample size is 644, which is then replicated to produce larger data. This is a negative binomial count model. In this particular setting <span class="pack" style="">glmmTMB</span> has an advantage.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="../../img/bam/brooks_n.png" class="img-fluid figure-img" width="453"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="brooks-et-al.-2018-timing-as-a-function-of-number-of-levels" class="level5">
<h5 class="anchored" data-anchor-id="brooks-et-al.-2018-timing-as-a-function-of-number-of-levels">Brooks et al.&nbsp;2018 timing as a function of number of levels</h5>
<p>This data is simulated based on models from the previous, and adds increasing numbers of (balanced) levels to the random effect. This shows a similar effect of the number of levels on <span class="pack" style="">mgcv</span> as the simulation presented in this post, though they are not using the functionality of <span class="func" style="">bam</span>.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="../../img/bam/brooks_nlevels.png" class="img-fluid figure-img" width="451"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="glmmtmb-timings" class="level5">
<h5 class="anchored" data-anchor-id="glmmtmb-timings">glmmTMB timings</h5>
<p>As previously noted, depending on the data, and whether the target is assumed gaussian or not, <span class="pack" style="">glmmTMB</span> might be preferable. For the following, in the first case a small data set was replicated to create larger data, and in the second, a larger data set was sub-sampled<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>. The advantage is to <span class="pack" style="">glmmTMB</span> in the first case, and <span class="pack" style="">lme4</span> in the second.</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="../../img/bam/tmb_vignette_larger_contra.png" class="img-fluid figure-img" width="329"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="../../img/bam/tmb_vignette_larger_insteval.png" class="img-fluid figure-img" width="333"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="limitations" class="level2">
<h2 class="anchored" data-anchor-id="limitations">Limitations</h2>
<p>There are limitations to the use of the <span class="pack" style="">mgcv</span> approach.</p>
<ul>
<li>The number of parameters to estimate increases with the number of random effect levels, which may void any gains until very large data with complex models</li>
<li>No estimation of random effect correlations, e.g.&nbsp;between slopes and intercepts</li>
</ul>
<p>All in all, these are pretty minor, and the last one likely will be remedied in a future release.</p>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>The take home point here is that you now have viable tools to run mixed models on even very large data with millions of observations. This doesn’t mean you won’t have to wait for it, especially for more complicated models, but you may even be able to run some of these on standard machines in reasonable times. The alternative estimation procedures may even make otherwise problematic models more feasible in smaller data settings. Good luck!</p>
</section>
<section id="supplemental" class="level2">
<h2 class="anchored" data-anchor-id="supplemental">Supplemental</h2>
<section id="simulation-settings" class="level3">
<h3 class="anchored" data-anchor-id="simulation-settings">Simulation Settings</h3>
<p>I will set up a repo with the simulation code at some point and link it here. But the settings for the timings can be summarized as follows.</p>
<section id="linear-mixed-model" class="level4">
<h4 class="anchored" data-anchor-id="linear-mixed-model">Linear mixed model</h4>
<p>The following are for the linear mixed model. <code>N</code> is the sample size, balanced refers to whether a random 75% sample was taken with proportion equivalent to the group index (first grouping variable for both 1 and 2 random effect settings), and <code>tau_2</code> is zero if there is only one random effect, or refers to the standard deviation of the second random effect. Each of these settings was run 5 times, and the previous visualizations display the average timing of those.</p>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">N</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">balanced</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">tau_2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1e+04</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="even">
<td style="text-align: right;">1e+04</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.5</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1e+04</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="even">
<td style="text-align: right;">1e+04</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.5</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5e+04</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="even">
<td style="text-align: right;">5e+04</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.5</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5e+04</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="even">
<td style="text-align: right;">5e+04</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.5</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1e+05</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="even">
<td style="text-align: right;">1e+05</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.5</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1e+05</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="even">
<td style="text-align: right;">1e+05</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.5</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5e+05</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="even">
<td style="text-align: right;">5e+05</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.5</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5e+05</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="even">
<td style="text-align: right;">5e+05</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.5</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1e+06</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="even">
<td style="text-align: right;">1e+06</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.5</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1e+06</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.0</td>
</tr>
<tr class="even">
<td style="text-align: right;">1e+06</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.5</td>
</tr>
</tbody>
</table>


</div>
</div>
<p>Held constant are:</p>
<ul>
<li>The number of covariates: 20, all drawn from a standardized normal distribution</li>
<li>Fixed effect coefficients: drawn from a random uniform (-1, 1)</li>
<li>Residual standard deviation: 1</li>
<li>The number of levels in each factor: 1000 for the first, 100 for the second</li>
<li>The standard deviations of the random effects: .5 for both</li>
</ul>
</section>
<section id="generalized-linear-mixed-model" class="level4">
<h4 class="anchored" data-anchor-id="generalized-linear-mixed-model">Generalized linear mixed model</h4>
<p>For the generalized linear mixed model, the settings are the same but we also add a case where the outcome is rare or not in this binary setting (~ 10% prevalence or less).</p>
<div class="cell">
<div class="cell-output-display">
<table class="table caption-top table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th style="text-align: right;" data-quarto-table-cell-role="th">N</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">balanced</th>
<th style="text-align: right;" data-quarto-table-cell-role="th">tau_2</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">rare</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1e+04</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: right;">1e+04</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1e+04</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.5</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: right;">1e+04</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.5</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1e+04</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: right;">1e+04</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1e+04</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.5</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: right;">1e+04</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.5</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5e+04</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: right;">5e+04</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5e+04</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.5</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: right;">5e+04</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.5</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5e+04</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: right;">5e+04</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5e+04</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.5</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: right;">5e+04</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.5</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1e+05</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: right;">1e+05</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1e+05</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.5</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: right;">1e+05</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.5</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1e+05</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: right;">1e+05</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1e+05</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.5</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: right;">1e+05</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.5</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5e+05</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: right;">5e+05</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5e+05</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.5</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: right;">5e+05</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.5</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5e+05</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: right;">5e+05</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5e+05</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.5</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: right;">5e+05</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.5</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1e+06</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: right;">1e+06</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1e+06</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.5</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: right;">1e+06</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.5</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1e+06</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: right;">1e+06</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">TRUE</td>
</tr>
<tr class="odd">
<td style="text-align: right;">1e+06</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.5</td>
<td style="text-align: left;">FALSE</td>
</tr>
<tr class="even">
<td style="text-align: right;">1e+06</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.5</td>
<td style="text-align: left;">TRUE</td>
</tr>
</tbody>
</table>


</div>
</div>
</section>
<section id="function-arguments" class="level4">
<h4 class="anchored" data-anchor-id="function-arguments">Function arguments</h4>
<p>For <span class="func" style="">g/lmer</span> I set <code>check.derivatives = FALSE</code> and for the GLMM I additionally set <code>nAGQ = 0</code>, as this is precisely the setting one would do so<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>. I did not mess with the optimizers but it is possible to get a speed gain there in some settings. See performance tips <a href="https://cran.r-project.org/web/packages/lme4/vignettes/lmerperf.html">here</a> and demonstrated <a href="http://svmiller.com/blog/2018/06/mixed-effects-models-optimizer-checks/">here</a>.</p>
<p>For <span class="func" style="">bam</span> I set the following.</p>
<ul>
<li><code>gc.level = 0</code></li>
<li><code>use.chol = TRUE</code></li>
<li><code>nthreads = 12/16</code></li>
<li><code>chunk.size = 1000</code></li>
<li><code>samfrac = .1</code></li>
</ul>
<p><span class="func" style="">glmmTMB</span> was left at defaults as I’m not aware of a specific approach for speed gain.</p>



</section>
</section>
</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-brooks_glmmtmb_2017" class="csl-entry" role="listitem">
Brooks, Mollie E., Kasper Kristensen, Koen J. van Benthem, Arni Magnusson, Casper W. Berg, Anders Nielsen, Hans J. Skaug, Martin Mächler, and Benjamin M. Bolker. 2017. <span>“glmmTMB Balances Speed and Flexibility Among Packages for Zero-Inflated Generalized Linear Mixed Modeling.”</span> <em>The R Journal</em> 9 (2): 378–400. <a href="https://journal.r-project.org/archive/2017/RJ-2017-066">https://journal.r-project.org/archive/2017/RJ-2017-066</a>.
</div>
<div id="ref-li_faster_2019" class="csl-entry" role="listitem">
Li, Zheyuan, and Simon N. Wood. 2019. <span>“Faster Model Matrix Crossproducts for Large Generalized Linear Models with Discretized Covariates.”</span> <em>Statistics and Computing</em>, March. <a href="https://doi.org/10.1007/s11222-019-09864-2">https://doi.org/10.1007/s11222-019-09864-2</a>.
</div>
<div id="ref-mccoach2018" class="csl-entry" role="listitem">
McCoach, D Betsy, Graham G Rifenbark, Sarah D Newton, Xiaoran Li, Janice Kooken, Dani Yomtov, Anthony J Gambino, and Aarti Bellara. 2018. <span>“Does the Package Matter? A Comparison of Five Common Multilevel Modeling Software Packages.”</span> <em>Journal of Educational and Behavioral Statistics</em> 43 (5): 594–627. <a href="https://journals.sagepub.com/doi/10.3102/1076998618776348">https://journals.sagepub.com/doi/10.3102/1076998618776348</a>.
</div>
<div id="ref-wood_mgcv:_2012" class="csl-entry" role="listitem">
Wood, Simon. 2012. <span>“Mgcv: <span>Mixed</span> <span>GAM</span> <span>Computation</span> <span>Vehicle</span> with <span>GCV</span>/<span>AIC</span>/<span>REML</span> Smoothness Estimation,”</span> October. <a href="https://researchportal.bath.ac.uk/en/publications/mgcv-mixed-gam-computation-vehicle-with-gcvaicreml-smoothness-est">https://researchportal.bath.ac.uk/en/publications/mgcv-mixed-gam-computation-vehicle-with-gcvaicreml-smoothness-est</a>.
</div>
<div id="ref-wood_generalized_2017" class="csl-entry" role="listitem">
Wood, Simon N. 2017. <em>Generalized Additive Models : An Introduction with r, Second Edition</em>. Chapman; Hall/CRC. <a href="https://doi.org/10.1201/9781315370279">https://doi.org/10.1201/9781315370279</a>.
</div>
<div id="ref-wood_generalized_2015" class="csl-entry" role="listitem">
Wood, Simon N., Yannig Goude, and Simon Shaw. 2015a. <span>“Generalized Additive Models for Large Data Sets.”</span> <em>Journal of the Royal Statistical Society: Series C (Applied Statistics)</em> 64 (1): 139–55. <a href="https://doi.org/10.1111/rssc.12068">https://doi.org/10.1111/rssc.12068</a>.
</div>
<div id="ref-wood_generalized_2015-1" class="csl-entry" role="listitem">
———. 2015b. <span>“Generalized Additive Models for Large Data Sets.”</span> <em>Journal of the Royal Statistical Society: Series C (Applied Statistics)</em> 64 (1): 139–55. <a href="https://doi.org/10.1111/rssc.12068">https://doi.org/10.1111/rssc.12068</a>.
</div>
<div id="ref-wood_generalized_2017-1" class="csl-entry" role="listitem">
Wood, Simon N., Zheyuan Li, Gavin Shaddick, and Nicole H. Augustin. 2017. <span>“Generalized Additive Models for Gigadata: Modeling the u.k. Black Smoke Network Daily Data.”</span> <em>Journal of the American Statistical Association</em> 112 (519): 1199–1210. <a href="https://doi.org/10.1080/01621459.2016.1195744">https://doi.org/10.1080/01621459.2016.1195744</a>.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>You could use construct the smooth with <span class="pack" style="">mgcv</span> and add it to the model matrix for <span class="pack" style="">lme4</span>.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>See <a href="https://cran.r-project.org/web/packages/REEMtree/">REEMtree</a>, <a href="https://cran.r-project.org/web/packages/MixRF/">mixRF</a> for example.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>While I haven’t seen it done, so it may have to serve as a later post, it should be possible to use deep learning tools like Keras or fastai by regularizing only weights associated with the random effects. If one takes an actual deep learning approach, then one can estimate functions of the ‘fixed’ covariates (like the smooth terms in typical GAM) and possibly get at correlations of the clusters themselves (a la spatial random effects).<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>See McCoach reference <span class="citation" data-cites="mccoach2018">(<a href="#ref-mccoach2018" role="doc-biblioref">McCoach et al. 2018</a>)</span>. They also look at HLM and Mplus. However, I haven’t in years consulted with anyone across dozens of disciplines that was using HLM for mixed models. With Mplus, the verbosity of the syntax, plus additional data processing required, plus huge lack of post-processing of the model would negate any speed gain one might get from simply running the model. Couple this with the fact that campus-wide licenses are rare for either, neither could be recommended for mixed models. Note also, that one setting of <span class="func" style="">lmer</span> probably would have negated almost all their reported convergence issues.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>See McCoach reference <span class="citation" data-cites="mccoach2018">(<a href="#ref-mccoach2018" role="doc-biblioref">McCoach et al. 2018</a>)</span>. They also look at HLM and Mplus. However, I haven’t in years consulted with anyone across dozens of disciplines that was using HLM for mixed models. With Mplus, the verbosity of the syntax, plus additional data processing required, plus huge lack of post-processing of the model would negate any speed gain one might get from simply running the model. Couple this with the fact that campus-wide licenses are rare for either, neither could be recommended for mixed models. Note also, that one setting of <span class="func" style="">lmer</span> probably would have negated almost all their reported convergence issues.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>“In general, we expect <span class="pack" style="">glmmTMB</span>‘s advantages over <span class="pack" style="">lme4</span> to be (1) greater flexibility (zero-inflation etc.); (2) greater speed for GLMMs, especially those with large number of ’top-level’ parameters (fixed effects plus random-effects variance-covariance parameters). In contrast, lme4 should be faster for LMMs.”<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>See this R user group thread for a <a href="https://stat.ethz.ch/pipermail/r-sig-mixed-models/2017q3/025938.html">discussion</a>, this <a href="https://stats.stackexchange.com/questions/77313/why-cant-i-match-glmer-family-binomial-output-with-manual-implementation-of-g">stackoverflow exchange</a> involving one of the lme4 contributors, and Bates <a href="https://github.com/dmbates/MixedModelsinJulia/blob/master/nAGQ.ipynb">Julia notebook</a> for more detail.<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a></div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{clark2019,
  author = {Clark, Michael and Clark, Michael},
  title = {Mixed {Models} for {Big} {Data}},
  date = {2019-10-20},
  url = {https://m-clark.github.io/posts/2019-10-20-big-mixed-models/},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-clark2019" class="csl-entry quarto-appendix-citeas" role="listitem">
Clark, Michael, and Michael Clark. 2019. <span>“Mixed Models for Big
Data.”</span> October 20, 2019. <a href="https://m-clark.github.io/posts/2019-10-20-big-mixed-models/">https://m-clark.github.io/posts/2019-10-20-big-mixed-models/</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/m-clark\.github\.io");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<div class="share-buttons"><div class="social-share"><a href="https://twitter.com/share?url=https://m-clark.github.io/posts/2019-10-20-big-mixed-models/&amp;text=Mixed Models for Big Data" target="_blank" class="twitter"><i class="fab fa-twitter fa-fw fa-lg"></i></a><a href="https://www.linkedin.com/shareArticle?url=https://m-clark.github.io/posts/2019-10-20-big-mixed-models/&amp;title=Mixed Models for Big Data" target="_blank" class="linkedin"><i class="fa-brands fa-linkedin-in fa-fw fa-lg"></i></a>  <a href="mailto:?subject=Mixed Models for Big Data&amp;body=Check out this link:https://m-clark.github.io/posts/2019-10-20-big-mixed-models/" target="_blank" class="email"><i class="fa-solid fa-envelope fa-fw fa-lg"></i></a><a href="https://www.facebook.com/sharer.php?u=https://m-clark.github.io/posts/2019-10-20-big-mixed-models/" target="_blank" class="facebook"><i class="fab fa-facebook-f fa-fw fa-lg"></i></a><a href="https://reddit.com/submit?url=https://m-clark.github.io/posts/2019-10-20-big-mixed-models/&amp;title=Mixed Models for Big Data" target="_blank" class="reddit">   <i class="fa-brands fa-reddit-alien fa-fw fa-lg"></i></a><a href="https://bsky.app/intent/compose?text=https://m-clark.github.io/posts/2019-10-20-big-mixed-models/ Mixed Models for Big Data" target="_blank" class="bsky"><i class="fa-brands fa-bluesky"></i></a></div></div>




</body></html>