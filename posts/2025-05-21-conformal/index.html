<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Michael Clark">
<meta name="dcterms.date" content="2025-05-21">
<meta name="description" content="More options for uncertainty estimation">

<title>Uncertainty Estimation with Conformal Prediction – Michael Clark</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-4a036e8d0dc2aed09c022e516d4a8f89.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/quarto-contrib/social-share-1.0.0/social-share.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/social-share-1.0.0/all.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-1.2.0/all.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-1.2.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../img/mc_logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Michael Clark</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/michael-clark-b475b5170/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/m-clark"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/m-clark.bsky.social"> 
<span class="menu-text"><i class="fa-brands fa-bluesky" aria-label="bluesky"></i></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://x.com/statsdatasci"> <i class="bi bi-twitter-x" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../book.html"> 
<span class="menu-text">Models Demystified</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../documents.html"> 
<span class="menu-text">Content</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../code.html"> 
<span class="menu-text">Code</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <div class="quarto-title-block"><div><h1 class="title">Uncertainty Estimation with Conformal Prediction</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
                  <div>
        <div class="description">
          More options for uncertainty estimation
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">machine learning</div>
                <div class="quarto-category">regression</div>
                <div class="quarto-category">boosting</div>
              </div>
                  </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author"><a href="https://m-clark.github.io">Michael Clark</a> <a href="mailto:stats.data.sci@gmail.com" class="quarto-title-author-email"><i class="bi bi-envelope"></i></a> </p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              <a href="https://onesixsolutions.com">
              OneSix
              </a>
            </p>
        </div>
    </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">May 21, 2025</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#why-is-uncertainty-estimation-important" id="toc-why-is-uncertainty-estimation-important" class="nav-link" data-scroll-target="#why-is-uncertainty-estimation-important">Why is Uncertainty Estimation Important?</a>
  <ul class="collapse">
  <li><a href="#contributing-factors" id="toc-contributing-factors" class="nav-link" data-scroll-target="#contributing-factors">Contributing Factors</a></li>
  </ul></li>
  <li><a href="#strategies-for-quantifying-uncertainty" id="toc-strategies-for-quantifying-uncertainty" class="nav-link" data-scroll-target="#strategies-for-quantifying-uncertainty">Strategies for Quantifying Uncertainty</a>
  <ul class="collapse">
  <li><a href="#statistical-uncertainty" id="toc-statistical-uncertainty" class="nav-link" data-scroll-target="#statistical-uncertainty">Statistical Uncertainty</a></li>
  <li><a href="#bootstrapping" id="toc-bootstrapping" class="nav-link" data-scroll-target="#bootstrapping">Bootstrapping</a></li>
  <li><a href="#bayesian-approaches" id="toc-bayesian-approaches" class="nav-link" data-scroll-target="#bayesian-approaches">Bayesian Approaches</a></li>
  <li><a href="#conformal-prediction" id="toc-conformal-prediction" class="nav-link" data-scroll-target="#conformal-prediction">Conformal Prediction</a></li>
  </ul></li>
  <li><a href="#practical-comparison-uncertainty-methods-on-housing-data" id="toc-practical-comparison-uncertainty-methods-on-housing-data" class="nav-link" data-scroll-target="#practical-comparison-uncertainty-methods-on-housing-data">Practical Comparison: Uncertainty Methods on Housing Data</a></li>
  <li><a href="#pros-and-cons" id="toc-pros-and-cons" class="nav-link" data-scroll-target="#pros-and-cons">Pros and Cons</a>
  <ul class="collapse">
  <li><a href="#traditional-statistical-prediction-intervals" id="toc-traditional-statistical-prediction-intervals" class="nav-link" data-scroll-target="#traditional-statistical-prediction-intervals">Traditional Statistical Prediction Intervals</a></li>
  <li><a href="#bootstrapping-1" id="toc-bootstrapping-1" class="nav-link" data-scroll-target="#bootstrapping-1">Bootstrapping</a></li>
  <li><a href="#bayesian-approaches-1" id="toc-bayesian-approaches-1" class="nav-link" data-scroll-target="#bayesian-approaches-1">Bayesian Approaches</a></li>
  <li><a href="#conformal-prediction-1" id="toc-conformal-prediction-1" class="nav-link" data-scroll-target="#conformal-prediction-1">Conformal Prediction</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  <li><a href="#data-details" id="toc-data-details" class="nav-link" data-scroll-target="#data-details">Data Details</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<blockquote class="blockquote">
<p>As with the <a href="https://m-clark.github.io/posts/2025-04-07-class-imbalance/">last post on class imbalance</a>, this is a resurrection of sorts. I began this post a little after that one had gotten an initial draft completed. Since then, conformal prediction has caught on quite a bit, but there wasn’t much at the time in terms of tools. I was focused on MAPIE as that’s a good package in Python, and as I was writing this, <span class="pack">probably</span> finally offered something more viable in R. I definitely recommend R folks to check it out.</p>
</blockquote>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Uncertainty estimation is a crucial component of machine learning systems. It is vital to know how precise our model predictions are, and whether we feel confident in taking action based on them. While typical usage of prediction and performance is often done with little consideration of uncertainty, we do so at our own (very predictable) peril. Here we will discuss uncertainty in the context of prediction, and how we can estimate it using several methods. We will focus especially on conformal prediction, a tried but relatively newer approach to uncertainty estimation that has several advantages. This post covers:</p>
<ol type="1">
<li><strong>Why Uncertainty Estimation is Important</strong>: We’ll discuss why uncertainty estimation is important and how it can be used to make better decisions.</li>
<li><strong>Approaches to Uncertainty Estimation</strong>: We’ll discuss different approaches to uncertainty estimation, including statistical prediction intervals, bootstrapping, Bayesian approaches, and conformal prediction.</li>
<li><strong>Example</strong>: We’ll demonstrate how to use conformal prediction to estimate uncertainty in a simple example to help demystify the process.</li>
<li><strong>Pros and Cons</strong>: We’ll discuss the advantages and disadvantages of different approaches to uncertainty estimation.</li>
</ol>
</section>
<section id="why-is-uncertainty-estimation-important" class="level2">
<h2 class="anchored" data-anchor-id="why-is-uncertainty-estimation-important">Why is Uncertainty Estimation Important?</h2>
<p>Uncertainty estimation is an indispensable part of our modeling endeavor, and <em>one of the main reasons is that it allows us to make better decisions from our data</em>. The more we understand our predictions, the more we can feel confident in taking action based on them. Understanding uncertainty can also help us understand the model itself, and especially where its weaknesses are, or at what points we should be more cautious.</p>
<p>For example, if we are building a model to predict the number of sales for a product, we would like to better assess our prediction of future sales in order to take current action. This could be increasing our marketing budget for the months ahead, or possibly assessing whether current marketing strategies have been successful. Our model may predict that we can expect an increase in sales of 150 units with the increased budget of 5%. If the range for the prediction is that the expected sales increase six months from now is between 100 and 200 units, we might make a different decision than if we expect the unit sales to be between -100 and 400 units. In the first case, we might be more willing to increase our budget spend, since it seems we are likely to experience an increase in sales by doing so. In the second case, we might not take any action, since the range encompasses anywhere between lost sales to an even larger boost.</p>
<p>The following illustrates the issue. The prediction on the left suggests less value and has notable uncertainty with that assessment. That might be easy to rule out. But the other two predictions take some thought. One is higher with less uncertainty, while the other prediction is slightly lower, but with more uncertainty that suggests the upside might be greater. Which would you prefer?</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/uncertainty-plot-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>Many times stakeholders will take action given the prediction alone, and then are disappointed when things don’t turn out as expected, which they definitely will not in practice. In similar fashion, some take action based on rankings of the predictions, which of course themselves have uncertainty that stems from the raw prediction, and even more so. In some situations, we may be able to get away with doing so, but it would be difficult to know this ahead of time. The old adage of not wanting to put all your eggs in one (prediction) basket applies here.</p>
<!-- TODO: generic pointrange type of plot with question marks -->
<section id="contributing-factors" class="level3">
<h3 class="anchored" data-anchor-id="contributing-factors">Contributing Factors</h3>
<p>Several key factors contribute to prediction uncertainty, among them:</p>
<ul>
<li><p><strong>Amount of Data</strong>: While more data can lead us to feel more confident about predictions in a general sense by providing additional learning examples of varying kinds, this is limited. Additional bad or uninformative data will not improve a model or its predictions!</p></li>
<li><p><strong>Model Complexity</strong>: More complex models may capture nuanced relationships leading to better predictions, but can also introduce instability in those predictions if additional steps aren’t taken. Conversely, having too simple a model yields relatively poor predictions in general.</p></li>
<li><p><strong>Precision of Measurement</strong>: The quality of the data collection process definitely impacts any predictions we might ultimately make. For example, if sales are entered with possible error, or a lag for some reporting units and not for others, this can lead to uncertainty in our predictions of future sales. In addition, the precision of measurement can vary across features. For example, if price is a feature, it may be that price fluctuates within a month but sales are recorded for a month, meaning we might have to take an average or other measure of price.</p></li>
</ul>
<p>So any number of things might contribute to the uncertainty in our predictions and, in general, some aspects contributing to prediction uncertainty may be under our control, while others may not be. Different methods produce different results, and some intervals may be too narrow or too wide in some settings, giving false confidence or excessive caution. In what follows, we’ll explore various uncertainty estimation approaches with a focus on <strong>conformal prediction</strong>, demonstrating its implementation and comparing its advantages to alternative methods. We’ll start by discussing the importance of uncertainty estimation and the different approaches to it. Next, we will discuss conformal prediction and show a simple demonstration of how it can be used to estimate uncertainty. Finally, we will discuss the advantages and disadvantages of conformal prediction compared to other approaches to uncertainty estimation.</p>
<div class="callout callout-style-default callout-tip callout-titled" title="Confidence is not Certainty">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Confidence is not Certainty
</div>
</div>
<div class="callout-body-container callout-body">
<p>It’s crucial to understand that <em>confidence</em> in terms of confidence intervals is not the same concept as <em>certainty</em>. The same level of confidence interval, say 95%, can produce different interval widths across models for the same prediction, and across predictions for the same model/data. Certainty reflects our understanding about the range provided by a confidence interval, and, for a given setting, we have less uncertainty with narrower intervals than wider ones.</p>
</div>
</div>
</section>
</section>
<section id="strategies-for-quantifying-uncertainty" class="level2">
<h2 class="anchored" data-anchor-id="strategies-for-quantifying-uncertainty">Strategies for Quantifying Uncertainty</h2>
<p>There are several approaches to uncertainty estimation, and many different things we can calculate uncertainty for. We’ll focus specifically on uncertainty for predictions, and we’ll briefly describe and demonstrate some of the different ways of getting an uncertainty estimate for those.</p>
<section id="statistical-uncertainty" class="level3">
<h3 class="anchored" data-anchor-id="statistical-uncertainty">Statistical Uncertainty</h3>
<p><span class="math display">\[y \sim \mathcal{N}(\mu, \sigma^2)\]</span></p>
<p>Probably the most common approach to estimate uncertainty is to use a statistical model. Given a statistical distribution and the estimated parameters of the model, we can get a sense of uncertainty in the prediction. For example, let’s say we have a standard linear regression model. In that case, we are assuming the data generating process for the target/outcome is a normal distribution. The mean for that distribution comes from our model via the linear combination of features, and the variance is estimated separately<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. Given those and other model-specific assumptions hold (e.g.&nbsp;homoscedasticity, independence of observations), we can then obtain an interval estimate for a prediction, typically using a standard formula. This approach extends well beyond both linear regression and the normal distribution, but the basic idea is the same. We assume a distribution for the target, estimate the parameters of that distribution via the data, and then use those estimates to ultimately obtain an interval estimate for our prediction.</p>
<!---
 The following shows how the prediction interval for an unseen observation is constructed:

$$
\hat{y} \pm t_{\alpha/2, n-2} \hat{\sigma} \sqrt{1 + \frac{1}{n} + \frac{(x - \bar{x})^2}{\sum_{i=1}^n (x_i - \bar{x})^2}}
$$ 

where $\hat{y}$ is the predicted value, $t_{\alpha/2, n-2}$ is the critical value of the t-distribution with $n-2$ degrees of freedom, $\hat{\sigma}$ is the standard error of the regression, $x$ is the value of the predictor, and $\bar{x}$ is the mean of the predictor. 
--->
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>We can contrast the <em>prediction interval</em> versus a <a href="https://stats.stackexchange.com/questions/16493/difference-between-confidence-intervals-and-prediction-intervals">confidence interval for a prediction</a>, i.e., for the prediction for an *average response*. The latter will always be smaller, as it reflects the uncertainty in the mean of the distribution of predictions, rather than the uncertainty in the predicted value for a *new* observation, which is what the prediction interval regards.</p>
</div>
</div>
</section>
<section id="bootstrapping" class="level3">
<h3 class="anchored" data-anchor-id="bootstrapping">Bootstrapping</h3>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/boot-r-1.png" class="img-fluid figure-img" style="width:66.0%"></p>
<figcaption>Bootstrap Resampling Visualization</figcaption>
</figure>
</div>
</div>
</div>
<p>Bootstrapping is another technique for estimating uncertainty in machine learning models. By repeatedly resampling our original dataset with replacement, we create multiple versions of our data that capture its inherent variability. This process mirrors what would happen if we could collect many different samples from the population. Each resampled dataset produces slightly different model parameters, and consequently, different predictions for the same input. The variation across these predictions directly quantifies our uncertainty - wider spread indicating higher uncertainty, narrower spread suggesting more confidence.</p>
<p>Think of it this way – we take our data, resample the observations with replacement, and train a new model on the resampled data. We then use the new model to make predictions on the original or new/test data. Now we do that many times, taking the average for our final prediction. We then use the quantiles of the prediction distribution (e.g.&nbsp;corresponding to the 5th and 95th percentiles) across the bootstrap samples to get an interval estimate for our prediction. This is a very powerful technique, as it allows us to estimate the uncertainty in our predictions without making any assumptions about the underlying distribution of the data.</p>
</section>
<section id="bayesian-approaches" class="level3">
<h3 class="anchored" data-anchor-id="bayesian-approaches">Bayesian Approaches</h3>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../img/priorLikePosterior.png" class="img-fluid figure-img" style="width:50.0%"></p>
<figcaption>Prior, Likelihood, Posterior</figcaption>
</figure>
</div>
<p>Bootstrap and Bayesian approaches are kindred spirits in that they both generate a distribution for our predictions. The Bayesian approach does not require resampling the data, but it does have an assumption about the distributions of the parameters, which ultimately means it still makes assumptions similar to those in traditional statistical models. We use the Bayesian approach to provide a distribution for the parameters we’re attempting to estimate. For our predictions, we then take random draws from that parameter distribution, feed it into our model to get a prediction, and then repeat that process many times. Again, we may take the average for our final prediction, and the quantiles of interest for our interval estimate.</p>
</section>
<section id="conformal-prediction" class="level3">
<h3 class="anchored" data-anchor-id="conformal-prediction">Conformal Prediction</h3>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/conformal-vis-2-1.png" class="img-fluid figure-img" width="768"></p>
</figure>
</div>
</div>
</div>
<p>Conformal prediction is yet another technique for estimating uncertainty in machine learning models, and one of its primary strengths is that it is model agnostic and theoretically can work for any model, from linear regression to deep learning. It is based on the idea that we can estimate the uncertainty in our predictions by looking at the distribution of the predictions from the model, or more specifically, the prediction error. Using the observed error on a calibration set that was not used to train the model, we can order those errors and find the quantile corresponding to the desired uncertainty coverage/error rate<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. When predicting on new data, we assume it (and its error) comes from a similar distribution as what we’ve seen already in our training/calibration process, with no particular assumption about that distribution. We then use that quantile from our previous distribution to create upper and lower bounds for the new prediction.</p>
<section id="quick-demo" class="level4">
<h4 class="anchored" data-anchor-id="quick-demo">Quick Demo</h4>
<p>While the implementation for various settings can get quite complicated, the conceptual approach is mostly straightforward as we’ve just suggested. The following shows some simplified code demonstrating the <strong>split-conformal</strong> procedure in Python and R. Note that you should use packages like <span class="pack">mapie</span> or fuller implementations for your own work.</p>
<!-- Can't do tabset for doc/blog post upload, so we'll do this instead. -->
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">Python</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">R</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<!-- ![](../../img/conformal/py_conformal_code.png){width=66%} -->
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> split_conformal(X, y, new_data, alpha <span class="op">=</span> <span class="fl">0.05</span>, seed <span class="op">=</span> <span class="dv">123</span>):</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set random seed for reproducibility</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    np.random.seed(seed)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Splitting the data into training and calibration sets</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    train_data, cal_data, train_y, cal_y <span class="op">=</span> train_test_split(X, y, test_size <span class="op">=</span> <span class="fl">0.5</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    N <span class="op">=</span> train_data.shape[<span class="dv">0</span>]</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train the base model</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> LinearRegression()</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    model.fit(train_data, train_y)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate residuals on calibration set</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    cal_preds <span class="op">=</span> model.predict(cal_data)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>    residuals <span class="op">=</span> np.array(np.<span class="bu">abs</span>(cal_y <span class="op">-</span> cal_preds))</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort residuals and find the quantile corresponding to (1-alpha)</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    residuals.sort()</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    quantile <span class="op">=</span> np.quantile(residuals, (<span class="dv">1</span> <span class="op">-</span> alpha) <span class="op">*</span> (N <span class="op">/</span> (N <span class="op">+</span> <span class="dv">1</span>)))</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make predictions on new data and calculate prediction intervals</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> model.predict(new_data)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    lower_bounds <span class="op">=</span> preds <span class="op">-</span> quantile</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    upper_bounds <span class="op">=</span> preds <span class="op">+</span> quantile</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return predictions and prediction intervals</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>        <span class="bu">dict</span>(</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>            cp_error <span class="op">=</span> quantile, </span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>            preds <span class="op">=</span> preds, </span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>            lower_bounds <span class="op">=</span> lower_bounds, </span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>            upper_bounds <span class="op">=</span> upper_bounds</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>cp_error_py <span class="op">=</span> split_conformal(X_train, y_train, X_test, alpha <span class="op">=</span> <span class="fl">.1</span>)[<span class="st">'cp_error'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<!-- ![](../../img/conformal/r_conformal_code.png){width=66%} -->
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>split_conformal <span class="ot">=</span> <span class="cf">function</span>(X, y, new_data, <span class="at">alpha =</span> .<span class="dv">05</span>, <span class="at">seed =</span> <span class="dv">123</span>) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set random seed for reproducibility</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(seed)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Splitting the data into training and calibration sets</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    idx <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(X), <span class="at">size =</span> <span class="fu">nrow</span>(X) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    train_data <span class="ot">=</span> X <span class="sc">|&gt;</span> <span class="fu">slice</span>(idx)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    cal_data <span class="ot">=</span> X <span class="sc">|&gt;</span> <span class="fu">slice</span>(<span class="sc">-</span>idx)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    train_y <span class="ot">=</span> y[idx]</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    cal_y <span class="ot">=</span> y[<span class="sc">-</span>idx]</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    N <span class="ot">=</span> <span class="fu">nrow</span>(train_data)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train the base model</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">=</span> <span class="fu">lm</span>(train_y <span class="sc">~</span> ., <span class="at">data =</span> train_data)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate residuals on calibration set</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    cal_preds <span class="ot">=</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> cal_data)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    residuals <span class="ot">=</span> <span class="fu">abs</span>(cal_y <span class="sc">-</span> cal_preds)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort residuals and find the quantile corresponding to (1-alpha)</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    residuals <span class="ot">=</span> <span class="fu">sort</span>(residuals)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    quantile  <span class="ot">=</span> <span class="fu">quantile</span>(residuals, (<span class="dv">1</span> <span class="sc">-</span> alpha) <span class="sc">*</span> (N <span class="sc">/</span> (N <span class="sc">+</span> <span class="dv">1</span>)))</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make predictions on new data and calculate prediction intervals</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    preds <span class="ot">=</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> new_data)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    lower_bounds <span class="ot">=</span> preds <span class="sc">-</span> quantile</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    upper_bounds <span class="ot">=</span> preds <span class="sc">+</span> quantile</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return predictions and prediction intervals</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>            <span class="at">cp_error =</span> quantile, </span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>            <span class="at">preds =</span> preds, </span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>            <span class="at">lower_bounds =</span> lower_bounds, </span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>            <span class="at">upper_bounds =</span> upper_bounds</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>cp_error_r <span class="ot">=</span> <span class="fu">split_conformal</span>(X_train, y_train, X_test, <span class="at">alpha =</span> .<span class="dv">1</span>)[[<span class="st">'cp_error'</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</div>
</div>
</div>
<p>We can compare our simple approach to <code>mapie</code> in Python, which is a solid package to use for this<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>. The ‘naive’ conformal procedure in <code>mapie</code> implemented is very similar to our split-conformal procedure, and generally you’d want to use one of the better approaches. But this is a bit more comparable, and most of the difference between our R, Python and the <code>mapie</code> results are due to the underlying data split.</p>
<!-- ![](../../img/conformal/py_mapie_conformal_code.png){width=66%} -->
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mapie.regression <span class="im">import</span> MapieRegressor</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>initial_fit <span class="op">=</span> LinearRegression().fit(X_train, y_train)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> MapieRegressor(initial_fit, method <span class="op">=</span> <span class="st">'naive'</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>y_pred, y_pis <span class="op">=</span> model.fit(X_train, y_train).predict(X_test, alpha <span class="op">=</span> <span class="fl">0.1</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># take the first difference between upper and lower bounds,</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># since it's constant for all predictions in this setting</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>cp_error_mapie <span class="op">=</span> (y_pis[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>] <span class="op">-</span> y_pis[<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>]) <span class="op">/</span> <span class="dv">2</span>  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="ycfngrsiqe" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#ycfngrsiqe table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#ycfngrsiqe thead, #ycfngrsiqe tbody, #ycfngrsiqe tfoot, #ycfngrsiqe tr, #ycfngrsiqe td, #ycfngrsiqe th {
  border-style: none;
}

#ycfngrsiqe p {
  margin: 0;
  padding: 0;
}

#ycfngrsiqe .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#ycfngrsiqe .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#ycfngrsiqe .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#ycfngrsiqe .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#ycfngrsiqe .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ycfngrsiqe .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ycfngrsiqe .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ycfngrsiqe .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#ycfngrsiqe .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#ycfngrsiqe .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#ycfngrsiqe .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#ycfngrsiqe .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#ycfngrsiqe .gt_spanner_row {
  border-bottom-style: hidden;
}

#ycfngrsiqe .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#ycfngrsiqe .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#ycfngrsiqe .gt_from_md > :first-child {
  margin-top: 0;
}

#ycfngrsiqe .gt_from_md > :last-child {
  margin-bottom: 0;
}

#ycfngrsiqe .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#ycfngrsiqe .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#ycfngrsiqe .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#ycfngrsiqe .gt_row_group_first td {
  border-top-width: 2px;
}

#ycfngrsiqe .gt_row_group_first th {
  border-top-width: 2px;
}

#ycfngrsiqe .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ycfngrsiqe .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#ycfngrsiqe .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#ycfngrsiqe .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ycfngrsiqe .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ycfngrsiqe .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#ycfngrsiqe .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#ycfngrsiqe .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#ycfngrsiqe .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ycfngrsiqe .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ycfngrsiqe .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#ycfngrsiqe .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ycfngrsiqe .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#ycfngrsiqe .gt_left {
  text-align: left;
}

#ycfngrsiqe .gt_center {
  text-align: center;
}

#ycfngrsiqe .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#ycfngrsiqe .gt_font_normal {
  font-weight: normal;
}

#ycfngrsiqe .gt_font_bold {
  font-weight: bold;
}

#ycfngrsiqe .gt_font_italic {
  font-style: italic;
}

#ycfngrsiqe .gt_super {
  font-size: 65%;
}

#ycfngrsiqe .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#ycfngrsiqe .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#ycfngrsiqe .gt_indent_1 {
  text-indent: 5px;
}

#ycfngrsiqe .gt_indent_2 {
  text-indent: 10px;
}

#ycfngrsiqe .gt_indent_3 {
  text-indent: 15px;
}

#ycfngrsiqe .gt_indent_4 {
  text-indent: 20px;
}

#ycfngrsiqe .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
  <thead>
    <tr class="gt_col_headings">
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col" id="Source">Source</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1" scope="col" id="CP Error">CP Error</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td headers="Source" class="gt_row gt_left">R-by-hand</td>
<td headers="CP Error" class="gt_row gt_right">0.5356</td></tr>
    <tr><td headers="Source" class="gt_row gt_left">Py-by-hand</td>
<td headers="CP Error" class="gt_row gt_right">0.5361</td></tr>
    <tr><td headers="Source" class="gt_row gt_left">Py-mapie</td>
<td headers="CP Error" class="gt_row gt_right">0.5370</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled" title="Other Methods">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Other Methods
</div>
</div>
<div class="callout-body-container callout-body">
<p>As we’ve seen, there are numerous methods for estimating uncertainty in our predictions. As another example, some use <em>quantile regression</em> in machine learning models. It is based on the idea that we can estimate the uncertainty in our predictions by modeling the specific quantiles rather than the conditional mean default value, for example, the .05 and .95 values. But those quantiles are predictions with uncertainty themselves, and without incorporating that uncertainty, tend to underestimate the uncertainty in the prediction (Bai et al., 2021). In general, one should be cautious about the method they choose in any particular setting.</p>
</div>
</div>
</section>
</section>
</section>
<section id="practical-comparison-uncertainty-methods-on-housing-data" class="level2">
<h2 class="anchored" data-anchor-id="practical-comparison-uncertainty-methods-on-housing-data">Practical Comparison: Uncertainty Methods on Housing Data</h2>
<p>To see our uncertainty estimation in practice, we’ll use a sample of the classic <a href="https://www.kaggle.com/camnugent/california-housing-prices">California Housing Prices dataset</a> for demonstration. The dataset contains information about housing prices in California, including the median house value in a district, the median income for that district, and the median house age etc. We’ll use all the available features to predict median house value on the log scale. You can find out some basic info for the data at the <a href="#data-details">end of this post</a>. The very rough notebook used to generate the data and results is available <a href="https://github.com/m-clark/m-clark.github.io/tree/master/posts">at my website repo</a>.</p>
<p>In the following we show the 90% prediction interval estimates for a basic linear regression after exponentiating to the original scale. Points are arranged in increasing (median) predicted value. We can see that the prediction intervals are essentially in agreement for all methods we previously discussed – statistical, bootstrapped, Bayesian, and conformal. Highlighted are the points missed by the intervals, which was around 10% for each method (data issues notwithstanding<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>). This should leave us feeling good about using any of these methods for uncertainty estimation in simpler model settings.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../img/conformal/lin-reg-plot.png" class="img-fluid figure-img" style="width:75.0%"></p>
<figcaption>Prediction Intervals (Linear Regression)</figcaption>
</figure>
</div>
<p>The following visualization shows the exact same data context, though now we use an xgboost model to predict the target. With this model, we do not have an underlying statistical distribution or easy Bayesian counterpart<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a> with which to estimate uncertainty. So we are left to use a bootstrapped approach or conformal prediction. Furthermore, the nature of the model means that the actual interval widths can vary a bit from point to point, so the lines shown are smoothed boundaries used to make the general pattern more clear, but should not be taken as the actual interval for a given point.</p>
<p>In the visualization, blue represents the bootstrapped prediction interval while red represents the conformal prediction interval. Points that fall outside their respective intervals are highlighted - blue dots show observations missed by bootstrap intervals and red dots show those missed by conformal intervals. Some points may appear in both colors when they’re missed by both approaches (i.e., anything missed by the conformal is also missed by the bootstrap).</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../../img/conformal/boost-plot.png" class="img-fluid figure-img" style="width:75.0%"></p>
<figcaption>Prediction Intervals (XGBoost)</figcaption>
</figure>
</div>
<p>The first thing we see is that the naive bootstrap is too optimistic in this situation, with interval estimates that are too narrow, which results in only 70% coverage compared to the target 90%. Complex tree-based models like XGBoost often exhibit this problem with bootstrapping because the resampling approach struggles to capture the full model uncertainty in high-variance models.</p>
<p>In contrast, the conformal interval is more conservative and achieves 92% coverage, close to matching our specified 90% target (though slightly more conservative). This demonstrates conformal prediction’s ability to produce reliable uncertainty estimates even for complex models where traditional methods struggle. As a practical advantage, on an Apple M1 laptop, it took a few seconds to get the conformal prediction intervals, while the bootstrap took over 10 minutes for 500 bootstrap replications.</p>
</section>
<section id="pros-and-cons" class="level2">
<h2 class="anchored" data-anchor-id="pros-and-cons">Pros and Cons</h2>
<p>Nothing comes for free in the modeling world. Here we list some advantages and disadvantages of the different approaches to uncertainty estimation. Note that this is not an exhaustive list nor does it go into specifics, and there may be additional considerations beyond those noted.</p>
<section id="traditional-statistical-prediction-intervals" class="level3">
<h3 class="anchored" data-anchor-id="traditional-statistical-prediction-intervals">Traditional Statistical Prediction Intervals</h3>
<p><strong>Advantages:</strong></p>
<ul>
<li><strong>Ease</strong>: For many models, prediction intervals can be computed easily and are automatically provided by various modeling packages.</li>
<li><strong>Interpretability</strong>: The statistical theory behind the prediction intervals is generally straightforward.</li>
<li><strong>Computational Efficiency</strong>: Unlike bootstrapping or Bayesian approaches that require multiple model fits or MCMC sampling, traditional statistical intervals can typically be calculated directly from the fitted model parameters with minimal computational overhead.</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li><strong>Distribution Assumption</strong>: They typically require (sometimes strong) assumptions about the underlying data distribution.</li>
<li><strong>Model-Specific Estimation</strong>: The intervals depend on a specific statistical model, and different estimation approaches are needed for different models.</li>
<li><strong>Model Complexity</strong>: Even common models, e.g., those using penalty terms, can make prediction uncertainty using distributional assumptions difficult<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>.</li>
</ul>
</section>
<section id="bootstrapping-1" class="level3">
<h3 class="anchored" data-anchor-id="bootstrapping-1">Bootstrapping</h3>
<p><strong>Advantages:</strong></p>
<ul>
<li><strong>Simple</strong>: Bootstrapping is a relatively simple approach to estimating uncertainty.</li>
<li><strong>Less Restrictive Assumptions</strong>: Like conformal prediction, non-parametric bootstrapping doesn’t require assumptions of the underlying data distribution.</li>
<li><strong>Model-Agnostic</strong>: It operates directly on the data irrespective of your model.</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li><strong>Computationally Intensive</strong>: It might require a large number of resamples, which can be computationally intensive for some model-data combinations.</li>
<li><strong>Data issues</strong>: For very small datasets, extreme values/tails, estimates could be problematic, but this is likely true for most approaches.</li>
<li><strong>Naive approach is limited</strong>: The naive resampling approach tends to underestimate uncertainty, so additional steps are required to get a more accurate estimate of uncertainty.</li>
</ul>
</section>
<section id="bayesian-approaches-1" class="level3">
<h3 class="anchored" data-anchor-id="bayesian-approaches-1">Bayesian Approaches</h3>
<p><strong>Advantages:</strong></p>
<ul>
<li><strong>Probabilistic Interpretation</strong>: It provides a full distribution of plausible values for our parameters or predictions.</li>
<li><strong>Incorporates Prior Information</strong>: We can use prior beliefs about parameters we estimate. For example, we can use last year’s data to inform our prior beliefs about the parameters of this year’s model.</li>
<li><strong>Confidence in Uncertainty Estimate</strong>: We can be more confident in our uncertainty estimates than we can with some statistical approaches that often use workarounds to estimate uncertainty (e.g.&nbsp;mixed models), and there are many diagnostic tools available to spot problematic models.</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li><strong>Computationally Intensive</strong>: MCMC sampling for model estimation can be slow, particularly for complex models.</li>
<li><strong>Choice of Prior</strong>: The choice of prior can significantly influence the results, especially with small data.</li>
<li><strong>Statistical Assumptions</strong>: As the Bayesian models are an alternative way to estimate statistical models, they depend on a specific statistical model and its likelihood.</li>
</ul>
</section>
<section id="conformal-prediction-1" class="level3">
<h3 class="anchored" data-anchor-id="conformal-prediction-1">Conformal Prediction</h3>
<p><strong>Advantages:</strong></p>
<ul>
<li><strong>Distribution-Free &amp; Model-Agnostic</strong>: Generates valid prediction intervals regardless of underlying data distribution and works with any model, providing a unified framework.</li>
<li><strong>Theoretical Guarantees</strong>: Given a significance level, conformal prediction provides valid coverage even with misspecified models.</li>
<li><strong>Efficiency</strong>: Conformal prediction is relatively computationally efficient compared to other methods, and nonconformity measures based on residuals are straightforward to compute during the training process.</li>
<li><strong>Generalizable</strong>: Other approaches that might be used for uncertainty prediction, like quantile regression or Bayesian methods, can be ‘conformalized’ to produce appropriate coverage.</li>
</ul>
<p><strong>Disadvantages:</strong></p>
<ul>
<li><strong>Implementation Challenges</strong>: The intervals can be unstable with small data changes, and are sometimes overly conservative when the nonconformity measure isn’t chosen properly.</li>
<li><strong>Data Splitting Requirement</strong>: A portion of the data needs to be held out to estimate the nonconformity scores, which can reduce the data available for model training.</li>
<li><strong>Theoretical Limitations</strong>: While theoretically sound, various practical implementations (like split-conformal) introduce trade-offs between computational efficiency and theoretical guarantees.</li>
<li><strong>Exchangeability Assumption</strong>: Still requires data exchangeability assumption, which must be accounted for in time series or other structured data.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled" title="Model Complexity Changes the Game">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Model Complexity Changes the Game
</div>
</div>
<div class="callout-body-container callout-body">
<p>The comparison highlights an important pattern in uncertainty estimation:</p>
<ol type="1">
<li><p><strong>Simple models</strong>: All methods tend to perform similarly when the underlying model is well-behaved (like linear regression).</p></li>
<li><p><strong>Complex models</strong>: Method differences become pronounced - distributional assumptions break down, computational demands diverge, and coverage guarantees can fail.</p></li>
<li><p><strong>Fundamental tradeoff</strong>: As models become more complex to capture nuanced patterns, the uncertainty estimation task becomes correspondingly more challenging.</p></li>
</ol>
<p>This explains why conformal prediction has gained popularity - it maintains validity across the model complexity spectrum without sacrificing computational efficiency.</p>
</div>
</div>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<blockquote class="blockquote">
<p>There’s a lot of uncertainty in uncertainty estimation.</p>
</blockquote>
<p>As we’ve seen, there are many approaches to estimating uncertainty, and each has its own strengths and weaknesses. Among the considerations for selection are computational feasibility, coverage accuracy, and underlying model assumptions. In this article we discussed statistical prediction intervals, bootstrapping, Bayesian estimation, and conformal prediction, as well as their relative advantages and disadvantages. Conformal prediction is a relatively newer approach that has some advantages over other approaches, including its flexibility, distribution-free nature, and theoretical guarantee of coverage probability, even under difficult and complex modeling circumstances. We hope this article has been helpful in understanding the importance of uncertainty estimation and the different approaches to it, and that it has provided a useful demonstration of how to use conformal prediction to estimate uncertainty.</p>
<p>As we’ve seen, there are many approaches to estimating uncertainty, and each has its own strengths and weaknesses. Among the considerations for selection are coverage accuracy, model/technical assumptions, and computational feasibility. These considerations matter because proper uncertainty estimation directly impacts decision quality – as our opening example illustrated, different uncertainty ranges can lead to entirely different actions.</p>
<p>For practitioners looking to implement these methods:</p>
<ul>
<li><strong>For simple models with well-understood distributions</strong>: Traditional statistical intervals typically offer computational efficiency and simplicity.</li>
<li><strong>When prior knowledge is important</strong>: Bayesian approaches provide a natural framework for incorporating this information, while also providing intervals for more complex statistical models.</li>
<li><strong>When working with moderate-sized datasets and statistical software or other model limitations</strong>: Bootstrapping provides flexibility across different model types, particularly for models where analytical intervals aren’t implemented or appropriate.</li>
<li><strong>For complex models or when distribution assumptions are questionable</strong>: Conformal prediction offers reliable coverage with minimal assumptions, while also providing better computational efficiency than bootstrapping approaches.</li>
</ul>
<p>Looking forward, the field of uncertainty estimation continues to evolve. Recent advances include adaptations of conformal prediction for time series data, more efficient implementations that reduce data splitting requirements, and hybrid approaches that combine the strengths of multiple methods. I’d probably recommend first implementing the simplest approach appropriate for your model setting. You could then compare it with conformal prediction to evaluate potential improvements in reliability and coverage.</p>
</section>
<section id="data-details" class="level2">
<h2 class="anchored" data-anchor-id="data-details">Data Details</h2>
<p>The following shows some basic information based on a sample of the data used in this post.</p>
<p><img src="../../img/conformal/data_table.png" class="img-fluid" style="width:75.0%"></p>
</section>
<section id="references" class="level2">



<!-- -->


</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-angelopoulos2022gentle" class="csl-entry" role="listitem">
Angelopoulos, Anastasios N., and Stephen Bates. 2022. <span>“A Gentle Introduction to Conformal Prediction and Distribution-Free Uncertainty Quantification.”</span> <a href="https://arxiv.org/abs/2107.07511">https://arxiv.org/abs/2107.07511</a>.
</div>
<div id="ref-va2022" class="csl-entry" role="listitem">
Arel-Bundock, Vincent. 2022. <span>“Distribution-Free Prediction Intervals with Conformal Inference Using r.”</span> <a href="https://arelbundock.com/posts/conformal/">https://arelbundock.com/posts/conformal/</a>.
</div>
<div id="ref-bai2021understanding" class="csl-entry" role="listitem">
Bai, Yu, Song Mei, Huan Wang, and Caiming Xiong. 2021. <span>“Understanding the Under-Coverage Bias in Uncertainty Estimation.”</span> <em>Advances in Neural Information Processing Systems</em> 34: 18307–19.
</div>
<div id="ref-brownlee2019" class="csl-entry" role="listitem">
Brownlee, J. 2019. <span>“A Gentle Introduction to Uncertainty in Machine Learning.”</span> <a href="https://machinelearningmastery.com/uncertainty-in-machine-learning/">https://machinelearningmastery.com/uncertainty-in-machine-learning/</a>.
</div>
<div id="ref-tidymodels2023" class="csl-entry" role="listitem">
Group, Tidymodels. 2023. <span>“Conformal Inference for Regression Models.”</span> <a href="https://arelbundock.com/posts/conformal/">https://arelbundock.com/posts/conformal/</a>.
</div>
<div id="ref-lei2018distribution" class="csl-entry" role="listitem">
Lei, Jing, Max G’Sell, Alessandro Rinaldo, Ryan J Tibshirani, and Larry Wasserman. 2018. <span>“Distribution-Free Predictive Inference for Regression.”</span> <em>Journal of the American Statistical Association</em> 113 (523): 1094–1111. <a href="https://www.stat.cmu.edu/~ryantibs/papers/conformal.pdf">https://www.stat.cmu.edu/~ryantibs/papers/conformal.pdf</a>.
</div>
<div id="ref-molnar2023" class="csl-entry" role="listitem">
Molnar, Christopher. 2023. <span>“Understanding Different Uncertainty Mindsets.”</span> <a href="https://mindfulmodeler.substack.com/p/understanding-different-uncertainty">https://mindfulmodeler.substack.com/p/understanding-different-uncertainty</a>.
</div>
<div id="ref-SOBoot" class="csl-entry" role="listitem">
StackExchange. 2023. <span>“Bootstrap Prediction Interval.”</span> <a href="https://stats.stackexchange.com/questions/226565/bootstrap-prediction-interval">https://stats.stackexchange.com/questions/226565/bootstrap-prediction-interval</a>.
</div>
</div></section><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>Technically we can model the variance with the features as well, but we’ll keep it simple here.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>The error rate (<span class="math inline">\(\alpha\)</span>) is the proportion of the data that would fall outside the prediction interval, while the coverage rate/interval is 1 - <span class="math inline">\(\alpha\)</span>.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>When I first started this post, there wasn’t much in the way of packages for conformal prediction in R. One <a href="https://github.com/ryantibs/conformal">was the conformal package</a>, but it is not very user friendly in the least. Others seem like one offs or have other limitations (e.g.&nbsp;only being for classification, working only in the tidymodels framework, etc.). More recently <span class="pack">probably</span> has add functionality that works nicely with the tidymodels framework, but I haven’t had a chance to try it out yet.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Interestingly all but the bootstrap appeared slightly narrow, but I think this has more to do with data issues, particularly the preponderance of house prices censored to ~500,000, about 5% of the data. No preprocessing was done except to put the home price on the log scale.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>There are methods like Bayesian Additive Regression Trees, but that’s a rabbit hole I didn’t think necessary to investigate for our purposes. Likewise we could also have done a very complicated linear model that incorporates interactions and nonlinearities.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>One of the more popular statistical packages in R is <code>lme4</code>, and the developers don’t provide prediction intervals for mixed models because “it is difficult to define an efficient method that incorporates uncertainty in the variance parameters”. They suggest to use bootstrapping instead.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a></div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{clark2025,
  author = {Clark, Michael},
  title = {Uncertainty {Estimation} with {Conformal} {Prediction}},
  date = {2025-05-21},
  url = {https://m-clark.github.io/posts/2025-05-21-conformal/},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-clark2025" class="csl-entry quarto-appendix-citeas" role="listitem">
Clark, Michael. 2025. <span>“Uncertainty Estimation with Conformal
Prediction.”</span> May 21, 2025. <a href="https://m-clark.github.io/posts/2025-05-21-conformal/">https://m-clark.github.io/posts/2025-05-21-conformal/</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/m-clark\.github\.io");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb4" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> 'Uncertainty Estimation with Conformal Prediction'</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="an">description:</span><span class="co"> More options for uncertainty estimation</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> 2025-05-21</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="an">image:</span><span class="co"> ../../img/conformal/boost-plot.png</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> </span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">    html:</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">        html-table-processing: none</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">        # not convinced any image settings are applicable with jupyter engine</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">        fig-width: 8</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">        fig-height: 6</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co">        default-image-extension: svg</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co">        code-tools: true # ignored?</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co">        code-fold: true</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span><span class="co"> </span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="co">    echo: false</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="an">bibliography:</span><span class="co"> refs.bib</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co">    - machine learning</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="co">    - regression</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co">    - boosting</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="an">nocite:</span><span class="co"> |</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co">    @lei2018distribution, @SOBoot, @angelopoulos2022gentle, @brownlee2019, @va2022, @tidymodels2023, @molnar2023, @bai2021understanding</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="co">#| include: false</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: 'setup'</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="co"># reticulate::use_condaenv("conformal")</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>okabe_ito <span class="ot">=</span> <span class="fu">c</span>(<span class="st">'#E69F00'</span>, <span class="st">'#56B4E9'</span>, <span class="st">'#009E73'</span>, <span class="st">'#F0E442'</span>, <span class="st">'#0072B2'</span>, <span class="st">'#D55E00'</span>, <span class="st">'#CC79A7'</span>)</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">'theme.r'</span>)</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; As with the </span><span class="co">[</span><span class="ot">last post on class imbalance</span><span class="co">](https://m-clark.github.io/posts/2025-04-07-class-imbalance/)</span><span class="at">, this is a resurrection of sorts. I began this post a little after that one had gotten an initial draft completed. Since then, conformal prediction has caught on quite a bit, but there wasn't much at the time in terms of tools. I was focused on MAPIE as that's a good package in Python, and as I was writing this, </span><span class="co">[</span><span class="ot">probably</span><span class="co">]</span><span class="at">{.pack} finally offered something more viable in R.  I definitely recommend R folks to check it out.</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a><span class="fu">## Introduction</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>Uncertainty estimation is a crucial component of machine learning systems. It is vital to know how precise our model predictions are, and whether we feel confident in taking action based on them. While typical usage of prediction and performance is often done with little consideration of uncertainty, we do so at our own (very predictable) peril. Here we will discuss uncertainty in the context of prediction, and how we can estimate it using several methods. We will focus especially on conformal prediction, a tried but relatively newer approach to uncertainty estimation that has several advantages.  This post covers:</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Why Uncertainty Estimation is Important**: We'll discuss why uncertainty estimation is important and how it can be used to make better decisions.</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Approaches to Uncertainty Estimation**: We'll discuss different approaches to uncertainty estimation, including statistical prediction intervals, bootstrapping, Bayesian approaches, and conformal prediction.</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Example**: We'll demonstrate how to use conformal prediction to estimate uncertainty in a simple example to help demystify the process.</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Pros and Cons**: We'll discuss the advantages and disadvantages of different approaches to uncertainty estimation.</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a><span class="fu">## Why is Uncertainty Estimation Important?</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>Uncertainty estimation is an indispensable part of our modeling endeavor, and *one of the main reasons is that it allows us to make better decisions from our data*. The more we understand our predictions, the more we can feel confident in taking action based on them. Understanding uncertainty can also help us understand the model itself, and especially where its weaknesses are, or at what points we should be more cautious.</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>For example, if we are building a model to predict the number of sales for a product, we would like to better assess our prediction of future sales in order to take current action. This could be increasing our marketing budget for the months ahead, or possibly assessing whether current marketing strategies have been successful. Our model may predict that we can expect an increase in sales of 150 units with the increased budget of 5%. If the range for the prediction is that the expected sales increase six months from now is between 100 and 200 units, we might make a different decision than if we expect the unit sales to be between -100 and 400 units. In the first case, we might be more willing to increase our budget spend, since it seems we are likely to experience an increase in sales by doing so. In the second case, we might not take any action, since the range encompasses anywhere between lost sales to an even larger boost. </span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>The following illustrates the issue. The prediction on the left suggests less value and has notable uncertainty with that assessment. That might be easy to rule out. But the other two predictions take some thought. One is higher with less uncertainty, while the other prediction is slightly lower, but with more uncertainty that suggests the upside might be greater. Which would you prefer?</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: 'uncertainty-plot'</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggdist)</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>okabe_ito <span class="ot">=</span> <span class="fu">c</span>(<span class="st">'#E69F00'</span>, <span class="st">'#56B4E9'</span>, <span class="st">'#009E73'</span>, <span class="st">'#F0E442'</span>, <span class="st">'#0072B2'</span>, <span class="st">'#D55E00'</span>, <span class="st">'#CC79A7'</span>)</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">tribble</span>(</span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>group, <span class="sc">~</span>subgroup, <span class="sc">~</span>value,</span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>    <span class="st">"A"</span>,          <span class="st">"h"</span>, <span class="fu">rnorm</span>(<span class="dv">100</span>, <span class="at">mean =</span> <span class="dv">500</span>, <span class="at">sd =</span> <span class="dv">100</span><span class="sc">*</span><span class="dv">1</span>),</span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>    <span class="st">"B"</span>,          <span class="st">"h"</span>, <span class="fu">rnorm</span>(<span class="dv">100</span>, <span class="at">mean =</span> <span class="dv">700</span>, <span class="at">sd =</span> <span class="dv">100</span><span class="sc">*</span>.<span class="dv">5</span>),</span>
<span id="cb4-79"><a href="#cb4-79" aria-hidden="true" tabindex="-1"></a>    <span class="st">"C"</span>,          <span class="st">"h"</span>, <span class="fu">rnorm</span>(<span class="dv">100</span>, <span class="at">mean =</span> <span class="dv">600</span>, <span class="at">sd =</span> <span class="dv">100</span><span class="sc">*</span>.<span class="dv">5</span>),</span>
<span id="cb4-80"><a href="#cb4-80" aria-hidden="true" tabindex="-1"></a>    <span class="st">"C"</span>,          <span class="st">"i"</span>, <span class="fu">rnorm</span>(<span class="dv">100</span>, <span class="at">mean =</span> <span class="dv">800</span>, <span class="at">sd =</span> <span class="dv">100</span><span class="sc">*</span><span class="dv">2</span>),</span>
<span id="cb4-81"><a href="#cb4-81" aria-hidden="true" tabindex="-1"></a>    <span class="st">"C"</span>,          <span class="st">"j"</span>, <span class="fu">rnorm</span>(<span class="dv">100</span>, <span class="at">mean =</span> <span class="dv">700</span>, <span class="at">sd =</span> <span class="dv">100</span><span class="sc">*</span><span class="dv">1</span>)</span>
<span id="cb4-82"><a href="#cb4-82" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb4-83"><a href="#cb4-83" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unnest</span>(value)</span>
<span id="cb4-84"><a href="#cb4-84" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb4-85"><a href="#cb4-85" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> group, <span class="at">y =</span> value, <span class="at">fill =</span> group, <span class="at">color =</span> group)) <span class="sc">+</span></span>
<span id="cb4-86"><a href="#cb4-86" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stat_gradientinterval</span>(</span>
<span id="cb4-87"><a href="#cb4-87" aria-hidden="true" tabindex="-1"></a>        <span class="at">position =</span> <span class="st">"dodge"</span>,</span>
<span id="cb4-88"><a href="#cb4-88" aria-hidden="true" tabindex="-1"></a>        <span class="at">width=</span>.<span class="dv">25</span>,</span>
<span id="cb4-89"><a href="#cb4-89" aria-hidden="true" tabindex="-1"></a>        <span class="co"># linewidth=10,</span></span>
<span id="cb4-90"><a href="#cb4-90" aria-hidden="true" tabindex="-1"></a>        <span class="at">point_size=</span><span class="dv">5</span></span>
<span id="cb4-91"><a href="#cb4-91" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb4-92"><a href="#cb4-92" aria-hidden="true" tabindex="-1"></a>    scico<span class="sc">::</span><span class="fu">scale_fill_scico_d</span>(<span class="at">palette =</span> <span class="st">"batlow"</span>, <span class="at">end=</span>.<span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb4-93"><a href="#cb4-93" aria-hidden="true" tabindex="-1"></a>    scico<span class="sc">::</span><span class="fu">scale_color_scico_d</span>(<span class="at">palette =</span> <span class="st">"batlow"</span>, <span class="at">end=</span>.<span class="dv">6</span>) <span class="sc">+</span></span>
<span id="cb4-94"><a href="#cb4-94" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(</span>
<span id="cb4-95"><a href="#cb4-95" aria-hidden="true" tabindex="-1"></a>        <span class="at">labels =</span> scales<span class="sc">::</span><span class="fu">dollar_format</span>(),</span>
<span id="cb4-96"><a href="#cb4-96" aria-hidden="true" tabindex="-1"></a>        <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1200</span>, <span class="dv">100</span>),</span>
<span id="cb4-97"><a href="#cb4-97" aria-hidden="true" tabindex="-1"></a>        <span class="co"># limits = c(0, 1000)</span></span>
<span id="cb4-98"><a href="#cb4-98" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb4-99"><a href="#cb4-99" aria-hidden="true" tabindex="-1"></a>    <span class="co"># scale_color_manual(values = okabe_ito) +</span></span>
<span id="cb4-100"><a href="#cb4-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># scale_fill_manual(values = okabe_ito) +</span></span>
<span id="cb4-101"><a href="#cb4-101" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb4-102"><a href="#cb4-102" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">''</span>,</span>
<span id="cb4-103"><a href="#cb4-103" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">'Value'</span>,</span>
<span id="cb4-104"><a href="#cb4-104" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Which do you prefer?"</span>,</span>
<span id="cb4-105"><a href="#cb4-105" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"Comparison of Different Predictions with Uncertainty"</span></span>
<span id="cb4-106"><a href="#cb4-106" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb4-107"><a href="#cb4-107" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_clean</span>() <span class="sc">+</span></span>
<span id="cb4-108"><a href="#cb4-108" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb4-109"><a href="#cb4-109" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb4-110"><a href="#cb4-110" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb4-111"><a href="#cb4-111" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb4-112"><a href="#cb4-112" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb4-113"><a href="#cb4-113" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.major.y =</span> <span class="fu">element_line</span>(),</span>
<span id="cb4-114"><a href="#cb4-114" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-115"><a href="#cb4-115" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb4-116"><a href="#cb4-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-117"><a href="#cb4-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-118"><a href="#cb4-118" aria-hidden="true" tabindex="-1"></a>Many times stakeholders will take action given the prediction alone, and then are disappointed when things don't turn out as expected, which they definitely will not in practice. In similar fashion, some take action based on rankings of the predictions, which of course themselves have uncertainty that stems from the raw prediction, and even more so. In some situations, we may be able to get away with doing so, but it would be difficult to know this ahead of time. The old adage of not wanting to put all your eggs in one (prediction) basket applies here.</span>
<span id="cb4-119"><a href="#cb4-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-120"><a href="#cb4-120" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- </span><span class="al">TODO</span><span class="co">: generic pointrange type of plot with question marks --&gt;</span></span>
<span id="cb4-121"><a href="#cb4-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-122"><a href="#cb4-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-123"><a href="#cb4-123" aria-hidden="true" tabindex="-1"></a><span class="fu">### Contributing Factors</span></span>
<span id="cb4-124"><a href="#cb4-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-125"><a href="#cb4-125" aria-hidden="true" tabindex="-1"></a>Several key factors contribute to prediction uncertainty, among them:</span>
<span id="cb4-126"><a href="#cb4-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-127"><a href="#cb4-127" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Amount of Data**: While more data can lead us to feel more confident about predictions in a general sense by providing additional learning examples of varying kinds, this is limited.  Additional bad or uninformative data will not improve a model or its predictions!</span>
<span id="cb4-128"><a href="#cb4-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-129"><a href="#cb4-129" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Model Complexity**: More complex models may capture nuanced relationships leading to better predictions, but can also introduce instability in those predictions if additional steps aren't taken. Conversely, having too simple a model yields relatively poor predictions in general.</span>
<span id="cb4-130"><a href="#cb4-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-131"><a href="#cb4-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-132"><a href="#cb4-132" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Precision of Measurement**: The quality of the data collection process definitely impacts any predictions we might ultimately make. For example, if sales are entered with possible error, or a lag for some reporting units and not for others, this can lead to uncertainty in our predictions of future sales. In addition, the precision of measurement can vary across features. For example, if price is a feature, it may be that price fluctuates within a month but sales are recorded for a month, meaning we might have to take an average or other measure of price. </span>
<span id="cb4-133"><a href="#cb4-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-134"><a href="#cb4-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-135"><a href="#cb4-135" aria-hidden="true" tabindex="-1"></a>So any number of things might contribute to the uncertainty in our predictions and, in general, some aspects contributing to prediction uncertainty may be under our control, while others may not be.  Different methods produce different results, and  some intervals may be too narrow or too wide in some settings, giving false confidence or excessive caution. In what follows, we'll explore various uncertainty estimation approaches with a focus on **conformal prediction**, demonstrating its implementation and comparing its advantages to alternative methods. We'll start by discussing the importance of uncertainty estimation and the different approaches to it. Next, we will discuss conformal prediction and show a simple demonstration of how it can be used to estimate uncertainty. Finally, we will discuss the advantages and disadvantages of conformal prediction compared to other approaches to uncertainty estimation.</span>
<span id="cb4-136"><a href="#cb4-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-137"><a href="#cb4-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-138"><a href="#cb4-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-139"><a href="#cb4-139" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip title='Confidence is not Certainty'}</span>
<span id="cb4-140"><a href="#cb4-140" aria-hidden="true" tabindex="-1"></a>It's crucial to understand that *confidence* in terms of confidence intervals is not the same concept as *certainty*. The same level of confidence interval, say 95%, can produce different interval widths across models for the same prediction, and across predictions for the same model/data. Certainty reflects our understanding about the range provided by a confidence interval, and, for a given setting, we have less uncertainty with narrower intervals than wider ones.</span>
<span id="cb4-141"><a href="#cb4-141" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb4-142"><a href="#cb4-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-143"><a href="#cb4-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-144"><a href="#cb4-144" aria-hidden="true" tabindex="-1"></a><span class="fu">## Strategies for Quantifying Uncertainty</span></span>
<span id="cb4-145"><a href="#cb4-145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-146"><a href="#cb4-146" aria-hidden="true" tabindex="-1"></a>There are several approaches to uncertainty estimation, and many different things we can calculate uncertainty for. We'll focus specifically on uncertainty for predictions, and we'll briefly describe and demonstrate some of the different ways of getting an uncertainty estimate for those. </span>
<span id="cb4-147"><a href="#cb4-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-150"><a href="#cb4-150" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb4-151"><a href="#cb4-151" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb4-152"><a href="#cb4-152" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: 'data-r'</span></span>
<span id="cb4-153"><a href="#cb4-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-154"><a href="#cb4-154" aria-hidden="true" tabindex="-1"></a>data_dir <span class="ot">=</span> <span class="st">"data/conformal/"</span></span>
<span id="cb4-155"><a href="#cb4-155" aria-hidden="true" tabindex="-1"></a>df_ca <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(data_dir, <span class="st">'housing.csv'</span>))</span>
<span id="cb4-156"><a href="#cb4-156" aria-hidden="true" tabindex="-1"></a>df_results <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(data_dir, <span class="st">'housing_CI_results.csv'</span>))</span>
<span id="cb4-157"><a href="#cb4-157" aria-hidden="true" tabindex="-1"></a>df_results_bayes <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(data_dir, <span class="st">'housing_CI_bayes_results.csv'</span>))</span>
<span id="cb4-158"><a href="#cb4-158" aria-hidden="true" tabindex="-1"></a>df_results_boost <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(data_dir, <span class="st">"housing_CI_boost_results.csv"</span>))</span>
<span id="cb4-159"><a href="#cb4-159" aria-hidden="true" tabindex="-1"></a>df_results <span class="ot">=</span> df_results  <span class="sc">|&gt;</span> <span class="fu">bind_cols</span>(df_results_bayes <span class="sc">|&gt;</span> <span class="fu">select</span>(bayes_lower, bayes_upper))</span>
<span id="cb4-160"><a href="#cb4-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-161"><a href="#cb4-161" aria-hidden="true" tabindex="-1"></a>X_train <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(data_dir, <span class="st">"housing_X_train.csv"</span>))</span>
<span id="cb4-162"><a href="#cb4-162" aria-hidden="true" tabindex="-1"></a>y_train <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(data_dir, <span class="st">"housing_y_train.csv"</span>))[[<span class="st">"median_house_value"</span>]]</span>
<span id="cb4-163"><a href="#cb4-163" aria-hidden="true" tabindex="-1"></a>X_test  <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(data_dir, <span class="st">"housing_X_test.csv"</span>))</span>
<span id="cb4-164"><a href="#cb4-164" aria-hidden="true" tabindex="-1"></a>y_test  <span class="ot">=</span> <span class="fu">read_csv</span>(<span class="fu">paste0</span>(data_dir, <span class="st">"housing_y_test.csv"</span>))[[<span class="st">"median_house_value"</span>]]</span>
<span id="cb4-165"><a href="#cb4-165" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb4-166"><a href="#cb4-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-169"><a href="#cb4-169" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb4-170"><a href="#cb4-170" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb4-171"><a href="#cb4-171" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: 'data-py'</span></span>
<span id="cb4-172"><a href="#cb4-172" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb4-173"><a href="#cb4-173" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb4-174"><a href="#cb4-174" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb4-175"><a href="#cb4-175" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb4-176"><a href="#cb4-176" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mapie.metrics <span class="im">import</span> regression_coverage_score</span>
<span id="cb4-177"><a href="#cb4-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-178"><a href="#cb4-178" aria-hidden="true" tabindex="-1"></a>np.set_printoptions(legacy<span class="op">=</span><span class="st">"1.25"</span>) <span class="co"># to get rid of ridiculous np.float in prints</span></span>
<span id="cb4-179"><a href="#cb4-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-180"><a href="#cb4-180" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> <span class="st">"data/conformal/"</span></span>
<span id="cb4-181"><a href="#cb4-181" aria-hidden="true" tabindex="-1"></a>df_results_boost <span class="op">=</span> pd.read_csv(data_dir <span class="op">+</span> <span class="st">"housing_CI_boost_results.csv"</span>) </span>
<span id="cb4-182"><a href="#cb4-182" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> pd.read_csv(data_dir <span class="op">+</span> <span class="st">"housing_X_train.csv"</span>)</span>
<span id="cb4-183"><a href="#cb4-183" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> pd.read_csv(data_dir <span class="op">+</span> <span class="st">"housing_y_train.csv"</span>)[<span class="st">'median_house_value'</span>]</span>
<span id="cb4-184"><a href="#cb4-184" aria-hidden="true" tabindex="-1"></a>X_test  <span class="op">=</span> pd.read_csv(data_dir <span class="op">+</span> <span class="st">"housing_X_test.csv"</span>)</span>
<span id="cb4-185"><a href="#cb4-185" aria-hidden="true" tabindex="-1"></a>y_test  <span class="op">=</span> pd.read_csv(data_dir <span class="op">+</span> <span class="st">"housing_y_test.csv"</span>)[<span class="st">'median_house_value'</span>]</span>
<span id="cb4-186"><a href="#cb4-186" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb4-187"><a href="#cb4-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-190"><a href="#cb4-190" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb4-191"><a href="#cb4-191" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb4-192"><a href="#cb4-192" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: 'coverage-py'</span></span>
<span id="cb4-193"><a href="#cb4-193" aria-hidden="true" tabindex="-1"></a><span class="co"># df_results_boost.head()</span></span>
<span id="cb4-194"><a href="#cb4-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-195"><a href="#cb4-195" aria-hidden="true" tabindex="-1"></a><span class="co"># y_pred, yp_conf_ci = lr_ca.predict(X_test, alpha=[.05, 0.1])</span></span>
<span id="cb4-196"><a href="#cb4-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-197"><a href="#cb4-197" aria-hidden="true" tabindex="-1"></a>coverage_scores <span class="op">=</span> [</span>
<span id="cb4-198"><a href="#cb4-198" aria-hidden="true" tabindex="-1"></a>    <span class="bu">dict</span>(</span>
<span id="cb4-199"><a href="#cb4-199" aria-hidden="true" tabindex="-1"></a>        boost_cov <span class="op">=</span> np.<span class="bu">round</span>(regression_coverage_score(y_test, df_results_boost[<span class="st">'conf_lower'</span>], df_results_boost[<span class="st">'conf_upper'</span>]), <span class="dv">4</span>),</span>
<span id="cb4-200"><a href="#cb4-200" aria-hidden="true" tabindex="-1"></a>        boot_cov  <span class="op">=</span> np.<span class="bu">round</span>(regression_coverage_score(y_test, df_results_boost[<span class="st">'boot_lower'</span>], df_results_boost[<span class="st">'boot_upper'</span>]), <span class="dv">4</span>)</span>
<span id="cb4-201"><a href="#cb4-201" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-202"><a href="#cb4-202" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, _ <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="fl">.1</span>])</span>
<span id="cb4-203"><a href="#cb4-203" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb4-204"><a href="#cb4-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-205"><a href="#cb4-205" aria-hidden="true" tabindex="-1"></a>coverage_result <span class="op">=</span> pd.DataFrame(coverage_scores).<span class="bu">round</span>(<span class="dv">3</span>)</span>
<span id="cb4-206"><a href="#cb4-206" aria-hidden="true" tabindex="-1"></a>coverage_result.to_csv(data_dir <span class="op">+</span> <span class="st">"coverage_results.csv"</span>, index <span class="op">=</span> <span class="va">False</span>) <span class="co"># to get around numpy</span></span>
<span id="cb4-207"><a href="#cb4-207" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb4-208"><a href="#cb4-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-211"><a href="#cb4-211" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb4-212"><a href="#cb4-212" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb4-213"><a href="#cb4-213" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: 'coverage-r'</span></span>
<span id="cb4-214"><a href="#cb4-214" aria-hidden="true" tabindex="-1"></a>cover <span class="ot">=</span> py<span class="sc">$</span>coverage_result <span class="co"># no way to convert to num</span></span>
<span id="cb4-215"><a href="#cb4-215" aria-hidden="true" tabindex="-1"></a>cover_boot <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(cover<span class="sc">$</span>boot_cov[<span class="dv">0</span>]))</span>
<span id="cb4-216"><a href="#cb4-216" aria-hidden="true" tabindex="-1"></a>cover_boost <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(cover<span class="sc">$</span>boost_cov[<span class="dv">0</span>]))</span>
<span id="cb4-217"><a href="#cb4-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-218"><a href="#cb4-218" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb4-219"><a href="#cb4-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-220"><a href="#cb4-220" aria-hidden="true" tabindex="-1"></a><span class="fu">### Statistical Uncertainty</span></span>
<span id="cb4-221"><a href="#cb4-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-222"><a href="#cb4-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-223"><a href="#cb4-223" aria-hidden="true" tabindex="-1"></a>$$y \sim \mathcal{N}(\mu, \sigma^2)$$</span>
<span id="cb4-224"><a href="#cb4-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-225"><a href="#cb4-225" aria-hidden="true" tabindex="-1"></a>Probably the most common approach to estimate uncertainty is to use a statistical model. Given a statistical distribution and the estimated parameters of the model, we can get a sense of uncertainty in the prediction.  For example, let's say we have a standard linear regression model. In that case, we are assuming the data generating process for the target/outcome is a normal distribution. The mean for that distribution comes from our model via the linear combination of features, and the variance is estimated separately<span class="ot">[^predvar]</span>. Given those and other model-specific assumptions hold (e.g. homoscedasticity, independence of observations), we can then obtain an interval estimate for a prediction, typically using a standard formula. This approach extends well beyond both linear regression and the normal distribution, but the basic idea is the same. We assume a distribution for the target, estimate the parameters of that distribution via the data, and then use those estimates to ultimately obtain an interval estimate for our prediction.</span>
<span id="cb4-226"><a href="#cb4-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-227"><a href="#cb4-227" aria-hidden="true" tabindex="-1"></a><span class="ot">[^predvar]: </span>Technically we can model the variance with the features as well, but we'll keep it simple here.</span>
<span id="cb4-228"><a href="#cb4-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-229"><a href="#cb4-229" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!---</span></span>
<span id="cb4-230"><a href="#cb4-230" aria-hidden="true" tabindex="-1"></a><span class="co"> The following shows how the prediction interval for an unseen observation is constructed:</span></span>
<span id="cb4-231"><a href="#cb4-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-232"><a href="#cb4-232" aria-hidden="true" tabindex="-1"></a><span class="co">$$</span></span>
<span id="cb4-233"><a href="#cb4-233" aria-hidden="true" tabindex="-1"></a><span class="co">\hat{y} \pm t_{\alpha/2, n-2} \hat{\sigma} \sqrt{1 + \frac{1}{n} + \frac{(x - \bar{x})^2}{\sum_{i=1}^n (x_i - \bar{x})^2}}</span></span>
<span id="cb4-234"><a href="#cb4-234" aria-hidden="true" tabindex="-1"></a><span class="co">$$ </span></span>
<span id="cb4-235"><a href="#cb4-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-236"><a href="#cb4-236" aria-hidden="true" tabindex="-1"></a><span class="co">where $\hat{y}$ is the predicted value, $t_{\alpha/2, n-2}$ is the critical value of the t-distribution with $n-2$ degrees of freedom, $\hat{\sigma}$ is the standard error of the regression, $x$ is the value of the predictor, and $\bar{x}$ is the mean of the predictor. </span></span>
<span id="cb4-237"><a href="#cb4-237" aria-hidden="true" tabindex="-1"></a><span class="co">---&gt;</span></span>
<span id="cb4-238"><a href="#cb4-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-239"><a href="#cb4-239" aria-hidden="true" tabindex="-1"></a>:::{.callout-tip}</span>
<span id="cb4-240"><a href="#cb4-240" aria-hidden="true" tabindex="-1"></a>We can contrast the *prediction interval* versus a <span class="co">[</span><span class="ot">confidence interval for a prediction</span><span class="co">](https://stats.stackexchange.com/questions/16493/difference-between-confidence-intervals-and-prediction-intervals)</span>, i.e., for the prediction for an <span class="sc">\*</span>average response<span class="sc">\*</span>.  The latter will always be smaller, as it reflects the uncertainty in the mean of the distribution of predictions, rather than the uncertainty in the predicted value for a <span class="sc">\*</span>new<span class="sc">\*</span> observation, which is what the prediction interval regards.  </span>
<span id="cb4-241"><a href="#cb4-241" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb4-242"><a href="#cb4-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-243"><a href="#cb4-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-244"><a href="#cb4-244" aria-hidden="true" tabindex="-1"></a><span class="fu">### Bootstrapping</span></span>
<span id="cb4-245"><a href="#cb4-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-246"><a href="#cb4-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-249"><a href="#cb4-249" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb4-250"><a href="#cb4-250" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: 'boot-r'</span></span>
<span id="cb4-251"><a href="#cb4-251" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: 'Bootstrap Resampling Visualization'</span></span>
<span id="cb4-252"><a href="#cb4-252" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: 66%</span></span>
<span id="cb4-253"><a href="#cb4-253" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb4-254"><a href="#cb4-254" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb4-255"><a href="#cb4-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-256"><a href="#cb4-256" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb4-257"><a href="#cb4-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-258"><a href="#cb4-258" aria-hidden="true" tabindex="-1"></a><span class="co"># Create original dataset (5 rows, 3 columns)</span></span>
<span id="cb4-259"><a href="#cb4-259" aria-hidden="true" tabindex="-1"></a>df_data <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb4-260"><a href="#cb4-260" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,</span>
<span id="cb4-261"><a href="#cb4-261" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Col 1</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">2</span>, <span class="dv">7</span>, <span class="dv">4</span>),</span>
<span id="cb4-262"><a href="#cb4-262" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Col 2</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">8</span>, <span class="dv">1</span>, <span class="dv">6</span>, <span class="dv">2</span>, <span class="dv">9</span>),</span>
<span id="cb4-263"><a href="#cb4-263" aria-hidden="true" tabindex="-1"></a>    <span class="st">`</span><span class="at">Col 3</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">6</span>)</span>
<span id="cb4-264"><a href="#cb4-264" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-265"><a href="#cb4-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-266"><a href="#cb4-266" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to create bootstrap sample</span></span>
<span id="cb4-267"><a href="#cb4-267" aria-hidden="true" tabindex="-1"></a>create_bootstrap <span class="ot">=</span> <span class="cf">function</span>(data, sample_id) {</span>
<span id="cb4-268"><a href="#cb4-268" aria-hidden="true" tabindex="-1"></a>    indices <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(data), <span class="fu">nrow</span>(data), <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-269"><a href="#cb4-269" aria-hidden="true" tabindex="-1"></a>    sampled <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb4-270"><a href="#cb4-270" aria-hidden="true" tabindex="-1"></a>        <span class="at">original_id =</span> indices,</span>
<span id="cb4-271"><a href="#cb4-271" aria-hidden="true" tabindex="-1"></a>        <span class="at">bootstrap_id =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(indices),</span>
<span id="cb4-272"><a href="#cb4-272" aria-hidden="true" tabindex="-1"></a>        <span class="at">sample_id =</span> sample_id</span>
<span id="cb4-273"><a href="#cb4-273" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-274"><a href="#cb4-274" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(sampled)</span>
<span id="cb4-275"><a href="#cb4-275" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-276"><a href="#cb4-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-277"><a href="#cb4-277" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate 3 bootstrap samples</span></span>
<span id="cb4-278"><a href="#cb4-278" aria-hidden="true" tabindex="-1"></a>bootstrap_samples <span class="ot">=</span> <span class="fu">bind_rows</span>(</span>
<span id="cb4-279"><a href="#cb4-279" aria-hidden="true" tabindex="-1"></a>    <span class="fu">create_bootstrap</span>(df_data, <span class="dv">1</span>),</span>
<span id="cb4-280"><a href="#cb4-280" aria-hidden="true" tabindex="-1"></a>    <span class="fu">create_bootstrap</span>(df_data, <span class="dv">2</span>),</span>
<span id="cb4-281"><a href="#cb4-281" aria-hidden="true" tabindex="-1"></a>    <span class="fu">create_bootstrap</span>(df_data, <span class="dv">3</span>)</span>
<span id="cb4-282"><a href="#cb4-282" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-283"><a href="#cb4-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-284"><a href="#cb4-284" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate long format for original data visualization</span></span>
<span id="cb4-285"><a href="#cb4-285" aria-hidden="true" tabindex="-1"></a>df_original_long <span class="ot">=</span> df_data <span class="sc">%&gt;%</span></span>
<span id="cb4-286"><a href="#cb4-286" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>id) <span class="sc">%&gt;%</span></span>
<span id="cb4-287"><a href="#cb4-287" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">everything</span>(), <span class="at">names_to =</span> <span class="st">'column'</span>, <span class="at">values_to =</span> <span class="st">'value'</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-288"><a href="#cb4-288" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">3</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-289"><a href="#cb4-289" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(id, column)</span>
<span id="cb4-290"><a href="#cb4-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-291"><a href="#cb4-291" aria-hidden="true" tabindex="-1"></a><span class="co"># Define color palette for original rows</span></span>
<span id="cb4-292"><a href="#cb4-292" aria-hidden="true" tabindex="-1"></a>row_colors <span class="ot">=</span> <span class="fu">c</span>(<span class="st">'#E69F00'</span>, <span class="st">'#56B4E9'</span>, <span class="st">'#009E73'</span>, <span class="st">'#CC79A7'</span>, <span class="st">'#0072B2'</span>)</span>
<span id="cb4-293"><a href="#cb4-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-294"><a href="#cb4-294" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the original data visualization</span></span>
<span id="cb4-295"><a href="#cb4-295" aria-hidden="true" tabindex="-1"></a>p_original <span class="ot">=</span> <span class="fu">ggplot</span>(df_original_long, <span class="fu">aes</span>(<span class="at">x =</span> column, <span class="at">y =</span> id, <span class="at">fill =</span> <span class="fu">factor</span>(id))) <span class="sc">+</span></span>
<span id="cb4-296"><a href="#cb4-296" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>(<span class="at">color =</span> <span class="st">'white'</span>, <span class="at">width =</span> <span class="fl">0.9</span>, <span class="at">height =</span> <span class="fl">0.4</span>) <span class="sc">+</span></span>
<span id="cb4-297"><a href="#cb4-297" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> row_colors) <span class="sc">+</span></span>
<span id="cb4-298"><a href="#cb4-298" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_reverse</span>(<span class="at">breaks =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">labels =</span> <span class="fu">paste</span>(<span class="st">'Row'</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)) <span class="sc">+</span></span>
<span id="cb4-299"><a href="#cb4-299" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">'Original Data'</span>, <span class="at">x =</span> <span class="st">''</span>, <span class="at">y =</span> <span class="st">''</span>) <span class="sc">+</span></span>
<span id="cb4-300"><a href="#cb4-300" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb4-301"><a href="#cb4-301" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb4-302"><a href="#cb4-302" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">'none'</span>,</span>
<span id="cb4-303"><a href="#cb4-303" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb4-304"><a href="#cb4-304" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb4-305"><a href="#cb4-305" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb4-306"><a href="#cb4-306" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-307"><a href="#cb4-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-308"><a href="#cb4-308" aria-hidden="true" tabindex="-1"></a><span class="co"># Create bootstrap sample visualizations</span></span>
<span id="cb4-309"><a href="#cb4-309" aria-hidden="true" tabindex="-1"></a><span class="co"># Create bootstrap sample visualizations</span></span>
<span id="cb4-310"><a href="#cb4-310" aria-hidden="true" tabindex="-1"></a>p_bootstrap <span class="ot">=</span> bootstrap_samples <span class="sc">%&gt;%</span></span>
<span id="cb4-311"><a href="#cb4-311" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(df_data, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"original_id"</span> <span class="ot">=</span> <span class="st">"id"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb4-312"><a href="#cb4-312" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(<span class="st">`</span><span class="at">Col 1</span><span class="st">`</span>, <span class="st">`</span><span class="at">Col 2</span><span class="st">`</span>, <span class="st">`</span><span class="at">Col 3</span><span class="st">`</span>), <span class="at">names_to =</span> <span class="st">"column"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb4-313"><a href="#cb4-313" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb4-314"><a href="#cb4-314" aria-hidden="true" tabindex="-1"></a>        <span class="at">sample_name =</span> <span class="fu">paste</span>(<span class="st">'Bootstrap Sample'</span>, sample_id),</span>
<span id="cb4-315"><a href="#cb4-315" aria-hidden="true" tabindex="-1"></a>        <span class="at">bootstrap_id =</span> <span class="fu">paste</span>(<span class="st">'Row '</span>, bootstrap_id),</span>
<span id="cb4-316"><a href="#cb4-316" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb4-317"><a href="#cb4-317" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> column, <span class="at">y =</span> bootstrap_id, <span class="at">fill =</span> <span class="fu">factor</span>(original_id))) <span class="sc">+</span></span>
<span id="cb4-318"><a href="#cb4-318" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>(<span class="at">color =</span> <span class="st">'white'</span>, <span class="at">width =</span> <span class="fl">0.9</span>, <span class="at">height =</span> <span class="fl">0.9</span>) <span class="sc">+</span></span>
<span id="cb4-319"><a href="#cb4-319" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> row_colors) <span class="sc">+</span></span>
<span id="cb4-320"><a href="#cb4-320" aria-hidden="true" tabindex="-1"></a>    <span class="co"># scale_y_reverse() +</span></span>
<span id="cb4-321"><a href="#cb4-321" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>sample_name, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb4-322"><a href="#cb4-322" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">''</span>, <span class="at">y =</span> <span class="st">''</span>) <span class="sc">+</span></span>
<span id="cb4-323"><a href="#cb4-323" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb4-324"><a href="#cb4-324" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb4-325"><a href="#cb4-325" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">'none'</span>,</span>
<span id="cb4-326"><a href="#cb4-326" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb4-327"><a href="#cb4-327" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>, <span class="at">face =</span> <span class="st">'bold'</span>),</span>
<span id="cb4-328"><a href="#cb4-328" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb4-329"><a href="#cb4-329" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb4-330"><a href="#cb4-330" aria-hidden="true" tabindex="-1"></a>        <span class="co"># axis.text.y = element_text(color='#fff'),</span></span>
<span id="cb4-331"><a href="#cb4-331" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-332"><a href="#cb4-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-333"><a href="#cb4-333" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine plots</span></span>
<span id="cb4-334"><a href="#cb4-334" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine plots with centered original data</span></span>
<span id="cb4-335"><a href="#cb4-335" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine plots with proper layout</span></span>
<span id="cb4-336"><a href="#cb4-336" aria-hidden="true" tabindex="-1"></a>(<span class="fu">plot_spacer</span>() <span class="sc">+</span> p_original <span class="sc">+</span> <span class="fu">plot_spacer</span>() <span class="sc">+</span> </span>
<span id="cb4-337"><a href="#cb4-337" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_layout</span>(<span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">widths =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>))) <span class="sc">/</span></span>
<span id="cb4-338"><a href="#cb4-338" aria-hidden="true" tabindex="-1"></a>    p_bootstrap <span class="sc">+</span></span>
<span id="cb4-339"><a href="#cb4-339" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_layout</span>(<span class="at">heights =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>)) <span class="sc">+</span></span>
<span id="cb4-340"><a href="#cb4-340" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_annotation</span>(</span>
<span id="cb4-341"><a href="#cb4-341" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">'Bootstrap Resampling Visualization'</span>,</span>
<span id="cb4-342"><a href="#cb4-342" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">'Colors show which original observation rows appear in each bootstrap sample'</span>,</span>
<span id="cb4-343"><a href="#cb4-343" aria-hidden="true" tabindex="-1"></a>        <span class="at">theme =</span> <span class="fu">theme</span>(</span>
<span id="cb4-344"><a href="#cb4-344" aria-hidden="true" tabindex="-1"></a>            <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb4-345"><a href="#cb4-345" aria-hidden="true" tabindex="-1"></a>            <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb4-346"><a href="#cb4-346" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-347"><a href="#cb4-347" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-348"><a href="#cb4-348" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb4-349"><a href="#cb4-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-350"><a href="#cb4-350" aria-hidden="true" tabindex="-1"></a>Bootstrapping is another technique for estimating uncertainty in machine learning models. By repeatedly resampling our original dataset with replacement, we create multiple versions of our data that capture its inherent variability. This process mirrors what would happen if we could collect many different samples from the population. Each resampled dataset produces slightly different model parameters, and consequently, different predictions for the same input. The variation across these predictions directly quantifies our uncertainty - wider spread indicating higher uncertainty, narrower spread suggesting more confidence.</span>
<span id="cb4-351"><a href="#cb4-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-352"><a href="#cb4-352" aria-hidden="true" tabindex="-1"></a>Think of it this way -- we take our data, resample the observations with replacement, and train a new model on the resampled data. We then use the new model to make predictions on the original or new/test data. Now we do that many times, taking the average for our final prediction. We then use the quantiles of the prediction distribution (e.g. corresponding to the 5th and 95th percentiles) across the bootstrap samples to get an interval estimate for our prediction. This is a very powerful technique, as it allows us to estimate the uncertainty in our predictions without making any assumptions about the underlying distribution of the data.</span>
<span id="cb4-353"><a href="#cb4-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-354"><a href="#cb4-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-355"><a href="#cb4-355" aria-hidden="true" tabindex="-1"></a><span class="fu">### Bayesian Approaches</span></span>
<span id="cb4-356"><a href="#cb4-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-357"><a href="#cb4-357" aria-hidden="true" tabindex="-1"></a><span class="al">![Prior, Likelihood, Posterior](../../img/priorLikePosterior.png)</span>{width=50%}</span>
<span id="cb4-358"><a href="#cb4-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-359"><a href="#cb4-359" aria-hidden="true" tabindex="-1"></a>Bootstrap and Bayesian approaches are kindred spirits in that they both generate a distribution for our predictions. The Bayesian approach does not require resampling the data, but it does have an assumption about the distributions of the parameters, which ultimately means it still makes assumptions similar to those in traditional statistical models. We use the Bayesian approach to provide a distribution for the parameters we're attempting to estimate. For our predictions, we then take random draws from that parameter distribution, feed it into our model to get a prediction, and then repeat that process many times. Again, we may take the average for our final prediction, and the quantiles of interest for our interval estimate.</span>
<span id="cb4-360"><a href="#cb4-360" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-361"><a href="#cb4-361" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-362"><a href="#cb4-362" aria-hidden="true" tabindex="-1"></a><span class="fu">### Conformal Prediction</span></span>
<span id="cb4-363"><a href="#cb4-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-366"><a href="#cb4-366" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb4-367"><a href="#cb4-367" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb4-368"><a href="#cb4-368" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: 'conformal-vis-1'</span></span>
<span id="cb4-369"><a href="#cb4-369" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb4-370"><a href="#cb4-370" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb4-371"><a href="#cb4-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-372"><a href="#cb4-372" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb4-373"><a href="#cb4-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-374"><a href="#cb4-374" aria-hidden="true" tabindex="-1"></a><span class="co"># Create original dataset</span></span>
<span id="cb4-375"><a href="#cb4-375" aria-hidden="true" tabindex="-1"></a>df_data <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb4-376"><a href="#cb4-376" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,</span>
<span id="cb4-377"><a href="#cb4-377" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>,</span>
<span id="cb4-378"><a href="#cb4-378" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="dv">3</span><span class="sc">*</span>x <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">10</span>, <span class="dv">0</span>, <span class="dv">2</span>)</span>
<span id="cb4-379"><a href="#cb4-379" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-380"><a href="#cb4-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-381"><a href="#cb4-381" aria-hidden="true" tabindex="-1"></a><span class="co"># Split data into training and calibration sets</span></span>
<span id="cb4-382"><a href="#cb4-382" aria-hidden="true" tabindex="-1"></a>train_indices <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df_data), <span class="fu">nrow</span>(df_data)<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb4-383"><a href="#cb4-383" aria-hidden="true" tabindex="-1"></a>cal_indices <span class="ot">=</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df_data), train_indices)</span>
<span id="cb4-384"><a href="#cb4-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-385"><a href="#cb4-385" aria-hidden="true" tabindex="-1"></a>df_train <span class="ot">=</span> df_data <span class="sc">%&gt;%</span> <span class="fu">slice</span>(train_indices) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">set =</span> <span class="st">"Training"</span>)</span>
<span id="cb4-386"><a href="#cb4-386" aria-hidden="true" tabindex="-1"></a>df_cal <span class="ot">=</span> df_data <span class="sc">%&gt;%</span> <span class="fu">slice</span>(cal_indices) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">set =</span> <span class="st">"Calibration"</span>)</span>
<span id="cb4-387"><a href="#cb4-387" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-388"><a href="#cb4-388" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit model on training data</span></span>
<span id="cb4-389"><a href="#cb4-389" aria-hidden="true" tabindex="-1"></a>model <span class="ot">=</span> <span class="fu">lm</span>(y <span class="sc">~</span> x, <span class="at">data =</span> df_train)</span>
<span id="cb4-390"><a href="#cb4-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-391"><a href="#cb4-391" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate residuals on calibration data</span></span>
<span id="cb4-392"><a href="#cb4-392" aria-hidden="true" tabindex="-1"></a>df_cal <span class="ot">=</span> df_cal <span class="sc">%&gt;%</span></span>
<span id="cb4-393"><a href="#cb4-393" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb4-394"><a href="#cb4-394" aria-hidden="true" tabindex="-1"></a>        <span class="at">pred =</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> df_cal),</span>
<span id="cb4-395"><a href="#cb4-395" aria-hidden="true" tabindex="-1"></a>        <span class="at">residual =</span> <span class="fu">abs</span>(y <span class="sc">-</span> pred)</span>
<span id="cb4-396"><a href="#cb4-396" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-397"><a href="#cb4-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-398"><a href="#cb4-398" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort residuals and find quantile (90% coverage)</span></span>
<span id="cb4-399"><a href="#cb4-399" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">=</span> <span class="fl">0.1</span></span>
<span id="cb4-400"><a href="#cb4-400" aria-hidden="true" tabindex="-1"></a>quantile_val <span class="ot">=</span> <span class="fu">quantile</span>(df_cal<span class="sc">$</span>residual, <span class="dv">1</span><span class="sc">-</span>alpha)</span>
<span id="cb4-401"><a href="#cb4-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-402"><a href="#cb4-402" aria-hidden="true" tabindex="-1"></a><span class="co"># Create new point for prediction</span></span>
<span id="cb4-403"><a href="#cb4-403" aria-hidden="true" tabindex="-1"></a>df_new <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb4-404"><a href="#cb4-404" aria-hidden="true" tabindex="-1"></a>    <span class="at">id =</span> <span class="dv">11</span>,</span>
<span id="cb4-405"><a href="#cb4-405" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fl">8.5</span>,</span>
<span id="cb4-406"><a href="#cb4-406" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="cn">NA</span>,</span>
<span id="cb4-407"><a href="#cb4-407" aria-hidden="true" tabindex="-1"></a>    <span class="at">set =</span> <span class="st">"New Point"</span></span>
<span id="cb4-408"><a href="#cb4-408" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-409"><a href="#cb4-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-410"><a href="#cb4-410" aria-hidden="true" tabindex="-1"></a>df_new <span class="ot">=</span> df_new <span class="sc">%&gt;%</span></span>
<span id="cb4-411"><a href="#cb4-411" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb4-412"><a href="#cb4-412" aria-hidden="true" tabindex="-1"></a>        <span class="at">pred =</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> df_new),</span>
<span id="cb4-413"><a href="#cb4-413" aria-hidden="true" tabindex="-1"></a>        <span class="at">lower =</span> pred <span class="sc">-</span> quantile_val,</span>
<span id="cb4-414"><a href="#cb4-414" aria-hidden="true" tabindex="-1"></a>        <span class="at">upper =</span> pred <span class="sc">+</span> quantile_val</span>
<span id="cb4-415"><a href="#cb4-415" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-416"><a href="#cb4-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-417"><a href="#cb4-417" aria-hidden="true" tabindex="-1"></a><span class="co"># Create combined visualization</span></span>
<span id="cb4-418"><a href="#cb4-418" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">=</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb4-419"><a href="#cb4-419" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">bind_rows</span>(df_train, df_cal), </span>
<span id="cb4-420"><a href="#cb4-420" aria-hidden="true" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">color =</span> set), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb4-421"><a href="#cb4-421" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="fu">coef</span>(model)[<span class="dv">1</span>], <span class="at">slope =</span> <span class="fu">coef</span>(model)[<span class="dv">2</span>], </span>
<span id="cb4-422"><a href="#cb4-422" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="st">"darkgray"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb4-423"><a href="#cb4-423" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"1. Split Data &amp; Fit Model"</span>, <span class="at">x =</span> <span class="st">"x"</span>, <span class="at">y =</span> <span class="st">"y"</span>) <span class="sc">+</span></span>
<span id="cb4-424"><a href="#cb4-424" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb4-425"><a href="#cb4-425" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Training"</span> <span class="ot">=</span> <span class="st">"#E69F00"</span>, <span class="st">"Calibration"</span> <span class="ot">=</span> <span class="st">"#56B4E9"</span>))</span>
<span id="cb4-426"><a href="#cb4-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-427"><a href="#cb4-427" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">=</span> <span class="fu">ggplot</span>(df_cal, <span class="fu">aes</span>(<span class="at">x =</span> id)) <span class="sc">+</span></span>
<span id="cb4-428"><a href="#cb4-428" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_segment</span>(<span class="fu">aes</span>(<span class="at">xend =</span> id, <span class="at">y =</span> pred, <span class="at">yend =</span> y), <span class="at">color =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb4-429"><a href="#cb4-429" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> pred), <span class="at">shape =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"#56B4E9"</span>) <span class="sc">+</span></span>
<span id="cb4-430"><a href="#cb4-430" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> y), <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"#56B4E9"</span>) <span class="sc">+</span></span>
<span id="cb4-431"><a href="#cb4-431" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> quantile_val, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb4-432"><a href="#cb4-432" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"2. Calculate Residuals on Calibration Set"</span>, </span>
<span id="cb4-433"><a href="#cb4-433" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Calibration Data Points"</span>, <span class="at">y =</span> <span class="st">"Value"</span>) <span class="sc">+</span></span>
<span id="cb4-434"><a href="#cb4-434" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb4-435"><a href="#cb4-435" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-436"><a href="#cb4-436" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">=</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb4-437"><a href="#cb4-437" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">bind_rows</span>(df_train, df_cal), </span>
<span id="cb4-438"><a href="#cb4-438" aria-hidden="true" tabindex="-1"></a>               <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y, <span class="at">color =</span> set), <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb4-439"><a href="#cb4-439" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="fu">coef</span>(model)[<span class="dv">1</span>], <span class="at">slope =</span> <span class="fu">coef</span>(model)[<span class="dv">2</span>], </span>
<span id="cb4-440"><a href="#cb4-440" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="st">"darkgray"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb4-441"><a href="#cb4-441" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> df_new, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> pred), <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb4-442"><a href="#cb4-442" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_errorbar</span>(<span class="at">data =</span> df_new, </span>
<span id="cb4-443"><a href="#cb4-443" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper), </span>
<span id="cb4-444"><a href="#cb4-444" aria-hidden="true" tabindex="-1"></a>                  <span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb4-445"><a href="#cb4-445" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"3. Apply Quantile to New Predictions"</span>, <span class="at">x =</span> <span class="st">"x"</span>, <span class="at">y =</span> <span class="st">"y"</span>) <span class="sc">+</span></span>
<span id="cb4-446"><a href="#cb4-446" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb4-447"><a href="#cb4-447" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Training"</span> <span class="ot">=</span> <span class="st">"#E69F00"</span>, <span class="st">"Calibration"</span> <span class="ot">=</span> <span class="st">"#56B4E9"</span>))</span>
<span id="cb4-448"><a href="#cb4-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-449"><a href="#cb4-449" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine plots</span></span>
<span id="cb4-450"><a href="#cb4-450" aria-hidden="true" tabindex="-1"></a>(p1 <span class="sc">/</span> p2 <span class="sc">&amp;</span> <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">'bottom'</span>, <span class="at">legend.title=</span><span class="fu">element_blank</span>()))  <span class="sc">|</span> p3 <span class="sc">+</span></span>
<span id="cb4-451"><a href="#cb4-451" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_layout</span>(<span class="at">widths =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb4-452"><a href="#cb4-452" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot_annotation</span>(</span>
<span id="cb4-453"><a href="#cb4-453" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Conformal Prediction Visualization"</span>,</span>
<span id="cb4-454"><a href="#cb4-454" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"Using calibration set residuals to create prediction intervals"</span>,</span>
<span id="cb4-455"><a href="#cb4-455" aria-hidden="true" tabindex="-1"></a>        <span class="at">theme =</span> <span class="fu">theme</span>(</span>
<span id="cb4-456"><a href="#cb4-456" aria-hidden="true" tabindex="-1"></a>            <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb4-457"><a href="#cb4-457" aria-hidden="true" tabindex="-1"></a>            <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb4-458"><a href="#cb4-458" aria-hidden="true" tabindex="-1"></a>            <span class="at">legend.position =</span> <span class="st">"bottom"</span>,</span>
<span id="cb4-459"><a href="#cb4-459" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-460"><a href="#cb4-460" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb4-461"><a href="#cb4-461" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb4-462"><a href="#cb4-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-465"><a href="#cb4-465" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb4-466"><a href="#cb4-466" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb4-467"><a href="#cb4-467" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: 'conformal-vis-2'</span></span>
<span id="cb4-468"><a href="#cb4-468" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb4-469"><a href="#cb4-469" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb4-470"><a href="#cb4-470" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-471"><a href="#cb4-471" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb4-472"><a href="#cb4-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-473"><a href="#cb4-473" aria-hidden="true" tabindex="-1"></a><span class="co"># Create simple dataset with clear pattern</span></span>
<span id="cb4-474"><a href="#cb4-474" aria-hidden="true" tabindex="-1"></a>df_data <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb4-475"><a href="#cb4-475" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">12</span>,</span>
<span id="cb4-476"><a href="#cb4-476" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="dv">2</span><span class="sc">*</span>x <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="dv">12</span>, <span class="dv">0</span>, <span class="dv">3</span>)</span>
<span id="cb4-477"><a href="#cb4-477" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-478"><a href="#cb4-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-479"><a href="#cb4-479" aria-hidden="true" tabindex="-1"></a><span class="co"># Split into train and calibration</span></span>
<span id="cb4-480"><a href="#cb4-480" aria-hidden="true" tabindex="-1"></a>train_indices <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">7</span>, <span class="dv">9</span>, <span class="dv">11</span>)</span>
<span id="cb4-481"><a href="#cb4-481" aria-hidden="true" tabindex="-1"></a>cal_indices <span class="ot">=</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>, <span class="dv">10</span>, <span class="dv">12</span>)</span>
<span id="cb4-482"><a href="#cb4-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-483"><a href="#cb4-483" aria-hidden="true" tabindex="-1"></a>df_train <span class="ot">=</span> df_data <span class="sc">%&gt;%</span> <span class="fu">slice</span>(train_indices) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">set =</span> <span class="st">"Training"</span>)</span>
<span id="cb4-484"><a href="#cb4-484" aria-hidden="true" tabindex="-1"></a>df_cal <span class="ot">=</span> df_data <span class="sc">%&gt;%</span> <span class="fu">slice</span>(cal_indices) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">set =</span> <span class="st">"Calibration"</span>)</span>
<span id="cb4-485"><a href="#cb4-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-486"><a href="#cb4-486" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit simple line</span></span>
<span id="cb4-487"><a href="#cb4-487" aria-hidden="true" tabindex="-1"></a>model <span class="ot">=</span> <span class="fu">lm</span>(y <span class="sc">~</span> x, <span class="at">data =</span> df_train)</span>
<span id="cb4-488"><a href="#cb4-488" aria-hidden="true" tabindex="-1"></a>slope <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="dv">2</span>]</span>
<span id="cb4-489"><a href="#cb4-489" aria-hidden="true" tabindex="-1"></a>intercept <span class="ot">=</span> <span class="fu">coef</span>(model)[<span class="dv">1</span>]</span>
<span id="cb4-490"><a href="#cb4-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-491"><a href="#cb4-491" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate errors and quantile</span></span>
<span id="cb4-492"><a href="#cb4-492" aria-hidden="true" tabindex="-1"></a>df_cal <span class="ot">=</span> df_cal <span class="sc">%&gt;%</span></span>
<span id="cb4-493"><a href="#cb4-493" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb4-494"><a href="#cb4-494" aria-hidden="true" tabindex="-1"></a>        <span class="at">prediction =</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> df_cal),</span>
<span id="cb4-495"><a href="#cb4-495" aria-hidden="true" tabindex="-1"></a>        <span class="at">error =</span> <span class="fu">abs</span>(y <span class="sc">-</span> prediction)</span>
<span id="cb4-496"><a href="#cb4-496" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-497"><a href="#cb4-497" aria-hidden="true" tabindex="-1"></a>quantile_val <span class="ot">=</span> <span class="fu">quantile</span>(df_cal<span class="sc">$</span>error, <span class="fl">0.9</span>)</span>
<span id="cb4-498"><a href="#cb4-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-499"><a href="#cb4-499" aria-hidden="true" tabindex="-1"></a><span class="co"># New point</span></span>
<span id="cb4-500"><a href="#cb4-500" aria-hidden="true" tabindex="-1"></a>new_x <span class="ot">=</span> <span class="fl">10.5</span></span>
<span id="cb4-501"><a href="#cb4-501" aria-hidden="true" tabindex="-1"></a>new_pred <span class="ot">=</span> intercept <span class="sc">+</span> slope <span class="sc">*</span> new_x</span>
<span id="cb4-502"><a href="#cb4-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-503"><a href="#cb4-503" aria-hidden="true" tabindex="-1"></a><span class="co"># Main conceptual plot</span></span>
<span id="cb4-504"><a href="#cb4-504" aria-hidden="true" tabindex="-1"></a>p_concept <span class="ot">=</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb4-505"><a href="#cb4-505" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Background explanation</span></span>
<span id="cb4-506"><a href="#cb4-506" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"rect"</span>, <span class="at">xmin =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">xmax =</span> <span class="dv">14</span>, <span class="at">ymin =</span> <span class="sc">-</span><span class="dv">2</span>, <span class="at">ymax =</span> <span class="dv">32</span>, </span>
<span id="cb4-507"><a href="#cb4-507" aria-hidden="true" tabindex="-1"></a>             <span class="at">fill =</span> <span class="st">"gray98"</span>) <span class="sc">+</span></span>
<span id="cb4-508"><a href="#cb4-508" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">2</span>, <span class="at">y =</span> <span class="dv">30</span>, </span>
<span id="cb4-509"><a href="#cb4-509" aria-hidden="true" tabindex="-1"></a>             <span class="at">label =</span> <span class="st">"Conformal Prediction Simplified"</span>, </span>
<span id="cb4-510"><a href="#cb4-510" aria-hidden="true" tabindex="-1"></a>             <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">5</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb4-511"><a href="#cb4-511" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">2</span>, <span class="at">y =</span> <span class="dv">28</span>, </span>
<span id="cb4-512"><a href="#cb4-512" aria-hidden="true" tabindex="-1"></a>             <span class="at">label =</span> <span class="st">"1. Train model on some data"</span>, </span>
<span id="cb4-513"><a href="#cb4-513" aria-hidden="true" tabindex="-1"></a>             <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb4-514"><a href="#cb4-514" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">2</span>, <span class="at">y =</span> <span class="dv">26</span>, </span>
<span id="cb4-515"><a href="#cb4-515" aria-hidden="true" tabindex="-1"></a>             <span class="at">label =</span> <span class="st">"2. Measure errors on holdout data"</span>, </span>
<span id="cb4-516"><a href="#cb4-516" aria-hidden="true" tabindex="-1"></a>             <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb4-517"><a href="#cb4-517" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">2</span>, <span class="at">y =</span> <span class="dv">24</span>, </span>
<span id="cb4-518"><a href="#cb4-518" aria-hidden="true" tabindex="-1"></a>             <span class="at">label =</span> <span class="st">"3. Use error pattern to create prediction bands"</span>, </span>
<span id="cb4-519"><a href="#cb4-519" aria-hidden="true" tabindex="-1"></a>             <span class="at">hjust =</span> <span class="dv">0</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb4-520"><a href="#cb4-520" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-521"><a href="#cb4-521" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Original data points</span></span>
<span id="cb4-522"><a href="#cb4-522" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> df_train, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y), </span>
<span id="cb4-523"><a href="#cb4-523" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> <span class="st">"#E69F00"</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb4-524"><a href="#cb4-524" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> df_cal, <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y), </span>
<span id="cb4-525"><a href="#cb4-525" aria-hidden="true" tabindex="-1"></a>               <span class="at">color =</span> <span class="st">"#56B4E9"</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb4-526"><a href="#cb4-526" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-527"><a href="#cb4-527" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Model line</span></span>
<span id="cb4-528"><a href="#cb4-528" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="at">intercept =</span> intercept, <span class="at">slope =</span> slope, </span>
<span id="cb4-529"><a href="#cb4-529" aria-hidden="true" tabindex="-1"></a>                <span class="at">color =</span> <span class="st">"darkgray"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb4-530"><a href="#cb4-530" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-531"><a href="#cb4-531" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Error bars for calibration points</span></span>
<span id="cb4-532"><a href="#cb4-532" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_segment</span>(<span class="at">data =</span> df_cal, </span>
<span id="cb4-533"><a href="#cb4-533" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">xend =</span> x, <span class="at">y =</span> prediction, <span class="at">yend =</span> y),</span>
<span id="cb4-534"><a href="#cb4-534" aria-hidden="true" tabindex="-1"></a>                 <span class="at">color =</span> <span class="st">"#56B4E9"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb4-535"><a href="#cb4-535" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-536"><a href="#cb4-536" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prediction for new point</span></span>
<span id="cb4-537"><a href="#cb4-537" aria-hidden="true" tabindex="-1"></a>    <span class="co"># geom_point(aes(x = new_x, y = new_pred), color = "red", size = 4) +</span></span>
<span id="cb4-538"><a href="#cb4-538" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-539"><a href="#cb4-539" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prediction interval</span></span>
<span id="cb4-540"><a href="#cb4-540" aria-hidden="true" tabindex="-1"></a>    ggdist<span class="sc">::</span><span class="fu">stat_gradientinterval</span>(</span>
<span id="cb4-541"><a href="#cb4-541" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> <span class="fu">tibble</span>(</span>
<span id="cb4-542"><a href="#cb4-542" aria-hidden="true" tabindex="-1"></a>            <span class="at">x =</span> new_x,</span>
<span id="cb4-543"><a href="#cb4-543" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> <span class="fu">rnorm</span>(<span class="dv">100</span>, <span class="at">mean =</span> new_pred, <span class="at">sd =</span> quantile_val <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb4-544"><a href="#cb4-544" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-545"><a href="#cb4-545" aria-hidden="true" tabindex="-1"></a>        ,</span>
<span id="cb4-546"><a href="#cb4-546" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> y),</span>
<span id="cb4-547"><a href="#cb4-547" aria-hidden="true" tabindex="-1"></a>        <span class="at">color=</span>okabe_ito[<span class="dv">5</span>],</span>
<span id="cb4-548"><a href="#cb4-548" aria-hidden="true" tabindex="-1"></a>        <span class="at">fill =</span> okabe_ito[<span class="dv">6</span>],</span>
<span id="cb4-549"><a href="#cb4-549" aria-hidden="true" tabindex="-1"></a>        <span class="at">fill_type =</span> <span class="st">'segments'</span>,</span>
<span id="cb4-550"><a href="#cb4-550" aria-hidden="true" tabindex="-1"></a>        <span class="at">fatten_point=</span> <span class="dv">2</span>,</span>
<span id="cb4-551"><a href="#cb4-551" aria-hidden="true" tabindex="-1"></a>        <span class="at">adjust=</span>.<span class="dv">5</span>,</span>
<span id="cb4-552"><a href="#cb4-552" aria-hidden="true" tabindex="-1"></a>        <span class="at">width=</span>.<span class="dv">4</span>,</span>
<span id="cb4-553"><a href="#cb4-553" aria-hidden="true" tabindex="-1"></a>        <span class="at">alpha =</span> <span class="fl">0.8</span></span>
<span id="cb4-554"><a href="#cb4-554" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb4-555"><a href="#cb4-555" aria-hidden="true" tabindex="-1"></a>    scico<span class="sc">::</span><span class="fu">scale_fill_scico</span>(<span class="at">palette =</span> <span class="st">"batlow"</span>, <span class="at">end =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb4-556"><a href="#cb4-556" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Labels for point types</span></span>
<span id="cb4-557"><a href="#cb4-557" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">4</span>, <span class="at">y =</span> <span class="dv">5</span>, <span class="at">label =</span> <span class="st">"Training data"</span>, </span>
<span id="cb4-558"><a href="#cb4-558" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"#E69F00"</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb4-559"><a href="#cb4-559" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">8</span>, <span class="at">y =</span> <span class="dv">5</span>, <span class="at">label =</span> <span class="st">"Calibration data"</span>, </span>
<span id="cb4-560"><a href="#cb4-560" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> <span class="st">"#56B4E9"</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb4-561"><a href="#cb4-561" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> new_x, <span class="at">y =</span> new_pred <span class="sc">-</span> quantile_val <span class="sc">-</span> <span class="fl">1.5</span>, </span>
<span id="cb4-562"><a href="#cb4-562" aria-hidden="true" tabindex="-1"></a>             <span class="at">label =</span> <span class="st">"Prediction interval</span><span class="sc">\n</span><span class="st">based on calibration errors"</span>, </span>
<span id="cb4-563"><a href="#cb4-563" aria-hidden="true" tabindex="-1"></a>             <span class="at">color =</span> okabe_ito[<span class="dv">6</span>], <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb4-564"><a href="#cb4-564" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-565"><a href="#cb4-565" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb4-566"><a href="#cb4-566" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"How Conformal Prediction Works"</span>,</span>
<span id="cb4-567"><a href="#cb4-567" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"Using observed errors to create reliable prediction intervals"</span>,</span>
<span id="cb4-568"><a href="#cb4-568" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Feature value"</span>,</span>
<span id="cb4-569"><a href="#cb4-569" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Target value"</span></span>
<span id="cb4-570"><a href="#cb4-570" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb4-571"><a href="#cb4-571" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb4-572"><a href="#cb4-572" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb4-573"><a href="#cb4-573" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">16</span>),</span>
<span id="cb4-574"><a href="#cb4-574" aria-hidden="true" tabindex="-1"></a>        <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>, <span class="at">size =</span> <span class="dv">12</span>),</span>
<span id="cb4-575"><a href="#cb4-575" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb4-576"><a href="#cb4-576" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-577"><a href="#cb4-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-578"><a href="#cb4-578" aria-hidden="true" tabindex="-1"></a>p_concept</span>
<span id="cb4-579"><a href="#cb4-579" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb4-580"><a href="#cb4-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-583"><a href="#cb4-583" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb4-584"><a href="#cb4-584" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb4-585"><a href="#cb4-585" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: 'conformal-vis-3'</span></span>
<span id="cb4-586"><a href="#cb4-586" aria-hidden="true" tabindex="-1"></a><span class="co">#| out-width: 66%</span></span>
<span id="cb4-587"><a href="#cb4-587" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb4-588"><a href="#cb4-588" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(patchwork)</span>
<span id="cb4-589"><a href="#cb4-589" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-590"><a href="#cb4-590" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a clean, conceptual visualization</span></span>
<span id="cb4-591"><a href="#cb4-591" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb4-592"><a href="#cb4-592" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Background</span></span>
<span id="cb4-593"><a href="#cb4-593" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"rect"</span>, <span class="at">xmin =</span> <span class="dv">0</span>, <span class="at">xmax =</span> <span class="dv">10</span>, <span class="at">ymin =</span> <span class="dv">0</span>, <span class="at">ymax =</span> <span class="dv">10</span>, <span class="at">fill =</span> <span class="st">"gray95"</span>) <span class="sc">+</span></span>
<span id="cb4-594"><a href="#cb4-594" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-595"><a href="#cb4-595" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Title and core concept</span></span>
<span id="cb4-596"><a href="#cb4-596" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">5</span>, <span class="at">y =</span> <span class="fl">9.5</span>, </span>
<span id="cb4-597"><a href="#cb4-597" aria-hidden="true" tabindex="-1"></a>             <span class="at">label =</span> <span class="st">"The Conformal Prediction Concept"</span>, </span>
<span id="cb4-598"><a href="#cb4-598" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="dv">6</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb4-599"><a href="#cb4-599" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-600"><a href="#cb4-600" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Three key steps as visual metaphors</span></span>
<span id="cb4-601"><a href="#cb4-601" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-602"><a href="#cb4-602" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 1: Train a model</span></span>
<span id="cb4-603"><a href="#cb4-603" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"rect"</span>, <span class="at">xmin =</span> <span class="fl">0.5</span>, <span class="at">xmax =</span> <span class="fl">3.5</span>, <span class="at">ymin =</span> <span class="fl">6.5</span>, <span class="at">ymax =</span> <span class="fl">8.5</span>, <span class="at">fill =</span> <span class="st">"#E69F00"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb4-604"><a href="#cb4-604" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">2</span>, <span class="at">y =</span> <span class="fl">7.8</span>, <span class="at">label =</span> <span class="st">"Step 1"</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb4-605"><a href="#cb4-605" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">2</span>, <span class="at">y =</span> <span class="fl">7.2</span>, <span class="at">label =</span> <span class="st">"Train any model</span><span class="sc">\n</span><span class="st">on your data"</span>, <span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb4-606"><a href="#cb4-606" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-607"><a href="#cb4-607" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 2: Measure errors</span></span>
<span id="cb4-608"><a href="#cb4-608" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"rect"</span>, <span class="at">xmin =</span> <span class="dv">4</span>, <span class="at">xmax =</span> <span class="dv">7</span>, <span class="at">ymin =</span> <span class="fl">6.5</span>, <span class="at">ymax =</span> <span class="fl">8.5</span>, <span class="at">fill =</span> <span class="st">"#56B4E9"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb4-609"><a href="#cb4-609" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">5.5</span>, <span class="at">y =</span> <span class="fl">7.8</span>, <span class="at">label =</span> <span class="st">"Step 2"</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb4-610"><a href="#cb4-610" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">5.5</span>, <span class="at">y =</span> <span class="fl">7.2</span>, </span>
<span id="cb4-611"><a href="#cb4-611" aria-hidden="true" tabindex="-1"></a>             <span class="at">label =</span> <span class="st">"See how wrong your model is</span><span class="sc">\n</span><span class="st">with a separate set of data"</span>, </span>
<span id="cb4-612"><a href="#cb4-612" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb4-613"><a href="#cb4-613" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-614"><a href="#cb4-614" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Step 3: Apply to new predictions</span></span>
<span id="cb4-615"><a href="#cb4-615" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"rect"</span>, <span class="at">xmin =</span> <span class="fl">7.5</span>, <span class="at">xmax =</span> <span class="fl">9.5</span>, <span class="at">ymin =</span> <span class="fl">6.5</span>, <span class="at">ymax =</span> <span class="fl">8.5</span>, <span class="at">fill =</span> <span class="st">"#009E73"</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb4-616"><a href="#cb4-616" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">8.5</span>, <span class="at">y =</span> <span class="fl">7.8</span>, <span class="at">label =</span> <span class="st">"Step 3"</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb4-617"><a href="#cb4-617" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="fl">8.5</span>, <span class="at">y =</span> <span class="fl">7.2</span>, </span>
<span id="cb4-618"><a href="#cb4-618" aria-hidden="true" tabindex="-1"></a>             <span class="at">label =</span> <span class="st">"Use that error pattern to</span><span class="sc">\n</span><span class="st">create prediction bands"</span>, </span>
<span id="cb4-619"><a href="#cb4-619" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb4-620"><a href="#cb4-620" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-621"><a href="#cb4-621" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Connect the steps with arrows</span></span>
<span id="cb4-622"><a href="#cb4-622" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"segment"</span>, <span class="at">x =</span> <span class="fl">3.5</span>, <span class="at">xend =</span> <span class="dv">4</span>, <span class="at">y =</span> <span class="fl">7.5</span>, <span class="at">yend =</span> <span class="fl">7.5</span>, </span>
<span id="cb4-623"><a href="#cb4-623" aria-hidden="true" tabindex="-1"></a>             <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.3</span>, <span class="st">"cm"</span>)), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb4-624"><a href="#cb4-624" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"segment"</span>, <span class="at">x =</span> <span class="dv">7</span>, <span class="at">xend =</span> <span class="fl">7.5</span>, <span class="at">y =</span> <span class="fl">7.5</span>, <span class="at">yend =</span> <span class="fl">7.5</span>, </span>
<span id="cb4-625"><a href="#cb4-625" aria-hidden="true" tabindex="-1"></a>             <span class="at">arrow =</span> <span class="fu">arrow</span>(<span class="at">length =</span> <span class="fu">unit</span>(<span class="fl">0.3</span>, <span class="st">"cm"</span>)), <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb4-626"><a href="#cb4-626" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-627"><a href="#cb4-627" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The key insight visualization</span></span>
<span id="cb4-628"><a href="#cb4-628" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">5</span>, <span class="at">y =</span> <span class="fl">5.8</span>, </span>
<span id="cb4-629"><a href="#cb4-629" aria-hidden="true" tabindex="-1"></a>             <span class="at">label =</span> <span class="st">"The key insight of conformal prediction:"</span>, </span>
<span id="cb4-630"><a href="#cb4-630" aria-hidden="true" tabindex="-1"></a>             <span class="at">fontface =</span> <span class="st">"bold"</span>, <span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb4-631"><a href="#cb4-631" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">5</span>, <span class="at">y =</span> <span class="dv">5</span>, </span>
<span id="cb4-632"><a href="#cb4-632" aria-hidden="true" tabindex="-1"></a>             <span class="at">label =</span> <span class="st">"If we know how wrong our model typically is,</span><span class="sc">\n</span><span class="st">we can use that knowledge to build reliable prediction intervals"</span>, </span>
<span id="cb4-633"><a href="#cb4-633" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb4-634"><a href="#cb4-634" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-635"><a href="#cb4-635" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Visual metaphor for prediction intervals</span></span>
<span id="cb4-636"><a href="#cb4-636" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"rect"</span>, <span class="at">xmin =</span> <span class="dv">1</span>, <span class="at">xmax =</span> <span class="dv">9</span>, <span class="at">ymin =</span> <span class="fl">1.5</span>, <span class="at">ymax =</span> <span class="dv">4</span>, <span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="st">"gray"</span>) <span class="sc">+</span></span>
<span id="cb4-637"><a href="#cb4-637" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">5</span>, <span class="at">y =</span> <span class="fl">3.5</span>, <span class="at">label =</span> <span class="st">"For a new prediction:"</span>, <span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">fontface =</span> <span class="st">"bold"</span>) <span class="sc">+</span></span>
<span id="cb4-638"><a href="#cb4-638" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"point"</span>, <span class="at">x =</span> <span class="dv">5</span>, <span class="at">y =</span> <span class="fl">2.75</span>, <span class="at">size =</span> <span class="dv">12</span>, <span class="at">color =</span> <span class="st">'#E69F00'</span>) <span class="sc">+</span></span>
<span id="cb4-639"><a href="#cb4-639" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"segment"</span>, <span class="at">x =</span> <span class="dv">3</span>, <span class="at">xend =</span> <span class="dv">7</span>, <span class="at">y =</span> <span class="fl">2.75</span>, <span class="at">yend =</span> <span class="fl">2.75</span>, <span class="at">color =</span> <span class="st">'#E69F00'</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb4-640"><a href="#cb4-640" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">5</span>, <span class="at">y =</span> <span class="fl">1.8</span>, </span>
<span id="cb4-641"><a href="#cb4-641" aria-hidden="true" tabindex="-1"></a>             <span class="at">label =</span> <span class="st">"We use past errors to create a confidence band</span><span class="sc">\n</span><span class="st">around our prediction that's right 90% of the time"</span>, </span>
<span id="cb4-642"><a href="#cb4-642" aria-hidden="true" tabindex="-1"></a>             <span class="at">size =</span> <span class="fl">3.5</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb4-643"><a href="#cb4-643" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-644"><a href="#cb4-644" aria-hidden="true" tabindex="-1"></a>    <span class="co"># What makes conformal prediction special</span></span>
<span id="cb4-645"><a href="#cb4-645" aria-hidden="true" tabindex="-1"></a>    <span class="fu">annotate</span>(<span class="st">"text"</span>, <span class="at">x =</span> <span class="dv">5</span>, <span class="at">y =</span> <span class="fl">0.7</span>, </span>
<span id="cb4-646"><a href="#cb4-646" aria-hidden="true" tabindex="-1"></a>             <span class="at">label =</span> <span class="st">"Works with ANY model | Mathematically guaranteed coverage | Model-agnostic"</span>, </span>
<span id="cb4-647"><a href="#cb4-647" aria-hidden="true" tabindex="-1"></a>             <span class="at">fontface =</span> <span class="st">"italic"</span>, <span class="at">size =</span> <span class="dv">3</span>, <span class="at">color =</span> <span class="st">"darkblue"</span>) <span class="sc">+</span></span>
<span id="cb4-648"><a href="#cb4-648" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-649"><a href="#cb4-649" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clean up</span></span>
<span id="cb4-650"><a href="#cb4-650" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_void</span>() <span class="sc">+</span></span>
<span id="cb4-651"><a href="#cb4-651" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_fixed</span>(<span class="at">ratio =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb4-652"><a href="#cb4-652" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.background =</span> <span class="fu">element_rect</span>(<span class="at">fill =</span> <span class="st">"white"</span>, <span class="at">color =</span> <span class="cn">NA</span>))</span>
<span id="cb4-653"><a href="#cb4-653" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb4-654"><a href="#cb4-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-655"><a href="#cb4-655" aria-hidden="true" tabindex="-1"></a>Conformal prediction is yet another technique for estimating uncertainty in machine learning models, and one of its primary strengths is that it is model agnostic and theoretically can work for any model, from linear regression to deep learning. It is based on the idea that we can estimate the uncertainty in our predictions by looking at the distribution of the predictions from the model, or more specifically, the prediction error. Using the observed error on a calibration set that was not used to train the model, we can order those errors and find the quantile corresponding to the desired uncertainty coverage/error rate<span class="ot">[^errorcov]</span>. When predicting on new data, we assume it (and its error) comes from a similar distribution as what we've seen already in our training/calibration process, with no particular assumption about that distribution. We then use that quantile from our previous distribution to create upper and lower bounds for the new prediction.</span>
<span id="cb4-656"><a href="#cb4-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-657"><a href="#cb4-657" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Quick Demo</span></span>
<span id="cb4-658"><a href="#cb4-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-659"><a href="#cb4-659" aria-hidden="true" tabindex="-1"></a>While the implementation for various settings can get quite complicated, the conceptual approach is mostly straightforward as we've just suggested. The following shows some simplified code demonstrating the **split-conformal** procedure in Python and R.  Note that you should use packages like <span class="co">[</span><span class="ot">mapie</span><span class="co">]</span>{.pack} or fuller implementations for your own work.</span>
<span id="cb4-660"><a href="#cb4-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-661"><a href="#cb4-661" aria-hidden="true" tabindex="-1"></a><span class="ot">[^errorcov]: </span>The error rate ($\alpha$) is the proportion of the data that would fall outside the prediction interval, while the coverage rate/interval is 1 - $\alpha$.</span>
<span id="cb4-662"><a href="#cb4-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-663"><a href="#cb4-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-664"><a href="#cb4-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-667"><a href="#cb4-667" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb4-668"><a href="#cb4-668" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb4-669"><a href="#cb4-669" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: old-cp-error-func-r</span></span>
<span id="cb4-670"><a href="#cb4-670" aria-hidden="true" tabindex="-1"></a>calc_cp_error <span class="ot">=</span> <span class="cf">function</span>(</span>
<span id="cb4-671"><a href="#cb4-671" aria-hidden="true" tabindex="-1"></a>    fit,            <span class="co"># fitted model</span></span>
<span id="cb4-672"><a href="#cb4-672" aria-hidden="true" tabindex="-1"></a>    test,           <span class="co"># test data</span></span>
<span id="cb4-673"><a href="#cb4-673" aria-hidden="true" tabindex="-1"></a>    y,              <span class="co"># test data target</span></span>
<span id="cb4-674"><a href="#cb4-674" aria-hidden="true" tabindex="-1"></a>    <span class="at">interval =</span> .<span class="dv">95</span>  <span class="co"># interval width</span></span>
<span id="cb4-675"><a href="#cb4-675" aria-hidden="true" tabindex="-1"></a>    ) {</span>
<span id="cb4-676"><a href="#cb4-676" aria-hidden="true" tabindex="-1"></a>    test_resid <span class="ot">=</span> <span class="fu">abs</span>(y <span class="sc">-</span> <span class="fu">predict</span>(fit, <span class="at">newdata =</span> test))</span>
<span id="cb4-677"><a href="#cb4-677" aria-hidden="true" tabindex="-1"></a>    N <span class="ot">=</span> <span class="fu">nrow</span>(test)</span>
<span id="cb4-678"><a href="#cb4-678" aria-hidden="true" tabindex="-1"></a>    k <span class="ot">=</span> <span class="fu">ceiling</span>((N <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">*</span> interval) <span class="co"># n/2 if actually splitting, but we're assuming it was already split</span></span>
<span id="cb4-679"><a href="#cb4-679" aria-hidden="true" tabindex="-1"></a>    q <span class="ot">=</span> <span class="fu">quantile</span>(test_resid, <span class="at">probs =</span> interval <span class="sc">*</span> (N <span class="sc">/</span> (N <span class="sc">+</span> <span class="dv">1</span>)))</span>
<span id="cb4-680"><a href="#cb4-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-681"><a href="#cb4-681" aria-hidden="true" tabindex="-1"></a>    residuals_sorted <span class="ot">=</span> <span class="fu">sort</span>(test_resid)</span>
<span id="cb4-682"><a href="#cb4-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-683"><a href="#cb4-683" aria-hidden="true" tabindex="-1"></a>    cp_error <span class="ot">=</span> residuals_sorted[k]</span>
<span id="cb4-684"><a href="#cb4-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-685"><a href="#cb4-685" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">cp_error =</span> cp_error, <span class="at">q =</span> q, <span class="at">k =</span> k)</span>
<span id="cb4-686"><a href="#cb4-686" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-687"><a href="#cb4-687" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-688"><a href="#cb4-688" aria-hidden="true" tabindex="-1"></a><span class="fu">calc_cp_error</span>(<span class="fu">lm</span>(y_train<span class="sc">~</span>., X_train), X_test, y_test, <span class="at">interval =</span> .<span class="dv">9</span>)[[<span class="st">'cp_error'</span>]]</span>
<span id="cb4-689"><a href="#cb4-689" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb4-690"><a href="#cb4-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-693"><a href="#cb4-693" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb4-694"><a href="#cb4-694" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb4-695"><a href="#cb4-695" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: old-cp-error-func-py</span></span>
<span id="cb4-696"><a href="#cb4-696" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calc_cp_error(</span>
<span id="cb4-697"><a href="#cb4-697" aria-hidden="true" tabindex="-1"></a>    fit,  <span class="co"># fitted model with predict method</span></span>
<span id="cb4-698"><a href="#cb4-698" aria-hidden="true" tabindex="-1"></a>    test, <span class="co"># test data</span></span>
<span id="cb4-699"><a href="#cb4-699" aria-hidden="true" tabindex="-1"></a>    y,    <span class="co"># test data target</span></span>
<span id="cb4-700"><a href="#cb4-700" aria-hidden="true" tabindex="-1"></a>    interval <span class="op">=</span> <span class="fl">.95</span> <span class="co"># interval width</span></span>
<span id="cb4-701"><a href="#cb4-701" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb4-702"><a href="#cb4-702" aria-hidden="true" tabindex="-1"></a>    test_resid <span class="op">=</span> np.array(np.<span class="bu">abs</span>(y <span class="op">-</span> fit.predict(test)))</span>
<span id="cb4-703"><a href="#cb4-703" aria-hidden="true" tabindex="-1"></a>    N <span class="op">=</span> test.shape[<span class="dv">0</span>]</span>
<span id="cb4-704"><a href="#cb4-704" aria-hidden="true" tabindex="-1"></a>    k <span class="op">=</span> np.ceil((N <span class="op">+</span> <span class="dv">1</span>) <span class="op">*</span> interval) <span class="co"># N/2 if actually splitting, but we're assuming it was already split</span></span>
<span id="cb4-705"><a href="#cb4-705" aria-hidden="true" tabindex="-1"></a>    q <span class="op">=</span> np.quantile(test_resid, q <span class="op">=</span> interval <span class="op">*</span> (N <span class="op">/</span> (N <span class="op">+</span> <span class="dv">1</span>))) </span>
<span id="cb4-706"><a href="#cb4-706" aria-hidden="true" tabindex="-1"></a>    residuals_sorted <span class="op">=</span> np.sort(test_resid)</span>
<span id="cb4-707"><a href="#cb4-707" aria-hidden="true" tabindex="-1"></a>    cp_error <span class="op">=</span> residuals_sorted[<span class="bu">int</span>(k)]    </span>
<span id="cb4-708"><a href="#cb4-708" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">dict</span>(cp_error <span class="op">=</span> cp_error, q <span class="op">=</span> q, k <span class="op">=</span> k)</span>
<span id="cb4-709"><a href="#cb4-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-710"><a href="#cb4-710" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm </span>
<span id="cb4-711"><a href="#cb4-711" aria-hidden="true" tabindex="-1"></a>ols_fit <span class="op">=</span> sm.OLS(y_train, sm.add_constant(X_train)).fit()</span>
<span id="cb4-712"><a href="#cb4-712" aria-hidden="true" tabindex="-1"></a>cp_error <span class="op">=</span> calc_cp_error(ols_fit, sm.add_constant(X_test), y_test, interval<span class="op">=</span><span class="fl">.9</span>)</span>
<span id="cb4-713"><a href="#cb4-713" aria-hidden="true" tabindex="-1"></a>cp_error[<span class="st">'cp_error'</span>]</span>
<span id="cb4-714"><a href="#cb4-714" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb4-715"><a href="#cb4-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-716"><a href="#cb4-716" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-717"><a href="#cb4-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-718"><a href="#cb4-718" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Can't do tabset for doc/blog post upload, so we'll do this instead. --&gt;</span></span>
<span id="cb4-719"><a href="#cb4-719" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-720"><a href="#cb4-720" aria-hidden="true" tabindex="-1"></a>:::{.panel-tabset}</span>
<span id="cb4-721"><a href="#cb4-721" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-722"><a href="#cb4-722" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Python</span></span>
<span id="cb4-723"><a href="#cb4-723" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-724"><a href="#cb4-724" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ![](../../img/conformal/py_conformal_code.png){width=66%} --&gt;</span></span>
<span id="cb4-725"><a href="#cb4-725" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-728"><a href="#cb4-728" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb4-729"><a href="#cb4-729" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb4-730"><a href="#cb4-730" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb4-731"><a href="#cb4-731" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb4-732"><a href="#cb4-732" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: split-conformal-py</span></span>
<span id="cb4-733"><a href="#cb4-733" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb4-734"><a href="#cb4-734" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb4-735"><a href="#cb4-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-736"><a href="#cb4-736" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> split_conformal(X, y, new_data, alpha <span class="op">=</span> <span class="fl">0.05</span>, seed <span class="op">=</span> <span class="dv">123</span>):</span>
<span id="cb4-737"><a href="#cb4-737" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set random seed for reproducibility</span></span>
<span id="cb4-738"><a href="#cb4-738" aria-hidden="true" tabindex="-1"></a>    np.random.seed(seed)</span>
<span id="cb4-739"><a href="#cb4-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-740"><a href="#cb4-740" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Splitting the data into training and calibration sets</span></span>
<span id="cb4-741"><a href="#cb4-741" aria-hidden="true" tabindex="-1"></a>    train_data, cal_data, train_y, cal_y <span class="op">=</span> train_test_split(X, y, test_size <span class="op">=</span> <span class="fl">0.5</span>)</span>
<span id="cb4-742"><a href="#cb4-742" aria-hidden="true" tabindex="-1"></a>    N <span class="op">=</span> train_data.shape[<span class="dv">0</span>]</span>
<span id="cb4-743"><a href="#cb4-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-744"><a href="#cb4-744" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train the base model</span></span>
<span id="cb4-745"><a href="#cb4-745" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> LinearRegression()</span>
<span id="cb4-746"><a href="#cb4-746" aria-hidden="true" tabindex="-1"></a>    model.fit(train_data, train_y)</span>
<span id="cb4-747"><a href="#cb4-747" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-748"><a href="#cb4-748" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate residuals on calibration set</span></span>
<span id="cb4-749"><a href="#cb4-749" aria-hidden="true" tabindex="-1"></a>    cal_preds <span class="op">=</span> model.predict(cal_data)</span>
<span id="cb4-750"><a href="#cb4-750" aria-hidden="true" tabindex="-1"></a>    residuals <span class="op">=</span> np.array(np.<span class="bu">abs</span>(cal_y <span class="op">-</span> cal_preds))</span>
<span id="cb4-751"><a href="#cb4-751" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-752"><a href="#cb4-752" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort residuals and find the quantile corresponding to (1-alpha)</span></span>
<span id="cb4-753"><a href="#cb4-753" aria-hidden="true" tabindex="-1"></a>    residuals.sort()</span>
<span id="cb4-754"><a href="#cb4-754" aria-hidden="true" tabindex="-1"></a>    quantile <span class="op">=</span> np.quantile(residuals, (<span class="dv">1</span> <span class="op">-</span> alpha) <span class="op">*</span> (N <span class="op">/</span> (N <span class="op">+</span> <span class="dv">1</span>)))</span>
<span id="cb4-755"><a href="#cb4-755" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-756"><a href="#cb4-756" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make predictions on new data and calculate prediction intervals</span></span>
<span id="cb4-757"><a href="#cb4-757" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> model.predict(new_data)</span>
<span id="cb4-758"><a href="#cb4-758" aria-hidden="true" tabindex="-1"></a>    lower_bounds <span class="op">=</span> preds <span class="op">-</span> quantile</span>
<span id="cb4-759"><a href="#cb4-759" aria-hidden="true" tabindex="-1"></a>    upper_bounds <span class="op">=</span> preds <span class="op">+</span> quantile</span>
<span id="cb4-760"><a href="#cb4-760" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-761"><a href="#cb4-761" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return predictions and prediction intervals</span></span>
<span id="cb4-762"><a href="#cb4-762" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span>(</span>
<span id="cb4-763"><a href="#cb4-763" aria-hidden="true" tabindex="-1"></a>        <span class="bu">dict</span>(</span>
<span id="cb4-764"><a href="#cb4-764" aria-hidden="true" tabindex="-1"></a>            cp_error <span class="op">=</span> quantile, </span>
<span id="cb4-765"><a href="#cb4-765" aria-hidden="true" tabindex="-1"></a>            preds <span class="op">=</span> preds, </span>
<span id="cb4-766"><a href="#cb4-766" aria-hidden="true" tabindex="-1"></a>            lower_bounds <span class="op">=</span> lower_bounds, </span>
<span id="cb4-767"><a href="#cb4-767" aria-hidden="true" tabindex="-1"></a>            upper_bounds <span class="op">=</span> upper_bounds</span>
<span id="cb4-768"><a href="#cb4-768" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-769"><a href="#cb4-769" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-770"><a href="#cb4-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-771"><a href="#cb4-771" aria-hidden="true" tabindex="-1"></a>cp_error_py <span class="op">=</span> split_conformal(X_train, y_train, X_test, alpha <span class="op">=</span> <span class="fl">.1</span>)[<span class="st">'cp_error'</span>]</span>
<span id="cb4-772"><a href="#cb4-772" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb4-773"><a href="#cb4-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-776"><a href="#cb4-776" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb4-777"><a href="#cb4-777" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb4-778"><a href="#cb4-778" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: show-py-cp-error</span></span>
<span id="cb4-779"><a href="#cb4-779" aria-hidden="true" tabindex="-1"></a>pd.DataFrame({</span>
<span id="cb4-780"><a href="#cb4-780" aria-hidden="true" tabindex="-1"></a>    <span class="st">'CP Error'</span>: np.<span class="bu">round</span>(cp_error_py, <span class="dv">3</span>)</span>
<span id="cb4-781"><a href="#cb4-781" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb4-782"><a href="#cb4-782" aria-hidden="true" tabindex="-1"></a>    ,index <span class="op">=</span> [<span class="st">''</span>]</span>
<span id="cb4-783"><a href="#cb4-783" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-784"><a href="#cb4-784" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb4-785"><a href="#cb4-785" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-786"><a href="#cb4-786" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-787"><a href="#cb4-787" aria-hidden="true" tabindex="-1"></a><span class="fu">#### R</span></span>
<span id="cb4-788"><a href="#cb4-788" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-789"><a href="#cb4-789" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ![](../../img/conformal/r_conformal_code.png){width=66%} --&gt;</span></span>
<span id="cb4-790"><a href="#cb4-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-793"><a href="#cb4-793" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb4-794"><a href="#cb4-794" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb4-795"><a href="#cb4-795" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb4-796"><a href="#cb4-796" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb4-797"><a href="#cb4-797" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: split-conformal-r</span></span>
<span id="cb4-798"><a href="#cb4-798" aria-hidden="true" tabindex="-1"></a>split_conformal <span class="ot">=</span> <span class="cf">function</span>(X, y, new_data, <span class="at">alpha =</span> .<span class="dv">05</span>, <span class="at">seed =</span> <span class="dv">123</span>) {</span>
<span id="cb4-799"><a href="#cb4-799" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set random seed for reproducibility</span></span>
<span id="cb4-800"><a href="#cb4-800" aria-hidden="true" tabindex="-1"></a>    <span class="fu">set.seed</span>(seed)</span>
<span id="cb4-801"><a href="#cb4-801" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-802"><a href="#cb4-802" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Splitting the data into training and calibration sets</span></span>
<span id="cb4-803"><a href="#cb4-803" aria-hidden="true" tabindex="-1"></a>    idx <span class="ot">=</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(X), <span class="at">size =</span> <span class="fu">nrow</span>(X) <span class="sc">/</span> <span class="dv">2</span>)</span>
<span id="cb4-804"><a href="#cb4-804" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-805"><a href="#cb4-805" aria-hidden="true" tabindex="-1"></a>    train_data <span class="ot">=</span> X <span class="sc">|&gt;</span> <span class="fu">slice</span>(idx)</span>
<span id="cb4-806"><a href="#cb4-806" aria-hidden="true" tabindex="-1"></a>    cal_data <span class="ot">=</span> X <span class="sc">|&gt;</span> <span class="fu">slice</span>(<span class="sc">-</span>idx)</span>
<span id="cb4-807"><a href="#cb4-807" aria-hidden="true" tabindex="-1"></a>    train_y <span class="ot">=</span> y[idx]</span>
<span id="cb4-808"><a href="#cb4-808" aria-hidden="true" tabindex="-1"></a>    cal_y <span class="ot">=</span> y[<span class="sc">-</span>idx]</span>
<span id="cb4-809"><a href="#cb4-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-810"><a href="#cb4-810" aria-hidden="true" tabindex="-1"></a>    N <span class="ot">=</span> <span class="fu">nrow</span>(train_data)</span>
<span id="cb4-811"><a href="#cb4-811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-812"><a href="#cb4-812" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Train the base model</span></span>
<span id="cb4-813"><a href="#cb4-813" aria-hidden="true" tabindex="-1"></a>    model <span class="ot">=</span> <span class="fu">lm</span>(train_y <span class="sc">~</span> ., <span class="at">data =</span> train_data)</span>
<span id="cb4-814"><a href="#cb4-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-815"><a href="#cb4-815" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate residuals on calibration set</span></span>
<span id="cb4-816"><a href="#cb4-816" aria-hidden="true" tabindex="-1"></a>    cal_preds <span class="ot">=</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> cal_data)</span>
<span id="cb4-817"><a href="#cb4-817" aria-hidden="true" tabindex="-1"></a>    residuals <span class="ot">=</span> <span class="fu">abs</span>(cal_y <span class="sc">-</span> cal_preds)</span>
<span id="cb4-818"><a href="#cb4-818" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-819"><a href="#cb4-819" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sort residuals and find the quantile corresponding to (1-alpha)</span></span>
<span id="cb4-820"><a href="#cb4-820" aria-hidden="true" tabindex="-1"></a>    residuals <span class="ot">=</span> <span class="fu">sort</span>(residuals)</span>
<span id="cb4-821"><a href="#cb4-821" aria-hidden="true" tabindex="-1"></a>    quantile  <span class="ot">=</span> <span class="fu">quantile</span>(residuals, (<span class="dv">1</span> <span class="sc">-</span> alpha) <span class="sc">*</span> (N <span class="sc">/</span> (N <span class="sc">+</span> <span class="dv">1</span>)))</span>
<span id="cb4-822"><a href="#cb4-822" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-823"><a href="#cb4-823" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make predictions on new data and calculate prediction intervals</span></span>
<span id="cb4-824"><a href="#cb4-824" aria-hidden="true" tabindex="-1"></a>    preds <span class="ot">=</span> <span class="fu">predict</span>(model, <span class="at">newdata =</span> new_data)</span>
<span id="cb4-825"><a href="#cb4-825" aria-hidden="true" tabindex="-1"></a>    lower_bounds <span class="ot">=</span> preds <span class="sc">-</span> quantile</span>
<span id="cb4-826"><a href="#cb4-826" aria-hidden="true" tabindex="-1"></a>    upper_bounds <span class="ot">=</span> preds <span class="sc">+</span> quantile</span>
<span id="cb4-827"><a href="#cb4-827" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-828"><a href="#cb4-828" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Return predictions and prediction intervals</span></span>
<span id="cb4-829"><a href="#cb4-829" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(</span>
<span id="cb4-830"><a href="#cb4-830" aria-hidden="true" tabindex="-1"></a>        <span class="fu">list</span>(</span>
<span id="cb4-831"><a href="#cb4-831" aria-hidden="true" tabindex="-1"></a>            <span class="at">cp_error =</span> quantile, </span>
<span id="cb4-832"><a href="#cb4-832" aria-hidden="true" tabindex="-1"></a>            <span class="at">preds =</span> preds, </span>
<span id="cb4-833"><a href="#cb4-833" aria-hidden="true" tabindex="-1"></a>            <span class="at">lower_bounds =</span> lower_bounds, </span>
<span id="cb4-834"><a href="#cb4-834" aria-hidden="true" tabindex="-1"></a>            <span class="at">upper_bounds =</span> upper_bounds</span>
<span id="cb4-835"><a href="#cb4-835" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-836"><a href="#cb4-836" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-837"><a href="#cb4-837" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-838"><a href="#cb4-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-839"><a href="#cb4-839" aria-hidden="true" tabindex="-1"></a>cp_error_r <span class="ot">=</span> <span class="fu">split_conformal</span>(X_train, y_train, X_test, <span class="at">alpha =</span> .<span class="dv">1</span>)[[<span class="st">'cp_error'</span>]]</span>
<span id="cb4-840"><a href="#cb4-840" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb4-841"><a href="#cb4-841" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-844"><a href="#cb4-844" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb4-845"><a href="#cb4-845" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb4-846"><a href="#cb4-846" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: gather-cp-error</span></span>
<span id="cb4-847"><a href="#cb4-847" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-848"><a href="#cb4-848" aria-hidden="true" tabindex="-1"></a>py_by_hand <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(py<span class="sc">$</span>cp_error_py))<span class="co">#$cp_error</span></span>
<span id="cb4-849"><a href="#cb4-849" aria-hidden="true" tabindex="-1"></a>r_by_hand  <span class="ot">=</span> cp_error_r</span>
<span id="cb4-850"><a href="#cb4-850" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-851"><a href="#cb4-851" aria-hidden="true" tabindex="-1"></a><span class="co"># gt(tibble(`CP Error` = round(cp_error, 3)))</span></span>
<span id="cb4-852"><a href="#cb4-852" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-853"><a href="#cb4-853" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb4-854"><a href="#cb4-854" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-855"><a href="#cb4-855" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb4-856"><a href="#cb4-856" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-857"><a href="#cb4-857" aria-hidden="true" tabindex="-1"></a>We can compare our simple approach to <span class="in">`mapie`</span> in Python, which is a solid package to use for this<span class="ot">[^rconformal]</span>. The 'naive' conformal procedure in <span class="in">`mapie`</span> implemented is very similar to our split-conformal procedure, and generally you'd want to use one of the better approaches. But this is a bit more comparable, and most of the difference between our R, Python and the <span class="in">`mapie`</span> results are due to the underlying data split.</span>
<span id="cb4-858"><a href="#cb4-858" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-859"><a href="#cb4-859" aria-hidden="true" tabindex="-1"></a><span class="ot">[^rconformal]: </span>When I first started this post, there wasn't much in the way of packages for conformal prediction in R. One <span class="co">[</span><span class="ot">was the conformal package</span><span class="co">](https://github.com/ryantibs/conformal)</span>, but it is not very user friendly in the least.  Others seem like one offs or have other limitations (e.g. only being for classification, working only in the tidymodels framework, etc.). More recently <span class="co">[</span><span class="ot">probably</span><span class="co">]</span>{.pack} has add functionality that works nicely with the tidymodels framework, but I haven't had a chance to try it out yet.</span>
<span id="cb4-860"><a href="#cb4-860" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-861"><a href="#cb4-861" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- ![](../../img/conformal/py_mapie_conformal_code.png){width=66%} --&gt;</span></span>
<span id="cb4-862"><a href="#cb4-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-865"><a href="#cb4-865" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb4-866"><a href="#cb4-866" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb4-867"><a href="#cb4-867" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb4-868"><a href="#cb4-868" aria-hidden="true" tabindex="-1"></a><span class="co">#| code-fold: true</span></span>
<span id="cb4-869"><a href="#cb4-869" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: 'mapie-py'</span></span>
<span id="cb4-870"><a href="#cb4-870" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> mapie.regression <span class="im">import</span> MapieRegressor</span>
<span id="cb4-871"><a href="#cb4-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-872"><a href="#cb4-872" aria-hidden="true" tabindex="-1"></a>initial_fit <span class="op">=</span> LinearRegression().fit(X_train, y_train)</span>
<span id="cb4-873"><a href="#cb4-873" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> MapieRegressor(initial_fit, method <span class="op">=</span> <span class="st">'naive'</span>)</span>
<span id="cb4-874"><a href="#cb4-874" aria-hidden="true" tabindex="-1"></a>y_pred, y_pis <span class="op">=</span> model.fit(X_train, y_train).predict(X_test, alpha <span class="op">=</span> <span class="fl">0.1</span>)</span>
<span id="cb4-875"><a href="#cb4-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-876"><a href="#cb4-876" aria-hidden="true" tabindex="-1"></a><span class="co"># take the first difference between upper and lower bounds,</span></span>
<span id="cb4-877"><a href="#cb4-877" aria-hidden="true" tabindex="-1"></a><span class="co"># since it's constant for all predictions in this setting</span></span>
<span id="cb4-878"><a href="#cb4-878" aria-hidden="true" tabindex="-1"></a>cp_error_mapie <span class="op">=</span> (y_pis[<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>] <span class="op">-</span> y_pis[<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>]) <span class="op">/</span> <span class="dv">2</span>  </span>
<span id="cb4-879"><a href="#cb4-879" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb4-880"><a href="#cb4-880" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-883"><a href="#cb4-883" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb4-884"><a href="#cb4-884" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb4-885"><a href="#cb4-885" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: show-mapie-cp-error</span></span>
<span id="cb4-886"><a href="#cb4-886" aria-hidden="true" tabindex="-1"></a>pd.DataFrame({<span class="st">'CP Error'</span>: np.<span class="bu">round</span>(cp_error, <span class="dv">4</span>)}, index<span class="op">=</span>[<span class="st">''</span>])</span>
<span id="cb4-887"><a href="#cb4-887" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb4-888"><a href="#cb4-888" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-891"><a href="#cb4-891" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb4-892"><a href="#cb4-892" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: true</span></span>
<span id="cb4-893"><a href="#cb4-893" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: show-r-cp-error</span></span>
<span id="cb4-894"><a href="#cb4-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-895"><a href="#cb4-895" aria-hidden="true" tabindex="-1"></a>cp_by_mapie <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">as.character</span>(py<span class="sc">$</span>cp_error_mapie))</span>
<span id="cb4-896"><a href="#cb4-896" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-897"><a href="#cb4-897" aria-hidden="true" tabindex="-1"></a><span class="fu">gt</span>(</span>
<span id="cb4-898"><a href="#cb4-898" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb4-899"><a href="#cb4-899" aria-hidden="true" tabindex="-1"></a>        <span class="at">Source =</span> <span class="fu">c</span>(<span class="st">'R-by-hand'</span>, <span class="st">'Py-by-hand'</span>, <span class="st">'Py-mapie'</span>),</span>
<span id="cb4-900"><a href="#cb4-900" aria-hidden="true" tabindex="-1"></a>        <span class="st">`</span><span class="at">CP Error</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">c</span>(r_by_hand, py_by_hand, cp_by_mapie) <span class="co"># add round back after issue found</span></span>
<span id="cb4-901"><a href="#cb4-901" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-902"><a href="#cb4-902" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> </span>
<span id="cb4-903"><a href="#cb4-903" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fmt_number</span>(</span>
<span id="cb4-904"><a href="#cb4-904" aria-hidden="true" tabindex="-1"></a>        <span class="at">columns =</span> <span class="fu">vars</span>(<span class="st">`</span><span class="at">CP Error</span><span class="st">`</span>),</span>
<span id="cb4-905"><a href="#cb4-905" aria-hidden="true" tabindex="-1"></a>        <span class="at">decimals =</span> <span class="dv">4</span></span>
<span id="cb4-906"><a href="#cb4-906" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-907"><a href="#cb4-907" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb4-908"><a href="#cb4-908" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-909"><a href="#cb4-909" aria-hidden="true" tabindex="-1"></a>:::{.callout-note title="Other Methods"}</span>
<span id="cb4-910"><a href="#cb4-910" aria-hidden="true" tabindex="-1"></a>As we've seen, there are numerous methods for estimating uncertainty in our predictions. As another example, some use *quantile regression* in machine learning models. It is based on the idea that we can estimate the uncertainty in our predictions by modeling the specific quantiles rather than the conditional mean default value, for example, the .05 and .95 values. But those quantiles are predictions with uncertainty themselves, and without incorporating that uncertainty, tend to underestimate the uncertainty in the prediction (Bai et al., 2021). In general, one should be cautious about the method they choose in any particular setting.</span>
<span id="cb4-911"><a href="#cb4-911" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb4-912"><a href="#cb4-912" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-913"><a href="#cb4-913" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-914"><a href="#cb4-914" aria-hidden="true" tabindex="-1"></a><span class="fu">## Practical Comparison: Uncertainty Methods on Housing Data</span></span>
<span id="cb4-915"><a href="#cb4-915" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-916"><a href="#cb4-916" aria-hidden="true" tabindex="-1"></a>To see our uncertainty estimation in practice, we'll use a sample of the classic <span class="co">[</span><span class="ot">California Housing Prices dataset</span><span class="co">](https://www.kaggle.com/camnugent/california-housing-prices)</span> for demonstration. The dataset contains information about housing prices in California, including the median house value in a district, the median income for that district, and the median house age etc. We'll use all the available features to predict median house value on the log scale. You can find out some basic info for the data at the <span class="co">[</span><span class="ot">end of this post</span><span class="co">](#data-details)</span>. The very rough notebook used to generate the data and results is available <span class="co">[</span><span class="ot">at my website repo</span><span class="co">](https://github.com/m-clark/m-clark.github.io/tree/master/posts)</span>.</span>
<span id="cb4-917"><a href="#cb4-917" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-918"><a href="#cb4-918" aria-hidden="true" tabindex="-1"></a>In the following we show the 90% prediction interval estimates for a basic linear regression after exponentiating to the original scale. Points are arranged in increasing (median) predicted value. We can see that the prediction intervals are essentially in agreement for all methods we previously discussed -- statistical, bootstrapped, Bayesian, and conformal. Highlighted are the points missed by the intervals, which was around 10% for each method (data issues notwithstanding<span class="ot">[^tooslim]</span>). This should leave us feeling good about using any of these methods for uncertainty estimation in simpler model settings.</span>
<span id="cb4-919"><a href="#cb4-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-920"><a href="#cb4-920" aria-hidden="true" tabindex="-1"></a><span class="ot">[^tooslim]: </span>Interestingly all but the bootstrap appeared slightly narrow, but I think this has more to do with data issues, particularly the preponderance of house prices censored to ~500,000, about <span class="in">`r scales::label_percent()(mean(exp(y_train)&gt;=500000))`</span> of the data. No preprocessing was done except to put the home price on the log scale. </span>
<span id="cb4-921"><a href="#cb4-921" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-924"><a href="#cb4-924" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb4-925"><a href="#cb4-925" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb4-926"><a href="#cb4-926" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: 'Prediction Intervals for Median House Value for the California Housing Dataset:&lt;br&gt;- conformal prediction (cp)&lt;br&gt;- bootstrapping (boot)&lt;br&gt;- bayesian (bayes)&lt;br&gt;- traditional statistical (ols)'</span></span>
<span id="cb4-927"><a href="#cb4-927" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: 'lin-reg-plot'</span></span>
<span id="cb4-928"><a href="#cb4-928" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-929"><a href="#cb4-929" aria-hidden="true" tabindex="-1"></a>p_dat <span class="ot">=</span> df_results <span class="sc">|&gt;</span> </span>
<span id="cb4-930"><a href="#cb4-930" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>median_house_value) <span class="sc">|&gt;</span> </span>
<span id="cb4-931"><a href="#cb4-931" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(y_pred) <span class="sc">|&gt;</span></span>
<span id="cb4-932"><a href="#cb4-932" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb4-933"><a href="#cb4-933" aria-hidden="true" tabindex="-1"></a>        <span class="at">y_pred =</span> <span class="fu">exp</span>(y_pred),</span>
<span id="cb4-934"><a href="#cb4-934" aria-hidden="true" tabindex="-1"></a>        <span class="at">idx =</span> <span class="fu">row_number</span>()</span>
<span id="cb4-935"><a href="#cb4-935" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span> </span>
<span id="cb4-936"><a href="#cb4-936" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="fu">c</span>(idx, y, y_pred), <span class="at">names_to =</span> <span class="st">'CI_type'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb4-937"><a href="#cb4-937" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">exp</span>(value)) <span class="sc">|&gt;</span> </span>
<span id="cb4-938"><a href="#cb4-938" aria-hidden="true" tabindex="-1"></a>    <span class="fu">separate</span>(CI_type, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">'type'</span>, <span class="st">'bound'</span>))  <span class="sc">|&gt;</span> </span>
<span id="cb4-939"><a href="#cb4-939" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> bound, <span class="at">values_from =</span> value)  <span class="sc">|&gt;</span> </span>
<span id="cb4-940"><a href="#cb4-940" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(        </span>
<span id="cb4-941"><a href="#cb4-941" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="fu">ifelse</span>(type <span class="sc">==</span> <span class="st">'conf'</span>, <span class="st">'cp'</span>, type),</span>
<span id="cb4-942"><a href="#cb4-942" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="fu">factor</span>(type, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">'ols'</span>, <span class="st">'boot'</span>, <span class="st">'bayes'</span>, <span class="st">'cp'</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">'OLS'</span>, <span class="st">'Bootstrap'</span>, <span class="st">'Bayesian'</span>, <span class="st">'Conformal'</span>)),</span>
<span id="cb4-943"><a href="#cb4-943" aria-hidden="true" tabindex="-1"></a>        <span class="at">coverage =</span> (<span class="fu">exp</span>(y) <span class="sc">&lt;</span> lower <span class="sc">|</span> <span class="fu">exp</span>(y) <span class="sc">&gt;</span> upper),</span>
<span id="cb4-944"><a href="#cb4-944" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="fu">exp</span>(y)</span>
<span id="cb4-945"><a href="#cb4-945" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb4-946"><a href="#cb4-946" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-947"><a href="#cb4-947" aria-hidden="true" tabindex="-1"></a><span class="co"># p_dat |&gt; </span></span>
<span id="cb4-948"><a href="#cb4-948" aria-hidden="true" tabindex="-1"></a><span class="co">#     summarize(coverage = mean(coverage), .by = type)</span></span>
<span id="cb4-949"><a href="#cb4-949" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-950"><a href="#cb4-950" aria-hidden="true" tabindex="-1"></a>p_dat <span class="sc">|&gt;</span></span>
<span id="cb4-951"><a href="#cb4-951" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> idx, <span class="at">y =</span> y_pred)) <span class="sc">+</span></span>
<span id="cb4-952"><a href="#cb4-952" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(</span>
<span id="cb4-953"><a href="#cb4-953" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(</span>
<span id="cb4-954"><a href="#cb4-954" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> y, </span>
<span id="cb4-955"><a href="#cb4-955" aria-hidden="true" tabindex="-1"></a>            <span class="co"># color = type, </span></span>
<span id="cb4-956"><a href="#cb4-956" aria-hidden="true" tabindex="-1"></a>            <span class="co"># size = I(ifelse(coverage, 1, .1)) , </span></span>
<span id="cb4-957"><a href="#cb4-957" aria-hidden="true" tabindex="-1"></a>            <span class="co"># alpha = I(ifelse(coverage, .5, .01))</span></span>
<span id="cb4-958"><a href="#cb4-958" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb4-959"><a href="#cb4-959" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> okabe_ito[<span class="dv">5</span>],</span>
<span id="cb4-960"><a href="#cb4-960" aria-hidden="true" tabindex="-1"></a>        <span class="at">alpha =</span> .<span class="dv">1</span>,</span>
<span id="cb4-961"><a href="#cb4-961" aria-hidden="true" tabindex="-1"></a>        <span class="at">show.legend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-962"><a href="#cb4-962" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> p_dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(coverage)</span>
<span id="cb4-963"><a href="#cb4-963" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb4-964"><a href="#cb4-964" aria-hidden="true" tabindex="-1"></a>    <span class="co"># scale_color_manual(values = c('gray50', okabe_ito[5])) +</span></span>
<span id="cb4-965"><a href="#cb4-965" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ggnewscale::new_scale_color() +</span></span>
<span id="cb4-966"><a href="#cb4-966" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">color =</span> okabe_ito[<span class="dv">1</span>]) <span class="sc">+</span></span>
<span id="cb4-967"><a href="#cb4-967" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(</span>
<span id="cb4-968"><a href="#cb4-968" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper),</span>
<span id="cb4-969"><a href="#cb4-969" aria-hidden="true" tabindex="-1"></a>        <span class="at">alpha =</span> .<span class="dv">05</span>,</span>
<span id="cb4-970"><a href="#cb4-970" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> p_dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">'ols'</span>)</span>
<span id="cb4-971"><a href="#cb4-971" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb4-972"><a href="#cb4-972" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(</span>
<span id="cb4-973"><a href="#cb4-973" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(</span>
<span id="cb4-974"><a href="#cb4-974" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> lower, </span>
<span id="cb4-975"><a href="#cb4-975" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> type,</span>
<span id="cb4-976"><a href="#cb4-976" aria-hidden="true" tabindex="-1"></a>            <span class="at">linetype =</span> type,</span>
<span id="cb4-977"><a href="#cb4-977" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb4-978"><a href="#cb4-978" aria-hidden="true" tabindex="-1"></a>        <span class="at">alpha =</span> .<span class="dv">25</span></span>
<span id="cb4-979"><a href="#cb4-979" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb4-980"><a href="#cb4-980" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(</span>
<span id="cb4-981"><a href="#cb4-981" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(</span>
<span id="cb4-982"><a href="#cb4-982" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> upper, </span>
<span id="cb4-983"><a href="#cb4-983" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> type,</span>
<span id="cb4-984"><a href="#cb4-984" aria-hidden="true" tabindex="-1"></a>            <span class="at">linetype =</span> type,</span>
<span id="cb4-985"><a href="#cb4-985" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb4-986"><a href="#cb4-986" aria-hidden="true" tabindex="-1"></a>        <span class="at">alpha =</span> .<span class="dv">5</span></span>
<span id="cb4-987"><a href="#cb4-987" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb4-988"><a href="#cb4-988" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb4-989"><a href="#cb4-989" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">'Prediction Index'</span>,</span>
<span id="cb4-990"><a href="#cb4-990" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">''</span>,</span>
<span id="cb4-991"><a href="#cb4-991" aria-hidden="true" tabindex="-1"></a>        <span class="co"># y = 'Median House Value',</span></span>
<span id="cb4-992"><a href="#cb4-992" aria-hidden="true" tabindex="-1"></a>        <span class="co"># title = 'Prediction Intervals for Median House Value\nfor the California Housing Dataset (test set)',</span></span>
<span id="cb4-993"><a href="#cb4-993" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">'Comparison of different prediction intervals for linear regression'</span></span>
<span id="cb4-994"><a href="#cb4-994" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb4-995"><a href="#cb4-995" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_log10</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="fl">5e4</span>, <span class="fl">1e5</span>, <span class="fl">5e5</span>, <span class="fl">1e6</span>), <span class="at">labels =</span> scales<span class="sc">::</span>dollar) <span class="sc">+</span></span>
<span id="cb4-996"><a href="#cb4-996" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> okabe_ito[<span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">6</span>,<span class="dv">7</span>)], <span class="at">aesthetics =</span> <span class="fu">c</span>(<span class="st">'fill'</span>, <span class="st">'color'</span>)) <span class="sc">+</span></span>
<span id="cb4-997"><a href="#cb4-997" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb4-998"><a href="#cb4-998" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb4-999"><a href="#cb4-999" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.major.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb4-1000"><a href="#cb4-1000" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid.minor.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb4-1001"><a href="#cb4-1001" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">'bottom'</span>,</span>
<span id="cb4-1002"><a href="#cb4-1002" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb4-1003"><a href="#cb4-1003" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb4-1004"><a href="#cb4-1004" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">'cm'</span>),</span>
<span id="cb4-1005"><a href="#cb4-1005" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-1006"><a href="#cb4-1006" aria-hidden="true" tabindex="-1"></a>     </span>
<span id="cb4-1007"><a href="#cb4-1007" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">'img/conformal/lin-reg-plot.png'</span>, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">units =</span> <span class="st">'in'</span>, <span class="at">dpi =</span> <span class="dv">300</span>)</span>
<span id="cb4-1008"><a href="#cb4-1008" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb4-1009"><a href="#cb4-1009" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1010"><a href="#cb4-1010" aria-hidden="true" tabindex="-1"></a><span class="al">![Prediction Intervals (Linear Regression)](../../img/conformal/lin-reg-plot.png)</span>{width=75%}</span>
<span id="cb4-1011"><a href="#cb4-1011" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1012"><a href="#cb4-1012" aria-hidden="true" tabindex="-1"></a>The following visualization shows the exact same data context, though now we use an xgboost model to predict the target. With this model, we do not have an underlying statistical distribution or easy Bayesian counterpart<span class="ot">[^BART]</span> with which to estimate uncertainty. So we are left to use a bootstrapped approach or conformal prediction. Furthermore, the nature of the model means that the actual interval widths can vary a bit from point to point, so the lines shown are smoothed boundaries used to make the general pattern more clear, but should not be taken as the actual interval for a given point. </span>
<span id="cb4-1013"><a href="#cb4-1013" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1014"><a href="#cb4-1014" aria-hidden="true" tabindex="-1"></a>In the visualization, blue represents the bootstrapped prediction interval while red represents the conformal prediction interval. Points that fall outside their respective intervals are highlighted - blue dots show observations missed by bootstrap intervals and red dots show those missed by conformal intervals.  Some points may appear in both colors when they're missed by both approaches (i.e., anything missed by the conformal is also missed by the bootstrap).</span>
<span id="cb4-1015"><a href="#cb4-1015" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1016"><a href="#cb4-1016" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1017"><a href="#cb4-1017" aria-hidden="true" tabindex="-1"></a><span class="ot">[^BART]: </span>There are methods like Bayesian Additive Regression Trees, but that's a rabbit hole I didn't think necessary to investigate for our purposes. Likewise we could also have done a very complicated linear model that incorporates interactions and nonlinearities.</span>
<span id="cb4-1018"><a href="#cb4-1018" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1021"><a href="#cb4-1021" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb4-1022"><a href="#cb4-1022" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb4-1023"><a href="#cb4-1023" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: 'hist-ci-diff'</span></span>
<span id="cb4-1024"><a href="#cb4-1024" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(df_results_boost<span class="sc">$</span>conf_upper <span class="sc">-</span> df_results_boost<span class="sc">$</span>conf_lower, <span class="st">'FD'</span>)</span>
<span id="cb4-1025"><a href="#cb4-1025" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb4-1026"><a href="#cb4-1026" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1027"><a href="#cb4-1027" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1030"><a href="#cb4-1030" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb4-1031"><a href="#cb4-1031" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb4-1032"><a href="#cb4-1032" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: 'boost-plot'</span></span>
<span id="cb4-1033"><a href="#cb4-1033" aria-hidden="true" tabindex="-1"></a>p_dat <span class="ot">=</span> df_results_boost <span class="sc">|&gt;</span></span>
<span id="cb4-1034"><a href="#cb4-1034" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(y_pred_boot) <span class="sc">|&gt;</span></span>
<span id="cb4-1035"><a href="#cb4-1035" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span><span class="fu">matches</span>(<span class="st">'ols'</span>), <span class="sc">-</span>median_house_value) <span class="sc">|&gt;</span></span>
<span id="cb4-1036"><a href="#cb4-1036" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb4-1037"><a href="#cb4-1037" aria-hidden="true" tabindex="-1"></a>        <span class="at">idx =</span> <span class="fu">row_number</span>(),</span>
<span id="cb4-1038"><a href="#cb4-1038" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="fu">exp</span>(y),</span>
<span id="cb4-1039"><a href="#cb4-1039" aria-hidden="true" tabindex="-1"></a>        <span class="at">y_pred_boost =</span> <span class="fu">exp</span>(y_pred_boost),</span>
<span id="cb4-1040"><a href="#cb4-1040" aria-hidden="true" tabindex="-1"></a>        <span class="at">y_pred_boot  =</span> <span class="fu">exp</span>(y_pred_boot),</span>
<span id="cb4-1041"><a href="#cb4-1041" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb4-1042"><a href="#cb4-1042" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="sc">-</span><span class="fu">c</span>(idx, y, y_pred_boost, y_pred_boot), <span class="at">names_to =</span> <span class="st">'CI_type'</span>) <span class="sc">|&gt;</span></span>
<span id="cb4-1043"><a href="#cb4-1043" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">value =</span> <span class="fu">exp</span>(value)) <span class="sc">|&gt;</span></span>
<span id="cb4-1044"><a href="#cb4-1044" aria-hidden="true" tabindex="-1"></a>    <span class="fu">separate</span>(CI_type, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">'type'</span>, <span class="st">'bound'</span>)) <span class="sc">|&gt;</span> <span class="co">#skimr::skim()</span></span>
<span id="cb4-1045"><a href="#cb4-1045" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> bound, <span class="at">values_from =</span> value) <span class="sc">|&gt;</span> </span>
<span id="cb4-1046"><a href="#cb4-1046" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb4-1047"><a href="#cb4-1047" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="fu">ifelse</span>(type <span class="sc">==</span> <span class="st">"conf"</span>, <span class="st">"cp"</span>, type),</span>
<span id="cb4-1048"><a href="#cb4-1048" aria-hidden="true" tabindex="-1"></a>        <span class="at">coverage =</span> (y <span class="sc">&gt;</span> lower <span class="sc">&amp;</span> y <span class="sc">&lt;</span> upper),</span>
<span id="cb4-1049"><a href="#cb4-1049" aria-hidden="true" tabindex="-1"></a>        <span class="at">type =</span> <span class="fu">factor</span>(type, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">'ols'</span>, <span class="st">'boot'</span>, <span class="st">'bayes'</span>, <span class="st">'cp'</span>), <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">'OLS'</span>, <span class="st">'Bootstrap'</span>, <span class="st">'Bayesian'</span>, <span class="st">'Conformal'</span>))</span>
<span id="cb4-1050"><a href="#cb4-1050" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-1051"><a href="#cb4-1051" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1052"><a href="#cb4-1052" aria-hidden="true" tabindex="-1"></a>p_dat <span class="ot">=</span> p_dat <span class="sc">|&gt;</span></span>
<span id="cb4-1053"><a href="#cb4-1053" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1054"><a href="#cb4-1054" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb4-1055"><a href="#cb4-1055" aria-hidden="true" tabindex="-1"></a>        <span class="at">too_narrow =</span> <span class="fu">ifelse</span>(<span class="sc">!</span>coverage, .<span class="dv">5</span>, .<span class="dv">01</span>), </span>
<span id="cb4-1056"><a href="#cb4-1056" aria-hidden="true" tabindex="-1"></a>        <span class="at">too_narrow_color =</span> <span class="fu">case_when</span>(</span>
<span id="cb4-1057"><a href="#cb4-1057" aria-hidden="true" tabindex="-1"></a>            <span class="sc">!</span>coverage <span class="sc">&amp;</span> type <span class="sc">==</span> <span class="st">'Bootstrap'</span> <span class="sc">~</span> okabe_ito[<span class="dv">5</span>],</span>
<span id="cb4-1058"><a href="#cb4-1058" aria-hidden="true" tabindex="-1"></a>            <span class="sc">!</span>coverage <span class="sc">&amp;</span> type <span class="sc">==</span> <span class="st">'Conformal'</span>   <span class="sc">~</span> okabe_ito[<span class="dv">6</span>],</span>
<span id="cb4-1059"><a href="#cb4-1059" aria-hidden="true" tabindex="-1"></a>            <span class="cn">TRUE</span> <span class="sc">~</span> <span class="st">'gray75'</span></span>
<span id="cb4-1060"><a href="#cb4-1060" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb4-1061"><a href="#cb4-1061" aria-hidden="true" tabindex="-1"></a>        <span class="at">too_narrow_size =</span> <span class="fu">case_when</span>(</span>
<span id="cb4-1062"><a href="#cb4-1062" aria-hidden="true" tabindex="-1"></a>            <span class="sc">!</span>coverage <span class="sc">&amp;</span> type <span class="sc">==</span> <span class="st">'Bootstrap'</span> <span class="sc">~</span> .<span class="dv">5</span>,</span>
<span id="cb4-1063"><a href="#cb4-1063" aria-hidden="true" tabindex="-1"></a>            <span class="sc">!</span>coverage <span class="sc">&amp;</span> type <span class="sc">==</span> <span class="st">'Conformal'</span>   <span class="sc">~</span> <span class="dv">2</span>,</span>
<span id="cb4-1064"><a href="#cb4-1064" aria-hidden="true" tabindex="-1"></a>            <span class="cn">TRUE</span> <span class="sc">~</span> .<span class="dv">25</span></span>
<span id="cb4-1065"><a href="#cb4-1065" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb4-1066"><a href="#cb4-1066" aria-hidden="true" tabindex="-1"></a>        <span class="at">.by =</span> type</span>
<span id="cb4-1067"><a href="#cb4-1067" aria-hidden="true" tabindex="-1"></a>    ) </span>
<span id="cb4-1068"><a href="#cb4-1068" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1069"><a href="#cb4-1069" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1070"><a href="#cb4-1070" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1071"><a href="#cb4-1071" aria-hidden="true" tabindex="-1"></a>p_dat <span class="sc">|&gt;</span></span>
<span id="cb4-1072"><a href="#cb4-1072" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> idx, <span class="at">y =</span> y_pred_boost)) <span class="sc">+</span></span>
<span id="cb4-1073"><a href="#cb4-1073" aria-hidden="true" tabindex="-1"></a>    <span class="co"># geom_line() +</span></span>
<span id="cb4-1074"><a href="#cb4-1074" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(</span>
<span id="cb4-1075"><a href="#cb4-1075" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(</span>
<span id="cb4-1076"><a href="#cb4-1076" aria-hidden="true" tabindex="-1"></a>            <span class="at">y     =</span> y, </span>
<span id="cb4-1077"><a href="#cb4-1077" aria-hidden="true" tabindex="-1"></a>            <span class="at">size  =</span> <span class="fu">I</span>(too_narrow_size),</span>
<span id="cb4-1078"><a href="#cb4-1078" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> <span class="fu">I</span>(too_narrow_color), </span>
<span id="cb4-1079"><a href="#cb4-1079" aria-hidden="true" tabindex="-1"></a>            <span class="at">alpha =</span> <span class="fu">I</span>(too_narrow)</span>
<span id="cb4-1080"><a href="#cb4-1080" aria-hidden="true" tabindex="-1"></a>        ), </span>
<span id="cb4-1081"><a href="#cb4-1081" aria-hidden="true" tabindex="-1"></a>        <span class="at">show.legend =</span> <span class="cn">FALSE</span>,</span>
<span id="cb4-1082"><a href="#cb4-1082" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> p_dat <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span>coverage)</span>
<span id="cb4-1083"><a href="#cb4-1083" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb4-1084"><a href="#cb4-1084" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(</span>
<span id="cb4-1085"><a href="#cb4-1085" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">ymin =</span> lower, <span class="at">ymax =</span> upper, <span class="at">fill =</span> type, <span class="at">linetype =</span> type),</span>
<span id="cb4-1086"><a href="#cb4-1086" aria-hidden="true" tabindex="-1"></a>        <span class="at">alpha =</span> .<span class="dv">1</span></span>
<span id="cb4-1087"><a href="#cb4-1087" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb4-1088"><a href="#cb4-1088" aria-hidden="true" tabindex="-1"></a>    ggnewscale<span class="sc">::</span><span class="fu">new_scale_color</span>() <span class="sc">+</span>    </span>
<span id="cb4-1089"><a href="#cb4-1089" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(</span>
<span id="cb4-1090"><a href="#cb4-1090" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(</span>
<span id="cb4-1091"><a href="#cb4-1091" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> lower,</span>
<span id="cb4-1092"><a href="#cb4-1092" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> type,</span>
<span id="cb4-1093"><a href="#cb4-1093" aria-hidden="true" tabindex="-1"></a>            <span class="co"># linetype = type</span></span>
<span id="cb4-1094"><a href="#cb4-1094" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb4-1095"><a href="#cb4-1095" aria-hidden="true" tabindex="-1"></a>        <span class="at">se =</span> <span class="cn">FALSE</span></span>
<span id="cb4-1096"><a href="#cb4-1096" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb4-1097"><a href="#cb4-1097" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(</span>
<span id="cb4-1098"><a href="#cb4-1098" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(</span>
<span id="cb4-1099"><a href="#cb4-1099" aria-hidden="true" tabindex="-1"></a>            <span class="at">y =</span> upper,</span>
<span id="cb4-1100"><a href="#cb4-1100" aria-hidden="true" tabindex="-1"></a>            <span class="at">color =</span> type,</span>
<span id="cb4-1101"><a href="#cb4-1101" aria-hidden="true" tabindex="-1"></a>            <span class="co"># linetype = type</span></span>
<span id="cb4-1102"><a href="#cb4-1102" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb4-1103"><a href="#cb4-1103" aria-hidden="true" tabindex="-1"></a>        <span class="at">se =</span> <span class="cn">FALSE</span></span>
<span id="cb4-1104"><a href="#cb4-1104" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb4-1105"><a href="#cb4-1105" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb4-1106"><a href="#cb4-1106" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">'Prediction Index'</span>,</span>
<span id="cb4-1107"><a href="#cb4-1107" aria-hidden="true" tabindex="-1"></a>        <span class="co"># y = 'Median House Value',</span></span>
<span id="cb4-1108"><a href="#cb4-1108" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">''</span>,</span>
<span id="cb4-1109"><a href="#cb4-1109" aria-hidden="true" tabindex="-1"></a>        <span class="co"># title = 'Prediction Intervals for Median House Value',</span></span>
<span id="cb4-1110"><a href="#cb4-1110" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">'Comparison of different prediction intervals for XGBoost'</span></span>
<span id="cb4-1111"><a href="#cb4-1111" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb4-1112"><a href="#cb4-1112" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_y_log10</span>(<span class="at">breaks =</span> <span class="fu">c</span>(<span class="fl">5e4</span>, <span class="fl">1e5</span>, <span class="fl">5e5</span>, <span class="fl">1e6</span>), <span class="at">labels =</span> scales<span class="sc">::</span>dollar) <span class="sc">+</span></span>
<span id="cb4-1113"><a href="#cb4-1113" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> okabe_ito[<span class="dv">5</span><span class="sc">:</span><span class="dv">6</span>], <span class="at">aesthetics =</span> <span class="fu">c</span>(<span class="st">'fill'</span>, <span class="st">'color'</span>)) <span class="sc">+</span></span>
<span id="cb4-1114"><a href="#cb4-1114" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb4-1115"><a href="#cb4-1115" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb4-1116"><a href="#cb4-1116" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">'bottom'</span>,</span>
<span id="cb4-1117"><a href="#cb4-1117" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb4-1118"><a href="#cb4-1118" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb4-1119"><a href="#cb4-1119" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.key.size =</span> <span class="fu">unit</span>(<span class="dv">1</span>, <span class="st">'cm'</span>),</span>
<span id="cb4-1120"><a href="#cb4-1120" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-1121"><a href="#cb4-1121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1122"><a href="#cb4-1122" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="st">'img/conformal/boost-plot.png'</span>, <span class="at">width =</span> <span class="dv">8</span>, <span class="at">height =</span> <span class="dv">6</span>, <span class="at">units =</span> <span class="st">'in'</span>, <span class="at">dpi =</span> <span class="dv">300</span>)</span>
<span id="cb4-1123"><a href="#cb4-1123" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb4-1124"><a href="#cb4-1124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1125"><a href="#cb4-1125" aria-hidden="true" tabindex="-1"></a><span class="al">![Prediction Intervals (XGBoost)](../../img/conformal/boost-plot.png)</span>{width=75%}</span>
<span id="cb4-1126"><a href="#cb4-1126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1127"><a href="#cb4-1127" aria-hidden="true" tabindex="-1"></a>The first thing we see is that the naive bootstrap is too optimistic in this situation, with interval estimates that are too narrow, which results in only <span class="in">`r scales::label_percent()(cover_boot)`</span> coverage compared to the target 90%. Complex tree-based models like XGBoost often exhibit this problem with bootstrapping because the resampling approach struggles to capture the full model uncertainty in high-variance models. </span>
<span id="cb4-1128"><a href="#cb4-1128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1129"><a href="#cb4-1129" aria-hidden="true" tabindex="-1"></a>In contrast, the conformal interval is more conservative and achieves <span class="in">`r scales::label_percent()(cover_boost)`</span> coverage, close to matching our specified 90% target (though slightly more conservative). This demonstrates conformal prediction's ability to produce reliable uncertainty estimates even for complex models where traditional methods struggle. As a practical advantage, on an Apple M1 laptop, it took a few seconds to get the conformal prediction intervals, while the bootstrap took over 10 minutes for 500 bootstrap replications.</span>
<span id="cb4-1130"><a href="#cb4-1130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1131"><a href="#cb4-1131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1132"><a href="#cb4-1132" aria-hidden="true" tabindex="-1"></a><span class="fu">## Pros and Cons</span></span>
<span id="cb4-1133"><a href="#cb4-1133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1134"><a href="#cb4-1134" aria-hidden="true" tabindex="-1"></a>Nothing comes for free in the modeling world. Here we list some advantages and disadvantages of the different approaches to uncertainty estimation. Note that this is not an exhaustive list nor does it go into specifics, and there may be additional considerations beyond those noted.</span>
<span id="cb4-1135"><a href="#cb4-1135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1136"><a href="#cb4-1136" aria-hidden="true" tabindex="-1"></a><span class="fu">### Traditional Statistical Prediction Intervals </span></span>
<span id="cb4-1137"><a href="#cb4-1137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1138"><a href="#cb4-1138" aria-hidden="true" tabindex="-1"></a>**Advantages:**</span>
<span id="cb4-1139"><a href="#cb4-1139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1140"><a href="#cb4-1140" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Ease**: For many models, prediction intervals can be computed easily and are automatically provided by various modeling packages.</span>
<span id="cb4-1141"><a href="#cb4-1141" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Interpretability**: The statistical theory behind the prediction intervals is generally straightforward.</span>
<span id="cb4-1142"><a href="#cb4-1142" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Computational Efficiency**: Unlike bootstrapping or Bayesian approaches that require multiple model fits or MCMC sampling, traditional statistical intervals can typically be calculated directly from the fitted model parameters with minimal computational overhead.</span>
<span id="cb4-1143"><a href="#cb4-1143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1144"><a href="#cb4-1144" aria-hidden="true" tabindex="-1"></a>**Disadvantages:**</span>
<span id="cb4-1145"><a href="#cb4-1145" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1146"><a href="#cb4-1146" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Distribution Assumption**: They typically require (sometimes strong) assumptions about the underlying data distribution.</span>
<span id="cb4-1147"><a href="#cb4-1147" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Model-Specific Estimation**: The intervals depend on a specific statistical model, and different estimation approaches are needed for different models. </span>
<span id="cb4-1148"><a href="#cb4-1148" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Model Complexity**: Even common models, e.g., those using penalty terms, can make prediction uncertainty using distributional assumptions difficult<span class="ot">[^nomer]</span>.</span>
<span id="cb4-1149"><a href="#cb4-1149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1150"><a href="#cb4-1150" aria-hidden="true" tabindex="-1"></a><span class="ot">[^nomer]: </span>One of the more popular statistical packages in R is <span class="in">`lme4`</span>, and the developers don't provide prediction intervals for mixed models because "it is difficult to define an efficient method that incorporates uncertainty in the variance parameters". They suggest to use bootstrapping instead.</span>
<span id="cb4-1151"><a href="#cb4-1151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1152"><a href="#cb4-1152" aria-hidden="true" tabindex="-1"></a><span class="fu">### Bootstrapping </span></span>
<span id="cb4-1153"><a href="#cb4-1153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1154"><a href="#cb4-1154" aria-hidden="true" tabindex="-1"></a>**Advantages:**</span>
<span id="cb4-1155"><a href="#cb4-1155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1156"><a href="#cb4-1156" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Simple**: Bootstrapping is a relatively simple approach to estimating uncertainty.</span>
<span id="cb4-1157"><a href="#cb4-1157" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Less Restrictive Assumptions**: Like conformal prediction, non-parametric bootstrapping doesn't require assumptions of the underlying data distribution.</span>
<span id="cb4-1158"><a href="#cb4-1158" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Model-Agnostic**: It operates directly on the data irrespective of your model.</span>
<span id="cb4-1159"><a href="#cb4-1159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1160"><a href="#cb4-1160" aria-hidden="true" tabindex="-1"></a>**Disadvantages:**</span>
<span id="cb4-1161"><a href="#cb4-1161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1162"><a href="#cb4-1162" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Computationally Intensive**: It might require a large number of resamples, which can be computationally intensive for some model-data combinations.</span>
<span id="cb4-1163"><a href="#cb4-1163" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Data issues**: For very small datasets, extreme values/tails, estimates could be problematic, but this is likely true for most approaches.</span>
<span id="cb4-1164"><a href="#cb4-1164" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Naive approach is limited**: The naive resampling approach tends to underestimate uncertainty, so additional steps are required to get a more accurate estimate of uncertainty.</span>
<span id="cb4-1165"><a href="#cb4-1165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1166"><a href="#cb4-1166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1167"><a href="#cb4-1167" aria-hidden="true" tabindex="-1"></a><span class="fu">### Bayesian Approaches </span></span>
<span id="cb4-1168"><a href="#cb4-1168" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1169"><a href="#cb4-1169" aria-hidden="true" tabindex="-1"></a>**Advantages:**</span>
<span id="cb4-1170"><a href="#cb4-1170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1171"><a href="#cb4-1171" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Probabilistic Interpretation**: It provides a full distribution of plausible values for our parameters or predictions.</span>
<span id="cb4-1172"><a href="#cb4-1172" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Incorporates Prior Information**: We can use prior beliefs about parameters we estimate. For example, we can use last year's data to inform our prior beliefs about the parameters of this year's model.</span>
<span id="cb4-1173"><a href="#cb4-1173" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Confidence in Uncertainty Estimate**: We can be more confident in our uncertainty estimates than we can with some statistical approaches that often use workarounds to estimate uncertainty (e.g. mixed models), and there are many diagnostic tools available to spot problematic models.</span>
<span id="cb4-1174"><a href="#cb4-1174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1175"><a href="#cb4-1175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1176"><a href="#cb4-1176" aria-hidden="true" tabindex="-1"></a>**Disadvantages:**</span>
<span id="cb4-1177"><a href="#cb4-1177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1178"><a href="#cb4-1178" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Computationally Intensive**: MCMC sampling for model estimation can be slow, particularly for complex models.</span>
<span id="cb4-1179"><a href="#cb4-1179" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Choice of Prior**: The choice of prior can significantly influence the results, especially with small data.</span>
<span id="cb4-1180"><a href="#cb4-1180" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Statistical Assumptions**: As the Bayesian models are an alternative way to estimate statistical models, they depend on a specific statistical model and its likelihood.</span>
<span id="cb4-1181"><a href="#cb4-1181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1182"><a href="#cb4-1182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1183"><a href="#cb4-1183" aria-hidden="true" tabindex="-1"></a><span class="fu">### Conformal Prediction </span></span>
<span id="cb4-1184"><a href="#cb4-1184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1185"><a href="#cb4-1185" aria-hidden="true" tabindex="-1"></a>**Advantages:**</span>
<span id="cb4-1186"><a href="#cb4-1186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1187"><a href="#cb4-1187" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Distribution-Free &amp; Model-Agnostic**: Generates valid prediction intervals regardless of underlying data distribution and works with any model, providing a unified framework.</span>
<span id="cb4-1188"><a href="#cb4-1188" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Theoretical Guarantees**: Given a significance level, conformal prediction provides valid coverage even with misspecified models.</span>
<span id="cb4-1189"><a href="#cb4-1189" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Efficiency**: Conformal prediction is relatively computationally efficient compared to other methods, and nonconformity measures based on residuals are straightforward to compute during the training process.</span>
<span id="cb4-1190"><a href="#cb4-1190" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Generalizable**: Other approaches that might be used for uncertainty prediction, like quantile regression or Bayesian methods, can be 'conformalized' to produce appropriate coverage.</span>
<span id="cb4-1191"><a href="#cb4-1191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1192"><a href="#cb4-1192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1193"><a href="#cb4-1193" aria-hidden="true" tabindex="-1"></a>**Disadvantages:**</span>
<span id="cb4-1194"><a href="#cb4-1194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1195"><a href="#cb4-1195" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Implementation Challenges**: The intervals can be unstable with small data changes, and are sometimes overly conservative when the nonconformity measure isn't chosen properly.</span>
<span id="cb4-1196"><a href="#cb4-1196" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Data Splitting Requirement**: A portion of the data needs to be held out to estimate the nonconformity scores, which can reduce the data available for model training.</span>
<span id="cb4-1197"><a href="#cb4-1197" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Theoretical Limitations**: While theoretically sound, various practical implementations (like split-conformal) introduce trade-offs between computational efficiency and theoretical guarantees.</span>
<span id="cb4-1198"><a href="#cb4-1198" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Exchangeability Assumption**: Still requires data exchangeability assumption, which must be accounted for in time series or other structured data.</span>
<span id="cb4-1199"><a href="#cb4-1199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1200"><a href="#cb4-1200" aria-hidden="true" tabindex="-1"></a>:::{.callout-note title="Model Complexity Changes the Game"}</span>
<span id="cb4-1201"><a href="#cb4-1201" aria-hidden="true" tabindex="-1"></a>The comparison highlights an important pattern in uncertainty estimation:</span>
<span id="cb4-1202"><a href="#cb4-1202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1203"><a href="#cb4-1203" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Simple models**: All methods tend to perform similarly when the underlying model is well-behaved (like linear regression).</span>
<span id="cb4-1204"><a href="#cb4-1204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1205"><a href="#cb4-1205" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Complex models**: Method differences become pronounced - distributional assumptions break down, computational demands diverge, and coverage guarantees can fail.</span>
<span id="cb4-1206"><a href="#cb4-1206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1207"><a href="#cb4-1207" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Fundamental tradeoff**: As models become more complex to capture nuanced patterns, the uncertainty estimation task becomes correspondingly more challenging.</span>
<span id="cb4-1208"><a href="#cb4-1208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1209"><a href="#cb4-1209" aria-hidden="true" tabindex="-1"></a>This explains why conformal prediction has gained popularity - it maintains validity across the model complexity spectrum without sacrificing computational efficiency.</span>
<span id="cb4-1210"><a href="#cb4-1210" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb4-1211"><a href="#cb4-1211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1212"><a href="#cb4-1212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1213"><a href="#cb4-1213" aria-hidden="true" tabindex="-1"></a><span class="fu">## Conclusion</span></span>
<span id="cb4-1214"><a href="#cb4-1214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1215"><a href="#cb4-1215" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; There's a lot of uncertainty in uncertainty estimation. </span></span>
<span id="cb4-1216"><a href="#cb4-1216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1217"><a href="#cb4-1217" aria-hidden="true" tabindex="-1"></a>As we've seen, there are many approaches to estimating uncertainty, and each has its own strengths and weaknesses. Among the considerations for selection are computational feasibility, coverage accuracy, and underlying model assumptions. In this article we discussed statistical prediction intervals, bootstrapping, Bayesian estimation, and conformal prediction, as well as their relative advantages and disadvantages. Conformal prediction is a relatively newer approach that has some advantages over other approaches, including its flexibility, distribution-free nature, and theoretical guarantee of coverage probability, even under difficult and complex modeling circumstances. We hope this article has been helpful in understanding the importance of uncertainty estimation and the different approaches to it, and that it has provided a useful demonstration of how to use conformal prediction to estimate uncertainty.</span>
<span id="cb4-1218"><a href="#cb4-1218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1219"><a href="#cb4-1219" aria-hidden="true" tabindex="-1"></a>As we've seen, there are many approaches to estimating uncertainty, and each has its own strengths and weaknesses. Among the considerations for selection are coverage accuracy, model/technical assumptions, and computational feasibility. These considerations matter because proper uncertainty estimation directly impacts decision quality -- as our opening example illustrated, different uncertainty ranges can lead to entirely different actions.</span>
<span id="cb4-1220"><a href="#cb4-1220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1221"><a href="#cb4-1221" aria-hidden="true" tabindex="-1"></a>For practitioners looking to implement these methods:</span>
<span id="cb4-1222"><a href="#cb4-1222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1223"><a href="#cb4-1223" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**For simple models with well-understood distributions**: Traditional statistical intervals typically offer computational efficiency and simplicity.</span>
<span id="cb4-1224"><a href="#cb4-1224" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**When prior knowledge is important**: Bayesian approaches provide a natural framework for incorporating this information, while also providing intervals for more complex statistical models.</span>
<span id="cb4-1225"><a href="#cb4-1225" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**When working with moderate-sized datasets and statistical software or other model limitations**: Bootstrapping provides flexibility across different model types, particularly for models where analytical intervals aren't implemented or appropriate.</span>
<span id="cb4-1226"><a href="#cb4-1226" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**For complex models or when distribution assumptions are questionable**: Conformal prediction offers reliable coverage with minimal assumptions, while also providing better computational efficiency than bootstrapping approaches.</span>
<span id="cb4-1227"><a href="#cb4-1227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1228"><a href="#cb4-1228" aria-hidden="true" tabindex="-1"></a>Looking forward, the field of uncertainty estimation continues to evolve. Recent advances include adaptations of conformal prediction for time series data, more efficient implementations that reduce data splitting requirements, and hybrid approaches that combine the strengths of multiple methods. I'd probably recommend first implementing the simplest approach appropriate for your model setting. You could then compare it with conformal prediction to evaluate potential improvements in reliability and coverage.</span>
<span id="cb4-1229"><a href="#cb4-1229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1230"><a href="#cb4-1230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1231"><a href="#cb4-1231" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Details</span></span>
<span id="cb4-1232"><a href="#cb4-1232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1233"><a href="#cb4-1233" aria-hidden="true" tabindex="-1"></a>The following shows some basic information based on a sample of the data used in this post.</span>
<span id="cb4-1234"><a href="#cb4-1234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1237"><a href="#cb4-1237" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb4-1238"><a href="#cb4-1238" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb4-1239"><a href="#cb4-1239" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: 'data-info'</span></span>
<span id="cb4-1240"><a href="#cb4-1240" aria-hidden="true" tabindex="-1"></a><span class="co">#| tbl-cap: 'Summary of the California Housing Prices dataset'</span></span>
<span id="cb4-1241"><a href="#cb4-1241" aria-hidden="true" tabindex="-1"></a><span class="co"># df_ca |&gt; skimr::skim()</span></span>
<span id="cb4-1242"><a href="#cb4-1242" aria-hidden="true" tabindex="-1"></a><span class="co"># this doesn't render right even in html, where it's missing icons, or possibly at all in other formats just do once and save as an image.</span></span>
<span id="cb4-1243"><a href="#cb4-1243" aria-hidden="true" tabindex="-1"></a>df_ca <span class="sc">|&gt;</span> </span>
<span id="cb4-1244"><a href="#cb4-1244" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_sample</span>(<span class="at">n=</span><span class="dv">1000</span>) <span class="sc">|&gt;</span> </span>
<span id="cb4-1245"><a href="#cb4-1245" aria-hidden="true" tabindex="-1"></a>    gtExtras<span class="sc">::</span><span class="fu">gt_plt_summary</span>(<span class="at">title =</span> <span class="st">''</span>) <span class="co"># Do all ONLY FOR FINAL DRAFT</span></span>
<span id="cb4-1246"><a href="#cb4-1246" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb4-1247"><a href="#cb4-1247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1248"><a href="#cb4-1248" aria-hidden="true" tabindex="-1"></a><span class="al">![](../../img/conformal/data_table.png)</span>{width=75%}</span>
<span id="cb4-1249"><a href="#cb4-1249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1250"><a href="#cb4-1250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1251"><a href="#cb4-1251" aria-hidden="true" tabindex="-1"></a><span class="fu">## References</span></span>
<span id="cb4-1252"><a href="#cb4-1252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1253"><a href="#cb4-1253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1254"><a href="#cb4-1254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-1255"><a href="#cb4-1255" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<div class="share-buttons"><div class="social-share"><a href="https://twitter.com/share?url=https://m-clark.github.io/&amp;text=Michael Clark" target="_blank" class="twitter"><i class="fab fa-twitter fa-fw fa-lg"></i></a><a href="https://www.linkedin.com/shareArticle?url=https://m-clark.github.io/&amp;title=Michael Clark" target="_blank" class="linkedin"><i class="fa-brands fa-linkedin-in fa-fw fa-lg"></i></a>  <a href="mailto:?subject=Michael Clark&amp;body=Check out this link:https://m-clark.github.io/" target="_blank" class="email"><i class="fa-solid fa-envelope fa-fw fa-lg"></i></a><a href="https://www.facebook.com/sharer.php?u=https://m-clark.github.io/" target="_blank" class="facebook"><i class="fab fa-facebook-f fa-fw fa-lg"></i></a><a href="https://reddit.com/submit?url=https://m-clark.github.io/&amp;title=Michael Clark" target="_blank" class="reddit">   <i class="fa-brands fa-reddit-alien fa-fw fa-lg"></i></a><a href="https://bsky.app/intent/compose?text=https://m-clark.github.io/ Michael Clark" target="_blank" class="bsky"><i class="fa-brands fa-bluesky"></i></a></div></div>




</body></html>