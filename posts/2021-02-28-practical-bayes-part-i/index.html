<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.30">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Michael Clark">
<meta name="dcterms.date" content="2021-02-28">
<meta name="description" content="Dealing with common model problems.">

<title>Practical Bayes Part I – Michael Clark</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-3a01e2046221230fdceeea94b1ec5d67.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-e2184218c7da002d19aaa9aaf3bba53d.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.14.0/css/all.css">
</head>

<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../img/mc_logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Michael Clark</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/michael-clark-b475b5170/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/m-clark"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/m-clark.bsky.social"> 
<span class="menu-text">BlueSky</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://x.com/statsdatasci"> <i class="bi bi-twitter-x" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../documents.html"> 
<span class="menu-text">Content</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../code.html"> 
<span class="menu-text">Code</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Practical Bayes Part I</h1>
                  <div>
        <div class="description">
          <p>Dealing with common model problems.</p>
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">bayesian</div>
              </div>
                  </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author"><a href="https://m-clark.github.io">Michael Clark</a> </p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              <a href="https://strong.io">
              Strong Analytics
              </a>
            </p>
        </div>
    </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 28, 2021</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#the-stated-problem" id="toc-the-stated-problem" class="nav-link" data-scroll-target="#the-stated-problem">The Stated Problem</a></li>
  <li><a href="#audience" id="toc-audience" class="nav-link" data-scroll-target="#audience">Audience</a></li>
  <li><a href="#outline" id="toc-outline" class="nav-link" data-scroll-target="#outline">Outline</a></li>
  <li><a href="#installation-issues" id="toc-installation-issues" class="nav-link" data-scroll-target="#installation-issues">Installation issues</a>
  <ul class="collapse">
  <li><a href="#mac" id="toc-mac" class="nav-link" data-scroll-target="#mac">Mac</a></li>
  <li><a href="#windows" id="toc-windows" class="nav-link" data-scroll-target="#windows">Windows</a></li>
  <li><a href="#linux" id="toc-linux" class="nav-link" data-scroll-target="#linux">Linux</a></li>
  <li><a href="#other-programming-languages-besides-r" id="toc-other-programming-languages-besides-r" class="nav-link" data-scroll-target="#other-programming-languages-besides-r">Other programming languages besides R</a></li>
  </ul></li>
  <li><a href="#example-data" id="toc-example-data" class="nav-link" data-scroll-target="#example-data">Example data</a></li>
  <li><a href="#essential-steps-for-practical-modeling" id="toc-essential-steps-for-practical-modeling" class="nav-link" data-scroll-target="#essential-steps-for-practical-modeling">Essential Steps for Practical Modeling</a></li>
  <li><a href="#warnings-what-they-mean-and-what-to-do-about-them" id="toc-warnings-what-they-mean-and-what-to-do-about-them" class="nav-link" data-scroll-target="#warnings-what-they-mean-and-what-to-do-about-them">Warnings, What They Mean, and What to do About Them</a>
  <ul class="collapse">
  <li><a href="#rhat-effective-sample-size" id="toc-rhat-effective-sample-size" class="nav-link" data-scroll-target="#rhat-effective-sample-size">Rhat &amp; Effective Sample Size</a></li>
  <li><a href="#some-details" id="toc-some-details" class="nav-link" data-scroll-target="#some-details">Some details</a>
  <ul class="collapse">
  <li><a href="#rhat" id="toc-rhat" class="nav-link" data-scroll-target="#rhat">Rhat</a></li>
  <li><a href="#ess" id="toc-ess" class="nav-link" data-scroll-target="#ess">ESS</a></li>
  <li><a href="#trace-plot" id="toc-trace-plot" class="nav-link" data-scroll-target="#trace-plot">Trace plot</a></li>
  <li><a href="#density-plot" id="toc-density-plot" class="nav-link" data-scroll-target="#density-plot">Density plot</a></li>
  <li><a href="#rank-plot" id="toc-rank-plot" class="nav-link" data-scroll-target="#rank-plot">Rank plot</a></li>
  <li><a href="#acf-plot" id="toc-acf-plot" class="nav-link" data-scroll-target="#acf-plot">ACF plot</a></li>
  <li><a href="#efficiency-plots" id="toc-efficiency-plots" class="nav-link" data-scroll-target="#efficiency-plots">Efficiency plots</a></li>
  <li><a href="#solution-for-rhatess-warnings" id="toc-solution-for-rhatess-warnings" class="nav-link" data-scroll-target="#solution-for-rhatess-warnings">Solution for Rhat/ESS warnings</a></li>
  </ul></li>
  <li><a href="#bfmi-low" id="toc-bfmi-low" class="nav-link" data-scroll-target="#bfmi-low">BFMI low</a></li>
  <li><a href="#tree-depth" id="toc-tree-depth" class="nav-link" data-scroll-target="#tree-depth">Tree Depth</a></li>
  <li><a href="#divergent-transitions" id="toc-divergent-transitions" class="nav-link" data-scroll-target="#divergent-transitions">Divergent Transitions</a></li>
  <li><a href="#other-messages" id="toc-other-messages" class="nav-link" data-scroll-target="#other-messages">Other messages</a>
  <ul class="collapse">
  <li><a href="#parser-warnings" id="toc-parser-warnings" class="nav-link" data-scroll-target="#parser-warnings">Parser warnings</a></li>
  <li><a href="#compilation-warnings" id="toc-compilation-warnings" class="nav-link" data-scroll-target="#compilation-warnings">Compilation warnings</a></li>
  <li><a href="#package-warnings" id="toc-package-warnings" class="nav-link" data-scroll-target="#package-warnings">Package warnings</a></li>
  <li><a href="#solutions-for-other-messages" id="toc-solutions-for-other-messages" class="nav-link" data-scroll-target="#solutions-for-other-messages">Solutions for other messages</a></li>
  </ul></li>
  <li><a href="#model-comparison-problems" id="toc-model-comparison-problems" class="nav-link" data-scroll-target="#model-comparison-problems">Model Comparison Problems</a></li>
  </ul></li>
  <li><a href="#other-issues" id="toc-other-issues" class="nav-link" data-scroll-target="#other-issues">Other Issues</a>
  <ul class="collapse">
  <li><a href="#but-its-slow" id="toc-but-its-slow" class="nav-link" data-scroll-target="#but-its-slow">But it’s slow!</a>
  <ul class="collapse">
  <li><a href="#solutions-for-a-slow-model" id="toc-solutions-for-a-slow-model" class="nav-link" data-scroll-target="#solutions-for-a-slow-model">Solutions for a slow model</a></li>
  </ul></li>
  <li><a href="#shinystan" id="toc-shinystan" class="nav-link" data-scroll-target="#shinystan">shinystan</a></li>
  </ul></li>
  <li><a href="#summary-the-practical-approach-to-dealing-with-model-problems" id="toc-summary-the-practical-approach-to-dealing-with-model-problems" class="nav-link" data-scroll-target="#summary-the-practical-approach-to-dealing-with-model-problems">Summary: The Practical Approach to Dealing with Model Problems</a></li>
  <li><a href="#resources" id="toc-resources" class="nav-link" data-scroll-target="#resources">Resources</a>
  <ul class="collapse">
  <li><a href="#general" id="toc-general" class="nav-link" data-scroll-target="#general">General</a></li>
  <li><a href="#priors" id="toc-priors" class="nav-link" data-scroll-target="#priors">Priors</a></li>
  <li><a href="#rhatess" id="toc-rhatess" class="nav-link" data-scroll-target="#rhatess">Rhat/ESS</a></li>
  <li><a href="#divergence" id="toc-divergence" class="nav-link" data-scroll-target="#divergence">Divergence</a></li>
  <li><a href="#other-warnings" id="toc-other-warnings" class="nav-link" data-scroll-target="#other-warnings">Other warnings</a></li>
  <li><a href="#visual-diagnostics" id="toc-visual-diagnostics" class="nav-link" data-scroll-target="#visual-diagnostics">Visual diagnostics</a></li>
  <li><a href="#misc" id="toc-misc" class="nav-link" data-scroll-target="#misc">Misc</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<blockquote class="blockquote">
<p>NB: This post was revisited when updating the website early 2025, and some changes were required. Attempts to keep things consistent were made, but if you feel you’ve found an issue, please post it at <a href="http://github.com/m-clark/m-clark.github.io/issues">GitHub</a>.</p>
</blockquote>
<section id="overview" class="level1">
<h1>Overview</h1>
<p><img src="../../img/r_and_stan.png" style="display:block; margin: 0 auto; width: 50%"></p>
<p><br></p>
<p>Bayesian analysis takes some getting used to, but offers great advantages once you get into it. While it can be difficult to get started, it typically should not take much to repeat an analysis one is already familiar with, say a standard regression with some (common) additional complexity like a binary outcome, interactions, random effects, etc. What’s great is that <span style="color: #b2001d;"><strong>Stan</strong></span>, a programming language for Bayesian analysis, has come a very long way, and provides a means for (relatively) fast computation. What’s more, applied analysts do not need to know the Stan programming language to do common and even notably complicated models. Packages like <span class="pack" style="">rstanarm</span> and <span class="pack" style="">brms</span>, coupled with additional tools like <span class="pack" style="">bayesplot</span>, <span class="pack" style="">tidybayes</span>, and more, make getting and exploring results even easier than the R packages one already uses.</p>
<p>One of the advantages of doing Bayesian analysis with these tools is that there are many ways to diagnose model issues, problems, and failures. This is great! Traditional analysis can often be notably more difficult in this regard, or at least typically has fewer ready tools to work with, and often there can be serious model deficiencies without much notification or, if there is, there might be little one can do about it. On the other hand, current Bayesian packages are providing diagnostic information as a default part of results, have ready visualizations to explore issues, and more.</p>
<div class="colum-margin">
<p>This is part one of two posts on doing practical modeling with R and Stan in an applied fashion. Due to unforeseen circumstances (and plenty of procrastination), the bulk of the content of these posts was created many months before actual posting. It’s hoped that most of this will still be applicable and have the conceptual continuity as originally intended, but apologies in advance if some parts seem a little disjointed, off topic, etc.</p>
</div>
</section>
<section id="the-stated-problem" class="level1">
<h1>The Stated Problem</h1>
<div style="text-align: center">
<p><i class="far fa-question-circle fa-5x" style="padding: 20px; color: #ff5500BF"></i></p>
</div>
<p>This is all great in general. However, in consulting I saw a consistent issue among clients starting out with Bayesian analysis and Stan packages. Someone has a standard model, e.g.&nbsp;a basic regression or mixed model, but is getting problematic warnings, messages, or errors. When they look up how to solve this problem, the documentation, forums, and other outlets, while great resources for the initiated, often overwhelm newer and/or more applied users, as they are too technical, assume a great deal of background knowledge, are even under-explained (especially in the case of interpreting visualizations), and even suggest things that aren’t typically possible (e.g.&nbsp;getting better data/model). What seems a straightforward suggestion to a more advanced user or developer, may not be even close to that for many applied analysts, and they can be left a bit deflated by their experience.</p>
<p>In the beginning of Stan’s ascension, the majority of people using Stan/<span class="pack" style="">rstan</span> were more technically inclined, coded in Stan directly, and, when problems arose, they were willing to do a lot of extra work to solve the problems (reading technical articles, developing pseudo-expertise with various techniques, and more). But tools like <span class="pack" style="">rstanarm</span> and <span class="pack" style="">brms</span> make running Bayesian models as <a href="https://m-clark.github.io/easy-bayes/">easy to do</a> as using base R functions and other non-Bayesian packages, and as Bayesian analysis has become more widely used, accepted, and presented, this has opened the Bayesian approach to practically anyone that wants to do it.</p>
<p>I personally don’t think one needs to be an expert in Bayesian analysis to enjoy its benefits for common models, even if difficulties come up. Nor do I think an exhaustive search through forums, technical articles, function documentation, and more is necessary to deal issues that arise often. So this is an attempt at a practical guide and one-stop shop for dealing with the most common issues that arise, interpreting results of diagnostics, and summarizing the options one can take. <span style="color: #ff5500"><strong>The goal here is to provide some practical, not perfect(!), suggestions on how to go about your applied Bayesian modeling.</strong></span></p>
</section>
<section id="audience" class="level1">
<h1>Audience</h1>
<div style="text-align: center;">
<p><i class="fas fa-users fa-5x" style="color: #ff5500BF"></i><i class="fas fa-users fa-5x" style="color: #ff5500"></i><i class="fas fa-users fa-5x" style="color: #ff5500BF"></i></p>
</div>
<p><br></p>
<p>Here is the presumed audience for this post:</p>
<ul>
<li>Wants to conduct Bayesian analysis</li>
<li>Is not going to code anything in Stan directly (i.e.&nbsp;will use a specific package like <span class="pack" style="">rstanarm</span> or <span class="pack" style="">brms</span>)</li>
<li>Is not a statistician, nor desires deep technical insights about Bayesian analysis (at least not yet!)</li>
<li>Is already having to learn a new tool/functions/possibly a whole system of inference</li>
<li>Has probably never used the <code>control</code> argument for any model</li>
</ul>
<p>While you can do a Bayesian analysis just for the heck of it, you really need to understand a few key ideas to take advantage of what it offers. Some things you do need to know in order to use it on a basic level:</p>
<ul>
<li>The distributions: priors, likelihood, posterior, posterior predictive</li>
<li>Iterative sampling to estimate parameters. Even a cursory understanding of maximum likelihood would probably be enough.</li>
</ul>
<p>You can obtain this basic info from my document <a href="m-clark.github.io/bayesian-basics/">Bayesian Basics</a>.</p>
</section>
<section id="outline" class="level1">
<h1>Outline</h1>
<p>Here is what we’re going to do:</p>
<ul>
<li>Discuss some of the more common problems</li>
<li>Explain conceptually what they indicate</li>
<li>Provide quick solutions that should work most of the time</li>
<li>Outline a practical approach for future endeavors (<a href="https://m-clark.github.io/posts/2021-02-28-practical-bayes-part-ii/">Part II</a>)</li>
</ul>
<p>Each section discusses a particular problem and ends with a general recommendation, and potentially, specific links to look further into the issue.</p>
</section>
<section id="installation-issues" class="level1">
<h1>Installation issues</h1>
<p>Your first hurdle is installation, so let’s start there. Applied users will use <span class="pack" style="">rstanarm</span>, <span class="pack" style="">brms</span>, or other higher level interfaces to the Stan programming language. These tools use Stan, but Stan itself requires compilation to C++. This means that to run a basic regression with <span class="pack" style="">brms</span>, you’ll likely be depending on multiple languages and packages for it to work. When using these packages, here is a high-level view of how things work:</p>
<p><span class="math inline">\(\rightarrow\quad\)</span> Package interprets your R code (<span class="pack" style="">brms</span>, <span class="pack" style="">rstanarm</span>)</p>
<p><span class="math inline">\(\quad\rightarrow\quad\)</span> Model is translated to Stan (or use <span class="pack" style="">rstan</span> with Stan code)</p>
<p><span class="math inline">\(\quad\quad\rightarrow\quad\)</span> Compiled to C++ (requires compiler)</p>
<p>In general, installing the package you want to use will install the appropriate dependencies, and that should be enough as far as your interactive R part goes. In some cases it may not be. If you have issues, it’s maybe best to install <span class="pack" style="">rstan</span> first, then your package of choice. Issues beyond that may indicate an issue with the compiler, at which point you’ll want to consult the forums.</p>
<section id="mac" class="level3">
<h3 class="anchored" data-anchor-id="mac">Mac</h3>
<p>To be nice about it, Mac’s Catalina OS was a problematic release to say the least. For our purposes, this meant that there was a period of time where Stan wasn’t viable for many users without extensive workarounds, and issues seemingly arose with every update. This was not specific to Stan, or R, by the way<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>. Then R 4.0 came along and helped some things, but also resulted in new issues. That said, the Stan community were excellent at helping people here, and many of the issues were ultimately resolved by the end of 2020.</p>
<p>Now that Big Sur has been out for a while I get the sense that things have been better there, or at least there aren’t four separate dedicated threads trying to deal with the various problems arising. My own recent luck has been without installation issues on Macs with either OS.</p>
<p><a href="https://discourse.mc-stan.org/search?q=Big%20Sur">Search Mac Issues on Stan Forums</a></p>
</section>
<section id="windows" class="level3">
<h3 class="anchored" data-anchor-id="windows">Windows</h3>
<p>I rarely had installation issues on Windows’ releases, though haven’t had to use it lately. It does require <a href="https://cran.r-project.org/bin/windows/Rtools/">rtools</a> to be installed, which is good to install for R with Windows anyway. If you are starting out, I would install it, then <span class="pack" style="">rstan</span>, then your package of choice (e.g.&nbsp;<span class="pack" style="">brms</span>). Again though, if you have issues, the Stan community will be very helpful.</p>
<p><a href="https://discourse.mc-stan.org/search?q=windows">Search Windows Issues on Stan Forums</a></p>
</section>
<section id="linux" class="level3">
<h3 class="anchored" data-anchor-id="linux">Linux</h3>
<p>I’ve only used Stan with Linux in a cluster computing environment. I generally have not had issues, but it’s not something I’ve done recently, and I don’t have any basic Linux desktop experience. Applied users also need cluster computing on occasion, it’s just that the problems will likely require IT support in that case. Again though, plenty of Stan folks are willing to help.</p>
<p><a href="https://discourse.mc-stan.org/search?q=Linux">Search Linux Issues on Stan Forums</a></p>
</section>
<section id="other-programming-languages-besides-r" class="level3">
<h3 class="anchored" data-anchor-id="other-programming-languages-besides-r">Other programming languages besides R</h3>
<p>If you’re using Stan with Python, Stata, Julia, etc., then you’re using the Stan language directly, and you’re likely already very familiar with the forums and dealing with a variety of issues. That’s not to say that you won’t find something useful here, it’s just that I have nothing to offer you regarding those platforms specifically.</p>
</section>
</section>
<section id="example-data" class="level1">
<h1>Example data</h1>
<div style="text-align: center">
<p><i class="fas fa-database fa-5x" style="padding: 20px; color: #ff5500BF"></i></p>
</div>
<p><br></p>
<p>To start out, I’m going to create some data for us to run some basic models with. To make things interesting, the true underlying model has categorical and continuous covariates, interactions, nonlinear relationships, random effects (observations are clustered in groups), and some variables are collinear. You can skip these details if uninterested, but note that we will be purposely using under- and over-fitted models relative to this one to see what happens.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>create_data <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">N =</span> <span class="dv">1000</span>, <span class="at">ng =</span> <span class="dv">100</span>, <span class="at">seed =</span> <span class="dv">1234</span>) {</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(seed)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># the model matrix</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  X_mm <span class="ot">=</span> <span class="fu">cbind</span>(</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># a standard binary</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">binary_1 =</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, N, <span class="at">replace =</span> <span class="cn">TRUE</span>),                      </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># a relatively rare categorical</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">binary_2 =</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, N, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(.<span class="dv">05</span>, .<span class="dv">95</span>)),  </span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># two partly collinear numeric</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    mvtnorm<span class="sc">::</span><span class="fu">rmvnorm</span>(N,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>                     <span class="at">mean =</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">3</span>),</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>                     <span class="at">sigma =</span> lazerhawk<span class="sc">::</span><span class="fu">create_corr</span>(<span class="fu">runif</span>(<span class="dv">3</span>, <span class="at">max =</span> .<span class="dv">6</span>)))</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  X_mm <span class="ot">=</span> <span class="fu">cbind</span>(</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># intercept</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>,</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    X_mm,</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># a cubic effect</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale</span>(<span class="fu">poly</span>(X_mm[,<span class="dv">5</span>], <span class="dv">3</span>))[,<span class="dv">2</span><span class="sc">:</span><span class="dv">3</span>],</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># interaction of binary variables</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    X_mm[,<span class="dv">1</span>]<span class="sc">*</span>X_mm[,<span class="dv">2</span>], </span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># interaction of binary 2 with numeric 1</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    X_mm[,<span class="dv">2</span>]<span class="sc">*</span>X_mm[,<span class="dv">3</span>]</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add names</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(X_mm) <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Intercept'</span>,</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">'b1'</span>,</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">'b2'</span>,</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">'x1'</span>,</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">'x2'</span>,</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">'x3'</span>,</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">'x3_sq'</span>,</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">'x3_cub'</span>,</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">'b1_b2'</span>,</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">'b2_x1'</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>  <span class="co"># coefficients</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>  beta <span class="ot">=</span> <span class="fu">c</span>(</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>    <span class="fl">3.0</span>,   <span class="co"># intercept</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>     .<span class="dv">3</span>,   <span class="co"># b1</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>.<span class="dv">3</span>,   <span class="co"># b2</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>     .<span class="dv">5</span>,   <span class="co"># x1</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>     .<span class="dv">0</span>,   <span class="co"># x2</span></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>     .<span class="dv">3</span> ,  <span class="co"># x3 </span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>     .<span class="dv">3</span>,   <span class="co"># x3_sq</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>.<span class="dv">2</span>,   <span class="co"># x3_cub</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>     .<span class="dv">5</span>,   <span class="co"># b1_b2 </span></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>    <span class="sc">-</span>.<span class="dv">5</span>    <span class="co"># b2_x1</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create target variable/linear predictor</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">=</span> X_mm <span class="sc">%*%</span> beta</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add random effect</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>  groups <span class="ot">=</span> <span class="fu">sort</span>(<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>ng, N, <span class="at">replace =</span> T))</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>  <span class="co"># random effect sd = .5</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>  re <span class="ot">=</span> <span class="fu">rnorm</span>(ng, <span class="at">sd =</span> .<span class="dv">5</span>)[groups]  </span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>  <span class="co"># add re and residual noise with sd = 1</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">=</span> y <span class="sc">+</span> re <span class="sc">+</span> <span class="fu">rnorm</span>(N)</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">=</span> <span class="fu">cbind</span>(y, groups)</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(y) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">'y'</span>, <span class="st">'group'</span>)</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>(<span class="fu">cbind</span>(X_mm, y))</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you want to check that the parameters are recovered, you can run something like the following.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">=</span> <span class="fu">create_data</span>(<span class="at">N =</span> <span class="dv">10000</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>mod <span class="ot">=</span> lme4<span class="sc">::</span><span class="fu">lmer</span>(y <span class="sc">~</span> . <span class="sc">-</span>group <span class="sc">+</span> (<span class="dv">1</span><span class="sc">|</span>group), <span class="fu">data.frame</span>(dat[,<span class="sc">-</span><span class="dv">1</span>]))</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>mixedup<span class="sc">::</span><span class="fu">summarise_model</span>(mod, <span class="at">ci =</span> <span class="cn">FALSE</span>)  <span class="co"># or just summary(mod)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We do not need much data for our purposes so we’ll set the total sample size to 1000. We’ll drop unnecessary columns (e.g.&nbsp;we’d normally specify interactions via the formula rather than create the columns explicitly), and also make our binary covariates explicit factors, which will make things easier when we want to visualize grouped effects later.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create the primary data frame</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>main_df <span class="ot">=</span> </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">create_data</span>(<span class="at">N =</span> <span class="dv">1000</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(group, b1<span class="sc">:</span>x3, y) <span class="sc">%&gt;%</span> </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">b1 =</span> <span class="fu">factor</span>(b1),   <span class="co"># will help with visuals</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">b2 =</span> <span class="fu">factor</span>(b2)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>main_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,000 × 7
   group b1    b2         x1      x2     x3     y
   &lt;dbl&gt; &lt;fct&gt; &lt;fct&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
 1     1 1     1      0.155   0.145  -1.84   4.01
 2     1 1     1     -0.356   1.33   -0.604  3.84
 3     1 1     1     -0.329   0.488  -0.441  3.37
 4     1 1     1      1.08   -1.50    1.00   3.80
 5     1 0     1     -0.563  -1.07   -0.150  1.81
 6     1 1     1     -0.0694 -0.229  -0.387  4.54
 7     1 0     1      0.374   0.606   2.04   4.17
 8     1 0     1      2.06   -0.266   0.168  1.83
 9     2 0     0      0.278   0.0559  1.04   1.58
10     2 1     0      0.184   0.230   0.174  3.56
# ℹ 990 more rows</code></pre>
</div>
</div>
</section>
<section id="essential-steps-for-practical-modeling" class="level1">
<h1>Essential Steps for Practical Modeling</h1>
<div style="text-align: center">
<p><i class="fa fa-shoe-prints fa-5x" style="padding: 20px; color: #ff5500BF"></i></p>
</div>
<p><br></p>
<p>Once data is in hand there are basic steps to take for a practical modeling approach with Stan tools.</p>
<section id="use-standarddefault-priors-for-the-model" class="level5">
<h5 class="anchored" data-anchor-id="use-standarddefault-priors-for-the-model">Use standard/default priors for the model</h5>
<ul>
<li>For common regression models, normal or student t for the (fixed effect) coefficients. You will have to explicitly set this if using <span class="pack" style="">brms</span>, but <span class="pack" style="">rstanarm</span> will have viable defaults already.</li>
<li>Use (half) normal/student-t for variances (esp.&nbsp;hierarchical models). Defaults are usually fine.</li>
<li>Otherwise, look at the <a href="https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations">recommendations</a>.</li>
<li>See <a href="https://m-clark.github.io/posts/2021-02-28-practical-bayes-part-ii/">Part II</a> for more on choosing priors.</li>
</ul>
</section>
<section id="build-models-in-increasing-complexity" class="level5">
<h5 class="anchored" data-anchor-id="build-models-in-increasing-complexity">Build models in increasing complexity</h5>
<ul>
<li>It’s a good idea not to start with the ‘final’ model, especially in complex settings. If the fitting has issues with simpler models, things will only get worse with more complex models.</li>
<li>Getting model settings squared away earlier will save time later (e.g.&nbsp;setting number of iterations, other options).</li>
</ul>
</section>
<section id="examine-convergence-via-rhat-ess-visualization" class="level5">
<h5 class="anchored" data-anchor-id="examine-convergence-via-rhat-ess-visualization">Examine convergence via Rhat, ESS, visualization</h5>
<ul>
<li>If you run the model and get no warnings or messages, you are okay to proceed to summarize and visualize it in my opinion. Any remaining issues, e.g.&nbsp;poor prediction, are likely to not have obvious solutions, other than things like getting better data, adding additional covariates, revising theory, etc.</li>
<li>Diagnostic plots are the main tool to explore issues that come from warnings.</li>
</ul>
</section>
<section id="examine-model-effectiveness-visually" class="level5">
<h5 class="anchored" data-anchor-id="examine-model-effectiveness-visually">Examine model effectiveness visually</h5>
<ul>
<li><p>There are entire packages at your disposal for visualizing model results such as <span class="pack" style="">bayesplot</span>, <span class="pack" style="">tidybayes</span>, etc. However, standard plots can be called from <span class="pack" style="">rstanarm</span> or <span class="pack" style="">brms</span> functions, which are wrappers for <span class="pack" style="">bayesplot</span> functions.</p></li>
<li><p><a href="https://mc-stan.org/bayesplot/reference/PPC-overview.html">Posterior predictive checks</a> are a fundamental part of Bayesian analysis.</p></li>
<li><p>Avoid using approaches that are merely substitutes for the null hypothesis test you would have done in the non-Bayesian setting (e.g.&nbsp;using <a href="https://statmodeling.stat.columbia.edu/2019/09/10/i-hate-bayes-factors-when-theyre-used-for-null-hypothesis-significance-testing/">bayes factors</a>).</p></li>
</ul>
</section>
<section id="compare-models-using-loo-posterior-probabilities-of-models" class="level5">
<h5 class="anchored" data-anchor-id="compare-models-using-loo-posterior-probabilities-of-models">Compare models using loo, posterior probabilities of models</h5>
<ul>
<li><p>Compare models via predictive capabilities (<em>l</em>eave-<em>o</em>ne-<em>o</em>ut approaches, see <a href="https://m-clark.github.io/posts/2021-02-28-practical-bayes-part-ii/">Part II</a>).</p></li>
<li><p>There is no ‘best’ model in Bayesian approach or otherwise. Consider model averaging for final predictions.</p></li>
<li><p>It is not necessary to automatically prefer simpler models, though it may make things easier to do so in some contexts.</p></li>
</ul>
<p>Assuming you have no problems in the above process, you have more or less fulfilled the basic requirements to do standard analyses in Bayesian form. Great!</p>
</section>
</section>
<section id="warnings-what-they-mean-and-what-to-do-about-them" class="level1 page-columns page-full">
<h1>Warnings, What They Mean, and What to do About Them</h1>
<div style="text-align: center">
<p><i class="fas fa-exclamation-triangle fa-5x" style="padding: 20px; color: #ff5500BF"></i></p>
</div>
<p>Of course, if it was always that easy, we wouldn’t be posting this. There are a few warnings that you’re bound to come across at some point in modeling with the Stan ecosystem. We’ll cover these, as well as the most common solutions.</p>
<p>Primary reference: <a href="https://mc-stan.org/misc/warnings.html">Brief Guide to Stan’s Warnings</a></p>
<section id="rhat-effective-sample-size" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="rhat-effective-sample-size">Rhat &amp; Effective Sample Size</h2>
<p>We will start with a simple standard regression model that we know is not adequate. We will use default priors<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> and run very few iterations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># no priors, no complexity, all default settings, few iterations</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>model_start_100 <span class="ot">=</span> <span class="fu">brm</span>(</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> b1 <span class="sc">+</span> b2 <span class="sc">+</span> x1 <span class="sc">+</span> x2 <span class="sc">+</span> x3, </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> main_df,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">100</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> F,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">123</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The largest R-hat is 1.1, indicating chains have not mixed.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#r-hat</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#bulk-ess</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#tail-ess</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_start_100)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: y ~ b1 + b2 + x1 + x2 + x3 
   Data: main_df (Number of observations: 1000) 
  Draws: 4 chains, each with iter = 100; warmup = 50; thin = 1;
         total post-warmup draws = 200

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept     2.72      0.15     2.44     3.00 1.10       36      144
b11           0.83      0.06     0.71     0.94 1.01      140      115
b21          -0.12      0.15    -0.41     0.15 1.10       35       82
x1            0.03      0.03    -0.04     0.09 1.00      310      239
x2           -0.04      0.03    -0.10     0.02 1.00      355      237
x3            0.28      0.03     0.22     0.35 1.04      349      132

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     1.10      0.02     1.06     1.15 1.00      220      145

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>As is common in other R models, for factors, the effect is the stated category vs.&nbsp;the reference. Since we only have binary variables, b11 is show the level 1 vs.&nbsp;level 0 (reference) for the first binary covariate.</p>
</div></div><p>The warnings about Rhat and effective sample size (ESS) are likely to pop up if you use default iterations for more complex models. They mostly regard the efficiency of the sampling process, and whether you have enough samples to have stable parameter estimates. Ideally Rhat is close to 1.0, and ESS is at least a notable percentage of the total posterior samples (e.g.&nbsp;50%).</p>
<p>The fix for these warnings is usually simple, just let the model run for more iterations beyond your warmup. The default is 2000 iterations, with warmup half of that. Warmup iterations are not used in calculation of parameter estimates, so you can just increase the number of iterations relative to it, or increase both by only increasing the <code>iter</code> argument.</p>
<p>In the following, we plot the estimated values across each iteration for each chain, called a <em>trace plot</em>, as well as the <em>density plot</em> of the values from the entire chain. From this we could see that things might be problematic (e.g.&nbsp;we’d want more symmetric density plots for the regression coefficients), but only if you are used to looking at these things, so it will take some practice.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_plot</span>(model_start_100, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">'b1'</span>, <span class="st">'b2'</span>, <span class="st">'x1'</span>), <span class="at">type =</span> <span class="st">'combo'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/model-start-trace-dens-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>To get some intuition for what you would expect, just plot a series from a normal distribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">qplot</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">1000</span>, <span class="at">y =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>), <span class="at">geom =</span> <span class="st">'line'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/rnorm-trace-dens-1.png" class="img-fluid figure-img" style="width:50.0%"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>ggplot2<span class="sc">::</span><span class="fu">qplot</span>(<span class="at">x =</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>), <span class="at">geom =</span> <span class="st">'density'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/rnorm-trace-dens-2.png" class="img-fluid figure-img" style="width:50.0%"></p>
</figure>
</div>
</div>
</div>
<p>Other plots allow us to look at the same sorts of things from a different perspective, or break out results by each chain.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_plot</span>(model_start_100, <span class="at">type =</span> <span class="st">'areas'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/area-violin-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_plot</span>(model_start_100, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">'b1'</span>, <span class="st">'b2'</span>, <span class="st">'x1'</span>), <span class="at">type =</span> <span class="st">'violin'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/area-violin-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>While things seem okay, if we single out a particular chain, we might think otherwise. In this case, the <code>Intercept</code> and <code>b2</code> coefficients may be problematic, given they do not seem to vary as much as the others (chain 2 for example, but also for other chains).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_plot</span>(model_start_100, <span class="at">highlight =</span> <span class="dv">2</span>, <span class="at">type =</span> <span class="st">'trace_highlight'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/trace-highlight-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Some suggest to look at <em>rank plots</em> instead of traditional trace plots. Really, all we’ve changed is looking for something ‘fuzzy’, to looking for something ‘approximately uniform’, so my opinion is that it’s not much of an improvement visually or intuitively. In general, histograms, which are variants of bar charts, are rarely an improvement for any visualization. If you do use it, you can use an overlay approach to see if the ranks are mixing, but this looks a lot like what I’d be looking for from a trace plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_plot</span>(model_start_100, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">'b1'</span>, <span class="st">'b2'</span>, <span class="st">'x1'</span>), <span class="at">type =</span> <span class="st">'rank_hist'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/rank-plots-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_plot</span>(model_start_100, <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">'b1'</span>, <span class="st">'b2'</span>, <span class="st">'x1'</span>), <span class="at">type =</span> <span class="st">'rank_overlay'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/rank-plots-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="some-details" class="level2">
<h2 class="anchored" data-anchor-id="some-details">Some details</h2>
<p>A little more detail will possibly provide additional understanding, and also some guidance, when looking at your own results.</p>
<section id="rhat" class="level3">
<h3 class="anchored" data-anchor-id="rhat">Rhat</h3>
<p>The <span class="math inline">\(\hat{R}\)</span> (or Rhat) statistic measures the ratio of the average variance of samples within each chain to the variance of the pooled samples across chains. If all chains are at equilibrium, these will be the same and <span class="math inline">\(\hat{R}\)</span> will be 1.0. If the chains have not converged to a common distribution, the <span class="math inline">\(\hat{R}\)</span> statistic will be greater than one.</p>
<p><strong>What we want</strong>: values near 1.0 (&lt; 1 okay) and less than 1.05</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_plot</span>(model_start_100, <span class="at">type =</span> <span class="st">'rhat'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/rhat-plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="ess" class="level3">
<h3 class="anchored" data-anchor-id="ess">ESS</h3>
<p>Effective sample size is an estimate of the effective number of independent draws from the posterior distribution of the parameter of interest. Because the draws within a chain are not independent if there is autocorrelation, the effective sample size will typically be smaller than the total number of iterations, but the calculation of this statistic is bit more art than science, and can even be greater than the number of posterior draws. Note also that the plot is based on slightly different values than reported by the <span class="pack" style="">brms</span> summary function.</p>
<ul>
<li><em>Bulk ESS</em>: ESS for the mean/median (<code>n_eff</code> in <span class="pack" style="">rstanarm</span>). Tells us whether the parameter estimates are stable.</li>
<li><em>Tail ESS</em>: ESS for the 5% and 95% quantiles. Tells us whether the interval estimates for the parameters are stable. Tail-ESS can help diagnose problems due to different scales of the chains and slow mixing in the tails.</li>
</ul>
<p><strong>What we want</strong>: ESS &gt; 10% percent of total posterior samples for sure, but &gt; 50% is best. At least 100 is desired for decent estimates of autocorrelation. For Bulk-ESS we want &gt; 100 times the number of chains.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_plot</span>(model_start_100, <span class="at">type =</span> <span class="st">'neff'</span>)  <span class="co"># &lt; .1 problem</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/neff-plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="trace-plot" class="level3">
<h3 class="anchored" data-anchor-id="trace-plot">Trace plot</h3>
<p>Shows the estimated parameter values at each iteration. In general you would like a random bouncing around an average value.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_plot</span>(model_start_100, <span class="at">type =</span> <span class="st">'trace'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/trace-plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>What we want</strong>: Something like random normal draws over a series. Trace plots in general should look ‘grassy’, or like a ‘fuzzy caterpillar’, which might not be very descriptive, but deviations are usually striking and obvious in my experience. If you see chains that look like they are getting stuck around certain estimates, or separating from one another, this would indicate a serious problem. If the chains are not converging with one another, you were probably already getting warnings and messages.</p>
</section>
<section id="density-plot" class="level3">
<h3 class="anchored" data-anchor-id="density-plot">Density plot</h3>
<p>Shows the density of the posterior draws for the parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_plot</span>(model_start_100, <span class="at">type =</span> <span class="st">'dens'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/dens-plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>What we want</strong>: For the density plots of regression coefficients, these should be roughly normal looking. For variance parameters you may see skewness, especially if the estimate is relatively near zero with smaller data sets. In general, we would not want to see long tails or bimodality for the typical parameters of interest with models you’d be doing with <span class="pack" style="">rstanarm</span> and <span class="pack" style="">brms</span>.</p>
</section>
<section id="rank-plot" class="level3">
<h3 class="anchored" data-anchor-id="rank-plot">Rank plot</h3>
<p>From <span class="pack" style="">bayesplot</span> help file:</p>
<blockquote class="blockquote">
<p>Whereas traditional trace plots visualize how the chains mix over the course of sampling, rank histograms visualize how the values from the chains mix together in terms of ranking. An ideal plot would show the rankings mixing or overlapping in a uniform distribution.</p>
</blockquote>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_plot</span>(model_start_100, <span class="at">type =</span> <span class="st">'rank_hist'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/rank-plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>What we want</strong>: Uniform distribution, a good mixing of lines for the overlay version.</p>
</section>
<section id="acf-plot" class="level3">
<h3 class="anchored" data-anchor-id="acf-plot">ACF plot</h3>
<p>The <em>acf</em>, or <em>autocorrelation</em> function plot, is exactly the same thing you’d visualize for any time series. It is a plot of a series of correlations of a parameter with specific lags of itself. <em>Autocorrelation does not bias estimates</em>, but increased autocorrelation may suggest a more inefficient/slower exploration of the parameter space. At lag zero, the series estimates are perfectly correlated with themselves, so that’s where the plot usually starts.</p>
<p><strong>What we want</strong>: Quick drop off, but not really that important. By the time you find it’s an issue, your model has already run.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_plot</span>(model_start_100, <span class="at">type =</span> <span class="st">'acf'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/acf-plot-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="efficiency-plots" class="level3">
<h3 class="anchored" data-anchor-id="efficiency-plots">Efficiency plots</h3>
<p>I have seen these often recommended, but I’m not aware of a package does them, though it seems they may make their way to <span class="pack" style="">shinystan</span> at some point. Aki Vehtari has supplied a walk-through and some code (see the <a href="Resources">resources section</a> below), but there isn’t really documentation for the functions, and they likely won’t work outside of <span class="pack" style="">rstan</span> objects, or at least I had limited success with applying them to <span class="pack" style="">brms</span> objects. Furthermore, these are getting into waters that are beyond what I’d expect applied users to be wading through.</p>
</section>
<section id="solution-for-rhatess-warnings" class="level3">
<h3 class="anchored" data-anchor-id="solution-for-rhatess-warnings">Solution for Rhat/ESS warnings</h3>
<p>To summarize, the general solution to Rhat and ESS warnings is simply to do more iterations (relative to the warmup). To keep posterior samples and model objects from becoming unwieldy in size<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>, consider thinning also. Thinning saves only a select amount of the available posterior samples. For example, setting <code>thin = 10</code> means only every tenth sample will be saved. This will also reduce autocorrelation, as the draws retained after thinning are not as correlated with one another as successive draws would be. However, if you thin too much, you may not have enough for effective sample size.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># default with 4 chains, 1000 warmup 2000 total = 4*(2000 - 1000) = 4000 post-warmup draws</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="fu">brm</span>(model)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 4*(4000 - 2000) = 8000 posterior draws</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="fu">brm</span>(model, <span class="at">warmup =</span> <span class="dv">2000</span>, <span class="at">iter =</span> <span class="dv">4000</span>)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 4*(4000 - 2000)/8 = 1000 posterior draws</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="fu">brm</span>(model, <span class="at">warmup =</span> <span class="dv">2000</span>, <span class="at">iter =</span> <span class="dv">4000</span>, <span class="at">thin =</span> <span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="bfmi-low" class="level2">
<h2 class="anchored" data-anchor-id="bfmi-low">BFMI low</h2>
<p>You may see a warning that says some number of chains had an ‘estimated Bayesian Fraction of Missing Information (BFMI) that was too low’. This implies that the adaptation phase of the Markov Chains did not turn out well, and those chains likely did not explore the posterior distribution efficiently. For more details on this diagnostic, you can see <a href="https://arxiv.org/abs/1604.00695">Betancourt’s article</a>, but this will almost surely be too technical for many applied and even more advanced users.</p>
<p>In this case, the problem here is often remedied by just adding more iterations. I typically keep to 1000 posterior samples, which makes for nicer visualizations of distributions without creating relatively large model objects. However, you may need more to get a satisfactory result.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>model_start <span class="ot">=</span> <span class="fu">update</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  model_start_100,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">2000</span>,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter =</span> <span class="dv">2250</span>,      <span class="co"># 1000 posterior draws</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores =</span> <span class="dv">4</span>,</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">123</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In this case, we no longer have any warnings, and even one of our more problematic coefficients looks fine now.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(model_start)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> Family: gaussian 
  Links: mu = identity; sigma = identity 
Formula: y ~ b1 + b2 + x1 + x2 + x3 
   Data: main_df (Number of observations: 1000) 
  Draws: 4 chains, each with iter = 2250; warmup = 2000; thin = 1;
         total post-warmup draws = 1000

Regression Coefficients:
          Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
Intercept     2.72      0.20     2.32     3.10 1.00     1583      938
b11           0.83      0.07     0.69     0.97 1.00     1711      895
b21          -0.12      0.20    -0.50     0.29 1.01     1509      864
x1            0.03      0.03    -0.04     0.10 1.00     1504      947
x2           -0.03      0.04    -0.11     0.05 1.00     1279      803
x3            0.28      0.04     0.21     0.35 1.00     1136      810

Further Distributional Parameters:
      Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
sigma     1.11      0.02     1.06     1.15 1.00     1357      735

Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
and Tail_ESS are effective sample size measures, and Rhat is the potential
scale reduction factor on split chains (at convergence, Rhat = 1).</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(model_start, <span class="at">par =</span> <span class="st">'b2'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/model-start-checks-show-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="solution-for-low-bfmi" class="level4">
<h4 class="anchored" data-anchor-id="solution-for-low-bfmi">Solution for low BFMI</h4>
<p>If there aren’t other serious problems, add more iterations to deal with low BFMI. In some cases, switching from a heavy-tailed prior (e.g.&nbsp;student t) to something else (e.g.&nbsp;normal) would be helpful, but some other approaches typically would involve having to write Stan code directly to <a href="https://mc-stan.org/docs/2_18/stan-users-guide/reparameterization-section.html">reparameterize the model</a>. Otherwise, you may need to approach it similarly to the problem of <a href="#divergent-transitions">divergent transitions</a>.</p>
</section>
</section>
<section id="tree-depth" class="level2">
<h2 class="anchored" data-anchor-id="tree-depth">Tree Depth</h2>
<p>Tree depth is a more technical warning that has to do with the details of Hamiltonian Monte Carlo. Practically speaking:</p>
<blockquote class="blockquote">
<p>Lack of convergence and hitting the maximum number of leapfrog steps (equivalently maximum tree depth) are indicative of improper posteriors ~ Stan User Guide</p>
</blockquote>
<p>Sometimes you’ll get a warning about hitting maximum tree depth, and without getting overly technical, the fix is easy enough. Just set the maximum higher.</p>
<section id="solution-for-max-tree-depth" class="level4">
<h4 class="anchored" data-anchor-id="solution-for-max-tree-depth">Solution for max tree depth</h4>
<p>Use the <code>control</code> argument to increase the value beyond the default of 10.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>model_update_treedepth <span class="ot">=</span> <span class="fu">update</span>(</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  model,</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">max_tree_depth =</span> <span class="dv">15</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="divergent-transitions" class="level2">
<h2 class="anchored" data-anchor-id="divergent-transitions">Divergent Transitions</h2>
<p><em>Divergent transitions</em> are a technical issue that indicates something may be notably wrong with the data or model (<a href="https://mc-stan.org/docs/2_24/reference-manual/divergent-transitions.html">technical details</a>). They indicate that the sampling process has ‘gone off the rails’, and that the divergent iteration’s results, and anything based on them (i.e.&nbsp;subsequent draws, parameter estimates), can’t be trusted. Unlike the other problems we’ve discussed, this is more difficult to navigate.</p>
<p>Why might this happen?</p>
<ul>
<li>insufficient data for the model’s complexity</li>
<li>poor model</li>
<li>high collinearity</li>
<li>improper or otherwise problematic priors</li>
<li>separability (logistic regression)</li>
<li>any number of other things</li>
</ul>
<p>As an example, I’ll make an overly complex model with only a small random sample of the data, improper priors, and use very few warmups/iterations.</p>
<div class="cell" data-cache.extra="12">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>model_problem <span class="ot">=</span> <span class="fu">brm</span>(</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bf</span>(</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    y <span class="sc">~</span> b1<span class="sc">*</span>b2<span class="sc">*</span>x1 <span class="sc">+</span> x2<span class="sc">*</span>b2 <span class="sc">+</span> x3<span class="sc">*</span>b2 <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> x1 <span class="sc">+</span> b2<span class="sc">|</span>group),</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    sigma <span class="sc">~</span> x1 <span class="sc">+</span> b1<span class="sc">*</span>b2</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">data   =</span> main_df <span class="sc">%&gt;%</span> <span class="fu">slice_sample</span>(<span class="at">prop =</span> .<span class="dv">1</span>),</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> student,</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">cores  =</span> <span class="dv">4</span>,</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">warmup =</span> <span class="dv">5</span>,</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">iter   =</span> <span class="dv">1005</span>,</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">thin   =</span> <span class="dv">4</span>,</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed   =</span> <span class="dv">123</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: There were 206 divergent transitions after warmup. See
https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
to find out why this is a problem and how to eliminate them.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Examine the pairs() plot to diagnose sampling problems</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The largest R-hat is 2.21, indicating chains have not mixed.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#r-hat</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#bulk-ess</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.
Running the chains for more iterations may help. See
https://mc-stan.org/misc/warnings.html#tail-ess</code></pre>
</div>
</div>
<p><br></p>
<p>So what do we do in this case? Well let’s start with visual inspection.</p>
<section id="visualization-pairs-plot" class="level4">
<h4 class="anchored" data-anchor-id="visualization-pairs-plot">Visualization: Pairs plot</h4>
<p>A diagnostic tool that is typically suggested to look at with divergent transitions is the <span class="emph" style="">pairs plot</span>. It is just a scatterplot matrix of the parameters estimates (and log posterior value), but it suffers from a few issues. The plot is slow to render even with few parameters, and simply too unwieldy to use for many typical modeling situations. If you somehow knew in advance which parameters were causing issues, you could narrow it down by only looking at those parameters. But if you knew which parameters were the problem, you wouldn’t need the pairs plot.</p>
<p>Another issue is that it isn’t what you think it is at first glance. The upper diagonal is not just the flipped coordinates of the lower diagonal like every other scatterplot matrix you’ve seen. The chains are split such that half are used for the above diagonal plots, and the other for the lower, with the split being based on the amount of numerical error (above or below the median). I suspect this may not help applied users interpret things, but the gist is, that if your red points show up only on the upper diagonal, changing the <code>adapt_delta</code> part of the control argument may help (<a href="#solution-for-divergent-transitions">see below</a>), otherwise it likely won’t<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>.</p>
<p>Let’s take a look at the pairs plot anyway. I’ll use <code>hex</code> bins instead of standard points because the point plots have no transparency by default. In addition, we’ll use a density plot on the diagonal, instead of the histogram.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_plot</span>(</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  model_problem,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">c</span>(<span class="st">'b_b11'</span>, <span class="st">'b_b21'</span>, <span class="st">'b_x1'</span>),</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">'pairs'</span>,</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">diag_fun =</span> <span class="st">'dens'</span>,</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">off_diag_fun =</span> <span class="st">'hex'</span>,</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">fixed =</span> <span class="cn">TRUE</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/pairs-plot-model-start-complex-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>With problematic cases, what you might see on the off-diagonal plots is some sort of ‘funneling’, which would indicate where the sampler is getting stuck in the parameter space. However, this visual notion isn’t defined well, as it may be happening without being obvious, displaying just a bump, or just some weird patterns as above. But you’ll also regularly see correlated parameters, but it’s unclear whether these might necessarily be a problem in a given situation.</p>
<p>For the initial model we ran, the pairs plot for all parameters takes several seconds to produce, and even with the hex option, it is still difficult to parse without closer inspection. It shows the intercept and <code>b2</code> parameters to be notably correlated, possibly indirectly due to the poor priors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_plot</span>(</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  model_start_100,</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">'pairs'</span>,</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">off_diag_fun =</span> <span class="st">'hex'</span>,</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">diag_fun =</span> <span class="st">'dens'</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/pairs-plot-model-start-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>What we want</strong>: Roughly little correlation among parameters, mostly symmetric densities for typical regression parameters.</p>
</section>
<section id="visualization-parallel-coordinates-plot" class="level4">
<h4 class="anchored" data-anchor-id="visualization-parallel-coordinates-plot">Visualization: Parallel Coordinates Plot</h4>
<p>It is also suggested to look at parallel coordinates plots, but unfortunately there are issues with these plots as well. The order of the variable/parameter axis is arbitrary, and yet the order can definitely influence your perception of any patterns. Also, unless everything is on similar scales, they simply aren’t going to be very useful, but even if you scale your data in some fashion, the estimates given divergent transitions may be notably beyond a reasonable scale.</p>
<p>As in our pairs plot, we’d be looking for a pattern among the divergences, specifically a concentration for a parameter where the lines seemingly converge to a point. If this isn’t the case, the divergences are probably false positives<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>. I had to add some <span class="pack" style="">ggplot</span> options to help this to be more legible, and you will likely have to as well. In the following, you might think the <code>b_sigma_x1</code> coefficient for dispersion is a problem, which might suggest we need to rethink the prior for it. In reality it’s likely just that it’s being estimated to be near zero, as it should be, especially since non-divergent transitions are also bouncing around that value. For the most part we don’t see much pattern here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_parcoord</span>(</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  model_problem,</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">pars =</span> <span class="fu">vars</span>(<span class="fu">matches</span>(<span class="st">'^b'</span>)),</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">size =</span> .<span class="dv">25</span>, </span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">alpha =</span> .<span class="dv">01</span>,</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">np =</span> <span class="fu">nuts_params</span>(model_problem),  <span class="co"># without this div trans won't be highlighted</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">np_style =</span> <span class="fu">parcoord_style_np</span>(</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">div_color =</span> <span class="st">"#ff5500"</span>,</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">div_size =</span> <span class="dv">1</span>,</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">div_alpha =</span> .<span class="dv">1</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">x =</span> <span class="fu">guide_axis</span>(<span class="at">n.dodge =</span> <span class="dv">2</span>)) <span class="sc">+</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">6</span>),</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.major.x =</span> <span class="fu">element_line</span>(<span class="at">color =</span> <span class="st">'#00AAFF80'</span>, <span class="at">size =</span> .<span class="dv">1</span>)</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/par-coord-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p><strong>What we want</strong>: Roughly no obvious pattern. If the divergence lines are not showing any particular concentration, it could be that these are false positives.</p>
</section>
<section id="solution-for-divergent-transitions" class="level4">
<h4 class="anchored" data-anchor-id="solution-for-divergent-transitions">Solution for divergent transitions</h4>
<p>Unfortunately the solution to divergent transitions is usually not straightforward. The typical starting point for solving the problem of divergent transitions is to use the control argument to increase <code>adapt_delta</code>, for example, from .80 to .99<a href="#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>, and let your model have more warmup/total iterations, which is the primary issue here. In the cases I see for myself and clients, increasing <code>adapt_delta</code> rarely helps, but it doesn’t hurt to try. I often will just start with it increased for more complex models, just to save messing with it later.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>model <span class="ot">=</span> <span class="fu">brm</span>(..., <span class="at">control =</span> <span class="fu">list</span>(<span class="at">adapt_delta =</span> .<span class="dv">99</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Aside from that you will have to look more deeply, including issues with priors, model specification, and more. I find this problem often comes from poor data (e.g.&nbsp;not scaled, possible separation in logistic models, etc.), combined with a complex model (e.g.&nbsp;complicated random effects structure), and beyond that, the priors may need to be amended. You should at least not have uniform priors for any parameter, and as we’ll see in <a href="https://m-clark.github.io/posts/2021-02-28-practical-bayes-part-ii/">Part II</a>, you can use a simulation approach to help choose better priors. Often these data and prior checks are a better approach to solving the problem than doing something after the fact. You may also need to simplify the model to better deal with your data nuances. As an example, for mixed models, it may be that some variance components are not necessary.</p>
<p>Some solutions offered on the forums assume you are coding in Stan directly, such as reparameterizing your model, using specific types of priors, etc. If you are writing Stan code rather than using a modeling package, you definitely need to double check it, as typos or other mistakes can certainly result in a problematic model. However, this post is for those using modeling packages, so I will not offer such remedies, and they are usually not obvious anyway.</p>
</section>
</section>
<section id="other-messages" class="level2">
<h2 class="anchored" data-anchor-id="other-messages">Other messages</h2>
<p>Certain builds of <span class="pack" style="">rstan</span> for some types of settings (e.g.&nbsp;specific operating systems) will often have warnings or other messages. Sometimes it looks like a bunch of gobbledygook, which is typically something happening at the C++ level. If your model runs and produces output despite these messages, you can typically ignore them in most cases. Even then, you should look it up on the forums just to be sure.</p>
<section id="parser-warnings" class="level3">
<h3 class="anchored" data-anchor-id="parser-warnings">Parser warnings</h3>
<p>Parser warnings are either a deprecation warning, or another more serious kind (Jacobian). The latter will not happen if you’re using higher level interfaces (e.g.&nbsp;<span class="pack" style="">brms</span>), rather than programming in Stan directly. The other kind, deprecation warnings, are not something you can do anything about, but the developer of the package will likely need to make minor changes to the code to avoid them in the future. I’ve never seen parser warnings from using <span class="pack" style="">rstanarm</span> or <span class="pack" style="">brms</span>.</p>
</section>
<section id="compilation-warnings" class="level3">
<h3 class="anchored" data-anchor-id="compilation-warnings">Compilation warnings</h3>
<p>Compiler warnings happen regularly and indicate something going on at the compiler level, typically that something in Stan is being compiled but not used. You can ignore these.</p>
</section>
<section id="package-warnings" class="level3">
<h3 class="anchored" data-anchor-id="package-warnings">Package warnings</h3>
<p>Like any good package, when things go unexpectedly, or just to be informative, modeling packages like <span class="pack" style="">rstanarm</span> and <span class="pack" style="">brms</span> will provide you messages or warnings. These do not have to do with the Stan part of things. For example, <span class="pack" style="">brms</span> will warn you that it will drop cases with missing values.</p>
<blockquote class="blockquote">
<p><code>Rows containing NAs were excluded from the model.</code></p>
</blockquote>
<p>Some issues can be more subtle. For example, you may get a message that the model is compiling but then nothing happens. This might be because of a typo in a distribution name for your priors, or some similar goof<a href="#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>.</p>
</section>
<section id="solutions-for-other-messages" class="level3">
<h3 class="anchored" data-anchor-id="solutions-for-other-messages">Solutions for other messages</h3>
<p>If you are using a package to interface with Stan and not having an issue with the model (i.e.&nbsp;it runs, converges), these messages can largely be ignored, unless it is a warning from the package itself, which typically should be investigated.</p>
</section>
</section>
<section id="model-comparison-problems" class="level2">
<h2 class="anchored" data-anchor-id="model-comparison-problems">Model Comparison Problems</h2>
<p>For a discussion of loo and related issues, see <a href="https://m-clark.github.io/posts/2021-02-28-practical-bayes-part-ii/">Part II</a>.</p>
</section>
</section>
<section id="other-issues" class="level1">
<h1>Other Issues</h1>
<section id="but-its-slow" class="level2">
<h2 class="anchored" data-anchor-id="but-its-slow">But it’s slow!</h2>
<p>Another problem people seem to be concerned with is the speed of the analysis. If you have a lot of data, or more to the point, a lot of parameters, your model can be very slow. For standard models with <span class="pack" style="">rstanarm</span> and <span class="pack" style="">brms</span>, there may be no real benefit doing it Bayesian style if you have millions of data points and simpler models. If your model is only taking a couple minutes, then you really have nothing to complain about- watch some YouTube or something while it runs. If your model takes on the order of hours, work with less data or simpler models until you have your modeling code, plots, etc. squared away. At that point you can run your primary analysis and wait it out. A slow model may also be indicative of a poorly specified/understood model, so you may have to think hard about how you are approaching the problem.</p>
<section id="solutions-for-a-slow-model" class="level3">
<h3 class="anchored" data-anchor-id="solutions-for-a-slow-model">Solutions for a slow model</h3>
<ul>
<li>For any model, Bayesian or otherwise, doing things like standardizing, logging or other variable transformations will put parameters in more reasonable domains, resulting in a more manageable estimation process. For example, if you standardize predictors, then the coefficients are on similar scales and a <code>Normal(0, 1)</code> prior can typically be applied.</li>
<li>Using more informative priors can avoid exploring areas of the posterior that aren’t going to lead to plausible results. We will show how to do this in <a href="https://m-clark.github.io/posts/2021-02-28-practical-bayes-part-ii/">Part II</a>.</li>
<li>Use less iterations if there are no other issues.</li>
<li>If possible, work with less data or simpler models until ready for the full model.</li>
<li>If possible, work with a different version of the model that can still answer the question of interest. For example, if an ordinal model is causing a lot of issues, and you’re not interested in category specific probabilities, just treat the target variable as numeric<a href="#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>.</li>
<li>Stop fishing/p-hacking/torturing your data so that you don’t have to run dozens of models. You’re likely not to care if the models takes hours if you only run them once or twice.</li>
</ul>
<!-- so that distill can know this isn't part of the previous list -->
<p><br></p>
</section>
</section>
<section id="shinystan" class="level2">
<h2 class="anchored" data-anchor-id="shinystan">shinystan</h2>
<p>The <span class="pack" style="">shinystan</span> package makes exploring model diagnostics actually fun! Using <span class="func" style="">launch_shinystan</span> on a model opens a browser window, providing interactive visualizations to help you see what’s going on with it. You can look at many of the previous plots, plus a few others we haven’t shown.</p>
<p>Unfortunately the documentation in the browser doesn’t really tell you what to look for in these plots. The glossary contains information that is likely overly technical for applied users, and if there is a problem, there’s not really a whole lot to go on. In addition, some plots are difficult to use (e.g.&nbsp;trying to assess whether overlapping histograms are similar), or are probably only useful if you have very obvious problem (e.g.&nbsp;lots of divergent transitions). As an example, consider the tree depth plots. What would be good here?</p>
<p><img src="../../img/howtobayes/max_treedepth.png" style="display:block; margin: 0 auto; width: 100%"></p>
<p>The documentation tells you the value should be somewhere between 0 and whatever <code>max_treedepth</code> is set at. If they are ‘large’, the documentation states the problem could be due to different things, but the solutions are to either reparameterize of the model (probably not possible unless using Stan code directly), or just increase the value. It doesn’t seem to tell you what those plots are supposed to look like, and unfortunately that severely limits their utility. The divergence and energy plots are similarly under-explained. Many refer users to Betancourt’s wonderful articles on the details, but these are far too technical for those not already steeped in the approach<a href="#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a>.</p>
<p>All that said, luckily there is a nice <a href="https://mc-stan.org/bayesplot/articles/visual-mcmc-diagnostics.html">walkthrough</a> if you do have a hankering to go down that path, and provides more details on the statistics and what you should be looking for in the visualizations.</p>
</section>
</section>
<section id="summary-the-practical-approach-to-dealing-with-model-problems" class="level1">
<h1>Summary: The Practical Approach to Dealing with Model Problems</h1>
<p>For applied analysts, you can do a couple things when faced with warnings or just otherwise assessing the model integrity. I would suggest first focusing on the density and trace plots for parameters. You can then examine other visualizations that might be appropriate to the problem, and take the appropriate steps outlined above to try and solve those issues. Pay extra attention to parameters with relatively low effective sample sizes, as these are the ones the model is struggling to estimate.</p>
<p>Many of the problems can be solved by increasing the warmup and total number of iterations. After that, setting control parameters may be enough. For more serious issues, you may need to try different priors or even a different model. If none of the above solves your problems, you may be trying too complex of a model for your data, have a data-specific problem, or some other issue.</p>
<p>In general, doing Bayesian analysis can be easy, and hopefully it will be for you. Many common problems have simple solutions, and the more serious ones will only make you a better Bayesian though the efforts you take to solve them. Rather than see them as a nuisance, see them as a learning opportunity, and you’ll enjoy your results even more when you finally resolve them. Remember that you may not be in your comfort zone, and that’s okay! Things will come around eventually, and you’ll solve these problems more easily in the future!</p>
<p>On to <a href="https://m-clark.github.io/posts/2021-02-28-practical-bayes-part-ii/">PART II: Do Bayes Better</a>.</p>
</section>
<section id="resources" class="level1">
<h1>Resources</h1>
<section id="general" class="level2">
<h2 class="anchored" data-anchor-id="general">General</h2>
<ul>
<li><p><a href="https://avehtari.github.io/">Aki Vehtari’s website</a> has demos and explanation for things like model comparison, Rhat/Neff, and more.</p></li>
<li><p><a href="https://mc-stan.org/bayesplot/articles/visual-mcmc-diagnostics.html">bayesplot Vignette for Diagnostic Plots</a></p></li>
<li><p><a href="https://jrnold.github.io/bayesian_notes/">Jeffrey Arnold’s Bayesian Notes</a> has nice examples of many models and good summaries otherwise.</p></li>
</ul>
<p><a href="m-clark.github.io/bayesian-basics/">Bayesian Basics</a>, an applied overview of Bayesian analysis with Stan as the backdrop.</p>
</section>
<section id="priors" class="level2">
<h2 class="anchored" data-anchor-id="priors">Priors</h2>
<p><a href="https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations">Prior Choice Recommendations</a> by the Stan group.</p>
<ul>
<li><a href="https://cran.r-project.org/web/packages/rstanarm/vignettes/priors.html">rstanarm vignette</a></li>
</ul>
</section>
<section id="rhatess" class="level2">
<h2 class="anchored" data-anchor-id="rhatess">Rhat/ESS</h2>
<ul>
<li><p><a href="https://mc-stan.org/docs/2_24/reference-manual/effective-sample-size-section.html">Stan Reference on Effective Sample Size</a></p></li>
<li><p><a href="https://projecteuclid.org/euclid.ba/1593828229">Vehtari et al.&nbsp;on Rank plots</a> for details.</p></li>
<li><p><a href="https://avehtari.github.io/rhat_ess/rhat_ess.html">Vehtari’s appendix for the above</a> (probably more accessible)</p></li>
<li><p><a href="https://github.com/avehtari/rhat_ess/blob/master/code/monitorplot.R">Vehtari’s code for efficiency plots</a>, <a href="https://github.com/avehtari/rhat_ess/blob/master/code/monitornew.R">Code for functions</a></p></li>
</ul>
</section>
<section id="divergence" class="level2">
<h2 class="anchored" data-anchor-id="divergence">Divergence</h2>
<ul>
<li><p><a href="https://mc-stan.org/docs/2_24/reference-manual/divergent-transitions.html">Stan Reference on Divergent Transitions</a></p></li>
<li><p><a href="https://discourse.mc-stan.org/t/divergent-transitions-a-primer/17099">Divergent Transitions A Primer</a></p></li>
<li><p><a href="https://mc-stan.org/users/documentation/case-studies/divergences_and_bias.html">Case study: Divergences and Bias</a></p></li>
</ul>
</section>
<section id="other-warnings" class="level2">
<h2 class="anchored" data-anchor-id="other-warnings">Other warnings</h2>
<ul>
<li><a href="https://mc-stan.org/misc/warnings.html#preruntime-warnings">Brief Guide to Stan’s Warnings</a></li>
</ul>
</section>
<section id="visual-diagnostics" class="level2">
<h2 class="anchored" data-anchor-id="visual-diagnostics">Visual diagnostics</h2>
<ul>
<li><a href="https://mc-stan.org/bayesplot/articles/visual-mcmc-diagnostics.html">Visual MCMC diagnostics</a></li>
</ul>
</section>
<section id="misc" class="level2">
<h2 class="anchored" data-anchor-id="misc">Misc</h2>
<ul>
<li><p><a href="https://statmodeling.stat.columbia.edu/2020/10/21/model-takes-many-hours-to-fit-and-chains-dont-converge-what-to-do-my-advice-on-first-steps/">Gelman’s advice for slow models</a></p></li>
<li><p><a href="https://cran.r-project.org/web/packages/brms/">brms vignettes</a></p></li>
<li><p><a href="http://mc-stan.org/cmdstanr/articles/cmdstanr.html">Use CmdStan to save memory</a></p></li>
<li><p><a href="https://mc-stan.org/users/documentation/case-studies">Stan case studies</a></p></li>
</ul>


</section>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>I will spare the details of my opinions, which are almost entirely negative.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>For this model, they are uniform/improper priors for the regression coefficients and half-t for the residual variance. You can always use <span class="func" style="">prior_summary</span> on a <span class="pack" style="">brms</span> model to see this.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>With more posterior samples comes slower visualizations and possibly other computations.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Another issue is that you could change how the chains are split and it could potentially dramatically change the how the pattern of divergent transitions looks.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5"><p>This seems counter to the common suggestion on forums and GitHub issues that even 1 divergent transition renders results suspect. I’ve never seen results meaningfully change for something with just a couple divergent transitions to one that has none, and often when there are that few, even rerunning the model will result in no divergences.<a href="#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6"><p>In my experience, there isn’t a need to guess some value between .80 and .99 as the time differences are typically not great, say between .9, .95, and .99, unless your model already takes a very long time. Also, if it doesn’t work at .99, it won’t at .9999 either.<a href="#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7"><p>I’m definitely not speaking from experience here or anything! Nomral distributions do exist, I’m sure of it! 😬<a href="#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8"><p>It is often suggested in the Stan world to reparameterize models. However, this advice doesn’t really apply in the case of using <span class="pack" style="">rstanarm</span> or <span class="pack" style="">brms</span> (i.e.&nbsp;where you aren’t writing Stan code directly), and it assumes a level of statistical expertise many would not have, or even if they do, the route to respecifying the model may not be obvious.<a href="#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9"><p>Betancourt, whose work I admire greatly, typically makes my head spin.<a href="#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a></div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{clark2021,
  author = {Clark, Michael},
  title = {Practical {Bayes} {Part} {I}},
  date = {2021-02-28},
  url = {https://m-clark.github.io/posts/2021-02-28-practical-bayes-part-i/},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-clark2021" class="csl-entry quarto-appendix-citeas" role="listitem">
Clark, Michael. 2021. <span>“Practical Bayes Part I.”</span> February
28, 2021. <a href="https://m-clark.github.io/posts/2021-02-28-practical-bayes-part-i/">https://m-clark.github.io/posts/2021-02-28-practical-bayes-part-i/</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/m-clark\.github\.io");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>