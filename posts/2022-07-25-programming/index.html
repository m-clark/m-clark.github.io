<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.30">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Michael Clark">
<meta name="dcterms.date" content="2022-07-25">
<meta name="description" content="Explorations in faster data processing and other problems.">

<title>Programming Odds &amp; Ends – Michael Clark</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-3a01e2046221230fdceeea94b1ec5d67.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-443a16db199bae091ac266a2b929a364.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/quarto-contrib/social-share-1.0.0/social-share.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/social-share-1.0.0/all.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-1.2.0/all.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/fontawesome6-1.2.0/latex-fontsize.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../img/mc_logo.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Michael Clark</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/michael-clark-b475b5170/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/m-clark"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/m-clark.bsky.social"> 
<span class="menu-text"><i class="fa-brands fa-bluesky" aria-label="bluesky"></i></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://x.com/statsdatasci"> <i class="bi bi-twitter-x" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../documents.html"> 
<span class="menu-text">Content</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../code.html"> 
<span class="menu-text">Code</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Programming Odds &amp; Ends</h1>
                  <div>
        <div class="description">
          <p>Explorations in faster data processing and other problems.</p>
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">programming</div>
              </div>
                  </div>
  </div>
    
  <div class="quarto-title-meta-author">
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author"><a href="https://m-clark.github.io">Michael Clark</a> </p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              <a href="https://strong.io">
              Strong Analytics
              </a>
            </p>
        </div>
    </div>

  <div class="quarto-title-meta">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 25, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#quick-summary" id="toc-quick-summary" class="nav-link" data-scroll-target="#quick-summary">Quick summary</a></li>
  <li><a href="#setup-and-orientation" id="toc-setup-and-orientation" class="nav-link" data-scroll-target="#setup-and-orientation">Setup and orientation</a></li>
  <li><a href="#fill-in-missing-values" id="toc-fill-in-missing-values" class="nav-link" data-scroll-target="#fill-in-missing-values">Fill in missing values</a></li>
  <li><a href="#antijoins" id="toc-antijoins" class="nav-link" data-scroll-target="#antijoins">Antijoins</a></li>
  <li><a href="#lagleaddifferences" id="toc-lagleaddifferences" class="nav-link" data-scroll-target="#lagleaddifferences">Lag/lead/differences</a></li>
  <li><a href="#firstlast" id="toc-firstlast" class="nav-link" data-scroll-target="#firstlast">First/Last</a></li>
  <li><a href="#coalesceifelse" id="toc-coalesceifelse" class="nav-link" data-scroll-target="#coalesceifelse">Coalesce/ifelse</a></li>
  <li><a href="#conditional-slide" id="toc-conditional-slide" class="nav-link" data-scroll-target="#conditional-slide">Conditional Slide</a></li>
  <li><a href="#take-the-first-true" id="toc-take-the-first-true" class="nav-link" data-scroll-target="#take-the-first-true">Take the first TRUE</a></li>
  <li><a href="#group-by-filteringslicing" id="toc-group-by-filteringslicing" class="nav-link" data-scroll-target="#group-by-filteringslicing">Group by filtering/slicing</a></li>
  <li><a href="#tidy-timings" id="toc-tidy-timings" class="nav-link" data-scroll-target="#tidy-timings">Tidy timings</a>
  <ul class="collapse">
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#standard-grouped-operation" id="toc-standard-grouped-operation" class="nav-link" data-scroll-target="#standard-grouped-operation">Standard grouped operation</a></li>
  <li><a href="#count" id="toc-count" class="nav-link" data-scroll-target="#count">Count</a></li>
  </ul></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary">Summary</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<blockquote class="blockquote">
<p>NB: This post was revisited when updating the website early 2025, and some changes were required. Attempts to keep things consistent were made, but if you feel you’ve found an issue, please post it at <a href="http://github.com/m-clark/m-clark.github.io/issues">GitHub</a>.</p>
</blockquote>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>Oftentimes I’m looking to gain speed/memory advantages, or maybe just exploring how to do the same thing differently in case it becomes useful later on. I thought I’d start posting them, but then I don’t get around to it. Here are a few that have come up over the past year (or two 😞), and even as I wrote this, more examples kept coming up, so I may come back to add more in the future.</p>
</section>
<section id="quick-summary" class="level2">
<h2 class="anchored" data-anchor-id="quick-summary">Quick summary</h2>
<p>Data processing efficiency really depends on context. Faster doesn’t mean memory efficient, and what may be the best in a standard setting can be notably worse in others. Some approaches won’t show their value until the data is very large, or there are many groups to deal with, while others will get notably worse. Also, you may not want an additional package dependency beyond what you’re using, and may need a base R approach. The good news is you’ll always have options!</p>
<p>One caveat: I’m not saying that the following timed approaches are necessarily the best/fastest, I mostly stuck to ones I’d try first. You may find even better for your situation! A great resource to keep in mind is the <a href="https://github.com/fastverse">fastverse</a>, which is a collection of packages with speed and efficiency in mind, and includes a couple that are demonstrated here.</p>
</section>
<section id="setup-and-orientation" class="level2">
<h2 class="anchored" data-anchor-id="setup-and-orientation">Setup and orientation</h2>
<p>Required packages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dtplyr)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyfast)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(collapse)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(vctrs)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bench)   <span class="co"># for timings</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Also, in the following bench marks I turn off checking if the results are equivalent (i.e.&nbsp;<code>check = FALSE</code>) because even if the resulting data is the same, the objects may be different classes, or some objects may even be of the same class, but have different attributes. You are welcome to double check that you would get the same thing as I did. Also, you might want to look at the <code>autoplot</code> of the bench mark summaries, as many results have some variability that isn’t captured by just looking at median/best times.</p>
</section>
<section id="fill-in-missing-values" class="level2">
<h2 class="anchored" data-anchor-id="fill-in-missing-values">Fill in missing values</h2>
<p>We’ll start with the problem of filling in missing values by group. I’ve created a realistic example where the missingness is seen randomly across multiple columns, and differently across groups. I’ve chosen to compare <span class="pack">tidyr</span>, <span class="pack">tidyfast</span>, the underlying approach of <span class="pack">tidyr</span> via <span class="pack">vctrs</span>, and <span class="pack">data.table</span>.</p>
<p>Note that only <span class="pack">data.table</span> is not last observation carried forward by default (‘down’ in <span class="pack">tidyr</span> parlance), so that argument is made explicit. All of these objects will have different attributes or classes. <span class="pack">tidyfast</span> for some reason renames the grouping variable to ‘by’. If you wrap all of these in <code>data.frame</code>, that will remove the attributes and give them all the same class, so you can verify they return the same result.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>N <span class="ot">=</span> <span class="fl">1e5</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>Ng <span class="ot">=</span> <span class="dv">5000</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>create_missing <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  x[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x), <span class="dv">5</span>)] <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  x</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>df_missing <span class="ot">=</span> <span class="fu">tibble</span>(<span class="at">grp =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>Ng, <span class="at">e =</span> N <span class="sc">/</span> Ng)) <span class="sc">%&gt;%</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(grp) <span class="sc">%&gt;%</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(grp) <span class="sc">%&gt;%</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>(),</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">rpois</span>(<span class="fu">n</span>(), <span class="dv">5</span>),</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">z =</span> <span class="fu">rnorm</span>(<span class="fu">n</span>(), <span class="dv">5</span>),</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">across</span>(x<span class="sc">:</span>z, create_missing)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>df_missing <span class="sc">%&gt;%</span> <span class="fu">head</span>(<span class="dv">5</span>)</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>dt_missing <span class="ot">=</span> <span class="fu">as.data.table</span>(df_missing) <span class="sc">%&gt;%</span> <span class="fu">setkey</span>(grp)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>tf_missing <span class="ot">=</span> <span class="fu">copy</span>(dt_missing)</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>bm_fill <span class="ot">&lt;-</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  bench<span class="sc">::</span><span class="fu">mark</span>(</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="sc">%!in%</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">tidyr    =</span> <span class="fu">fill</span>(<span class="fu">group_by</span>(df_missing, grp), x<span class="sc">:</span>z),  </span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">tidyfast =</span> <span class="fu">dt_fill</span>(tf_missing, x, y, z, <span class="at">id =</span> grp),</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">vctrs    =</span> df_missing <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(grp) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="fu">across</span>(x<span class="sc">:</span>z, vec_fill_missing)),</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">dt =</span> dt_missing[</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>      ,</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>      .(<span class="at">x =</span> <span class="fu">nafill</span>(x, <span class="at">type =</span> <span class="st">'locf'</span>),</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="fu">nafill</span>(y, <span class="at">type =</span> <span class="st">'locf'</span>),</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">z =</span> <span class="fu">nafill</span>(z, <span class="at">type =</span> <span class="st">'locf'</span>)),</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> grp</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">check =</span> <span class="cn">FALSE</span>,</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">iterations =</span> <span class="dv">10</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is a great example of where there is a notable speed/memory trade-off. Very surprising how much memory <span class="pack">data.table</span> uses<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>, while not giving much speed advantage relative to the <span class="pack">tidyr</span>. Perhaps there is something I’m missing (😏)? Also note that we can get an even ‘tidier’ advantage by using <span class="pack">vctrs</span> directly, rather than wrapping it via <span class="pack">tidyr</span>, and seeing how easy it is to use, it’s probably the best option.</p>
<div class="cell">
<div class="cell-output-display">
<div id="grgoruydxr" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Libre+Franklin:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
#grgoruydxr table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#grgoruydxr thead, #grgoruydxr tbody, #grgoruydxr tfoot, #grgoruydxr tr, #grgoruydxr td, #grgoruydxr th {
  border-style: none;
}

#grgoruydxr p {
  margin: 0;
  padding: 0;
}

#grgoruydxr .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#grgoruydxr .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#grgoruydxr .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#grgoruydxr .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#grgoruydxr .gt_heading {
  background-color: #FFFFFF;
  text-align: left;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#grgoruydxr .gt_bottom_border {
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#grgoruydxr .gt_col_headings {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#grgoruydxr .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#grgoruydxr .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#grgoruydxr .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#grgoruydxr .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#grgoruydxr .gt_column_spanner {
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#grgoruydxr .gt_spanner_row {
  border-bottom-style: hidden;
}

#grgoruydxr .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#grgoruydxr .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#grgoruydxr .gt_from_md > :first-child {
  margin-top: 0;
}

#grgoruydxr .gt_from_md > :last-child {
  margin-bottom: 0;
}

#grgoruydxr .gt_row {
  padding-top: 7px;
  padding-bottom: 7px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#grgoruydxr .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#grgoruydxr .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#grgoruydxr .gt_row_group_first td {
  border-top-width: 2px;
}

#grgoruydxr .gt_row_group_first th {
  border-top-width: 2px;
}

#grgoruydxr .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#grgoruydxr .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#grgoruydxr .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#grgoruydxr .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#grgoruydxr .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#grgoruydxr .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#grgoruydxr .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#grgoruydxr .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#grgoruydxr .gt_table_body {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #FFFFFF;
}

#grgoruydxr .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#grgoruydxr .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#grgoruydxr .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#grgoruydxr .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#grgoruydxr .gt_left {
  text-align: left;
}

#grgoruydxr .gt_center {
  text-align: center;
}

#grgoruydxr .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#grgoruydxr .gt_font_normal {
  font-weight: normal;
}

#grgoruydxr .gt_font_bold {
  font-weight: bold;
}

#grgoruydxr .gt_font_italic {
  font-style: italic;
}

#grgoruydxr .gt_super {
  font-size: 65%;
}

#grgoruydxr .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#grgoruydxr .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#grgoruydxr .gt_indent_1 {
  text-indent: 5px;
}

#grgoruydxr .gt_indent_2 {
  text-indent: 10px;
}

#grgoruydxr .gt_indent_3 {
  text-indent: 15px;
}

#grgoruydxr .gt_indent_4 {
  text-indent: 20px;
}

#grgoruydxr .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="gt_col_headings header">
<th id="expression" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">expression</th>
<th id="min" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">min</th>
<th id="median" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median</th>
<th id="mem_alloc" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_alloc</th>
<th id="median_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median_relative</th>
<th id="mem_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_relative</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">tidyfast</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">18.3ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">24.5ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">39.87MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">6.06</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">vctrs</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">27ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">28.5ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">6.58MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.16</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">dt</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">111.7ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">117.8ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">237.08MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">4.81</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">36.04</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">tidyr</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">132.3ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">147.2ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">6.59MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">6.01</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="antijoins" class="level2">
<h2 class="anchored" data-anchor-id="antijoins">Antijoins</h2>
<p>Sometimes you just don’t want that! In the following we have a situation where we want to filter values based on the negation of some condition. Think of a case where certain person IDs are not viable for consideration for analysis. Many times, a natural approach would be to use something like a filter where instead of using <code>vals %in% values_desired</code>, we just negate that with a bang (<code>!</code>) operator. However, another approach is to create a data frame of the undesired values and use an <code>anti_join</code>. When using joins in general, you get a relative advantage by explicitly noting the variables you’re joining on, so I compare that as well for demonstration. Finally, in this particular example we could use <span class="pack">data.table’s</span> built-in character match, <code>chin</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>df1 <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="fu">sample</span>(letters, <span class="dv">10000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>df2 <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="fu">sample</span>(letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>], <span class="dv">10000</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>df1_lazy <span class="ot">=</span> <span class="fu">lazy_dt</span>(df1)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>df2_lazy <span class="ot">=</span> <span class="fu">lazy_dt</span>(df2)</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>df1_dt <span class="ot">=</span> <span class="fu">data.table</span>(df1)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>df2_dt <span class="ot">=</span> <span class="fu">data.table</span>(df2)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressMessages</span>({</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  bm_antijoin <span class="ot">=</span> bench<span class="sc">::</span><span class="fu">mark</span>(</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">in_     =</span> <span class="fu">filter</span>(df1, <span class="sc">!</span>id <span class="sc">%in%</span> letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]),</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">in_dtp  =</span> <span class="fu">collect</span>(<span class="fu">filter</span>(df1_lazy, <span class="sc">!</span>id <span class="sc">%in%</span> letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>])),     <span class="co"># not usable until collected/as_tibbled</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">chin    =</span> <span class="fu">filter</span>(df1, <span class="sc">!</span>id <span class="sc">%chin%</span> letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]),                 <span class="co"># chin for char vector only, from data.table</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">chin_dt =</span> df1_dt[<span class="sc">!</span>df1_dt<span class="sc">$</span>id <span class="sc">%chin%</span> letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>],],              </span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">coll    =</span> <span class="fu">fsubset</span>(df1, id <span class="sc">%!in%</span> letters[<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>]),                  <span class="co"># can work with dt or tidyverse</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">aj      =</span> <span class="fu">anti_join</span>(df1, df2, <span class="at">by =</span> <span class="st">'id'</span>),</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">aj_noby =</span> <span class="fu">anti_join</span>(df1, df2),</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">iterations =</span> <span class="dv">100</span>,</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">check      =</span> <span class="cn">FALSE</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In this case, the fully <span class="pack">data.table</span> approach is best in speed and memory, but <span class="pack">collapse</span> is not close behind<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>. In addition, if you are in the tidyverse, the <code>anti_join</code> function is a very good option. Hopefully the lesson about explicitly setting the <code>by</code> argument is made clear.</p>
<div class="cell">
<div class="cell-output-display">
<div id="vhqyrwfjfu" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Libre+Franklin:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
#vhqyrwfjfu table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#vhqyrwfjfu thead, #vhqyrwfjfu tbody, #vhqyrwfjfu tfoot, #vhqyrwfjfu tr, #vhqyrwfjfu td, #vhqyrwfjfu th {
  border-style: none;
}

#vhqyrwfjfu p {
  margin: 0;
  padding: 0;
}

#vhqyrwfjfu .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#vhqyrwfjfu .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#vhqyrwfjfu .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#vhqyrwfjfu .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#vhqyrwfjfu .gt_heading {
  background-color: #FFFFFF;
  text-align: left;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#vhqyrwfjfu .gt_bottom_border {
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#vhqyrwfjfu .gt_col_headings {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#vhqyrwfjfu .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#vhqyrwfjfu .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#vhqyrwfjfu .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#vhqyrwfjfu .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#vhqyrwfjfu .gt_column_spanner {
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#vhqyrwfjfu .gt_spanner_row {
  border-bottom-style: hidden;
}

#vhqyrwfjfu .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#vhqyrwfjfu .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#vhqyrwfjfu .gt_from_md > :first-child {
  margin-top: 0;
}

#vhqyrwfjfu .gt_from_md > :last-child {
  margin-bottom: 0;
}

#vhqyrwfjfu .gt_row {
  padding-top: 7px;
  padding-bottom: 7px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#vhqyrwfjfu .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#vhqyrwfjfu .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#vhqyrwfjfu .gt_row_group_first td {
  border-top-width: 2px;
}

#vhqyrwfjfu .gt_row_group_first th {
  border-top-width: 2px;
}

#vhqyrwfjfu .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#vhqyrwfjfu .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#vhqyrwfjfu .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#vhqyrwfjfu .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#vhqyrwfjfu .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#vhqyrwfjfu .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#vhqyrwfjfu .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#vhqyrwfjfu .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#vhqyrwfjfu .gt_table_body {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #FFFFFF;
}

#vhqyrwfjfu .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#vhqyrwfjfu .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#vhqyrwfjfu .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#vhqyrwfjfu .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#vhqyrwfjfu .gt_left {
  text-align: left;
}

#vhqyrwfjfu .gt_center {
  text-align: center;
}

#vhqyrwfjfu .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#vhqyrwfjfu .gt_font_normal {
  font-weight: normal;
}

#vhqyrwfjfu .gt_font_bold {
  font-weight: bold;
}

#vhqyrwfjfu .gt_font_italic {
  font-style: italic;
}

#vhqyrwfjfu .gt_super {
  font-size: 65%;
}

#vhqyrwfjfu .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#vhqyrwfjfu .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#vhqyrwfjfu .gt_indent_1 {
  text-indent: 5px;
}

#vhqyrwfjfu .gt_indent_2 {
  text-indent: 10px;
}

#vhqyrwfjfu .gt_indent_3 {
  text-indent: 15px;
}

#vhqyrwfjfu .gt_indent_4 {
  text-indent: 20px;
}

#vhqyrwfjfu .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="gt_col_headings header">
<th id="expression" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">expression</th>
<th id="min" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">min</th>
<th id="median" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median</th>
<th id="mem_alloc" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_alloc</th>
<th id="median_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median_relative</th>
<th id="mem_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_relative</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">chin_dt</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">152µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">160µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">206KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">coll</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">167µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">185µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">268KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.16</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.3</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">aj</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">529µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">559µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">293KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">3.5</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.42</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">chin</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">626µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">662µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">270KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">4.15</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.31</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">in_</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">716µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">804µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">387KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">5.04</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.88</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">in_dtp</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">923µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">988µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">479KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">6.2</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">2.33</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">aj_noby</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">9.95ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">10.962ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">323KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">68.72</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.57</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="lagleaddifferences" class="level2">
<h2 class="anchored" data-anchor-id="lagleaddifferences">Lag/lead/differences</h2>
<p>Here we are interested in getting the difference in the current value of some feature from it’s last (or next) value, typically called a lag (lead). Note that it doesn’t have to be the last value, but that is most common. In the tidyverse we have <code>lag</code>/<code>lead</code> functions, or with <span class="pack">data.table</span>, we have the generic <code>shift</code> function that can do both. In the following I look at using that function in the fully <span class="pack">data.table</span> situation or within a tibble.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>N <span class="ot">=</span> <span class="fl">1e5</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>Ng <span class="ot">=</span> <span class="dv">5000</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>df  <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">rpois</span>(N, <span class="dv">10</span>),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">grp =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>Ng, <span class="at">e =</span> N <span class="sc">/</span> Ng)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">=</span> <span class="fu">as.data.table</span>(df)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>bm_lag <span class="ot">=</span> bench<span class="sc">::</span><span class="fu">mark</span>(</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">dplyr_lag  =</span> <span class="fu">mutate</span>(df, <span class="at">x_diff =</span> x <span class="sc">-</span> <span class="fu">lag</span>(x)),</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">dplyr_lead =</span> <span class="fu">mutate</span>(df, <span class="at">x_diff =</span> x <span class="sc">-</span> <span class="fu">lead</span>(x)),</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">dt_lag     =</span> dt[, <span class="at">x_diff :=</span> x <span class="sc">-</span> <span class="fu">shift</span>(x)],</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">dt_lead    =</span> dt[, <span class="at">x_diff :=</span> x <span class="sc">-</span> <span class="fu">shift</span>(x, <span class="at">n =</span> <span class="sc">-</span><span class="dv">1</span>)],</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">dt_dp_lag  =</span> <span class="fu">mutate</span>(df, <span class="at">x_diff =</span> x <span class="sc">-</span> <span class="fu">shift</span>(x)),</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">dt_dp_lead =</span> <span class="fu">mutate</span>(df, <span class="at">x_diff =</span> x <span class="sc">-</span> <span class="fu">shift</span>(x, <span class="at">n =</span> <span class="sc">-</span><span class="dv">1</span>)),</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">coll_lag   =</span> <span class="fu">ftransform</span>(df, <span class="at">x_diff =</span> x <span class="sc">-</span> <span class="fu">flag</span>(x)),</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">coll_lead  =</span> <span class="fu">ftransform</span>(df, <span class="at">x_diff =</span> x <span class="sc">-</span> <span class="fu">flag</span>(x, <span class="at">n =</span> <span class="sc">-</span><span class="dv">1</span>)),</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">iterations =</span> <span class="dv">100</span>,</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">check      =</span> <span class="cn">FALSE</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In this case, <span class="pack">collapse</span> is best, with <span class="pack">data.table</span> not far behind, but using the <code>shift</code> function within the tidy approach is a very solid gain. Oddly, <code>lag</code> and <code>lead</code> seem somewhat different in terms of speed and memory.</p>
<div class="cell">
<div class="cell-output-display">
<div id="ekwotullnu" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Libre+Franklin:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
#ekwotullnu table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#ekwotullnu thead, #ekwotullnu tbody, #ekwotullnu tfoot, #ekwotullnu tr, #ekwotullnu td, #ekwotullnu th {
  border-style: none;
}

#ekwotullnu p {
  margin: 0;
  padding: 0;
}

#ekwotullnu .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#ekwotullnu .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#ekwotullnu .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#ekwotullnu .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#ekwotullnu .gt_heading {
  background-color: #FFFFFF;
  text-align: left;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ekwotullnu .gt_bottom_border {
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ekwotullnu .gt_col_headings {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ekwotullnu .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#ekwotullnu .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#ekwotullnu .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#ekwotullnu .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#ekwotullnu .gt_column_spanner {
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#ekwotullnu .gt_spanner_row {
  border-bottom-style: hidden;
}

#ekwotullnu .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#ekwotullnu .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#ekwotullnu .gt_from_md > :first-child {
  margin-top: 0;
}

#ekwotullnu .gt_from_md > :last-child {
  margin-bottom: 0;
}

#ekwotullnu .gt_row {
  padding-top: 7px;
  padding-bottom: 7px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#ekwotullnu .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#ekwotullnu .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#ekwotullnu .gt_row_group_first td {
  border-top-width: 2px;
}

#ekwotullnu .gt_row_group_first th {
  border-top-width: 2px;
}

#ekwotullnu .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ekwotullnu .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#ekwotullnu .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#ekwotullnu .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ekwotullnu .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ekwotullnu .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#ekwotullnu .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#ekwotullnu .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#ekwotullnu .gt_table_body {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #FFFFFF;
}

#ekwotullnu .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ekwotullnu .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#ekwotullnu .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ekwotullnu .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#ekwotullnu .gt_left {
  text-align: left;
}

#ekwotullnu .gt_center {
  text-align: center;
}

#ekwotullnu .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#ekwotullnu .gt_font_normal {
  font-weight: normal;
}

#ekwotullnu .gt_font_bold {
  font-weight: bold;
}

#ekwotullnu .gt_font_italic {
  font-style: italic;
}

#ekwotullnu .gt_super {
  font-size: 65%;
}

#ekwotullnu .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#ekwotullnu .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#ekwotullnu .gt_indent_1 {
  text-indent: 5px;
}

#ekwotullnu .gt_indent_2 {
  text-indent: 10px;
}

#ekwotullnu .gt_indent_3 {
  text-indent: 15px;
}

#ekwotullnu .gt_indent_4 {
  text-indent: 20px;
}

#ekwotullnu .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="gt_col_headings header">
<th id="expression" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">expression</th>
<th id="min" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">min</th>
<th id="median" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median</th>
<th id="mem_alloc" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_alloc</th>
<th id="median_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median_relative</th>
<th id="mem_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_relative</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">coll_lag</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">226µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">260µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">783.84KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">coll_lead</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">250µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">309µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">783.84KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.18</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">dt_lag</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">316µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">354µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">813.87KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.36</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.04</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">dt_lead</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">319µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">355µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">813.87KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.36</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.04</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">dt_dp_lag</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">792µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">818µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">782.91KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">3.14</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">dt_dp_lead</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">797µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">892µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">782.91KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">3.42</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">dplyr_lead</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">994µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">1.115ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">1.53MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">4.28</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">2</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">dplyr_lag</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">1.044ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">1.2ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">1.15MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">4.61</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.5</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>What about a grouped scenario? To keep it simple we’ll just look at using lagged values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>bm_lag_grp <span class="ot">=</span> bench<span class="sc">::</span><span class="fu">mark</span>(</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">dt_lag    =</span> dt[, <span class="at">x_diff :=</span> x <span class="sc">-</span> <span class="fu">shift</span>(x), <span class="at">by =</span> grp],</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">dt_dp_lag =</span> <span class="fu">mutate</span>(<span class="fu">group_by</span>(df, grp), <span class="at">x_diff =</span> x <span class="sc">-</span> <span class="fu">shift</span>(x)),</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">dplyr_lag =</span> <span class="fu">mutate</span>(<span class="fu">group_by</span>(df, grp), <span class="at">x_diff =</span> x <span class="sc">-</span> <span class="fu">lag</span>(x)),</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">coll_lag  =</span> <span class="fu">fmutate</span>(<span class="fu">fgroup_by</span>(df, grp), <span class="at">x_diff =</span> x <span class="sc">-</span> <span class="fu">flag</span>(x)),</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">iterations =</span> <span class="dv">10</span>,</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">check      =</span> <span class="cn">FALSE</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the grouped situation, using a <span class="pack">collapse</span> isn’t best for memory, but the speed gain is ridiculous!!</p>
<div class="cell">
<div class="cell-output-display">
<div id="rtiypogkfz" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Libre+Franklin:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
#rtiypogkfz table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#rtiypogkfz thead, #rtiypogkfz tbody, #rtiypogkfz tfoot, #rtiypogkfz tr, #rtiypogkfz td, #rtiypogkfz th {
  border-style: none;
}

#rtiypogkfz p {
  margin: 0;
  padding: 0;
}

#rtiypogkfz .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#rtiypogkfz .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#rtiypogkfz .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#rtiypogkfz .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#rtiypogkfz .gt_heading {
  background-color: #FFFFFF;
  text-align: left;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#rtiypogkfz .gt_bottom_border {
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#rtiypogkfz .gt_col_headings {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#rtiypogkfz .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#rtiypogkfz .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#rtiypogkfz .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#rtiypogkfz .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#rtiypogkfz .gt_column_spanner {
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#rtiypogkfz .gt_spanner_row {
  border-bottom-style: hidden;
}

#rtiypogkfz .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#rtiypogkfz .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#rtiypogkfz .gt_from_md > :first-child {
  margin-top: 0;
}

#rtiypogkfz .gt_from_md > :last-child {
  margin-bottom: 0;
}

#rtiypogkfz .gt_row {
  padding-top: 7px;
  padding-bottom: 7px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#rtiypogkfz .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#rtiypogkfz .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#rtiypogkfz .gt_row_group_first td {
  border-top-width: 2px;
}

#rtiypogkfz .gt_row_group_first th {
  border-top-width: 2px;
}

#rtiypogkfz .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#rtiypogkfz .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#rtiypogkfz .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#rtiypogkfz .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#rtiypogkfz .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#rtiypogkfz .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#rtiypogkfz .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#rtiypogkfz .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#rtiypogkfz .gt_table_body {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #FFFFFF;
}

#rtiypogkfz .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#rtiypogkfz .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#rtiypogkfz .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#rtiypogkfz .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#rtiypogkfz .gt_left {
  text-align: left;
}

#rtiypogkfz .gt_center {
  text-align: center;
}

#rtiypogkfz .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#rtiypogkfz .gt_font_normal {
  font-weight: normal;
}

#rtiypogkfz .gt_font_bold {
  font-weight: bold;
}

#rtiypogkfz .gt_font_italic {
  font-style: italic;
}

#rtiypogkfz .gt_super {
  font-size: 65%;
}

#rtiypogkfz .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#rtiypogkfz .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#rtiypogkfz .gt_indent_1 {
  text-indent: 5px;
}

#rtiypogkfz .gt_indent_2 {
  text-indent: 10px;
}

#rtiypogkfz .gt_indent_3 {
  text-indent: 15px;
}

#rtiypogkfz .gt_indent_4 {
  text-indent: 20px;
}

#rtiypogkfz .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="gt_col_headings header">
<th id="expression" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">expression</th>
<th id="min" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">min</th>
<th id="median" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median</th>
<th id="mem_alloc" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_alloc</th>
<th id="median_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median_relative</th>
<th id="mem_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_relative</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">coll_lag</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">484µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">548µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">1.59MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">3.52</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">dt_lag</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">25.692ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">28.067ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">462.32KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">51.2</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">dt_dp_lag</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">30.843ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">32.969ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">2.61MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">60.15</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">5.77</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">dplyr_lag</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">77.156ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">78.771ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">5.19MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">143.7</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">11.49</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="firstlast" class="level2">
<h2 class="anchored" data-anchor-id="firstlast">First/Last</h2>
<p>In this demo, we want to take the first (last) value of each group. Surprisingly, for the same functionality, it turns out that the number of groups matter when doing groupwise operations. For the following I’ll even use a base R approach (though within <span class="pack">dplyr’s</span> mutate) to demonstrate some differences.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>N <span class="ot">=</span> <span class="dv">100000</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">x  =</span> <span class="fu">rpois</span>(N, <span class="dv">10</span>),</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, N, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">=</span> <span class="fu">as.data.table</span>(df)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>bm_first <span class="ot">=</span> bench<span class="sc">::</span><span class="fu">mark</span>(</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">base_first  =</span> <span class="fu">summarize</span>(<span class="fu">group_by</span>(df, id), <span class="at">x =</span> x[<span class="dv">1</span>]),</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">base_last   =</span> <span class="fu">summarize</span>(<span class="fu">group_by</span>(df, id), <span class="at">x =</span> x[<span class="fu">length</span>(x)]),</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">dplyr_first =</span> <span class="fu">summarize</span>(<span class="fu">group_by</span>(df, id), <span class="at">x =</span> dplyr<span class="sc">::</span><span class="fu">first</span>(x)),</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">dplyr_last  =</span> <span class="fu">summarize</span>(<span class="fu">group_by</span>(df, id), <span class="at">x =</span> dplyr<span class="sc">::</span><span class="fu">last</span>(x)),</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">dt_first    =</span> dt[, .(<span class="at">x =</span> data.table<span class="sc">::</span><span class="fu">first</span>(x)), <span class="at">by =</span> id],</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">dt_last     =</span> dt[, .(<span class="at">x =</span> data.table<span class="sc">::</span><span class="fu">last</span>(x)),  <span class="at">by =</span> id],</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">coll_first  =</span> <span class="fu">ffirst</span>(<span class="fu">fgroup_by</span>(df, id)),</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">coll_last   =</span> <span class="fu">flast</span>(<span class="fu">fgroup_by</span>(df, id)),</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">iterations  =</span> <span class="dv">100</span>,</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">check       =</span> <span class="cn">FALSE</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The first result is actually not too surprising, in that the fully dt approaches are fast and memory efficient, though <span class="pack">collapse</span> is notably faster. Somewhat interesting is that the base last is a bit faster than <span class="pack">dplyr’s</span> <code>last</code> (technically <code>nth</code>) approach.</p>
<div class="cell">
<div class="cell-output-display">
<div id="tfhxxvpjrz" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Libre+Franklin:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
#tfhxxvpjrz table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#tfhxxvpjrz thead, #tfhxxvpjrz tbody, #tfhxxvpjrz tfoot, #tfhxxvpjrz tr, #tfhxxvpjrz td, #tfhxxvpjrz th {
  border-style: none;
}

#tfhxxvpjrz p {
  margin: 0;
  padding: 0;
}

#tfhxxvpjrz .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#tfhxxvpjrz .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#tfhxxvpjrz .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#tfhxxvpjrz .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#tfhxxvpjrz .gt_heading {
  background-color: #FFFFFF;
  text-align: left;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#tfhxxvpjrz .gt_bottom_border {
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#tfhxxvpjrz .gt_col_headings {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#tfhxxvpjrz .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#tfhxxvpjrz .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#tfhxxvpjrz .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#tfhxxvpjrz .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#tfhxxvpjrz .gt_column_spanner {
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#tfhxxvpjrz .gt_spanner_row {
  border-bottom-style: hidden;
}

#tfhxxvpjrz .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#tfhxxvpjrz .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#tfhxxvpjrz .gt_from_md > :first-child {
  margin-top: 0;
}

#tfhxxvpjrz .gt_from_md > :last-child {
  margin-bottom: 0;
}

#tfhxxvpjrz .gt_row {
  padding-top: 7px;
  padding-bottom: 7px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#tfhxxvpjrz .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#tfhxxvpjrz .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#tfhxxvpjrz .gt_row_group_first td {
  border-top-width: 2px;
}

#tfhxxvpjrz .gt_row_group_first th {
  border-top-width: 2px;
}

#tfhxxvpjrz .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#tfhxxvpjrz .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#tfhxxvpjrz .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#tfhxxvpjrz .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#tfhxxvpjrz .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#tfhxxvpjrz .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#tfhxxvpjrz .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#tfhxxvpjrz .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#tfhxxvpjrz .gt_table_body {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #FFFFFF;
}

#tfhxxvpjrz .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#tfhxxvpjrz .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#tfhxxvpjrz .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#tfhxxvpjrz .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#tfhxxvpjrz .gt_left {
  text-align: left;
}

#tfhxxvpjrz .gt_center {
  text-align: center;
}

#tfhxxvpjrz .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#tfhxxvpjrz .gt_font_normal {
  font-weight: normal;
}

#tfhxxvpjrz .gt_font_bold {
  font-weight: bold;
}

#tfhxxvpjrz .gt_font_italic {
  font-style: italic;
}

#tfhxxvpjrz .gt_super {
  font-size: 65%;
}

#tfhxxvpjrz .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#tfhxxvpjrz .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#tfhxxvpjrz .gt_indent_1 {
  text-indent: 5px;
}

#tfhxxvpjrz .gt_indent_2 {
  text-indent: 10px;
}

#tfhxxvpjrz .gt_indent_3 {
  text-indent: 15px;
}

#tfhxxvpjrz .gt_indent_4 {
  text-indent: 20px;
}

#tfhxxvpjrz .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="gt_col_headings header">
<th id="expression" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">expression</th>
<th id="min" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">min</th>
<th id="median" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median</th>
<th id="mem_alloc" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_alloc</th>
<th id="median_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median_relative</th>
<th id="mem_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_relative</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">coll_last</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">307µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">341µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">783.53KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.72</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">coll_first</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">299µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">345µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">783.53KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.01</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.72</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">dt_last</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">698µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">876µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">454.62KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">2.57</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">dt_first</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">689µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">895µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">454.62KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">2.62</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">base_last</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">1.944ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">2.036ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">2.06MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">5.97</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">4.64</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">dplyr_first</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">2.026ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">2.127ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">2.06MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">6.24</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">4.64</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">base_first</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">1.984ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">2.165ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">2.06MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">6.35</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">4.64</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">dplyr_last</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">2.111ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">2.553ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">2.06MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">7.49</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">4.64</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>In the following, the only thing that changes is the number of groups.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>N <span class="ot">=</span> <span class="dv">100000</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">rpois</span>(N, <span class="dv">10</span>),</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">id =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>(N<span class="sc">/</span><span class="dv">10</span>), N, <span class="at">replace =</span> <span class="cn">TRUE</span>) <span class="co"># &lt;--- change is here</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">=</span> <span class="fu">as.data.table</span>(df)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>bm_first_more_groups <span class="ot">=</span> bench<span class="sc">::</span><span class="fu">mark</span>(</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">base_first  =</span> <span class="fu">summarize</span>(<span class="fu">group_by</span>(df, id), <span class="at">x =</span> x[<span class="dv">1</span>]),</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">base_last   =</span> <span class="fu">summarize</span>(<span class="fu">group_by</span>(df, id), <span class="at">x =</span> x[<span class="fu">length</span>(x)]),</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">dplyr_first =</span> <span class="fu">summarize</span>(<span class="fu">group_by</span>(df, id), <span class="at">x =</span> dplyr<span class="sc">::</span><span class="fu">first</span>(x)),</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">dplyr_last  =</span> <span class="fu">summarize</span>(<span class="fu">group_by</span>(df, id), <span class="at">x =</span> dplyr<span class="sc">::</span><span class="fu">last</span>(x)),</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">dt_first    =</span> dt[, .(<span class="at">x =</span> data.table<span class="sc">::</span><span class="fu">first</span>(x)), <span class="at">by =</span> id],</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">dt_last     =</span> dt[, .(<span class="at">x =</span> data.table<span class="sc">::</span><span class="fu">last</span>(x)),  <span class="at">by =</span> id],</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">coll_first  =</span> <span class="fu">ffirst</span>(<span class="fu">group_by</span>(df, id)),</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">coll_last   =</span> <span class="fu">flast</span>(<span class="fu">group_by</span>(df, id)),</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">iterations  =</span> <span class="dv">100</span>,</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">check       =</span> <span class="cn">FALSE</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now what the heck is going on here? The base R approach is way faster than even <span class="pack">data.table</span>, while not using any more memory than what <span class="pack">dplyr</span> is doing (because of the group-by-summarize). More to the point is that <span class="pack">collapse</span> is notably faster than the other options, but still a bit heavy memory-wise relative to <span class="pack">data.table</span>.</p>
<div class="cell">
<div class="cell-output-display">
<div id="uynnxpnzoh" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Libre+Franklin:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
#uynnxpnzoh table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#uynnxpnzoh thead, #uynnxpnzoh tbody, #uynnxpnzoh tfoot, #uynnxpnzoh tr, #uynnxpnzoh td, #uynnxpnzoh th {
  border-style: none;
}

#uynnxpnzoh p {
  margin: 0;
  padding: 0;
}

#uynnxpnzoh .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#uynnxpnzoh .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#uynnxpnzoh .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#uynnxpnzoh .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#uynnxpnzoh .gt_heading {
  background-color: #FFFFFF;
  text-align: left;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#uynnxpnzoh .gt_bottom_border {
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#uynnxpnzoh .gt_col_headings {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#uynnxpnzoh .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#uynnxpnzoh .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#uynnxpnzoh .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#uynnxpnzoh .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#uynnxpnzoh .gt_column_spanner {
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#uynnxpnzoh .gt_spanner_row {
  border-bottom-style: hidden;
}

#uynnxpnzoh .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#uynnxpnzoh .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#uynnxpnzoh .gt_from_md > :first-child {
  margin-top: 0;
}

#uynnxpnzoh .gt_from_md > :last-child {
  margin-bottom: 0;
}

#uynnxpnzoh .gt_row {
  padding-top: 7px;
  padding-bottom: 7px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#uynnxpnzoh .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#uynnxpnzoh .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#uynnxpnzoh .gt_row_group_first td {
  border-top-width: 2px;
}

#uynnxpnzoh .gt_row_group_first th {
  border-top-width: 2px;
}

#uynnxpnzoh .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#uynnxpnzoh .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#uynnxpnzoh .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#uynnxpnzoh .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#uynnxpnzoh .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#uynnxpnzoh .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#uynnxpnzoh .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#uynnxpnzoh .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#uynnxpnzoh .gt_table_body {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #FFFFFF;
}

#uynnxpnzoh .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#uynnxpnzoh .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#uynnxpnzoh .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#uynnxpnzoh .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#uynnxpnzoh .gt_left {
  text-align: left;
}

#uynnxpnzoh .gt_center {
  text-align: center;
}

#uynnxpnzoh .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#uynnxpnzoh .gt_font_normal {
  font-weight: normal;
}

#uynnxpnzoh .gt_font_bold {
  font-weight: bold;
}

#uynnxpnzoh .gt_font_italic {
  font-style: italic;
}

#uynnxpnzoh .gt_super {
  font-size: 65%;
}

#uynnxpnzoh .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#uynnxpnzoh .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#uynnxpnzoh .gt_indent_1 {
  text-indent: 5px;
}

#uynnxpnzoh .gt_indent_2 {
  text-indent: 10px;
}

#uynnxpnzoh .gt_indent_3 {
  text-indent: 15px;
}

#uynnxpnzoh .gt_indent_4 {
  text-indent: 20px;
}

#uynnxpnzoh .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="gt_col_headings header">
<th id="expression" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">expression</th>
<th id="min" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">min</th>
<th id="median" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median</th>
<th id="mem_alloc" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_alloc</th>
<th id="median_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median_relative</th>
<th id="mem_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_relative</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">coll_last</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">2.813ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">3.006ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">2.79MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">3.8</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">coll_first</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">2.838ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">3.128ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">2.79MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.04</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">3.8</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">base_first</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">10.596ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">11.4ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">3.06MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">3.79</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">4.17</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">base_last</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">12.551ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">13.151ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">3.06MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">4.37</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">4.17</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">dt_last</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">17.588ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">18.318ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">752.15KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">6.09</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">dt_first</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">17.671ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">18.379ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">752.15KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">6.11</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">dplyr_first</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">20.066ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">20.943ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">3.06MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">6.97</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">4.17</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">dplyr_last</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">20.916ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">21.357ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">3.16MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">7.1</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">4.31</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="coalesceifelse" class="level2">
<h2 class="anchored" data-anchor-id="coalesceifelse">Coalesce/ifelse</h2>
<p>It’s very often we want to change a single value based on some condition, often starting with <code>ifelse</code>. This is similar to our previous fill situation for missing values, but applies a constant as opposed to last/next value. <code>Coalesce</code> is similar to <span class="pack">tidyr’s</span> <code>fill</code>, and is often used in cases where we might otherwise use an <code>ifelse</code> style approach . In the following, we want to change NA values to zero, and there are many ways we might go about it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1000</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>x[x <span class="sc">&gt;</span> <span class="dv">2</span>] <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>bm_coalesce <span class="ot">=</span> bench<span class="sc">::</span><span class="fu">mark</span>(</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">base      =</span> {x[<span class="fu">is.na</span>(x)] <span class="ot">&lt;-</span> <span class="dv">0</span>; x},</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">ifelse    =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(x), <span class="dv">0</span>, x),</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">if_else   =</span> <span class="fu">if_else</span>(<span class="fu">is.na</span>(x), <span class="dv">0</span>, x),</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">vctrs     =</span> <span class="fu">vec_assign</span>(x, <span class="fu">is.na</span>(x), <span class="dv">0</span>),</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">tidyr     =</span> <span class="fu">replace_na</span>(x, <span class="dv">0</span>),</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">fifelse   =</span> <span class="fu">fifelse</span>(<span class="fu">is.na</span>(x), <span class="dv">0</span>, x),</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">coalesce  =</span> <span class="fu">coalesce</span>(x, <span class="dv">0</span>),</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">fcoalesce =</span> <span class="fu">fcoalesce</span>(x, <span class="dv">0</span>),</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">nafill    =</span> <span class="fu">nafill</span>(x, <span class="at">fill =</span> <span class="dv">0</span>),</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">coll      =</span> <span class="fu">replace_NA</span>(x)   <span class="co"># default is 0</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The key result here to me is just how much memory the <span class="pack">dplyr</span> <code>if_else</code> approach is using, as well as how fast and memory efficient the base R approach is even with a second step. While providing type safety, <code>if_else</code> is both slow and a memory hog, so probably anything else is better. <span class="pack">tidyr</span> itself would be a good option here, and while it makes up for the memory issue, it’s relatively slow compared to other approaches, including the function it’s a wrapper for (<code>vec_assign</code>), which is also demonstrated. Interestingly, <code>fcoalesce</code> and <code>fifelse</code> would both be better options than <span class="pack">data.table’s</span> other approach that is explicitly for this task.</p>
<div class="cell">
<div class="cell-output-display">
<div id="wwgthwcxah" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Libre+Franklin:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
#wwgthwcxah table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#wwgthwcxah thead, #wwgthwcxah tbody, #wwgthwcxah tfoot, #wwgthwcxah tr, #wwgthwcxah td, #wwgthwcxah th {
  border-style: none;
}

#wwgthwcxah p {
  margin: 0;
  padding: 0;
}

#wwgthwcxah .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#wwgthwcxah .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#wwgthwcxah .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#wwgthwcxah .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#wwgthwcxah .gt_heading {
  background-color: #FFFFFF;
  text-align: left;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#wwgthwcxah .gt_bottom_border {
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#wwgthwcxah .gt_col_headings {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#wwgthwcxah .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#wwgthwcxah .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#wwgthwcxah .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#wwgthwcxah .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#wwgthwcxah .gt_column_spanner {
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#wwgthwcxah .gt_spanner_row {
  border-bottom-style: hidden;
}

#wwgthwcxah .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#wwgthwcxah .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#wwgthwcxah .gt_from_md > :first-child {
  margin-top: 0;
}

#wwgthwcxah .gt_from_md > :last-child {
  margin-bottom: 0;
}

#wwgthwcxah .gt_row {
  padding-top: 7px;
  padding-bottom: 7px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#wwgthwcxah .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#wwgthwcxah .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#wwgthwcxah .gt_row_group_first td {
  border-top-width: 2px;
}

#wwgthwcxah .gt_row_group_first th {
  border-top-width: 2px;
}

#wwgthwcxah .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#wwgthwcxah .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#wwgthwcxah .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#wwgthwcxah .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#wwgthwcxah .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#wwgthwcxah .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#wwgthwcxah .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#wwgthwcxah .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#wwgthwcxah .gt_table_body {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #FFFFFF;
}

#wwgthwcxah .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#wwgthwcxah .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#wwgthwcxah .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#wwgthwcxah .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#wwgthwcxah .gt_left {
  text-align: left;
}

#wwgthwcxah .gt_center {
  text-align: center;
}

#wwgthwcxah .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#wwgthwcxah .gt_font_normal {
  font-weight: normal;
}

#wwgthwcxah .gt_font_bold {
  font-weight: bold;
}

#wwgthwcxah .gt_font_italic {
  font-style: italic;
}

#wwgthwcxah .gt_super {
  font-size: 65%;
}

#wwgthwcxah .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#wwgthwcxah .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#wwgthwcxah .gt_indent_1 {
  text-indent: 5px;
}

#wwgthwcxah .gt_indent_2 {
  text-indent: 10px;
}

#wwgthwcxah .gt_indent_3 {
  text-indent: 15px;
}

#wwgthwcxah .gt_indent_4 {
  text-indent: 20px;
}

#wwgthwcxah .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="gt_col_headings header">
<th id="expression" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">expression</th>
<th id="min" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">min</th>
<th id="median" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median</th>
<th id="mem_alloc" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_alloc</th>
<th id="median_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median_relative</th>
<th id="mem_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_relative</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">fcoalesce</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">1µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">1µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">7.86KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">coll</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">1µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">1µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">7.86KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.03</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">base</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">2µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">3µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">7.91KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">2.17</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.01</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">fifelse</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">3µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">4µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">11.81KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">2.6</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.5</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">vctrs</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">4µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">4µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">11.81KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">3.09</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.5</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">nafill</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">5µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">6µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">23.95KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">4.14</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">3.05</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">tidyr</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">9µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">10µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">11.81KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">7.09</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.5</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">coalesce</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">15µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">17µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">20.19KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">11.71</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">2.57</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">ifelse</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">15µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">17µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">47.31KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">12.11</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">6.02</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">if_else</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">21µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">25µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">71.06KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">17.54</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">9.04</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="conditional-slide" class="level2">
<h2 class="anchored" data-anchor-id="conditional-slide">Conditional Slide</h2>
<p>I recently had a problem where I wanted to do a apply a certain function that required taking the difference between the current and last value as we did in the lag demo. The problem was that ‘last’ depended on a specific condition being met. The basic idea is that we want to take x - lag(x) but where the condition is <code>FALSE</code>, we need to basically ignore that value for consideration as the last value, and only use the previous value for which the condition is <code>TRUE</code>. In the following, for the first two values where the condition is met, this is straightforward (6 minus 10). But for the fourth row, 4 should subtract 6, rather than 5, because the condition is <code>FALSE</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">cond =</span> <span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>, <span class="cn">FALSE</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>),</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">'a'</span>, <span class="st">'b'</span>), <span class="at">e =</span> <span class="dv">5</span>)</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>df </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 3
       x cond  group
   &lt;int&gt; &lt;lgl&gt; &lt;chr&gt;
 1    10 TRUE  a    
 2     6 TRUE  a    
 3     5 FALSE a    
 4     4 TRUE  a    
 5     1 FALSE a    
 6     8 TRUE  b    
 7     2 FALSE b    
 8     7 FALSE b    
 9     9 TRUE  b    
10     3 FALSE b    </code></pre>
</div>
</div>
<p>While somewhat simple in concept, it doesn’t really work with simple lags, as the answer would be wrong, or sliding functions, because the window is adaptive. I wrote the following function to deal with this. By default, it basically takes our vector under consideration, <code>x</code>, makes it <code>NA</code> where the condition doesn’t hold, then fills in the NA values with the last value using the <code>vec_fill_missing</code> (or a supplied constant/single value). However there is flexibility beyond that type of fill. In addition, the function applied is generic, and could be applied to the newly created variable (<code>.x</code>), or use both the original (<code>x</code>) and the newly created variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>conditional_slide <span class="ot">&lt;-</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(x,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>           condition,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>           fun,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>           <span class="at">direction  =</span> <span class="fu">c</span>(<span class="st">"down"</span>),</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>           <span class="at">fill_value =</span> <span class="cn">NA</span>,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>           <span class="at">na_value   =</span> <span class="cn">NA</span>,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>           ...) {</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span>direction <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"constant"</span>, <span class="st">"down"</span>, <span class="st">"up"</span>, <span class="st">"downup"</span>, <span class="st">"updown"</span>))</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>      rlang<span class="sc">::</span><span class="fu">abort</span>(<span class="st">'direction must be one of "constant", "down", "up", "downup", "updown"'</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(x) <span class="sc">!=</span> <span class="fu">length</span>(condition))</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>      rlang<span class="sc">::</span><span class="fu">abort</span>(<span class="st">'condition and x must be the same length'</span>)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># can't use dplyr/dt ifelse since we won't know class type of fill_value</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    conditional_val <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(direction <span class="sc">==</span> <span class="st">'constant'</span>, fill_value, <span class="cn">NA</span>)    </span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    .x <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(condition, x, conditional_val)</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (direction <span class="sc">!=</span> <span class="st">'constant'</span>)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>      .x <span class="ot">&lt;-</span> vctrs<span class="sc">::</span><span class="fu">vec_fill_missing</span>(.x, <span class="at">direction =</span> direction)</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">class</span>(.x) <span class="ot">&lt;-</span> <span class="fu">class</span>(x)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    result <span class="ot">&lt;-</span> <span class="fu">fun</span>(x, .x, ...)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.na</span>(na_value))</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>      result[<span class="fu">is.na</span>(result)] <span class="ot">&lt;-</span> na_value</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    result</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The first example applies the function, <code>x - lag(x)</code>, to our dataset, and which in my case, I also wanted to apply within groups, which caused further problems for some of the available functions I thought would otherwise be applicable. I also show it for another type of problem, taking the cumulative sum, as well as just conditionally changing the values to zero.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a> <span class="fu">group_by</span>(group) <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a> <span class="fu">mutate</span>(</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>   <span class="co"># demo first difference</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>   <span class="at">simple_diff =</span> x <span class="sc">-</span> dplyr<span class="sc">::</span><span class="fu">lag</span>(x),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>   <span class="at">cond_diff =</span> <span class="fu">conditional_slide</span>(x, cond, <span class="at">fun =</span> \(x, .x) x <span class="sc">-</span> <span class="fu">lag</span>(.x), <span class="at">na_value =</span> <span class="dv">0</span>),</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>   <span class="co"># demo cumulative sum</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>   <span class="at">simple_cumsum =</span> <span class="fu">cumsum</span>(x),</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>   <span class="at">cond_cumsum   =</span> <span class="fu">conditional_slide</span>(</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>     x,</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>     cond,</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>     <span class="at">fun =</span> \(x, .x) <span class="fu">cumsum</span>(.x),</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>     <span class="at">direction =</span> <span class="st">'constant'</span>,</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>     <span class="at">fill =</span> <span class="dv">0</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>   ),</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>   <span class="co"># demo fill last</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>   <span class="at">simple_fill_last =</span> <span class="fu">vec_fill_missing</span>(x),</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>   <span class="at">cond_fill_last =</span> <span class="fu">conditional_slide</span>(</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>     x,</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>     cond,</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>     <span class="at">fun =</span> \(x, .x) .x,</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>     <span class="at">direction =</span> <span class="st">'down'</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a> )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 9
# Groups:   group [2]
       x cond  group simple_diff cond_diff simple_cumsum cond_cumsum
   &lt;int&gt; &lt;lgl&gt; &lt;chr&gt;       &lt;int&gt;     &lt;dbl&gt;         &lt;int&gt;       &lt;int&gt;
 1    10 TRUE  a              NA         0            10          10
 2     6 TRUE  a              -4        -4            16          16
 3     5 FALSE a              -1        -1            21          16
 4     4 TRUE  a              -1        -2            25          20
 5     1 FALSE a              -3        -3            26          20
 6     8 TRUE  b              NA         0             8           8
 7     2 FALSE b              -6        -6            10           8
 8     7 FALSE b               5        -1            17           8
 9     9 TRUE  b               2         1            26          17
10     3 FALSE b              -6        -6            29          17
# ℹ 2 more variables: simple_fill_last &lt;int&gt;, cond_fill_last &lt;int&gt;</code></pre>
</div>
</div>
<p>This is one of those things that comes up from time to time where trying to apply a standard tool likely won’t cut it. You may find similar situations where you need to modify what’s available and create some functionality tailored to your needs.</p>
</section>
<section id="take-the-first-true" class="level2">
<h2 class="anchored" data-anchor-id="take-the-first-true">Take the first TRUE</h2>
<p>Sometimes we want the first instance of a condition. For example, we might want the position or value of the first number &gt; than some value. We’ve already investigated using <span class="pack">dplyr</span> or <span class="pack">data.table’s</span> <code>first</code>, and I won’t do so again here except to say they are both notably slower and worse on memory here. We have a few approaches we might take in base R. Using <code>which</code> would be common, but there is also <code>which.max</code>, that, when applied to logical vectors, gives the position of the first <code>TRUE</code> (<code>which.min</code> gives the position of the first <code>FALSE</code>). In addition, there is the <code>Position</code> function, which I didn’t even know about until messing with this problem.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">sort</span>(<span class="fu">rnorm</span>(<span class="dv">10000</span>))</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>marker <span class="ot">=</span> <span class="dv">2</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>bm_first_true_1 <span class="ot">=</span> bench<span class="sc">::</span><span class="fu">mark</span>(</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">which     =</span> <span class="fu">which</span>(x <span class="sc">&gt;</span> marker)[<span class="dv">1</span>],</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">which_max =</span> <span class="fu">which.max</span>(x <span class="sc">&gt;</span> marker),</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">pos       =</span> <span class="fu">Position</span>(\(x) x <span class="sc">&gt;</span> marker, x)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co"># make it slightly more challenging</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">sort</span>(<span class="fu">rnorm</span>(<span class="fl">1e6</span>))</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>marker <span class="ot">=</span> <span class="dv">4</span> </span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>bm_first_true_2 <span class="ot">=</span> bench<span class="sc">::</span><span class="fu">mark</span>(</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">which     =</span> <span class="fu">which</span>(x <span class="sc">&gt;</span> marker)[<span class="dv">1</span>],</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">which_max =</span> <span class="fu">which.max</span>(x <span class="sc">&gt;</span> marker),</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">pos       =</span> <span class="fu">Position</span>(\(x) x <span class="sc">&gt;</span> marker, x)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Interestingly <code>Position</code> provides the best memory performance, but is prohibitively slower. <code>which.max</code> is probably your best bet.</p>
<div class="cell">
<div class="cell-output-display">
<div id="zfontnxddu" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Libre+Franklin:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
#zfontnxddu table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#zfontnxddu thead, #zfontnxddu tbody, #zfontnxddu tfoot, #zfontnxddu tr, #zfontnxddu td, #zfontnxddu th {
  border-style: none;
}

#zfontnxddu p {
  margin: 0;
  padding: 0;
}

#zfontnxddu .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#zfontnxddu .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#zfontnxddu .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#zfontnxddu .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#zfontnxddu .gt_heading {
  background-color: #FFFFFF;
  text-align: left;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#zfontnxddu .gt_bottom_border {
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zfontnxddu .gt_col_headings {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#zfontnxddu .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#zfontnxddu .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#zfontnxddu .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#zfontnxddu .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#zfontnxddu .gt_column_spanner {
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#zfontnxddu .gt_spanner_row {
  border-bottom-style: hidden;
}

#zfontnxddu .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#zfontnxddu .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#zfontnxddu .gt_from_md > :first-child {
  margin-top: 0;
}

#zfontnxddu .gt_from_md > :last-child {
  margin-bottom: 0;
}

#zfontnxddu .gt_row {
  padding-top: 7px;
  padding-bottom: 7px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#zfontnxddu .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#zfontnxddu .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#zfontnxddu .gt_row_group_first td {
  border-top-width: 2px;
}

#zfontnxddu .gt_row_group_first th {
  border-top-width: 2px;
}

#zfontnxddu .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#zfontnxddu .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#zfontnxddu .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#zfontnxddu .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zfontnxddu .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#zfontnxddu .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#zfontnxddu .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#zfontnxddu .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#zfontnxddu .gt_table_body {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #FFFFFF;
}

#zfontnxddu .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#zfontnxddu .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#zfontnxddu .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#zfontnxddu .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#zfontnxddu .gt_left {
  text-align: left;
}

#zfontnxddu .gt_center {
  text-align: center;
}

#zfontnxddu .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#zfontnxddu .gt_font_normal {
  font-weight: normal;
}

#zfontnxddu .gt_font_bold {
  font-weight: bold;
}

#zfontnxddu .gt_font_italic {
  font-style: italic;
}

#zfontnxddu .gt_super {
  font-size: 65%;
}

#zfontnxddu .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#zfontnxddu .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#zfontnxddu .gt_indent_1 {
  text-indent: 5px;
}

#zfontnxddu .gt_indent_2 {
  text-indent: 10px;
}

#zfontnxddu .gt_indent_3 {
  text-indent: 15px;
}

#zfontnxddu .gt_indent_4 {
  text-indent: 20px;
}

#zfontnxddu .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="gt_col_headings header">
<th id="expression" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">expression</th>
<th id="min" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">min</th>
<th id="median" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median</th>
<th id="mem_alloc" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_alloc</th>
<th id="median_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median_relative</th>
<th id="mem_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_relative</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">which</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">15µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">20µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">79.14KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">14.19</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">which_max</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">18µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">20µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">39.11KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.01</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">7.01</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">pos</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">1.986ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">2.158ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">5.58KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">109.67</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output-display">
<div id="htxcdzeboh" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Libre+Franklin:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
#htxcdzeboh table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#htxcdzeboh thead, #htxcdzeboh tbody, #htxcdzeboh tfoot, #htxcdzeboh tr, #htxcdzeboh td, #htxcdzeboh th {
  border-style: none;
}

#htxcdzeboh p {
  margin: 0;
  padding: 0;
}

#htxcdzeboh .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#htxcdzeboh .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#htxcdzeboh .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#htxcdzeboh .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#htxcdzeboh .gt_heading {
  background-color: #FFFFFF;
  text-align: left;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#htxcdzeboh .gt_bottom_border {
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#htxcdzeboh .gt_col_headings {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#htxcdzeboh .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#htxcdzeboh .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#htxcdzeboh .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#htxcdzeboh .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#htxcdzeboh .gt_column_spanner {
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#htxcdzeboh .gt_spanner_row {
  border-bottom-style: hidden;
}

#htxcdzeboh .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#htxcdzeboh .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#htxcdzeboh .gt_from_md > :first-child {
  margin-top: 0;
}

#htxcdzeboh .gt_from_md > :last-child {
  margin-bottom: 0;
}

#htxcdzeboh .gt_row {
  padding-top: 7px;
  padding-bottom: 7px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#htxcdzeboh .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#htxcdzeboh .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#htxcdzeboh .gt_row_group_first td {
  border-top-width: 2px;
}

#htxcdzeboh .gt_row_group_first th {
  border-top-width: 2px;
}

#htxcdzeboh .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#htxcdzeboh .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#htxcdzeboh .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#htxcdzeboh .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#htxcdzeboh .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#htxcdzeboh .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#htxcdzeboh .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#htxcdzeboh .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#htxcdzeboh .gt_table_body {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #FFFFFF;
}

#htxcdzeboh .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#htxcdzeboh .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#htxcdzeboh .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#htxcdzeboh .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#htxcdzeboh .gt_left {
  text-align: left;
}

#htxcdzeboh .gt_center {
  text-align: center;
}

#htxcdzeboh .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#htxcdzeboh .gt_font_normal {
  font-weight: normal;
}

#htxcdzeboh .gt_font_bold {
  font-weight: bold;
}

#htxcdzeboh .gt_font_italic {
  font-style: italic;
}

#htxcdzeboh .gt_super {
  font-size: 65%;
}

#htxcdzeboh .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#htxcdzeboh .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#htxcdzeboh .gt_indent_1 {
  text-indent: 5px;
}

#htxcdzeboh .gt_indent_2 {
  text-indent: 10px;
}

#htxcdzeboh .gt_indent_3 {
  text-indent: 15px;
}

#htxcdzeboh .gt_indent_4 {
  text-indent: 20px;
}

#htxcdzeboh .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="gt_col_headings header">
<th id="expression" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">expression</th>
<th id="min" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">min</th>
<th id="median" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median</th>
<th id="mem_alloc" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_alloc</th>
<th id="median_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median_relative</th>
<th id="mem_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_relative</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">which</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">1.44ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">1.69ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">7.63MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1400.58</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">which_max</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">1.79ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">2ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">3.81MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.18</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">700.29</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">pos</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">213.55ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">219.13ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">5.58KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">129.4</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>But not so fast? The following makes the first case come very quickly, where <code>Position</code> blows the other options out of the water! I guess if you knew this was going to be the case you could take serious advantage.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">sort</span>(<span class="fu">rnorm</span>(<span class="dv">100000</span>), <span class="at">decreasing =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>x[<span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>] <span class="ot">=</span> <span class="dv">4</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>bm_first_true_3 <span class="ot">=</span> bench<span class="sc">::</span><span class="fu">mark</span>(</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">which     =</span> <span class="fu">which</span>(x <span class="sc">&lt;</span> marker)[<span class="dv">1</span>],</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">which_max =</span> <span class="fu">which.max</span>(x <span class="sc">&lt;</span> marker),</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">pos       =</span> <span class="fu">Position</span>(\(x) x <span class="sc">&lt;</span> marker, x) </span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="tplcwisvdh" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Libre+Franklin:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
#tplcwisvdh table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#tplcwisvdh thead, #tplcwisvdh tbody, #tplcwisvdh tfoot, #tplcwisvdh tr, #tplcwisvdh td, #tplcwisvdh th {
  border-style: none;
}

#tplcwisvdh p {
  margin: 0;
  padding: 0;
}

#tplcwisvdh .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#tplcwisvdh .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#tplcwisvdh .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#tplcwisvdh .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#tplcwisvdh .gt_heading {
  background-color: #FFFFFF;
  text-align: left;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#tplcwisvdh .gt_bottom_border {
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#tplcwisvdh .gt_col_headings {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#tplcwisvdh .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#tplcwisvdh .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#tplcwisvdh .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#tplcwisvdh .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#tplcwisvdh .gt_column_spanner {
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#tplcwisvdh .gt_spanner_row {
  border-bottom-style: hidden;
}

#tplcwisvdh .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#tplcwisvdh .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#tplcwisvdh .gt_from_md > :first-child {
  margin-top: 0;
}

#tplcwisvdh .gt_from_md > :last-child {
  margin-bottom: 0;
}

#tplcwisvdh .gt_row {
  padding-top: 7px;
  padding-bottom: 7px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#tplcwisvdh .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#tplcwisvdh .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#tplcwisvdh .gt_row_group_first td {
  border-top-width: 2px;
}

#tplcwisvdh .gt_row_group_first th {
  border-top-width: 2px;
}

#tplcwisvdh .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#tplcwisvdh .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#tplcwisvdh .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#tplcwisvdh .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#tplcwisvdh .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#tplcwisvdh .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#tplcwisvdh .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#tplcwisvdh .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#tplcwisvdh .gt_table_body {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #FFFFFF;
}

#tplcwisvdh .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#tplcwisvdh .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#tplcwisvdh .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#tplcwisvdh .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#tplcwisvdh .gt_left {
  text-align: left;
}

#tplcwisvdh .gt_center {
  text-align: center;
}

#tplcwisvdh .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#tplcwisvdh .gt_font_normal {
  font-weight: normal;
}

#tplcwisvdh .gt_font_bold {
  font-weight: bold;
}

#tplcwisvdh .gt_font_italic {
  font-style: italic;
}

#tplcwisvdh .gt_super {
  font-size: 65%;
}

#tplcwisvdh .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#tplcwisvdh .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#tplcwisvdh .gt_indent_1 {
  text-indent: 5px;
}

#tplcwisvdh .gt_indent_2 {
  text-indent: 10px;
}

#tplcwisvdh .gt_indent_3 {
  text-indent: 15px;
}

#tplcwisvdh .gt_indent_4 {
  text-indent: 20px;
}

#tplcwisvdh .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="gt_col_headings header">
<th id="expression" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">expression</th>
<th id="min" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">min</th>
<th id="median" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median</th>
<th id="mem_alloc" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_alloc</th>
<th id="median_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median_relative</th>
<th id="mem_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_relative</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">pos_rev</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">10µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">10µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">5.58KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">which_max_rev</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">110µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">130µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">390.67KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">13.04</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">70.04</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">which_rev</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">160µs</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">220µs</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">1.14MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">22.55</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">210.09</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="group-by-filteringslicing" class="level2">
<h2 class="anchored" data-anchor-id="group-by-filteringslicing">Group by filtering/slicing</h2>
<p>The previous situation was the basis for this next demo where we utilize <code>which.max</code>. Here we want to filter in one scenario, such that if all values are zero, we drop them, and in the second, we want to only retain certain values based on a condition. In this latter case, the condition is that at least one non-zero has occurred, in which case we want to keep all of those values from that point on (even if they are zero).</p>
<p>To make things more clear, for the example data that follows, we want to drop group 1 entirely, the initial part of group 2, and retain all of group 3.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">12345</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">e =</span> <span class="dv">10</span>),</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> <span class="fu">c</span>(</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">7</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)), </span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">10</span>, <span class="dv">10</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(group) <span class="sc">%&gt;%</span> </span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">all</span>(value <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="fu">which.max</span>(value <span class="sc">&gt;</span> <span class="dv">0</span>)<span class="sc">:</span><span class="fu">n</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 17 × 2
# Groups:   group [2]
   group value
   &lt;int&gt; &lt;dbl&gt;
 1     2     5
 2     2     2
 3     2     1
 4     2     3
 5     2     1
 6     2     4
 7     2     2
 8     3     7
 9     3     1
10     3     5
11     3    10
12     3     5
13     3     6
14     3     9
15     3     0
16     3     7
17     3     6</code></pre>
</div>
</div>
<p>In the above scenario, we take two steps to illustrate our desired outcome conceptually. Ideally though, we’d like one step, because it is just a general filtering. You might think maybe to change <code>which.max</code> to <code>which</code> and just slice, but this would remove all zeros, when we want to retain zeros after the point where at least some values are greater than zero. Using <code>row_number</code> was a way I thought to get around things.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>df <span class="sc">%&gt;%</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(group) <span class="sc">%&gt;%</span> </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">all</span>(value <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">&amp;</span> <span class="fu">row_number</span>() <span class="sc">&gt;=</span> <span class="fu">which.max</span>(value <span class="sc">&gt;</span> <span class="dv">0</span>))</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>bm_filter_slice <span class="ot">=</span> bench<span class="sc">::</span><span class="fu">mark</span>(</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">orig =</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(group) <span class="sc">%&gt;%</span> </span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">all</span>(value <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="fu">which.max</span>(value <span class="sc">&gt;</span> <span class="dv">0</span>)<span class="sc">:</span><span class="fu">n</span>()),</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">new =</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(group) <span class="sc">%&gt;%</span> </span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">all</span>(value <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">&amp;</span> <span class="fu">row_number</span>() <span class="sc">&gt;=</span> <span class="fu">which.max</span>(value <span class="sc">&gt;</span> <span class="dv">0</span>))</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="falthzlcin" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Libre+Franklin:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
#falthzlcin table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#falthzlcin thead, #falthzlcin tbody, #falthzlcin tfoot, #falthzlcin tr, #falthzlcin td, #falthzlcin th {
  border-style: none;
}

#falthzlcin p {
  margin: 0;
  padding: 0;
}

#falthzlcin .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#falthzlcin .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#falthzlcin .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#falthzlcin .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#falthzlcin .gt_heading {
  background-color: #FFFFFF;
  text-align: left;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#falthzlcin .gt_bottom_border {
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#falthzlcin .gt_col_headings {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#falthzlcin .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#falthzlcin .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#falthzlcin .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#falthzlcin .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#falthzlcin .gt_column_spanner {
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#falthzlcin .gt_spanner_row {
  border-bottom-style: hidden;
}

#falthzlcin .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#falthzlcin .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#falthzlcin .gt_from_md > :first-child {
  margin-top: 0;
}

#falthzlcin .gt_from_md > :last-child {
  margin-bottom: 0;
}

#falthzlcin .gt_row {
  padding-top: 7px;
  padding-bottom: 7px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#falthzlcin .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#falthzlcin .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#falthzlcin .gt_row_group_first td {
  border-top-width: 2px;
}

#falthzlcin .gt_row_group_first th {
  border-top-width: 2px;
}

#falthzlcin .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#falthzlcin .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#falthzlcin .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#falthzlcin .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#falthzlcin .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#falthzlcin .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#falthzlcin .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#falthzlcin .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#falthzlcin .gt_table_body {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #FFFFFF;
}

#falthzlcin .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#falthzlcin .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#falthzlcin .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#falthzlcin .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#falthzlcin .gt_left {
  text-align: left;
}

#falthzlcin .gt_center {
  text-align: center;
}

#falthzlcin .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#falthzlcin .gt_font_normal {
  font-weight: normal;
}

#falthzlcin .gt_font_bold {
  font-weight: bold;
}

#falthzlcin .gt_font_italic {
  font-style: italic;
}

#falthzlcin .gt_super {
  font-size: 65%;
}

#falthzlcin .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#falthzlcin .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#falthzlcin .gt_indent_1 {
  text-indent: 5px;
}

#falthzlcin .gt_indent_2 {
  text-indent: 10px;
}

#falthzlcin .gt_indent_3 {
  text-indent: 15px;
}

#falthzlcin .gt_indent_4 {
  text-indent: 20px;
}

#falthzlcin .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="gt_col_headings header">
<th id="expression" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">expression</th>
<th id="min" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">min</th>
<th id="median" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median</th>
<th id="mem_alloc" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_alloc</th>
<th id="median_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median_relative</th>
<th id="mem_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_relative</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">orig</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">2ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">2.2ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">10.25KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.11</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">new</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">6.1ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">7.1ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">9.21KB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">3.28</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Well we got it to one operation, but now it takes longer and has no memory advantage. Are we on the wrong track? Let’s try with a realistically sized data set with a lot of groups.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>N <span class="ot">=</span> <span class="dv">100000</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>g <span class="ot">=</span> <span class="dv">1</span><span class="sc">:</span>(N<span class="sc">/</span><span class="dv">4</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>df <span class="ot">=</span> <span class="fu">tibble</span>(</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">group =</span> <span class="fu">rep</span>(g, <span class="at">e =</span> <span class="dv">4</span>),</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">value =</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">size =</span> N, <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>bm_filter_slice2 <span class="ot">=</span> bench<span class="sc">::</span><span class="fu">mark</span>(</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">orig =</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(group) <span class="sc">%&gt;%</span> </span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">all</span>(value <span class="sc">==</span> <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice</span>(<span class="fu">which.max</span>(value <span class="sc">&gt;</span> <span class="dv">0</span>)<span class="sc">:</span><span class="fu">n</span>()),</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">new =</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(group) <span class="sc">%&gt;%</span> </span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">all</span>(value <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">&amp;</span> <span class="fu">row_number</span>() <span class="sc">&gt;=</span> <span class="fu">which.max</span>(value <span class="sc">&gt;</span> <span class="dv">0</span>))</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we have the reverse scenario. The single filter is notably faster and more memory efficient.</p>
<div class="cell">
<div class="cell-output-display">
<div id="mtjwppbtiy" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Libre+Franklin:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
#mtjwppbtiy table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#mtjwppbtiy thead, #mtjwppbtiy tbody, #mtjwppbtiy tfoot, #mtjwppbtiy tr, #mtjwppbtiy td, #mtjwppbtiy th {
  border-style: none;
}

#mtjwppbtiy p {
  margin: 0;
  padding: 0;
}

#mtjwppbtiy .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#mtjwppbtiy .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#mtjwppbtiy .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#mtjwppbtiy .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#mtjwppbtiy .gt_heading {
  background-color: #FFFFFF;
  text-align: left;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#mtjwppbtiy .gt_bottom_border {
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#mtjwppbtiy .gt_col_headings {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#mtjwppbtiy .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#mtjwppbtiy .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#mtjwppbtiy .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#mtjwppbtiy .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#mtjwppbtiy .gt_column_spanner {
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#mtjwppbtiy .gt_spanner_row {
  border-bottom-style: hidden;
}

#mtjwppbtiy .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#mtjwppbtiy .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#mtjwppbtiy .gt_from_md > :first-child {
  margin-top: 0;
}

#mtjwppbtiy .gt_from_md > :last-child {
  margin-bottom: 0;
}

#mtjwppbtiy .gt_row {
  padding-top: 7px;
  padding-bottom: 7px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#mtjwppbtiy .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#mtjwppbtiy .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#mtjwppbtiy .gt_row_group_first td {
  border-top-width: 2px;
}

#mtjwppbtiy .gt_row_group_first th {
  border-top-width: 2px;
}

#mtjwppbtiy .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#mtjwppbtiy .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#mtjwppbtiy .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#mtjwppbtiy .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#mtjwppbtiy .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#mtjwppbtiy .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#mtjwppbtiy .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#mtjwppbtiy .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#mtjwppbtiy .gt_table_body {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #FFFFFF;
}

#mtjwppbtiy .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#mtjwppbtiy .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#mtjwppbtiy .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#mtjwppbtiy .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#mtjwppbtiy .gt_left {
  text-align: left;
}

#mtjwppbtiy .gt_center {
  text-align: center;
}

#mtjwppbtiy .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#mtjwppbtiy .gt_font_normal {
  font-weight: normal;
}

#mtjwppbtiy .gt_font_bold {
  font-weight: bold;
}

#mtjwppbtiy .gt_font_italic {
  font-style: italic;
}

#mtjwppbtiy .gt_super {
  font-size: 65%;
}

#mtjwppbtiy .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#mtjwppbtiy .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#mtjwppbtiy .gt_indent_1 {
  text-indent: 5px;
}

#mtjwppbtiy .gt_indent_2 {
  text-indent: 10px;
}

#mtjwppbtiy .gt_indent_3 {
  text-indent: 15px;
}

#mtjwppbtiy .gt_indent_4 {
  text-indent: 20px;
}

#mtjwppbtiy .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="gt_col_headings header">
<th id="expression" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">expression</th>
<th id="min" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">min</th>
<th id="median" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median</th>
<th id="mem_alloc" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_alloc</th>
<th id="median_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median_relative</th>
<th id="mem_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_relative</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">new</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">208.6ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">209.9ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">12.9MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">orig</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">949.8ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">949.8ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">28.3MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">4.53</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">2.19</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="tidy-timings" class="level2">
<h2 class="anchored" data-anchor-id="tidy-timings">Tidy timings</h2>
<section id="overview" class="level3">
<h3 class="anchored" data-anchor-id="overview">Overview</h3>
<blockquote class="blockquote">
<p>This tidy timings section comes from a notably old exploration I rediscovered (I think it was originally Jan 2020), but it looks like tidyfast still has some functionality beyond dtplyr, and it doesn’t hurt to revisit. I added a result for collapse. My original timings were on a nicely suped up pc, but the following are on a year and a half old macbook with an M1 processer, and were almost 2x faster.</p>
</blockquote>
<p>Here I take a look at some timings for data processing tasks. My reason for doing so is that <span class="pack">dtplyr</span> has recently arisen from the dead, and <span class="pack">tidyfast</span> has come on the scene, so I wanted a quick reference for myself and others to see how things stack up against <span class="pack">data.table</span>.</p>
<p>So we have the following:</p>
<ul>
<li><em>Base R</em>: Just kidding. If you’re using base R approaches for this <code>aggregate</code> you will always be slower. Functions like <code>aggregate</code>, <code>tapply</code> and similar could be used in these demos, but I leave that as an exercise to the reader. I’ve done them, and it isn’t pretty.</li>
<li><em>dplyr</em>: standard data wrangling workhorse package</li>
<li><em>tidyr</em>: has some specific functionality not included in dplyr</li>
<li><em>data.table</em>: another commonly used data processing package that purports to be faster and more memory efficient (usually but not always)</li>
<li><em>tidyfast</em>: can only do a few things, but does them quickly.</li>
<li><em>collapse</em>: many replacements for base R functions.</li>
</ul>
</section>
<section id="standard-grouped-operation" class="level3">
<h3 class="anchored" data-anchor-id="standard-grouped-operation">Standard grouped operation</h3>
<p>The following demonstrates some timings from <a href="http://stackoverflow.com/questions/3505701/r-grouping-functions-sapply-vs-lapply-vs-apply-vs-tapply-vs-by-vs-aggrega/34167477#34167477">this post on stackoverflow</a>. I reproduced it on my own machine based on 50 million observations. The grouped operations that are applied are just a sum and length on a vector. As this takes several seconds to do even once, I only do it one time.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">=</span> <span class="fl">5e7</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>k <span class="ot">=</span> <span class="fl">5e5</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">runif</span>(n)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>grp <span class="ot">=</span> <span class="fu">sample</span>(k, n, <span class="cn">TRUE</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>timing_group_by_big <span class="ot">=</span> <span class="fu">list</span>()</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co"># dplyr</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>timing_group_by_big[[<span class="st">"dplyr"</span>]] <span class="ot">=</span> <span class="fu">system.time</span>({</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">=</span> <span class="fu">tibble</span>(x, grp)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    r.dplyr <span class="ot">=</span> <span class="fu">summarise</span>(<span class="fu">group_by</span>(df, grp), <span class="fu">sum</span>(x), <span class="fu">n</span>())</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="co"># dtplyr</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>timing_group_by_big[[<span class="st">"dtplyr"</span>]] <span class="ot">=</span> <span class="fu">system.time</span>({</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">=</span> <span class="fu">lazy_dt</span>(<span class="fu">tibble</span>(x, grp))</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    r.dtplyr <span class="ot">=</span> df <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(grp) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="fu">sum</span>(x), <span class="fu">n</span>()) <span class="sc">%&gt;%</span> <span class="fu">collect</span>()</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="co"># tidyfast</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>timing_group_by_big[[<span class="st">"tidyfast"</span>]] <span class="ot">=</span> <span class="fu">system.time</span>({</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    dt <span class="ot">=</span> <span class="fu">setnames</span>(<span class="fu">setDT</span>(<span class="fu">list</span>(x, grp)), <span class="fu">c</span>(<span class="st">"x"</span>,<span class="st">"grp"</span>))</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    r.tidyfast <span class="ot">=</span> <span class="fu">dt_count</span>(dt, grp)</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a><span class="co"># data.table</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>timing_group_by_big[[<span class="st">"data.table"</span>]] <span class="ot">=</span> <span class="fu">system.time</span>({</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    dt <span class="ot">=</span> <span class="fu">setnames</span>(<span class="fu">setDT</span>(<span class="fu">list</span>(x, grp)), <span class="fu">c</span>(<span class="st">"x"</span>,<span class="st">"grp"</span>))</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    r.data.table <span class="ot">=</span> dt[, .(<span class="fu">sum</span>(x), .N), grp]</span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a><span class="co"># collapse</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>timing_group_by_big[[<span class="st">"collapse"</span>]] <span class="ot">=</span> <span class="fu">system.time</span>({</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>     df <span class="ot">=</span> <span class="fu">tibble</span>(x, grp)</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>    r.data.table <span class="ot">=</span> <span class="fu">fsummarise</span>(<span class="fu">fgroup_by</span>(df, grp), <span class="at">x =</span> <span class="fu">fsum</span>(x),  <span class="at">n =</span> <span class="fu">fnobs</span>(x))</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>timing_group_by_big <span class="ot">=</span> timing_group_by_big <span class="sc">%&gt;%</span> </span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">do.call</span>(rbind, .) <span class="sc">%&gt;%</span> </span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">'package'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="dhkfieosqq" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Libre+Franklin:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
#dhkfieosqq table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#dhkfieosqq thead, #dhkfieosqq tbody, #dhkfieosqq tfoot, #dhkfieosqq tr, #dhkfieosqq td, #dhkfieosqq th {
  border-style: none;
}

#dhkfieosqq p {
  margin: 0;
  padding: 0;
}

#dhkfieosqq .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#dhkfieosqq .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#dhkfieosqq .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#dhkfieosqq .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#dhkfieosqq .gt_heading {
  background-color: #FFFFFF;
  text-align: left;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#dhkfieosqq .gt_bottom_border {
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#dhkfieosqq .gt_col_headings {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#dhkfieosqq .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#dhkfieosqq .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#dhkfieosqq .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#dhkfieosqq .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#dhkfieosqq .gt_column_spanner {
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#dhkfieosqq .gt_spanner_row {
  border-bottom-style: hidden;
}

#dhkfieosqq .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#dhkfieosqq .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#dhkfieosqq .gt_from_md > :first-child {
  margin-top: 0;
}

#dhkfieosqq .gt_from_md > :last-child {
  margin-bottom: 0;
}

#dhkfieosqq .gt_row {
  padding-top: 7px;
  padding-bottom: 7px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#dhkfieosqq .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#dhkfieosqq .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#dhkfieosqq .gt_row_group_first td {
  border-top-width: 2px;
}

#dhkfieosqq .gt_row_group_first th {
  border-top-width: 2px;
}

#dhkfieosqq .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#dhkfieosqq .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#dhkfieosqq .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#dhkfieosqq .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#dhkfieosqq .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#dhkfieosqq .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#dhkfieosqq .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#dhkfieosqq .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#dhkfieosqq .gt_table_body {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #FFFFFF;
}

#dhkfieosqq .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#dhkfieosqq .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#dhkfieosqq .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#dhkfieosqq .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#dhkfieosqq .gt_left {
  text-align: left;
}

#dhkfieosqq .gt_center {
  text-align: center;
}

#dhkfieosqq .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#dhkfieosqq .gt_font_normal {
  font-weight: normal;
}

#dhkfieosqq .gt_font_bold {
  font-weight: bold;
}

#dhkfieosqq .gt_font_italic {
  font-style: italic;
}

#dhkfieosqq .gt_super {
  font-size: 65%;
}

#dhkfieosqq .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#dhkfieosqq .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#dhkfieosqq .gt_indent_1 {
  text-indent: 5px;
}

#dhkfieosqq .gt_indent_2 {
  text-indent: 10px;
}

#dhkfieosqq .gt_indent_3 {
  text-indent: 15px;
}

#dhkfieosqq .gt_indent_4 {
  text-indent: 20px;
}

#dhkfieosqq .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="gt_col_headings header">
<th id="package" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">package</th>
<th id="elapsed" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">elapsed</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="package" style="font-family: 'Source Sans Pro'; font-weight: 400">dplyr</td>
<td class="gt_row gt_right" headers="elapsed" style="font-family: 'Source Sans Pro'; font-weight: 400">7.03</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="package" style="font-family: 'Source Sans Pro'; font-weight: 400">dtplyr</td>
<td class="gt_row gt_right" headers="elapsed" style="font-family: 'Source Sans Pro'; font-weight: 400">1.30</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="package" style="font-family: 'Source Sans Pro'; font-weight: 400">collapse</td>
<td class="gt_row gt_right" headers="elapsed" style="font-family: 'Source Sans Pro'; font-weight: 400">1.02</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="package" style="font-family: 'Source Sans Pro'; font-weight: 400">data.table</td>
<td class="gt_row gt_right" headers="elapsed" style="font-family: 'Source Sans Pro'; font-weight: 400">0.67</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="package" style="font-family: 'Source Sans Pro'; font-weight: 400">tidyfast</td>
<td class="gt_row gt_right" headers="elapsed" style="font-family: 'Source Sans Pro'; font-weight: 400">0.47</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We can see that all options are notable improvements on <span class="pack">dplyr</span>. <span class="pack">tidyfast</span> is a little optimistic, as it can count but does not appear to do a summary operation like means or sums.</p>
</section>
<section id="count" class="level3">
<h3 class="anchored" data-anchor-id="count">Count</h3>
<p>To make things more evenly matched, we’ll just do a simple grouped count. In the following, I add a different option for <span class="pack">dplyr</span> if all we want are group sizes. In addition, you have to ‘collect’ the data for a <span class="pack">dtplyr</span> object, otherwise the resulting object is not actually a usable tibble, and we don’t want to count the timing until it actually performs the operation. You can do this with the <code>collect</code> function or <code>as_tibble</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(flights, <span class="at">package =</span> <span class="st">'nycflights13'</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(flights)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>flights_dtp <span class="ot">=</span> <span class="fu">lazy_dt</span>(flights)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>flights_dt <span class="ot">=</span> <span class="fu">data.table</span>(flights)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>bm_count_flights <span class="ot">=</span> bench<span class="sc">::</span><span class="fu">mark</span>(</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">dplyr_base =</span> <span class="fu">count</span>(flights, arr_time),</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">dtplyr     =</span> <span class="fu">collect</span>(<span class="fu">count</span>(flights_dt, arr_time)),</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">tidyfast   =</span> <span class="fu">dt_count</span>(flights_dt, arr_time),</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">data.table =</span> flights_dt[, .(<span class="at">n =</span> .N), <span class="at">by =</span> arr_time],</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">iterations =</span> <span class="dv">100</span>,</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">check =</span> <span class="cn">FALSE</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here are the results. It’s important to note the memory as well as the time. The faster functions here are taking a bit more memory to do it. If dealing with very large data this could be more important if operations timings aren’t too different.</p>
<div class="cell">
<div class="cell-output-display">
<div id="ezjcsmcqjx" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Libre+Franklin:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
@import url("https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
#ezjcsmcqjx table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#ezjcsmcqjx thead, #ezjcsmcqjx tbody, #ezjcsmcqjx tfoot, #ezjcsmcqjx tr, #ezjcsmcqjx td, #ezjcsmcqjx th {
  border-style: none;
}

#ezjcsmcqjx p {
  margin: 0;
  padding: 0;
}

#ezjcsmcqjx .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#ezjcsmcqjx .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#ezjcsmcqjx .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#ezjcsmcqjx .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#ezjcsmcqjx .gt_heading {
  background-color: #FFFFFF;
  text-align: left;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ezjcsmcqjx .gt_bottom_border {
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ezjcsmcqjx .gt_col_headings {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#ezjcsmcqjx .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#ezjcsmcqjx .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 12px;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#ezjcsmcqjx .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#ezjcsmcqjx .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#ezjcsmcqjx .gt_column_spanner {
  border-bottom-style: none;
  border-bottom-width: 1px;
  border-bottom-color: #334422;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#ezjcsmcqjx .gt_spanner_row {
  border-bottom-style: hidden;
}

#ezjcsmcqjx .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#ezjcsmcqjx .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#ezjcsmcqjx .gt_from_md > :first-child {
  margin-top: 0;
}

#ezjcsmcqjx .gt_from_md > :last-child {
  margin-bottom: 0;
}

#ezjcsmcqjx .gt_row {
  padding-top: 7px;
  padding-bottom: 7px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#ezjcsmcqjx .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#ezjcsmcqjx .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#ezjcsmcqjx .gt_row_group_first td {
  border-top-width: 2px;
}

#ezjcsmcqjx .gt_row_group_first th {
  border-top-width: 2px;
}

#ezjcsmcqjx .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ezjcsmcqjx .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#ezjcsmcqjx .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#ezjcsmcqjx .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#ezjcsmcqjx .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#ezjcsmcqjx .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#ezjcsmcqjx .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#ezjcsmcqjx .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#ezjcsmcqjx .gt_table_body {
  border-top-style: none;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #FFFFFF;
}

#ezjcsmcqjx .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ezjcsmcqjx .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#ezjcsmcqjx .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#ezjcsmcqjx .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#ezjcsmcqjx .gt_left {
  text-align: left;
}

#ezjcsmcqjx .gt_center {
  text-align: center;
}

#ezjcsmcqjx .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#ezjcsmcqjx .gt_font_normal {
  font-weight: normal;
}

#ezjcsmcqjx .gt_font_bold {
  font-weight: bold;
}

#ezjcsmcqjx .gt_font_italic {
  font-style: italic;
}

#ezjcsmcqjx .gt_super {
  font-size: 65%;
}

#ezjcsmcqjx .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#ezjcsmcqjx .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#ezjcsmcqjx .gt_indent_1 {
  text-indent: 5px;
}

#ezjcsmcqjx .gt_indent_2 {
  text-indent: 10px;
}

#ezjcsmcqjx .gt_indent_3 {
  text-indent: 15px;
}

#ezjcsmcqjx .gt_indent_4 {
  text-indent: 20px;
}

#ezjcsmcqjx .gt_indent_5 {
  text-indent: 25px;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="gt_col_headings header">
<th id="expression" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">expression</th>
<th id="min" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">min</th>
<th id="median" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median</th>
<th id="mem_alloc" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_alloc</th>
<th id="median_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">median_relative</th>
<th id="mem_relative" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" style="color: #A9A9A9; font-family: 'Source Sans Pro'; text-transform: uppercase" scope="col">mem_relative</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">data.table</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">2ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">2.4ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">9.07MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.5</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">tidyfast</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">2ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">3.3ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">9.05MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.38</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.49</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">dplyr_gs</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">3.7ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">4ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">6.06MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.65</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1</td>
</tr>
<tr class="even">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">dtplyr</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">3.5ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">4.2ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">9.06MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.73</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.5</td>
</tr>
<tr class="odd">
<td class="gt_row gt_left" headers="expression" style="font-family: 'Source Sans Pro'; font-weight: 400">dplyr_base</td>
<td class="gt_row gt_left" headers="min" style="font-family: 'Source Sans Pro'; font-weight: 400">9.3ms</td>
<td class="gt_row gt_left" headers="median" style="font-family: 'Source Sans Pro'; font-weight: 400">10.5ms</td>
<td class="gt_row gt_left" headers="mem_alloc" style="font-family: 'Source Sans Pro'; font-weight: 400">6.12MB</td>
<td class="gt_row gt_right" headers="median_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">4.31</td>
<td class="gt_row gt_right" headers="mem_relative" style="font-family: 'Source Sans Pro'; font-weight: 400">1.01</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Just for giggles I did the same in Python with a <span class="pack">pandas</span> <code>DataFrame</code>, and depending on how you go about it you could be notably slower than all these methods, or less than half the standard <span class="pack">dplyr</span> approach. Unfortunately I can’t reproduce it here<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>, but I did run it on the same machine using a <code>df.groupby().size()</code> approach to create the same type of data frame. Things get worse as you move to something not as simple, like summarizing with a custom function, even if that custom function is still simple arithmetic.</p>
<p>A lot of folks that use Python primarily still think R is slow, but that is mostly just a sign that they don’t know how to effectively program with R for data science. I know folks who use Python more, but also use tidyverse, and I use R more but also use pandas quite a bit. It’s not really a debate - tidyverse is easier, less verbose, and generally faster relative to pandas, especially for more complicated operations. If you start using tools like <span class="pack">data.table</span>, then there is really no comparison for speed and efficiency. You can run the following for comparison.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># flights = r.flights</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>flights <span class="op">=</span> pd.read_parquet(<span class="st">'data/flights.parquet'</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>flights.groupby(<span class="st">"arr_time"</span>, as_index<span class="op">=</span><span class="va">False</span>).size()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      arr_time  size
0          1.0   201
1          2.0   164
2          3.0   174
3          4.0   173
4          5.0   206
...        ...   ...
1406    2356.0   202
1407    2357.0   207
1408    2358.0   189
1409    2359.0   222
1410    2400.0   150

[1411 rows x 2 columns]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> test(): </span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  flights.groupby(<span class="st">"arr_time"</span>, as_index<span class="op">=</span><span class="va">False</span>).arr_time.count()</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>test()</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> timeit</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>timeit.timeit() <span class="co"># see documentation</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.004515166991041042</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>test_result <span class="op">=</span> timeit.timeit(stmt<span class="op">=</span><span class="st">"test()"</span>, setup<span class="op">=</span><span class="st">"from __main__ import test"</span>, number <span class="op">=</span> <span class="dv">100</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co"># default result is in seconds for the total number of 100 runs</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>test_result<span class="op">/</span><span class="dv">100</span><span class="op">*</span><span class="dv">1000</span>  <span class="co"># ms per run </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3.404746250016615</code></pre>
</div>
</div>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>Programming is a challenge, and programming in a computationally efficient manner is even harder. Depending on your situation, you may need to switch tools or just write your own to come up with the best solution.</p>


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p><span class="pack">data.table</span> modifies in place, so it technically it doesn’t have anything to fill after the first run. As a comparison, I created new columns as the filled in values, and this made almost no speed/memory difference. I also tried <code>copy(dt_missing)[...]</code>, which had a minor speed hit. I also tried using <code>setkey</code> first but that made no difference. Note also that <span class="pack">data.table</span> has <code>setnafill</code>, but this apparently has no grouping argument, so is not demonstrated.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>As of this writing, I’m new to the <span class="pack">collapse</span> package, and so might be missing other uses that might be more efficient.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>This is because <a href="https://github.com/rstudio/reticulate/issues/1019">reticulate still has issues with M1 out of the box</a>, and even then getting it to work can be a pain.<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a></div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{clark2022,
  author = {Clark, Michael},
  title = {Programming {Odds} \&amp; {Ends}},
  date = {2022-07-25},
  url = {https://m-clark.github.io/posts/2022-07-25-programming/},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-clark2022" class="csl-entry quarto-appendix-citeas" role="listitem">
Clark, Michael. 2022. <span>“Programming Odds &amp; Ends.”</span> July
25, 2022. <a href="https://m-clark.github.io/posts/2022-07-25-programming/">https://m-clark.github.io/posts/2022-07-25-programming/</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/m-clark\.github\.io");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<div class="page-columns page-rows-contents page-layout-article"><div class="social-share"><a href="https://twitter.com/share?url=https://m-clark.github.io/&amp;text=Michael Clark" target="_blank" class="twitter"><i class="fab fa-twitter fa-fw fa-lg"></i></a><a href="https://www.linkedin.com/shareArticle?url=https://m-clark.github.io/&amp;title=Michael Clark" target="_blank" class="linkedin"><i class="fa-brands fa-linkedin-in fa-fw fa-lg"></i></a>  <a href="mailto:?subject=Michael Clark&amp;body=Check out this link:https://m-clark.github.io/" target="_blank" class="email"><i class="fa-solid fa-envelope fa-fw fa-lg"></i></a><a href="https://www.facebook.com/sharer.php?u=https://m-clark.github.io/" target="_blank" class="facebook"><i class="fab fa-facebook-f fa-fw fa-lg"></i></a><a href="https://reddit.com/submit?url=https://m-clark.github.io/&amp;title=Michael Clark" target="_blank" class="reddit">   <i class="fa-brands fa-reddit-alien fa-fw fa-lg"></i></a><a href="https://bsky.app/intent/compose?text=https://m-clark.github.io/ Michael Clark" target="_blank" class="bsky"><i class="fa-brands fa-bluesky"></i></a></div></div>




</body></html>